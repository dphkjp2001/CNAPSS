import{r as n,u as ne,b as se,R as t}from"./index-808f52da.js";import{u as ae,c as re,l as G,b as J,e as oe,d as le,M as ie,T as ce,a as q,L as K,P as W}from"./leaflet-a1517919.js";function ue(o,s,a){s.center!==a.center&&o.setLatLng(s.center),s.radius!=null&&s.radius!==a.radius&&o.setRadius(s.radius)}function me(){return ae().map}const D=re(function({center:s,children:a,...r},l){const f=new G.Circle(s,r);return J(f,oe(l,{overlayContainer:f}))},ue),de=le(function(s,a){const r=new G.Tooltip(s,a.overlayContainer);return J(r,a)},function(s,a,{position:r},l){n.useEffect(function(){const i=a.overlayContainer;if(i==null)return;const{instance:g}=s,h=p=>{p.tooltip===g&&(r!=null&&g.setLatLng(r),g.update(),l(!0))},x=p=>{p.tooltip===g&&l(!1)};return i.on({tooltipopen:h,tooltipclose:x}),i.bindTooltip(g),function(){i.off({tooltipopen:h,tooltipclose:x}),i._map!=null&&i.unbindTooltip()}},[s,a,l,r])}),Q="https://api.cnapss.com/api".replace(/\/$/,""),X=o=>({"Content-Type":"application/json",Authorization:`Bearer ${o}`});async function fe({school:o,token:s,address:a,lat:r,lon:l,radius:f,types:i=["restaurant","cafe","fast food"],minRating:g=0,minReviews:h=0,sortBy:x="best_match",term:p="",categories:C,priceLevels:w,openNow:k}){const N=String(o||"").toLowerCase().trim(),_=new URLSearchParams({...a&&{address:a},...r!=null&&{lat:r},...l!=null&&{lon:l},...f!=null&&{radius:f},types:i.join(","),minRating:g,minReviews:h,sortBy:x,...p&&{term:p},...C&&{categories:C},...w&&{priceLevels:w},...k?{openNow:"true"}:{}}),E=await fetch(`${Q}/${N}/places/nearby?${_.toString()}`,{headers:X(s)});if(E.status===501){const T=new Error("Feature unavailable");throw T.code="FEATURE_UNAVAILABLE",T}if(!E.ok)throw new Error(`Failed to load places: ${E.status}`);return E.json()}async function ge({school:o,token:s,text:a,lat:r,lon:l,limit:f=8}){const i=String(o||"").toLowerCase().trim(),g=new URLSearchParams({text:String(a||""),...r!=null&&{latitude:String(r)},...l!=null&&{longitude:String(l)},limit:String(f)}),h=await fetch(`${Q}/${i}/places/suggest?${g.toString()}`,{headers:X(s)});if(!h.ok)throw new Error("Failed to load suggestions");return h.json()}function pe({anchor:o,focus:s}){const a=me();return n.useEffect(()=>{const r=s||o;r!=null&&r.lat&&(r!=null&&r.lon)&&a.setView([r.lat,r.lon],a.getZoom(),{animate:!0})},[o,s,a]),null}const he=K.divIcon({className:"w-3 h-3 rounded-full bg-rose-600 ring-2 ring-white shadow-[0_0_0_2px_rgba(244,63,94,0.35)]",iconSize:[12,12],iconAnchor:[6,6]});function Ae(){const{token:o}=ne(),{school:s}=se(),[a,r]=n.useState({lat:40.729513,lon:-73.997649}),[l,f]=n.useState({lat:40.729513,lon:-73.997649}),[i,g]=n.useState(1200),[h,x]=n.useState(null),[p,C]=n.useState(["restaurant","cafe","fast food"]),[w,k]=n.useState([]),[N,_]=n.useState([1,2,3]),[E,T]=n.useState(!1),[P,xe]=n.useState(0),[$,Ee]=n.useState(0),[I,ve]=n.useState("best_match"),[S,ye]=n.useState(""),[M,be]=n.useState(!1),[v,A]=n.useState([]),[y,L]=n.useState(null),[F,U]=n.useState(!1),[z,B]=n.useState(""),[ee,O]=n.useState(!1),[we,R]=n.useState([]),[Se,j]=n.useState(!1),[Ne,te]=n.useState(-1);n.useRef(null);const H=n.useRef({}),V=n.useRef(null),Y=n.useRef({});return n.useMemo(()=>String(s||"").toUpperCase(),[s]),o?(n.useEffect(()=>{let e=!1;return(async()=>{var c,m,d,b,Z;try{U(!0),B(""),O(!1);const u=await fe({school:s,token:o,...M?{address:S}:{term:S},radius:i,types:p,minRating:P,minReviews:$,sortBy:I,categories:w.join(","),priceLevels:N.join(","),openNow:E});if(e)return;(c=u.anchor)!=null&&c.lat&&((m=u.anchor)!=null&&m.lon)&&r(u.anchor),(d=u.center)!=null&&d.lat&&((b=u.center)!=null&&b.lon)&&f(u.center),A(Array.isArray(u.items)?u.items:[]),!y&&((Z=u.items)!=null&&Z.length)&&L(u.items[0].id),x(null)}catch(u){if(e)return;u&&u.code==="FEATURE_UNAVAILABLE"?(O(!0),A([])):(B("Failed to load places."),A([]))}finally{e||U(!1)}})(),()=>{e=!0}},[s,o,i,p.join("|"),w.join("|"),N.join(","),E,P,$,I,S,M]),n.useEffect(()=>{let e;const c=S.trim();return c.length>=2?e=setTimeout(async()=>{try{const{suggestions:m}=await ge({school:s,token:o,text:c,lat:l.lat,lon:l.lon,limit:8});R(m||[]),j(!0),te(-1)}catch{R([]),j(!1)}},220):(R([]),j(!1)),()=>clearTimeout(e)},[S,s,o,l]),n.useEffect(()=>{if(!y)return;const e=v.find(b=>b.id===y),c=H.current[y];e!=null&&e.lat&&(e!=null&&e.lon)&&(x({lat:e.lat,lon:e.lon}),setTimeout(()=>{c&&typeof c.openPopup=="function"&&c.openPopup()},250));const m=Y.current[y],d=V.current;if(m&&d)try{m.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}catch{const b=m.offsetTop-d.clientHeight/2+m.clientHeight/2;d.scrollTo({top:b,behavior:"smooth"})}},[y,v]),t.createElement("div",{className:"flex h-[calc(100vh-72px)] flex-col overflow-hidden"},t.createElement("div",{className:"border-b bg-white/95 px-4 py-3"}),t.createElement("div",{className:"flex flex-1 overflow-hidden"},t.createElement("div",{className:"relative flex-1"},t.createElement(ie,{center:[a.lat,a.lon],zoom:15,style:{height:"100%",width:"100%"},scrollWheelZoom:!0},t.createElement(pe,{anchor:a,focus:h||null}),t.createElement(ce,{attribution:"© OpenStreetMap contributors",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),t.createElement(q,{position:[a.lat,a.lon],icon:K.divIcon({className:"flex items-center justify-center rounded-full border-2 border-white bg-indigo-600 shadow-lg",html:'<div style="width:18px;height:18px;border-radius:9999px"></div>',iconSize:[18,18],iconAnchor:[9,9]})},t.createElement(de,{direction:"top",offset:[0,-10],opacity:1,permanent:!0},String(s||"").toUpperCase()),t.createElement(W,null,"Center")),t.createElement(D,{center:[a.lat,a.lon],radius:80,color:"#6b21a8",fillColor:"#c4b5fd",fillOpacity:.25}),t.createElement(D,{center:[l.lat,l.lon],radius:i,color:"#6b21a8",fillOpacity:0,dashArray:"6 6"}),v.map(e=>t.createElement(q,{key:e.id,position:[e.lat,e.lon],icon:he,eventHandlers:{click:()=>L(e.id)},ref:c=>{c&&(H.current[e.id]=c)}},t.createElement(W,null,t.createElement("div",{className:"text-sm"},t.createElement("div",{className:"font-semibold"},e.name),t.createElement("div",{className:"text-gray-600"},e.address||"-"),t.createElement("div",{className:"mt-1 text-gray-600"},"⭐ ",e.rating??"-"," · ",e.review_count??0," reviews"),e.price?t.createElement("div",{className:"text-gray-600"},"$".repeat(e.price)):null,e.website?t.createElement("a",{href:e.website,target:"_blank",rel:"noreferrer",className:"mt-1 inline-block text-indigo-600 underline"},"Yelp"):null))))),t.createElement("div",{className:"pointer-events-none absolute left-3 bottom-3 rounded-lg bg-white/90 px-3 py-1 text-xs text-gray-700 shadow"},F?"Loading…":`${v.length} places`,z&&t.createElement("span",{className:"ml-2 text-red-600"},z),ee&&t.createElement("span",{className:"ml-2"},"Feature not available yet."))),t.createElement("div",{className:"w-[380px] border-l bg-white h-full flex flex-col"},t.createElement("div",{className:"flex items-center justify-between border-b px-4 py-3"},t.createElement("div",{className:"text-sm font-semibold"},"Results"),t.createElement("div",{className:"text-xs text-gray-500"},v.length)),t.createElement("div",{className:"flex-1 overflow-auto",ref:V},!F&&v.length===0?t.createElement("div",{className:"p-4 text-sm text-gray-500"},"No results. Try widening radius or changing filters."):t.createElement("ul",{className:"divide-y"},v.map(e=>{var m;const c=y===e.id;return t.createElement("li",{key:e.id,ref:d=>{d&&(Y.current[e.id]=d)},className:`cursor-pointer px-4 py-3 hover:bg-gray-50 ${c?"bg-indigo-50":""}`,onClick:()=>L(e.id)},t.createElement("div",{className:"flex items-start justify-between"},t.createElement("div",null,t.createElement("div",{className:"font-medium"},e.name),t.createElement("div",{className:"text-xs text-gray-600"},((m=e.categories)==null?void 0:m.join(" • "))||"-"),t.createElement("div",{className:"mt-1 text-xs text-gray-600"},"⭐ ",e.rating??"-"," · ",e.review_count??0," reviews",e.price?t.createElement("span",null," · ","$".repeat(e.price)):null),t.createElement("div",{className:"mt-1 text-xs text-gray-500"},e.address||"-")),e.website?t.createElement("a",{href:e.website,target:"_blank",rel:"noreferrer",className:"ml-3 rounded bg-gray-900 px-2 py-1 text-xs text-white",onClick:d=>d.stopPropagation()},"Yelp"):null))}))))))):t.createElement("div",{className:"mx-auto max-w-4xl p-6"},t.createElement("div",{className:"rounded-xl border border-gray-200 bg-white p-6 text-sm text-gray-700"},"Please log in to use Food Map."))}export{Ae as default};
