import{a as $,b as A,r as d,R as e,A as z,d as y,e as D,f as R,u as J,c as K,L as H}from"./index-50e73a55.js";import"./en-93a80531.js";import{g as I,d as M,t as W}from"./posts-a3317476.js";const N="https://api.cnapss.com/api".replace(/\/$/,""),v=n=>({"Content-Type":"application/json",Authorization:`Bearer ${n}`});async function q({school:n,token:l,postId:a}){const s=String(n||"").toLowerCase().trim(),r=await fetch(`${N}/${s}/comments/${a}`,{headers:v(l)});if(!r.ok)throw new Error("Failed to load comments");return r.json()}async function G({school:n,token:l,postId:a,content:s}){const r=String(n||"").toLowerCase().trim(),i=await fetch(`${N}/${r}/comments/${a}`,{method:"POST",headers:v(l),body:JSON.stringify({content:s})});if(!i.ok)throw new Error("Failed to add comment");return i.json()}async function Q({school:n,token:l,commentId:a,content:s}){const r=String(n||"").toLowerCase().trim(),i=await fetch(`${N}/${r}/comments/${a}`,{method:"PUT",headers:v(l),body:JSON.stringify({content:s})});if(!i.ok)throw new Error("Failed to update comment");return i.json()}async function V({school:n,token:l,commentId:a}){const s=String(n||"").toLowerCase().trim(),r=await fetch(`${N}/${s}/comments/${a}`,{method:"DELETE",headers:v(l)});if(!r.ok)throw new Error("Failed to delete comment");return r.json()}async function X({school:n,token:l,commentId:a}){const s=String(n||"").toLowerCase().trim(),r=await fetch(`${N}/${s}/comments/${a}/thumbs`,{method:"POST",headers:v(l)});if(!r.ok)throw new Error("Failed to toggle comment like");return r.json()}y.extend(D);y.locale("en");function Y({postId:n}){const{user:l,token:a}=$(),{school:s}=A(),[r,i]=d.useState([]),[C,o]=d.useState(!0),[h,x]=d.useState(""),[k,p]=d.useState(""),[L,S]=d.useState(!1),[f,w]=d.useState(null),[c,E]=d.useState(""),P=((l==null?void 0:l.email)||"").toLowerCase(),F=d.useCallback(async()=>{if(!(!n||!s||!a)){o(!0),x("");try{const t=await q({school:s,token:a,postId:n});i(Array.isArray(t)?t:[])}catch(t){console.error("comments:load failed",t),x("Failed to load comments."),i([])}finally{o(!1)}}},[n,s,a]);d.useEffect(()=>{F()},[F]);const U=async()=>{const t=k.trim();if(!(!t||!n))try{const m=await G({school:s,token:a,postId:n,content:t});i(u=>[...u,m]),p("")}catch(m){console.error("comments:add failed",m),alert("Failed to add comment.")}},j=t=>{w(t._id),E(t.content||"")},_=()=>{w(null),E("")},T=async()=>{const t=c.trim();if(!(!t||!f))try{const m=await Q({school:s,token:a,commentId:f,content:t});i(u=>u.map(g=>g._id===f?m:g)),_()}catch(m){console.error("comments:update failed",m),alert("Failed to update comment.")}},B=async t=>{if(window.confirm("Delete this comment?"))try{await V({school:s,token:a,commentId:t}),i(m=>m.filter(u=>u._id!==t))}catch(m){console.error("comments:delete failed",m),alert("Failed to delete comment.")}},O=async t=>{try{const m=await X({school:s,token:a,commentId:t});i(u=>u.map(g=>{var b;return g._id===t?{...g,thumbs:m.thumbs??[],thumbsCount:m.count??(((b=m.thumbs)==null?void 0:b.length)||0)}:g}))}catch(m){console.error("comments:thumb toggle failed",m)}};return!l||!a?e.createElement("div",{className:"mt-6 rounded-xl border border-gray-200 bg-white p-4 text-sm text-gray-600"},"Please log in to view and write comments."):e.createElement("div",{className:"mt-8"},e.createElement("h3",{className:"mb-3 text-lg font-semibold text-gray-900"},"Comments"),e.createElement("div",{className:"mb-4 rounded-xl border border-gray-200 bg-white p-3 shadow-sm"},e.createElement("textarea",{value:k,onChange:t=>p(t.target.value),onCompositionStart:()=>S(!0),onCompositionEnd:()=>S(!1),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&!L&&(t.preventDefault(),U())},placeholder:"Write a comment‚Ä¶",className:"h-20 w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),e.createElement("div",{className:"mt-2 text-right"},e.createElement(z,{onClick:U,className:"rounded-lg bg-gray-900 px-3 py-2 text-sm font-medium text-white hover:bg-black"},"Post"))),e.createElement("div",{className:"rounded-xl border border-gray-200 bg-white p-2 sm:p-3"},C?e.createElement("div",{className:"p-3 text-sm text-gray-600"},"Loading‚Ä¶"):h?e.createElement("div",{className:"rounded-lg bg-red-50 p-3 text-sm text-red-700"},h):r.length===0?e.createElement("div",{className:"p-3 text-sm text-gray-600"},"No comments yet."):e.createElement("ul",{className:"divide-y divide-gray-100"},r.map(t=>{const m=(t.email||"").toLowerCase()===P,u=(t.thumbs||[]).map(b=>b.toLowerCase()).includes(P),g=t.thumbsCount??(t.thumbs?t.thumbs.length:0);return e.createElement("li",{key:t._id,className:"py-3"},e.createElement("div",{className:"flex items-start gap-3"},e.createElement("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gray-200"}),e.createElement("div",{className:"min-w-0 flex-1"},e.createElement("div",{className:"flex items-center gap-2"},e.createElement("span",{className:"text-sm font-medium text-gray-900"},(t.email||"").split("@")[0]||"anon"),e.createElement("span",{className:"text-xs text-gray-500"},"‚Ä¢ ",y(t.createdAt).fromNow())),f===t._id?e.createElement("div",{className:"mt-2"},e.createElement("textarea",{value:c,onChange:b=>E(b.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),e.createElement("div",{className:"mt-2 flex gap-2"},e.createElement("button",{onClick:T,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black"},"Save"),e.createElement("button",{onClick:_,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))):e.createElement("p",{className:"mt-1 whitespace-pre-wrap break-words text-sm text-gray-800"},t.content),e.createElement("div",{className:"mt-2 flex items-center gap-3 text-xs text-gray-600"},e.createElement("button",{onClick:()=>O(t._id),className:`rounded px-2 py-1 ${u?"bg-blue-50 text-blue-600":"hover:bg-gray-100"}`,title:"Like"},"üëç ",g),m&&f!==t._id&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>j(t),className:"rounded px-2 py-1 hover:bg-gray-100"},"Edit"),e.createElement("button",{onClick:()=>B(t._id),className:"rounded px-2 py-1 text-red-600 hover:bg-red-50"},"Delete"))))))}))))}y.extend(D);y.locale("en");function ae(){var w;const{id:n}=R(),l=J(),{user:a}=$(),{school:s,schoolTheme:r}=A(),i=K(),{token:C}=$(),[o,h]=d.useState(null),[x,k]=d.useState(""),p=async()=>{try{const c=await I({school:s,token:C,id:n});h(c)}catch(c){k(c.message||"Failed to load the post.")}};d.useEffect(()=>{p()},[n,s]);const L=d.useMemo(()=>(a==null?void 0:a.email)===(o==null?void 0:o.email),[a,o]),S=async()=>{if(window.confirm("Delete this post?"))try{await M(n,a.email,s),alert("Post deleted."),l(i("/freeboard"))}catch(c){alert("Delete failed: "+(c.message||"Unknown error"))}},f=async()=>{try{await W({school:s,token:C,id:o._id}),h(c=>c&&{...c,thumbsUpUsers:(c.thumbsUpUsers||[]).includes(((a==null?void 0:a.email)||"").toLowerCase())?c.thumbsUpUsers.filter(E=>E.toLowerCase()!==((a==null?void 0:a.email)||"").toLowerCase()):[...c.thumbsUpUsers||[],((a==null?void 0:a.email)||"").toLowerCase()]}),await p()}catch(c){alert("Failed to like: "+(c.message||"Unknown error"))}};return x?e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-red-700",style:{backgroundColor:(r==null?void 0:r.bg)||"#f6f3ff"}},x):o?e.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(r==null?void 0:r.bg)||"#f6f3ff"}},e.createElement("div",{className:"mx-auto max-w-3xl"},e.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},e.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},e.createElement("h1",{className:"text-2xl font-bold text-gray-900"},o.title),e.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",e.createElement("span",{className:"font-medium"},"anonymous")," ‚Ä¢ ",y(o.createdAt).fromNow())),e.createElement("div",{className:"p-5 sm:p-6"},e.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},e.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},o.content)),e.createElement("div",{className:"mt-6 flex flex-wrap items-center gap-3"},e.createElement("button",{onClick:f,className:"rounded-xl border border-gray-300 bg-white px-3 py-1.5 text-sm text-gray-800 shadow-sm hover:bg-gray-50","aria-label":"like post"},"üëç ",((w=o.thumbsUpUsers)==null?void 0:w.length)||0),L&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>l(i(`/freeboard/edit/${o._id}`)),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:(r==null?void 0:r.primary)||"#6b46c1"}},"Edit"),e.createElement("button",{onClick:S,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")),e.createElement(H,{to:i("/freeboard"),className:"ml-auto text-sm font-medium text-blue-600 underline underline-offset-2"},"‚Üê Back to List")))),(o==null?void 0:o._id)&&e.createElement("div",{className:"mt-6 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm sm:p-6"},e.createElement(Y,{postId:o._id,postAuthorEmail:o.email})))):e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-gray-600",style:{backgroundColor:(r==null?void 0:r.bg)||"#f6f3ff"}},"Loading‚Ä¶")}export{ae as default};
