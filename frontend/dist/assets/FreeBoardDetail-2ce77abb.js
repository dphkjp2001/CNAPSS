import{a as z,b as Z,r as u,R as e,A as pe,d as P,e as ee,g as ye,u as fe,c as be,L as he}from"./index-d46643dc.js";import"./en-944bc826.js";import{d as xe,e as Ee,t as we}from"./posts-7a288c92.js";const A="https://api.cnapss.com/api".replace(/\/$/,""),F=l=>({"Content-Type":"application/json",Authorization:`Bearer ${l}`});async function Ce({school:l,token:a,postId:s}){const c=String(l||"").toLowerCase().trim(),n=await fetch(`${A}/${c}/comments/${s}`,{headers:F(a)});if(!n.ok)throw new Error("Failed to load comments");return n.json()}async function Y({school:l,token:a,postId:s,content:c,parentId:n=null}){const b=String(l||"").toLowerCase().trim(),f={content:String(c||"").trim()};n&&(f.parentId=String(n));const i=await fetch(`${A}/${b}/comments/${s}`,{method:"POST",headers:F(a),body:JSON.stringify(f)});if(!i.ok)throw new Error("Failed to add comment");return i.json()}async function Ne({school:l,token:a,commentId:s,content:c}){const n=String(l||"").toLowerCase().trim(),b=await fetch(`${A}/${n}/comments/${s}`,{method:"PUT",headers:F(a),body:JSON.stringify({content:c})});if(!b.ok)throw new Error("Failed to update comment");return b.json()}async function ve({school:l,token:a,commentId:s}){const c=String(l||"").toLowerCase().trim(),n=await fetch(`${A}/${c}/comments/${s}`,{method:"DELETE",headers:F(a)});if(!n.ok)throw new Error("Failed to delete comment");return n.json()}async function ke({school:l,token:a,commentId:s}){const c=String(l||"").toLowerCase().trim(),n=await fetch(`${A}/${c}/comments/${s}/thumbs`,{method:"POST",headers:F(a)});if(!n.ok)throw new Error("Failed to toggle comment like");return n.json()}P.extend(ee);P.locale("en");const y=l=>l==null?"":String(l),B=l=>String(l||"").toLowerCase().trim();function Se({postId:l,authorEmail:a=""}){const{user:s,token:c}=z(),{school:n}=Z(),b=B(s==null?void 0:s.email),f=B(a),[i,h]=u.useState([]),[w,C]=u.useState(!0),[N,S]=u.useState(""),[I,_]=u.useState(""),[v,p]=u.useState(!1),[L,D]=u.useState(!1),[T,R]=u.useState(null),[U,$]=u.useState(""),[M,j]=u.useState(null),[k,x]=u.useState(null),[W,O]=u.useState(""),[ae,J]=u.useState(null),[ne,K]=u.useState(null),[oe,H]=u.useState(null),q=u.useCallback(async()=>{if(!(!l||!n||!c)){C(!0),S("");try{const t=await Ce({school:n,token:c,postId:l});h(Array.isArray(t)?t:[])}catch(t){console.error("comments:load failed",t),S("Failed to load comments."),h([])}finally{C(!1)}}},[l,n,c]);u.useEffect(()=>{q()},[q]);const G=u.useMemo(()=>{const t=new Map;for(const d of i){const g=B(d.email);if(!g)continue;const r=new Date(d.createdAt||0).getTime();t.has(g)?t.set(g,Math.min(t.get(g),r)):t.set(g,r)}const o=Array.from(t.keys()).filter(d=>d&&d!==f);o.sort((d,g)=>(t.get(d)||0)-(t.get(g)||0));const m=new Map;return f&&m.set(f,"anonymous (게시자)"),o.forEach((d,g)=>m.set(d,`anonymous ${g+1}`)),m},[i,f]),se=u.useCallback(t=>G.get(B(t))||"anonymous",[G]),Q=u.useMemo(()=>{const t=(i||[]).map(r=>({...r,_id:y(r._id),parentId:r.parentId?y(r.parentId):null,children:[]})),o=new Map;t.forEach(r=>o.set(r._id,r));const m=[];t.forEach(r=>{const E=r.parentId?y(r.parentId):"";E&&o.has(E)?o.get(E).children.push(r):m.push(r)});const d=(r,E)=>new Date(r.createdAt)-new Date(E.createdAt),g=r=>{r.sort(d),r.forEach(E=>g(E.children))};return g(m),m},[i]),re=(t,o)=>h(m=>m.map(d=>y(d._id)===y(t)?o:d)),le=t=>h(o=>{const m=y(t),d=new Set([m]);let g=!0;for(;g;)g=!1,o.forEach(r=>{const E=r.parentId?y(r.parentId):"";E&&d.has(E)&&!d.has(y(r._id))&&(d.add(y(r._id)),g=!0)});return o.filter(r=>!d.has(y(r._id)))}),V=async()=>{const t=I.trim();if(t){p(!0);try{const o=await Y({school:n,token:c,postId:l,content:t});h(m=>[...m,o]),_("")}catch(o){console.error("comments:add root failed",o),alert("Failed to add comment.")}finally{p(!1)}}},ce=()=>{R(null),$("")},ie=async t=>{const o=U.trim();if(!o)return;const m=y(t);j(m);try{const d=await Y({school:n,token:c,postId:l,content:o,parentId:m});h(g=>[...g,d]),ce()}catch(d){console.error("comments:add reply failed",d),alert("Failed to add reply.")}finally{j(null)}},de=t=>{x(y(t._id)),O(t.content||"")},X=()=>{x(null),O("")},me=async()=>{const t=W.trim();if(!(!t||!k)){J(k);try{const o=await Ne({school:n,token:c,commentId:k,content:t});re(k,{...o,_id:y(o._id),parentId:o.parentId?y(o.parentId):null}),X()}catch(o){console.error("comments:update failed",o),alert("Failed to update comment.")}finally{J(null)}}},ue=async t=>{if(!window.confirm("Delete this comment? Replies will also be removed in the list view."))return;const o=y(t);K(o);try{await ve({school:n,token:c,commentId:o}),le(o)}catch(m){console.error("comments:delete failed",m),alert("Failed to delete comment.")}finally{K(null)}},ge=async t=>{const o=y(t);H(o);try{const m=await ke({school:n,token:c,commentId:o});h(d=>d.map(g=>{var r;return y(g._id)===o?{...g,thumbs:m.thumbs??[],thumbsCount:m.count??(((r=m.thumbs)==null?void 0:r.length)||0)}:g}))}catch(m){console.error("comments:thumb toggle failed",m)}finally{H(null)}};return!s||!c?e.createElement("div",{className:"mt-6 rounded-xl border border-gray-200 bg-white p-4 text-sm text-gray-600"},"Please log in to view and write comments."):e.createElement("div",{className:"mt-8"},e.createElement("h3",{className:"mb-3 text-lg font-semibold text-gray-900"},"Comments"),e.createElement("div",{className:"mb-4 rounded-xl border border-gray-200 bg-white p-3 shadow-sm"},e.createElement("textarea",{value:I,onChange:t=>_(t.target.value),onCompositionStart:()=>D(!0),onCompositionEnd:()=>D(!1),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&!L&&(t.preventDefault(),V())},placeholder:"Write a comment…",className:"h-20 w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),e.createElement("div",{className:"mt-2 text-right"},e.createElement(pe,{disabled:v,onClick:V,className:"rounded-lg bg-gray-900 px-3 py-2 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},v?"Posting…":"Post"))),e.createElement("div",{className:"rounded-xl border border-gray-200 bg-white p-2 sm:p-3"},w?e.createElement("div",{className:"p-3 text-sm text-gray-600"},"Loading…"):N?e.createElement("div",{className:"rounded-lg bg-red-50 p-3 text-sm text-red-700"},N):Q.length===0?e.createElement("div",{className:"p-3 text-sm text-gray-600"},"No comments yet."):e.createElement("ul",{className:"space-y-3"},Q.map(t=>e.createElement(te,{key:t._id,node:t,me:b,getLabel:se,replyingId:T,replyText:U,postingReplyId:M,editingId:k,editText:W,savingId:ae,deletingId:ne,likingId:oe,onStartReply:o=>R(y(o)),onCancelReply:()=>{R(null),$("")},onChangeReply:$,onSubmitReply:ie,onStartEdit:de,onCancelEdit:X,onChangeEdit:O,onSaveEdit:me,onDelete:ue,onToggleLike:ge})))))}function te(l){var k;const{node:a,me:s,getLabel:c,replyingId:n,replyText:b,postingReplyId:f,editingId:i,editText:h,savingId:w,deletingId:C,likingId:N,onStartReply:S,onCancelReply:I,onChangeReply:_,onSubmitReply:v,onStartEdit:p,onCancelEdit:L,onChangeEdit:D,onSaveEdit:T,onDelete:R,onToggleLike:U}=l,$=a.thumbs??a.thumbsUpUsers??[],M=$.map(x=>String(x||"").toLowerCase()).includes(s),j=a.thumbsCount??$.length;return e.createElement("li",null,e.createElement("div",{className:"flex items-start gap-3"},e.createElement("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gray-200"}),e.createElement("div",{className:"min-w-0 flex-1"},e.createElement("div",{className:"flex items-center gap-2"},e.createElement("span",{className:"text-sm font-medium text-gray-900"},c(a.email)),e.createElement("span",{className:"text-xs text-gray-500"},"• ",P(a.createdAt).fromNow())),i===a._id?e.createElement("div",{className:"mt-2"},e.createElement("textarea",{value:h,onChange:x=>D(x.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),e.createElement("div",{className:"mt-2 flex gap-2"},e.createElement("button",{onClick:T,disabled:w===a._id,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},w===a._id?"Saving…":"Save"),e.createElement("button",{onClick:L,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))):e.createElement("p",{className:"mt-1 whitespace-pre-wrap break-words text-sm text-gray-800"},a.content),e.createElement("div",{className:"mt-2 flex items-center gap-3 text-xs text-gray-600"},e.createElement("button",{onClick:()=>U(a._id),disabled:N===a._id,className:`rounded px-2 py-1 ${M?"bg-blue-50 text-blue-600":"hover:bg-gray-100"} disabled:opacity-60`},"👍 ",j),e.createElement("button",{onClick:()=>S(a._id),className:"rounded px-2 py-1 hover:bg-gray-100"},"Reply"),String(a.email||"").toLowerCase()===s&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>p(a),className:"rounded px-2 py-1 hover:bg-gray-100"},"Edit"),e.createElement("button",{onClick:()=>R(a._id),disabled:C===a._id,className:"rounded px-2 py-1 text-red-600 hover:bg-red-50 disabled:opacity-60"},C===a._id?"Deleting…":"Delete"))),((k=a.children)==null?void 0:k.length)>0&&e.createElement("ul",{className:"mt-3 space-y-3 border-l-2 border-gray-200 pl-6"},a.children.map(x=>e.createElement(te,{key:x._id,node:x,me:s,getLabel:c,replyingId:n,replyText:b,postingReplyId:f,editingId:i,editText:h,savingId:w,deletingId:C,likingId:N,onStartReply:S,onCancelReply:I,onChangeReply:_,onSubmitReply:v,onStartEdit:p,onCancelEdit:L,onChangeEdit:D,onSaveEdit:T,onDelete:R,onToggleLike:U}))))),n===a._id&&e.createElement("div",{className:"ml-11 mt-2"},e.createElement("textarea",{value:b,onChange:x=>_(x.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10",placeholder:"Write a reply…"}),e.createElement("div",{className:"mt-2 flex gap-2"},e.createElement("button",{onClick:()=>v(a._id),disabled:f===a._id,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},f===a._id?"Posting…":"Reply"),e.createElement("button",{onClick:I,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))))}P.extend(ee);P.locale("en");function Re(){var v;const{id:l}=ye(),a=fe(),{user:s}=z(),{school:c,schoolTheme:n}=Z(),b=be(),{token:f}=z(),[i,h]=u.useState(null),[w,C]=u.useState(""),N=async()=>{try{const p=await xe({school:c,token:f,id:l});h(p)}catch(p){C(p.message||"Failed to load the post.")}};u.useEffect(()=>{N()},[l,c]);const S=u.useMemo(()=>(s==null?void 0:s.email)===(i==null?void 0:i.email),[s,i]),I=async()=>{if(window.confirm("Delete this post?"))try{await Ee(l,s.email,c),alert("Post deleted."),a(b("/freeboard"))}catch(p){alert("Delete failed: "+(p.message||"Unknown error"))}},_=async()=>{try{await we({school:c,token:f,id:i._id}),h(p=>p&&{...p,thumbsUpUsers:(p.thumbsUpUsers||[]).includes(((s==null?void 0:s.email)||"").toLowerCase())?p.thumbsUpUsers.filter(L=>L.toLowerCase()!==((s==null?void 0:s.email)||"").toLowerCase()):[...p.thumbsUpUsers||[],((s==null?void 0:s.email)||"").toLowerCase()]}),await N()}catch(p){alert("Failed to like: "+(p.message||"Unknown error"))}};return w?e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-red-700",style:{backgroundColor:(n==null?void 0:n.bg)||"#f6f3ff"}},w):i?e.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(n==null?void 0:n.bg)||"#f6f3ff"}},e.createElement("div",{className:"mx-auto max-w-3xl"},e.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},e.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},e.createElement("h1",{className:"text-2xl font-bold text-gray-900"},i.title),e.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",e.createElement("span",{className:"font-medium"},"anonymous")," • ",P(i.createdAt).fromNow())),e.createElement("div",{className:"p-5 sm:p-6"},e.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},e.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},i.content)),e.createElement("div",{className:"mt-6 flex flex-wrap items-center gap-3"},e.createElement("button",{onClick:_,className:"rounded-xl border border-gray-300 bg-white px-3 py-1.5 text-sm text-gray-800 shadow-sm hover:bg-gray-50","aria-label":"like post"},"👍 ",((v=i.thumbsUpUsers)==null?void 0:v.length)||0),S&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>a(b(`/freeboard/edit/${i._id}`)),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:(n==null?void 0:n.primary)||"#6b46c1"}},"Edit"),e.createElement("button",{onClick:I,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")),e.createElement(he,{to:b("/freeboard"),className:"ml-auto text-sm font-medium text-blue-600 underline underline-offset-2"},"← Back to List")))),(i==null?void 0:i._id)&&e.createElement("div",{className:"mt-6 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm sm:p-6"},e.createElement(Se,{postId:i._id,authorEmail:i.email})))):e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-gray-600",style:{backgroundColor:(n==null?void 0:n.bg)||"#f6f3ff"}},"Loading…")}export{Re as default};
