import{u as A,h as L,n as _,g as P,r as o,q as M,R as t,C as B}from"./index-a74e7749.js";function D(){const{user:n,token:c}=A()||{},{school:f}=L(),[y]=_(),{on:i,off:u}=P(),h=o.useMemo(()=>String(f||localStorage.getItem("selectedSchool")||"").toLowerCase(),[f]),[E,g]=o.useState([]),[s,p]=o.useState(null),d=((n==null?void 0:n.email)||"").toLowerCase(),b=e=>(String(e||"").split("@")[0]||"").trim(),x=e=>{const a=((e==null?void 0:e.buyer)||"").toLowerCase()===d,r=a?e==null?void 0:e.sellerNickname:e==null?void 0:e.buyerNickname,l=a?e==null?void 0:e.seller:e==null?void 0:e.buyer;return(r&&r!=="Unknown"?r:b(l))||"Unknown"},k=e=>(((e==null?void 0:e.buyer)||"").toLowerCase()===d?e==null?void 0:e.seller:e==null?void 0:e.buyer)||"",v=e=>((e==null?void 0:e.messages)||[]).filter(a=>(a.sender||"").toLowerCase()!==d&&!(a.readBy||[]).includes(d)).length,w=o.useCallback(async()=>{if(!(!c||!h))try{const e=await M({school:h,token:c});g(Array.isArray(e)?e:[]);const a=y.get("conversation");if(a){const r=(e||[]).find(l=>l._id===a);r&&p(r)}else!s&&(e||[]).length>0&&p(e[0])}catch{g([])}},[c,h,y,s]);return o.useEffect(()=>{w()},[w]),o.useEffect(()=>{const e=({conversationId:a,lastMessage:r,updatedAt:l})=>{g(C=>{const N=C.map(m=>m._id===a?{...m,lastMessage:r,updatedAt:l}:m);return N.sort((m,S)=>new Date(S.updatedAt)-new Date(m.updatedAt)),N})};return i==null||i("chat:preview",e),()=>u==null?void 0:u("chat:preview",e)},[i,u]),t.createElement("div",{className:"flex h-[calc(100vh-80px)]"},t.createElement("div",{className:"w-80 border-r p-4"},t.createElement("h2",{className:"mb-4 text-lg font-bold"},"💬 Messages"),t.createElement("div",{className:"space-y-2"},E.length===0&&t.createElement("p",{className:"text-sm text-gray-500"},"진행 중인 채팅이 없습니다."),E.map(e=>t.createElement("div",{key:e._id,onClick:()=>p(e),className:`relative cursor-pointer rounded-lg p-3 ${(s==null?void 0:s._id)===e._id?"bg-blue-100":"hover:bg-gray-100"}`},t.createElement("p",{className:"font-medium"},x(e)),t.createElement("p",{className:"truncate text-sm text-gray-500"},e.lastMessage||"(메시지 없음)"),v(e)>0&&t.createElement("span",{className:"absolute right-2 top-2 rounded-full bg-red-500 px-1.5 py-0.5 text-xs text-white"},v(e)))))),t.createElement("div",{className:"flex-1 p-4"},s?t.createElement(B,{conversationId:s._id,userEmail:n==null?void 0:n.email,otherEmail:k(s),otherNickname:x(s),fullSize:!0}):t.createElement("div",{className:"mt-20 text-center text-gray-400"},"🧭 왼쪽에서 채팅을 선택하세요.")))}export{D as default};
