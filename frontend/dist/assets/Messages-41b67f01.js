import{h as R,m as O,i as T,p as z,u as U,a as G,e as F,r as c,R as r,f as K,n as V}from"./index-183d3401.js";import{a as Z,d as L,r as q}from"./relativeTime-d2626eee.js";var H={exports:{}};(function(a,m){(function(o,i){a.exports=i()})(R,function(){var o={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"};return function(i,M,u){var n=M.prototype,x=n.format;u.en.formats=o,n.format=function(h){h===void 0&&(h="YYYY-MM-DDTHH:mm:ssZ");var _=this.$locale().formats,s=function(f,d){return f.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,function(E,b,y){var Y=y&&y.toUpperCase();return b||d[y]||o[y]||d[Y].replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,function(N,S,w){return S||w.slice(1)})})}(h,_===void 0?{}:_);return x.call(this,s)}}})})(H);var Q=H.exports;const W=O(Q);var X={exports:{}};(function(a,m){(function(o,i){a.exports=i(Z)})(R,function(o){function i(n){return n&&typeof n=="object"&&"default"in n?n:{default:n}}var M=i(o),u={name:"ko",weekdays:"일요일_월요일_화요일_수요일_목요일_금요일_토요일".split("_"),weekdaysShort:"일_월_화_수_목_금_토".split("_"),weekdaysMin:"일_월_화_수_목_금_토".split("_"),months:"1월_2월_3월_4월_5월_6월_7월_8월_9월_10월_11월_12월".split("_"),monthsShort:"1월_2월_3월_4월_5월_6월_7월_8월_9월_10월_11월_12월".split("_"),ordinal:function(n){return n+"일"},formats:{LT:"A h:mm",LTS:"A h:mm:ss",L:"YYYY.MM.DD.",LL:"YYYY년 MMMM D일",LLL:"YYYY년 MMMM D일 A h:mm",LLLL:"YYYY년 MMMM D일 dddd A h:mm",l:"YYYY.MM.DD.",ll:"YYYY년 MMMM D일",lll:"YYYY년 MMMM D일 A h:mm",llll:"YYYY년 MMMM D일 dddd A h:mm"},meridiem:function(n){return n<12?"오전":"오후"},relativeTime:{future:"%s 후",past:"%s 전",s:"몇 초",m:"1분",mm:"%d분",h:"한 시간",hh:"%d시간",d:"하루",dd:"%d일",M:"한 달",MM:"%d달",y:"일 년",yy:"%d년"}};return M.default.locale(u,null,!0),u})})(X);const P="https://api.cnapss.com/api".replace(/\/$/,"");function I({school:a,token:m}){return T(`${P}/${a}/chat/conversations`,{headers:{Authorization:`Bearer ${m}`}})}function ee({school:a,token:m,conversationId:o,cursor:i,limit:M=50}){const u=new URL(`${P}/${a}/chat/conversations/${o}/messages`);return i&&u.searchParams.set("cursor",i),u.searchParams.set("limit",String(M)),T(u.toString(),{headers:{Authorization:`Bearer ${m}`}})}function te({school:a,token:m,conversationId:o,content:i}){return z(`${P}/${a}/chat/conversations/${o}/messages`,{content:i},{headers:{Authorization:`Bearer ${m}`}})}function ae({school:a,token:m,conversationId:o}){return z(`${P}/${a}/chat/conversations/${o}/read`,{},{headers:{Authorization:`Bearer ${m}`}})}L.locale("ko");L.extend(q);L.extend(W);function re({conversationId:a,userEmail:m,onClose:o,fullSize:i=!1,otherNickname:M,otherEmail:u}){const{user:n,token:x}=U()||{},{school:h}=G()||{},{socket:_,emit:s,on:f,off:d}=F(),E=((n==null?void 0:n.email)||m||"").toLowerCase(),[b,y]=c.useState([]),[Y,N]=c.useState(""),[S,w]=c.useState(!1),[j,D]=c.useState(!1),C=c.useRef(null);c.useEffect(()=>{if(!a||!x||!h)return;let e=!0;return(async()=>{try{D(!0);const t=await ee({school:h,token:x,conversationId:a});if(!e)return;y((Array.isArray(t)?t:[]).reverse()),s==null||s("chat:read",{conversationId:a});try{await ae({school:h,token:x,conversationId:a})}catch{}}finally{e&&D(!1)}})(),()=>{e=!1}},[a,x,h,s]),c.useEffect(()=>{if(!a||!_)return;s==null||s("chat:join",{conversationId:a});const e=l=>{l.conversationId===a&&(y(p=>p.some(g=>g._id&&l._id&&String(g._id)===String(l._id))?p:[...p,l]),s==null||s("chat:read",{conversationId:a}))},t=({conversationId:l,reader:p})=>{l===a&&y(k=>k.map(g=>{var v;return(v=g.readBy)!=null&&v.includes(p)?g:{...g,readBy:[...g.readBy||[],p]}}))};return f==null||f("chat:receive",e),f==null||f("chat:read:updated",t),()=>{d==null||d("chat:receive",e),d==null||d("chat:read:updated",t)}},[_,s,f,d,a]);const A=async()=>{const e=Y.trim();if(!(!e||!a))try{const t=await te({school:h,token:x,conversationId:a,content:e});y(l=>[...l,t])}catch(t){console.error("send failed",t),alert("메시지 전송 실패")}finally{N("")}};c.useEffect(()=>{var e;(e=C.current)==null||e.scrollIntoView({behavior:"smooth",block:"nearest"})},[b]);const $=(e,t)=>{var l;return t===0||!L(e.createdAt).isSame((l=b[t-1])==null?void 0:l.createdAt,"day")},B=[...b].reverse().find(e=>(e.sender||"").toLowerCase()===E&&(e.readBy||[]).map(t=>t.toLowerCase()).includes((u||"").toLowerCase()));return r.createElement("div",{className:`relative border rounded-lg shadow bg-white flex flex-col ${i?"w-full h-full":"w-[360px]"}`},o&&r.createElement("button",{onClick:o,className:"absolute top-2 right-2 text-gray-400 hover:text-black text-xl"},"×"),r.createElement("div",{className:"flex items-center gap-2 border-b p-2 font-semibold"},r.createElement("span",null,"🗨️"),r.createElement("span",null,M||"Chat")),r.createElement("div",{className:"flex-1 overflow-y-auto p-3 space-y-2"},j&&r.createElement("div",{className:"text-sm text-gray-500"},"Loading..."),b.map((e,t)=>r.createElement("div",{key:e._id||t},$(e,t)&&r.createElement("div",{className:"text-center text-xs text-gray-400 my-2"},L(e.createdAt).format("YYYY년 M월 D일")),r.createElement("div",{className:`flex ${(e.sender||"").toLowerCase()===E?"justify-end":"justify-start"}`},r.createElement("div",{className:"max-w-xs"},r.createElement("div",{className:`px-3 py-1 rounded-lg break-words ${(e.sender||"").toLowerCase()===E?"bg-blue-600 text-white":"bg-gray-200 text-black"}`},e.content),r.createElement("div",{className:`text-[11px] mt-1 ${(e.sender||"").toLowerCase()===E?"text-right text-gray-400":"text-left text-gray-500"}`},L(e.createdAt).format("A h:mm"),e===B&&r.createElement("span",{className:"ml-1 text-blue-500 font-medium"},"Seen")))))),r.createElement("div",{ref:C})),r.createElement("div",{className:"flex gap-2 p-2 border-t"},r.createElement("input",{type:"text",className:"flex-1 border rounded p-2",value:Y,onChange:e=>N(e.target.value),onCompositionStart:()=>w(!0),onCompositionEnd:()=>w(!1),onKeyDown:e=>{e.key==="Enter"&&!S&&A()},placeholder:"메시지를 입력하세요..."}),r.createElement("button",{onClick:A,disabled:!Y.trim(),className:"bg-blue-600 text-white px-4 rounded hover:bg-blue-700 disabled:opacity-50"},"Send")))}function le(){var B;const{user:a,token:m}=U()||{},{school:o}=K(),[i,M]=V(),{on:u,off:n}=F(),x=c.useMemo(()=>String(o||localStorage.getItem("selectedSchool")||"").toLowerCase(),[o]),[h,_]=c.useState([]),[s,f]=c.useState(null),[d,E]=c.useState("all"),[b,y]=c.useState(()=>i.get("conversation")||null),Y=((a==null?void 0:a.email)||"").toLowerCase(),N=e=>(String(e||"").split("@")[0]||"").trim(),S=e=>{const t=((e==null?void 0:e.buyer)||"").toLowerCase()===Y,l=t?e==null?void 0:e.sellerNickname:e==null?void 0:e.buyerNickname,p=t?e==null?void 0:e.seller:e==null?void 0:e.buyer;return(l&&l!=="Unknown"?l:N(p))||"Unknown"},w=e=>{const t=((e==null?void 0:e.source)||"").toLowerCase();return t==="market"?"market":t==="coursehub"?"coursehub":e!=null&&e.itemId?"market":"dm"},j=e=>{const t=w(e);return t==="market"?"🛒 Market":t==="coursehub"?"🎓 CourseHub":"💬 DM"},D=e=>{var t;return((t=e==null?void 0:e.resourceTitle)==null?void 0:t.trim())||S(e)},C=e=>((e==null?void 0:e.messages)||[]).filter(t=>(t.sender||"").toLowerCase()!==Y&&!(t.readBy||[]).includes(Y)).length,A=c.useCallback(async()=>{if(!(!m||!x))try{const e=await I({school:x,token:m}),t=Array.isArray(e)?e:[];if(_(t),b){const l=t.find(k=>k._id===b);l?f(l):!s&&t.length>0&&f(t[0]);const p=new URLSearchParams(i);p.delete("conversation"),M(p,{replace:!0}),y(null)}else!s&&t.length>0&&f(t[0])}catch{_([])}},[m,x,b,s,i,M]);c.useEffect(()=>{A()},[A]),c.useEffect(()=>{const e=({conversationId:t,lastMessage:l,updatedAt:p})=>{_(k=>{const g=k.map(v=>v._id===t?{...v,lastMessage:l,updatedAt:p}:v);return g.sort((v,J)=>new Date(J.updatedAt)-new Date(v.updatedAt)),g})};return u==null||u("chat:preview",e),()=>n==null?void 0:n("chat:preview",e)},[u,n]);const $=c.useMemo(()=>d==="all"?h:h.filter(e=>w(e)===d),[h,d]);return r.createElement("div",{className:"flex h-[calc(100vh-80px)]"},r.createElement("div",{className:"w-80 border-r p-4"},r.createElement("div",{className:"mb-3 flex items-center justify-between"},r.createElement("h2",{className:"text-lg font-bold"},"💬 Messages")),r.createElement("div",{className:"mb-3 flex gap-2"},[{key:"all",label:"All"},{key:"market",label:"Market"},{key:"coursehub",label:"CourseHub"}].map(e=>r.createElement("button",{key:e.key,onClick:()=>E(e.key),className:"rounded-full border px-3 py-1 text-xs "+(d===e.key?"border-blue-600 bg-blue-50 text-blue-700":"border-gray-300 text-gray-700")},e.label))),r.createElement("div",{className:"space-y-2"},$.length===0&&r.createElement("p",{className:"text-sm text-gray-500"},"해당 필터에 대화가 없습니다."),$.map(e=>r.createElement("button",{key:e._id,onClick:()=>f(e),className:`relative w-full text-left rounded-lg p-3 transition ${(s==null?void 0:s._id)===e._id?"bg-blue-100":"hover:bg-gray-100"}`},r.createElement("div",{className:"flex items-center justify-between"},r.createElement("p",{className:"max-w-[10rem] truncate font-medium"},D(e)),r.createElement("span",{className:"ml-2 shrink-0 rounded-full bg-gray-200 px-2 py-0.5 text-xs text-gray-700"},j(e))),r.createElement("p",{className:"mt-0.5 truncate text-sm text-gray-500"},e.lastMessage||"(메시지 없음)"),C(e)>0&&r.createElement("span",{className:"absolute right-2 top-2 rounded-full bg-red-500 px-1.5 py-0.5 text-xs text-white"},C(e)))))),r.createElement("div",{className:"flex-1 p-4"},s?r.createElement(re,{conversationId:s._id,userEmail:a==null?void 0:a.email,otherEmail:((s==null?void 0:s.buyer)||"").toLowerCase()===((a==null?void 0:a.email)||"").toLowerCase()?s==null?void 0:s.seller:s==null?void 0:s.buyer,otherNickname:((B=s==null?void 0:s.resourceTitle)==null?void 0:B.trim())||"",fullSize:!0}):r.createElement("div",{className:"mt-20 text-center text-gray-400"},"🧭 왼쪽에서 채팅을 선택하세요.")))}export{le as default};
