import{h as T,x as J,i as z,p as P,u as F,a as O,e as U,r as u,R as a,f as G,y as K}from"./index-5a00037f.js";import{a as V,d as A,r as Z}from"./relativeTime-850f9b91.js";var H={exports:{}};(function(r,m){(function(o,c){r.exports=c()})(T,function(){var o={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"};return function(c,x,d){var l=x.prototype,g=l.format;d.en.formats=o,l.format=function(y){y===void 0&&(y="YYYY-MM-DDTHH:mm:ssZ");var f=this.$locale().formats,i=function(h,M){return h.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,function(Y,E,_){var w=_&&_.toUpperCase();return E||M[_]||o[_]||M[w].replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,function(C,L,N){return L||N.slice(1)})})}(y,f===void 0?{}:f);return g.call(this,i)}}})})(H);var q=H.exports;const Q=J(q);var W={exports:{}};(function(r,m){(function(o,c){r.exports=c(V)})(T,function(o){function c(l){return l&&typeof l=="object"&&"default"in l?l:{default:l}}var x=c(o),d={name:"ko",weekdays:"일요일_월요일_화요일_수요일_목요일_금요일_토요일".split("_"),weekdaysShort:"일_월_화_수_목_금_토".split("_"),weekdaysMin:"일_월_화_수_목_금_토".split("_"),months:"1월_2월_3월_4월_5월_6월_7월_8월_9월_10월_11월_12월".split("_"),monthsShort:"1월_2월_3월_4월_5월_6월_7월_8월_9월_10월_11월_12월".split("_"),ordinal:function(l){return l+"일"},formats:{LT:"A h:mm",LTS:"A h:mm:ss",L:"YYYY.MM.DD.",LL:"YYYY년 MMMM D일",LLL:"YYYY년 MMMM D일 A h:mm",LLLL:"YYYY년 MMMM D일 dddd A h:mm",l:"YYYY.MM.DD.",ll:"YYYY년 MMMM D일",lll:"YYYY년 MMMM D일 A h:mm",llll:"YYYY년 MMMM D일 dddd A h:mm"},meridiem:function(l){return l<12?"오전":"오후"},relativeTime:{future:"%s 후",past:"%s 전",s:"몇 초",m:"1분",mm:"%d분",h:"한 시간",hh:"%d시간",d:"하루",dd:"%d일",M:"한 달",MM:"%d달",y:"일 년",yy:"%d년"}};return x.default.locale(d,null,!0),d})})(W);const j="https://api.cnapss.com/api".replace(/\/$/,"");function X({school:r,token:m}){return z(`${j}/${r}/chat/conversations`,{headers:{Authorization:`Bearer ${m}`}})}function I({school:r,token:m,conversationId:o,cursor:c,limit:x=50}){const d=new URL(`${j}/${r}/chat/conversations/${o}/messages`);return c&&d.searchParams.set("cursor",c),d.searchParams.set("limit",String(x)),z(d.toString(),{headers:{Authorization:`Bearer ${m}`}})}function ee({school:r,token:m,conversationId:o,content:c}){return P(`${j}/${r}/chat/conversations/${o}/messages`,{content:c},{headers:{Authorization:`Bearer ${m}`}})}function te({school:r,token:m,conversationId:o}){return P(`${j}/${r}/chat/conversations/${o}/read`,{},{headers:{Authorization:`Bearer ${m}`}})}A.locale("ko");A.extend(Z);A.extend(Q);function ae({conversationId:r,userEmail:m,onClose:o,fullSize:c=!1,otherNickname:x,otherEmail:d}){const{user:l,token:g}=F()||{},{school:y}=O()||{},{socket:f,emit:i,on:h,off:M}=U(),Y=((l==null?void 0:l.email)||m||"").toLowerCase(),[E,_]=u.useState([]),[w,C]=u.useState(""),[L,N]=u.useState(!1),[$,S]=u.useState(!1),D=u.useRef(null);u.useEffect(()=>{if(!r||!g||!y)return;let t=!0;return(async()=>{try{S(!0);const n=await I({school:y,token:g,conversationId:r});if(!t)return;_((Array.isArray(n)?n:[]).reverse()),i==null||i("chat:read",{conversationId:r});try{await te({school:y,token:g,conversationId:r})}catch{}}finally{t&&S(!1)}})(),()=>{t=!1}},[r,g,y,i]),u.useEffect(()=>{if(!r||!f)return;i==null||i("chat:join",{conversationId:r});const t=p=>{p.conversationId===r&&(_(b=>b.some(k=>k._id&&p._id&&String(k._id)===String(p._id))?b:[...b,p]),i==null||i("chat:read",{conversationId:r}))},n=({conversationId:p,reader:b})=>{p===r&&_(B=>B.map(k=>{var R;return(R=k.readBy)!=null&&R.includes(b)?k:{...k,readBy:[...k.readBy||[],b]}}))};return h==null||h("chat:receive",t),h==null||h("chat:read:updated",n),()=>{M==null||M("chat:receive",t),M==null||M("chat:read:updated",n)}},[f,i,h,M,r]);const e=async()=>{const t=w.trim();if(!(!t||!r))try{const n=await ee({school:y,token:g,conversationId:r,content:t});_(p=>[...p,n])}catch(n){console.error("send failed",n),alert("메시지 전송 실패")}finally{C("")}};u.useEffect(()=>{var t;(t=D.current)==null||t.scrollIntoView({behavior:"smooth",block:"nearest"})},[E]);const s=(t,n)=>{var p;return n===0||!A(t.createdAt).isSame((p=E[n-1])==null?void 0:p.createdAt,"day")},v=[...E].reverse().find(t=>(t.sender||"").toLowerCase()===Y&&(t.readBy||[]).map(n=>n.toLowerCase()).includes((d||"").toLowerCase()));return a.createElement("div",{className:`relative border rounded-lg shadow bg-white flex flex-col ${c?"w-full h-full":"w-[360px]"}`},o&&a.createElement("button",{onClick:o,className:"absolute top-2 right-2 text-gray-400 hover:text-black text-xl"},"×"),a.createElement("div",{className:"flex items-center gap-2 border-b p-2 font-semibold"},a.createElement("span",null,"🗨️"),a.createElement("span",null,x||"Chat")),a.createElement("div",{className:"flex-1 overflow-y-auto p-3 space-y-2"},$&&a.createElement("div",{className:"text-sm text-gray-500"},"Loading..."),E.map((t,n)=>a.createElement("div",{key:t._id||n},s(t,n)&&a.createElement("div",{className:"text-center text-xs text-gray-400 my-2"},A(t.createdAt).format("YYYY년 M월 D일")),a.createElement("div",{className:`flex ${(t.sender||"").toLowerCase()===Y?"justify-end":"justify-start"}`},a.createElement("div",{className:"max-w-xs"},a.createElement("div",{className:`px-3 py-1 rounded-lg break-words ${(t.sender||"").toLowerCase()===Y?"bg-blue-600 text-white":"bg-gray-200 text-black"}`},t.content),a.createElement("div",{className:`text-[11px] mt-1 ${(t.sender||"").toLowerCase()===Y?"text-right text-gray-400":"text-left text-gray-500"}`},A(t.createdAt).format("A h:mm"),t===v&&a.createElement("span",{className:"ml-1 text-blue-500 font-medium"},"Seen")))))),a.createElement("div",{ref:D})),a.createElement("div",{className:"flex gap-2 p-2 border-t"},a.createElement("input",{type:"text",className:"flex-1 border rounded p-2",value:w,onChange:t=>C(t.target.value),onCompositionStart:()=>N(!0),onCompositionEnd:()=>N(!1),onKeyDown:t=>{t.key==="Enter"&&!L&&e()},placeholder:"메시지를 입력하세요..."}),a.createElement("button",{onClick:e,disabled:!w.trim(),className:"bg-blue-600 text-white px-4 rounded hover:bg-blue-700 disabled:opacity-50"},"Send")))}function ne(){const{user:r,token:m}=F()||{},{school:o}=G(),[c]=K(),{on:x,off:d}=U(),l=u.useMemo(()=>String(o||localStorage.getItem("selectedSchool")||"").toLowerCase(),[o]),[g,y]=u.useState([]),[f,i]=u.useState(null),[h,M]=u.useState("all"),Y=((r==null?void 0:r.email)||"").toLowerCase(),E=e=>(String(e||"").split("@")[0]||"").trim(),_=e=>{const s=((e==null?void 0:e.buyer)||"").toLowerCase()===Y,v=s?e==null?void 0:e.sellerNickname:e==null?void 0:e.buyerNickname,t=s?e==null?void 0:e.seller:e==null?void 0:e.buyer;return(v&&v!=="Unknown"?v:E(t))||"Unknown"},w=e=>{const s=((e==null?void 0:e.source)||"").toLowerCase();return s==="market"?"market":s==="coursehub"?"coursehub":e!=null&&e.itemId?"market":"dm"},C=e=>{const s=w(e);return s==="market"?"🛒 Market":s==="coursehub"?"🎓 CourseHub":"💬 DM"},L=e=>{var s;return((s=e==null?void 0:e.resourceTitle)==null?void 0:s.trim())||_(e)},N=e=>(((e==null?void 0:e.buyer)||"").toLowerCase()===Y?e==null?void 0:e.seller:e==null?void 0:e.buyer)||"",$=e=>((e==null?void 0:e.messages)||[]).filter(s=>(s.sender||"").toLowerCase()!==Y&&!(s.readBy||[]).includes(Y)).length,S=u.useCallback(async()=>{if(!(!m||!l))try{const e=await X({school:l,token:m}),s=Array.isArray(e)?e:[];y(s);const v=c.get("conversation");if(v){const t=s.find(n=>n._id===v);t&&i(t)}else!f&&s.length>0&&i(s[0])}catch{y([])}},[m,l,c,f]);u.useEffect(()=>{S()},[S]),u.useEffect(()=>{const e=({conversationId:s,lastMessage:v,updatedAt:t})=>{y(n=>{const p=n.map(b=>b._id===s?{...b,lastMessage:v,updatedAt:t}:b);return p.sort((b,B)=>new Date(B.updatedAt)-new Date(b.updatedAt)),p})};return x==null||x("chat:preview",e),()=>d==null?void 0:d("chat:preview",e)},[x,d]);const D=u.useMemo(()=>h==="all"?g:g.filter(e=>w(e)===h),[g,h]);return a.createElement("div",{className:"flex h-[calc(100vh-80px)]"},a.createElement("div",{className:"w-80 border-r p-4"},a.createElement("div",{className:"mb-3 flex items-center justify-between"},a.createElement("h2",{className:"text-lg font-bold"},"💬 Messages")),a.createElement("div",{className:"mb-3 flex gap-2"},[{key:"all",label:"All"},{key:"market",label:"Market"},{key:"coursehub",label:"CourseHub"}].map(e=>a.createElement("button",{key:e.key,onClick:()=>M(e.key),className:"rounded-full border px-3 py-1 text-xs "+(h===e.key?"border-blue-600 bg-blue-50 text-blue-700":"border-gray-300 text-gray-700")},e.label))),a.createElement("div",{className:"space-y-2"},D.length===0&&a.createElement("p",{className:"text-sm text-gray-500"},"해당 필터에 대화가 없습니다."),D.map(e=>a.createElement("button",{key:e._id,onClick:()=>i(e),className:`relative w-full text-left rounded-lg p-3 transition ${(f==null?void 0:f._id)===e._id?"bg-blue-100":"hover:bg-gray-100"}`},a.createElement("div",{className:"flex items-center justify-between"},a.createElement("p",{className:"max-w-[10rem] truncate font-medium"},L(e)),a.createElement("span",{className:"ml-2 shrink-0 rounded-full bg-gray-200 px-2 py-0.5 text-xs text-gray-700"},C(e))),a.createElement("p",{className:"mt-0.5 truncate text-sm text-gray-500"},e.lastMessage||"(메시지 없음)"),$(e)>0&&a.createElement("span",{className:"absolute right-2 top-2 rounded-full bg-red-500 px-1.5 py-0.5 text-xs text-white"},$(e)))))),a.createElement("div",{className:"flex-1 p-4"},f?a.createElement(ae,{conversationId:f._id,userEmail:r==null?void 0:r.email,otherEmail:N(f),otherNickname:L(f),fullSize:!0}):a.createElement("div",{className:"mt-20 text-center text-gray-400"},"🧭 왼쪽에서 채팅을 선택하세요.")))}export{ne as default};
