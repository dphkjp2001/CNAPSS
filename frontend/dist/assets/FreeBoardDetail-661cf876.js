import{u as z,b as Z,r as m,R as e,A as pe,d as U,e as ee,g as ye,a as fe,f as he,c as be,L as xe,h as Ee}from"./index-ab7583da.js";import"./en-338244bc.js";import{d as we,e as Ce,t as Ne}from"./posts-692f4253.js";const T="https://api.cnapss.com/api".replace(/\/$/,""),A=l=>({"Content-Type":"application/json",Authorization:`Bearer ${l}`});async function ve({school:l,token:n,postId:p}){const a=String(l||"").toLowerCase().trim(),s=await fetch(`${T}/${a}/comments/${p}`,{headers:A(n)});if(!s.ok)throw new Error("Failed to load comments");return s.json()}async function Y({school:l,token:n,postId:p,content:a,parentId:s=null}){const u=String(l||"").toLowerCase().trim(),h={content:String(a||"").trim()};s&&(h.parentId=String(s));const b=await fetch(`${T}/${u}/comments/${p}`,{method:"POST",headers:A(n),body:JSON.stringify(h)});if(!b.ok)throw new Error("Failed to add comment");return b.json()}async function ke({school:l,token:n,commentId:p,content:a}){const s=String(l||"").toLowerCase().trim(),u=await fetch(`${T}/${s}/comments/${p}`,{method:"PUT",headers:A(n),body:JSON.stringify({content:a})});if(!u.ok)throw new Error("Failed to update comment");return u.json()}async function Se({school:l,token:n,commentId:p}){const a=String(l||"").toLowerCase().trim(),s=await fetch(`${T}/${a}/comments/${p}`,{method:"DELETE",headers:A(n)});if(!s.ok)throw new Error("Failed to delete comment");return s.json()}async function Ie({school:l,token:n,commentId:p}){const a=String(l||"").toLowerCase().trim(),s=await fetch(`${T}/${a}/comments/${p}/thumbs`,{method:"POST",headers:A(n)});if(!s.ok)throw new Error("Failed to toggle comment like");return s.json()}U.extend(ee);U.locale("en");const f=l=>l==null?"":String(l),B=l=>String(l||"").toLowerCase().trim();function Le({postId:l,authorEmail:n=""}){const{user:p,token:a}=z(),{school:s}=Z(),u=B(p==null?void 0:p.email),h=B(n),[b,c]=m.useState([]),[N,C]=m.useState(!0),[L,v]=m.useState(""),[_,R]=m.useState(""),[$,k]=m.useState(!1),[y,E]=m.useState(!1),[P,S]=m.useState(null),[F,D]=m.useState(""),[M,j]=m.useState(null),[I,x]=m.useState(null),[W,O]=m.useState(""),[ae,J]=m.useState(null),[ne,K]=m.useState(null),[oe,H]=m.useState(null),q=m.useCallback(async()=>{if(!(!l||!s||!a)){C(!0),v("");try{const t=await ve({school:s,token:a,postId:l});c(Array.isArray(t)?t:[])}catch(t){console.error("comments:load failed",t),v("Failed to load comments."),c([])}finally{C(!1)}}},[l,s,a]);m.useEffect(()=>{q()},[q]);const G=m.useMemo(()=>{const t=new Map;for(const i of b){const g=B(i.email);if(!g)continue;const r=new Date(i.createdAt||0).getTime();t.has(g)?t.set(g,Math.min(t.get(g),r)):t.set(g,r)}const o=Array.from(t.keys()).filter(i=>i&&i!==h);o.sort((i,g)=>(t.get(i)||0)-(t.get(g)||0));const d=new Map;return h&&d.set(h,"anonymous (게시자)"),o.forEach((i,g)=>d.set(i,`anonymous ${g+1}`)),d},[b,h]),se=m.useCallback(t=>G.get(B(t))||"anonymous",[G]),Q=m.useMemo(()=>{const t=(b||[]).map(r=>({...r,_id:f(r._id),parentId:r.parentId?f(r.parentId):null,children:[]})),o=new Map;t.forEach(r=>o.set(r._id,r));const d=[];t.forEach(r=>{const w=r.parentId?f(r.parentId):"";w&&o.has(w)?o.get(w).children.push(r):d.push(r)});const i=(r,w)=>new Date(r.createdAt)-new Date(w.createdAt),g=r=>{r.sort(i),r.forEach(w=>g(w.children))};return g(d),d},[b]),re=(t,o)=>c(d=>d.map(i=>f(i._id)===f(t)?o:i)),le=t=>c(o=>{const d=f(t),i=new Set([d]);let g=!0;for(;g;)g=!1,o.forEach(r=>{const w=r.parentId?f(r.parentId):"";w&&i.has(w)&&!i.has(f(r._id))&&(i.add(f(r._id)),g=!0)});return o.filter(r=>!i.has(f(r._id)))}),V=async()=>{const t=_.trim();if(t){k(!0);try{const o=await Y({school:s,token:a,postId:l,content:t});c(d=>[...d,o]),R("")}catch(o){console.error("comments:add root failed",o),alert("Failed to add comment.")}finally{k(!1)}}},ce=()=>{S(null),D("")},ie=async t=>{const o=F.trim();if(!o)return;const d=f(t);j(d);try{const i=await Y({school:s,token:a,postId:l,content:o,parentId:d});c(g=>[...g,i]),ce()}catch(i){console.error("comments:add reply failed",i),alert("Failed to add reply.")}finally{j(null)}},de=t=>{x(f(t._id)),O(t.content||"")},X=()=>{x(null),O("")},me=async()=>{const t=W.trim();if(!(!t||!I)){J(I);try{const o=await ke({school:s,token:a,commentId:I,content:t});re(I,{...o,_id:f(o._id),parentId:o.parentId?f(o.parentId):null}),X()}catch(o){console.error("comments:update failed",o),alert("Failed to update comment.")}finally{J(null)}}},ue=async t=>{if(!window.confirm("Delete this comment? Replies will also be removed in the list view."))return;const o=f(t);K(o);try{await Se({school:s,token:a,commentId:o}),le(o)}catch(d){console.error("comments:delete failed",d),alert("Failed to delete comment.")}finally{K(null)}},ge=async t=>{const o=f(t);H(o);try{const d=await Ie({school:s,token:a,commentId:o});c(i=>i.map(g=>{var r;return f(g._id)===o?{...g,thumbs:d.thumbs??[],thumbsCount:d.count??(((r=d.thumbs)==null?void 0:r.length)||0)}:g}))}catch(d){console.error("comments:thumb toggle failed",d)}finally{H(null)}};return!p||!a?e.createElement("div",{className:"mt-6 rounded-xl border border-gray-200 bg-white p-4 text-sm text-gray-600"},"Please log in to view and write comments."):e.createElement("div",{className:"mt-8"},e.createElement("h3",{className:"mb-3 text-lg font-semibold text-gray-900"},"Comments"),e.createElement("div",{className:"mb-4 rounded-xl border border-gray-200 bg-white p-3 shadow-sm"},e.createElement("textarea",{value:_,onChange:t=>R(t.target.value),onCompositionStart:()=>E(!0),onCompositionEnd:()=>E(!1),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&!y&&(t.preventDefault(),V())},placeholder:"Write a comment…",className:"h-20 w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),e.createElement("div",{className:"mt-2 text-right"},e.createElement(pe,{disabled:$,onClick:V,className:"rounded-lg bg-gray-900 px-3 py-2 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},$?"Posting…":"Post"))),e.createElement("div",{className:"rounded-xl border border-gray-200 bg-white p-2 sm:p-3"},N?e.createElement("div",{className:"p-3 text-sm text-gray-600"},"Loading…"):L?e.createElement("div",{className:"rounded-lg bg-red-50 p-3 text-sm text-red-700"},L):Q.length===0?e.createElement("div",{className:"p-3 text-sm text-gray-600"},"No comments yet."):e.createElement("ul",{className:"space-y-3"},Q.map(t=>e.createElement(te,{key:t._id,node:t,me:u,getLabel:se,replyingId:P,replyText:F,postingReplyId:M,editingId:I,editText:W,savingId:ae,deletingId:ne,likingId:oe,onStartReply:o=>S(f(o)),onCancelReply:()=>{S(null),D("")},onChangeReply:D,onSubmitReply:ie,onStartEdit:de,onCancelEdit:X,onChangeEdit:O,onSaveEdit:me,onDelete:ue,onToggleLike:ge})))))}function te(l){var I;const{node:n,me:p,getLabel:a,replyingId:s,replyText:u,postingReplyId:h,editingId:b,editText:c,savingId:N,deletingId:C,likingId:L,onStartReply:v,onCancelReply:_,onChangeReply:R,onSubmitReply:$,onStartEdit:k,onCancelEdit:y,onChangeEdit:E,onSaveEdit:P,onDelete:S,onToggleLike:F}=l,D=n.thumbs??n.thumbsUpUsers??[],M=D.map(x=>String(x||"").toLowerCase()).includes(p),j=n.thumbsCount??D.length;return e.createElement("li",null,e.createElement("div",{className:"flex items-start gap-3"},e.createElement("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gray-200"}),e.createElement("div",{className:"min-w-0 flex-1"},e.createElement("div",{className:"flex items-center gap-2"},e.createElement("span",{className:"text-sm font-medium text-gray-900"},a(n.email)),e.createElement("span",{className:"text-xs text-gray-500"},"• ",U(n.createdAt).fromNow())),b===n._id?e.createElement("div",{className:"mt-2"},e.createElement("textarea",{value:c,onChange:x=>E(x.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),e.createElement("div",{className:"mt-2 flex gap-2"},e.createElement("button",{onClick:P,disabled:N===n._id,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},N===n._id?"Saving…":"Save"),e.createElement("button",{onClick:y,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))):e.createElement("p",{className:"mt-1 whitespace-pre-wrap break-words text-sm text-gray-800"},n.content),e.createElement("div",{className:"mt-2 flex items-center gap-3 text-xs text-gray-600"},e.createElement("button",{onClick:()=>F(n._id),disabled:L===n._id,className:`rounded px-2 py-1 ${M?"bg-blue-50 text-blue-600":"hover:bg-gray-100"} disabled:opacity-60`},"👍 ",j),e.createElement("button",{onClick:()=>v(n._id),className:"rounded px-2 py-1 hover:bg-gray-100"},"Reply"),String(n.email||"").toLowerCase()===p&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>k(n),className:"rounded px-2 py-1 hover:bg-gray-100"},"Edit"),e.createElement("button",{onClick:()=>S(n._id),disabled:C===n._id,className:"rounded px-2 py-1 text-red-600 hover:bg-red-50 disabled:opacity-60"},C===n._id?"Deleting…":"Delete"))),((I=n.children)==null?void 0:I.length)>0&&e.createElement("ul",{className:"mt-3 space-y-3 border-l-2 border-gray-200 pl-6"},n.children.map(x=>e.createElement(te,{key:x._id,node:x,me:p,getLabel:a,replyingId:s,replyText:u,postingReplyId:h,editingId:b,editText:c,savingId:N,deletingId:C,likingId:L,onStartReply:v,onCancelReply:_,onChangeReply:R,onSubmitReply:$,onStartEdit:k,onCancelEdit:y,onChangeEdit:E,onSaveEdit:P,onDelete:S,onToggleLike:F}))))),s===n._id&&e.createElement("div",{className:"ml-11 mt-2"},e.createElement("textarea",{value:u,onChange:x=>R(x.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10",placeholder:"Write a reply…"}),e.createElement("div",{className:"mt-2 flex gap-2"},e.createElement("button",{onClick:()=>$(n._id),disabled:h===n._id,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},h===n._id?"Posting…":"Reply"),e.createElement("button",{onClick:_,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))))}U.extend(ee);U.locale("en");function Pe(){var k;const{id:l}=ye(),n=fe(),p=he(),{user:a}=z(),{school:s,schoolTheme:u}=Z(),h=be(),{token:b}=z(),[c,N]=m.useState(null),[C,L]=m.useState(""),v=async()=>{try{const y=await we({school:s,token:b,id:l});N(y)}catch(y){L(y.message||"Failed to load the post.")}};m.useEffect(()=>{v()},[l,s]),m.useEffect(()=>{const E=new URLSearchParams(p.search).get("nid");async function P(){if(!(!E||!(a!=null&&a.email)||!s))try{const S="https://api.cnapss.com/api".replace(/\/+$/,"");await Ee(`${S}/${s}/notification/mark-read`,{method:"POST",headers:{"Content-Type":"application/json"},body:{commentId:E,email:a.email}})}catch{}}P()},[p.search,a==null?void 0:a.email,s]);const _=m.useMemo(()=>(a==null?void 0:a.email)===(c==null?void 0:c.email),[a,c]),R=async()=>{if(window.confirm("Delete this post?"))try{await Ce(l,a.email,s),alert("Post deleted."),n(h("/freeboard"))}catch(y){alert("Delete failed: "+(y.message||"Unknown error"))}},$=async()=>{try{await Ne({school:s,token:b,id:c._id}),N(y=>y&&{...y,thumbsUpUsers:(y.thumbsUpUsers||[]).includes(((a==null?void 0:a.email)||"").toLowerCase())?y.thumbsUpUsers.filter(E=>E.toLowerCase()!==((a==null?void 0:a.email)||"").toLowerCase()):[...y.thumbsUpUsers||[],((a==null?void 0:a.email)||"").toLowerCase()]}),await v()}catch(y){alert("Failed to like: "+(y.message||"Unknown error"))}};return C?e.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-red-700",style:{backgroundColor:(u==null?void 0:u.bg)||"#f6f3ff"}},C):c?e.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(u==null?void 0:u.bg)||"#f6f3ff"}},e.createElement("div",{className:"mx-auto max-w-3xl"},e.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},e.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},e.createElement("h1",{className:"text-2xl font-bold text-gray-900"},c.title),e.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",e.createElement("span",{className:"font-medium"},"anonymous")," • ",U(c.createdAt).fromNow())),e.createElement("div",{className:"p-5 sm:p-6"},e.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},e.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},c.content)),e.createElement("div",{className:"mt-6 flex flex-wrap items-center gap-3"},e.createElement("button",{onClick:$,className:"rounded-xl border border-gray-300 bg-white px-3 py-1.5 text-sm text-gray-800 shadow-sm hover:bg-gray-50","aria-label":"like post"},"👍 ",((k=c.thumbsUpUsers)==null?void 0:k.length)||0),_&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>n(h(`/freeboard/edit/${c._id}`)),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:(u==null?void 0:u.primary)||"#6b46c1"}},"Edit"),e.createElement("button",{onClick:R,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")),e.createElement(xe,{to:h("/freeboard"),className:"ml-auto text-sm font-medium text-blue-600 underline underline-offset-2"},"← Back to List")))),(c==null?void 0:c._id)&&e.createElement("div",{className:"mt-6 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm sm:p-6"},e.createElement(Le,{postId:c._id,authorEmail:c.email})))):e.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-gray-600",style:{backgroundColor:(u==null?void 0:u.bg)||"#f6f3ff"}},"Loading…")}export{Pe as default};
