import{f as M,u as V,a as $,c as z,b as H,d as O,r as n,R as t,h as T,L as W,i as q,j as G,k as J,l as K}from"./index-c3dd0bff.js";import{C as Q}from"./CommentSection-68bf5cf4.js";import{d as y,r as X}from"./relativeTime-e912e304.js";import"./useLoginGate-af1fe665.js";y.extend(X);y.locale("en");function oe(){const{id:d}=M(),_=V(),i=$(),{user:o,token:b}=z(),{school:l,schoolTheme:c}=H(),p=O(),[a,h]=n.useState(null),[w,E]=n.useState(""),[m,x]=n.useState(!1),[v,u]=n.useState(""),[C,f]=n.useState(""),[N,S]=n.useState(!1),k=!!(o!=null&&o.email||b&&String(b).length>0),[Y,P]=n.useState(0),[Z,I]=n.useState(0),[ee,j]=n.useState(null),F=async()=>{E("");try{const e=await q({school:l,id:d});h(e),u((e==null?void 0:e.title)||""),f((e==null?void 0:e.content)||""),P((e==null?void 0:e.upCount)||0),I((e==null?void 0:e.downCount)||0)}catch(e){if((e==null?void 0:e.status)!==404){E((e==null?void 0:e.message)||"Failed to load the post.");return}}if(k)try{const e=await G({school:l,id:d});h(e),u((e==null?void 0:e.title)||""),f((e==null?void 0:e.content)||""),P((e==null?void 0:e.upCount)||0),I((e==null?void 0:e.downCount)||0),j((e==null?void 0:e.myVote)??null)}catch{}};n.useEffect(()=>{!l||!d||F()},[d,l,k]),n.useEffect(()=>{const r=new URLSearchParams(i.search).get("nid");async function s(){if(!(!r||!(o!=null&&o.email)||!l))try{const g="https://api.cnapss.com/api".replace(/\/+$/,"");await J(`${g}/${l}/notification/mark-read`,{method:"POST",headers:{"Content-Type":"application/json"},body:{commentId:r,email:o.email}})}catch{}}s()},[i.search,o==null?void 0:o.email,l]);const R=n.useMemo(()=>{const e=i.hash||"",r=e.startsWith("#comment-")?e.slice(9):null,s=new URLSearchParams(i.search).get("nid");return r||s||null},[i.hash,i.search]),L=n.useMemo(()=>{var D,U;const e=a,r=o;if(!e||!r)return!1;const s=[r.id,r._id].filter(Boolean).map(String);return[e.userId,e.authorId,(D=e.author)==null?void 0:D._id,(U=e.author)==null?void 0:U.id].filter(Boolean).map(String).some(B=>s.includes(B))},[o,a]),A=async()=>{if(window.confirm("Delete this post?"))try{await K({school:l,id:a._id}),alert("Post deleted."),_(p("/dashboard?tab=free"))}catch(e){alert("Delete failed: "+((e==null?void 0:e.message)||"Unknown error"))}};return w?t.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-red-700",style:{backgroundColor:(c==null?void 0:c.bg)||"#f6f3ff"}},w):a?t.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(c==null?void 0:c.bg)||"#f6f3ff"}},t.createElement("div",{className:"mx-auto max-w-3xl"},t.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},t.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},t.createElement("div",{className:"flex items-start gap-4"},t.createElement("div",{className:"flex-1"},m?t.createElement("input",{value:v,onChange:e=>u(e.target.value),placeholder:"Title",className:"w-full rounded-xl border border-gray-300 px-3 py-2 text-lg font-semibold text-gray-900 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):t.createElement("h1",{className:"text-2xl font-bold text-gray-900"},a.title),t.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",t.createElement("span",{className:"font-medium"},"anonymous")," • ",y(a.createdAt).fromNow())))),t.createElement("div",{className:"p-5 sm:p-6"},m?t.createElement("textarea",{value:C,onChange:e=>f(e.target.value),placeholder:"Content",className:"h-56 w-full resize-y rounded-xl border border-gray-300 px-3 py-2 text-sm text-gray-800 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):t.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},t.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},a.content)),t.createElement("div",{className:"mt-6 flex flex-wrap items-center gap-3"},L&&!m&&t.createElement(t.Fragment,null,t.createElement("button",{onClick:()=>x(!0),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:"#6b46c1"}},"Edit"),t.createElement("button",{onClick:A,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")),L&&m&&t.createElement(t.Fragment,null,t.createElement("button",{onClick:async()=>{const e=v.trim(),r=C.trim();if(!(!e||!r)){S(!0);try{const s=await T({school:l,id:a._id,title:e,content:r}),g=(s==null?void 0:s.post)||s;h(g),x(!1)}catch(s){alert("Update failed: "+((s==null?void 0:s.message)||"Unknown error"))}finally{S(!1)}}},disabled:N,className:"rounded-xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-black disabled:opacity-60"},N?"Saving…":"Save"),t.createElement("button",{onClick:()=>{u((a==null?void 0:a.title)||""),f((a==null?void 0:a.content)||""),x(!1)},className:"rounded-xl border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-800 shadow-sm hover:bg-gray-50"},"Cancel")),t.createElement(W,{to:p("/dashboard?tab=free"),className:"ml-auto text-sm font-medium text-blue-600 underline underline-offset-2"},"← Back to List"))),(a==null?void 0:a._id)&&t.createElement("div",{className:"mt-0 rounded-2xl border-t border-gray-200 bg-white p-5 shadow-sm sm:p-6"},t.createElement(Q,{postId:a._id,authorEmail:a.email,highlightId:R,anonymousMode:!0}))))):t.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-gray-600",style:{backgroundColor:(c==null?void 0:c.bg)||"#f6f3ff"}},"Loading…")}export{oe as default};
