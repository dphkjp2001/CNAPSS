import{f as H,u as O,a as T,c as W,b as q,d as G,r,R as a,L as J}from"./index-64af46bb.js";import{C as K}from"./CommentSection-de8afedd.js";import{d as S,r as Q}from"./relativeTime-e9150860.js";import{a as X,b as Z,d as ee,v as te,u as ae}from"./posts-9169f141.js";import{a as ne}from"./http-3230a7f7.js";import"./useLoginGate-f1c0bd29.js";S.extend(Q);S.locale("en");function de(){const{id:p}=H(),$=O(),u=T(),{user:o,token:k}=W(),{school:l,schoolTheme:i}=q(),P=G(),[n,C]=r.useState(null),[L,U]=r.useState(""),[x,N]=r.useState(!1),[D,b]=r.useState(""),[V,h]=r.useState(""),[F,M]=r.useState(!1),R=!!(o!=null&&o.email||k&&String(k).length>0),[w,g]=r.useState(0),[v,y]=r.useState(0),[d,E]=r.useState(null),j=w-v,A=async()=>{U("");try{const e=await X({school:l,id:p});C(e),b((e==null?void 0:e.title)||""),h((e==null?void 0:e.content)||""),g((e==null?void 0:e.upCount)||0),y((e==null?void 0:e.downCount)||0)}catch(e){if((e==null?void 0:e.status)!==404){U((e==null?void 0:e.message)||"Failed to load the post.");return}}if(R)try{const e=await Z({school:l,id:p});C(e),b((e==null?void 0:e.title)||""),h((e==null?void 0:e.content)||""),g((e==null?void 0:e.upCount)||0),y((e==null?void 0:e.downCount)||0),E((e==null?void 0:e.myVote)||null)}catch{}};r.useEffect(()=>{!l||!p||A()},[p,l,R]),r.useEffect(()=>{const s=new URLSearchParams(u.search).get("nid");async function t(){if(!(!s||!(o!=null&&o.email)||!l))try{const c="https://api.cnapss.com/api".replace(/\/+$/,"");await ne(`${c}/${l}/notification/mark-read`,{method:"POST",headers:{"Content-Type":"application/json"},body:{commentId:s,email:o.email}})}catch{}}t()},[u.search,o==null?void 0:o.email,l]);const I=r.useMemo(()=>{const e=u.hash||"",s=e.startsWith("#comment-")?e.slice(9):null,t=new URLSearchParams(u.search).get("nid");return s||t||null},[u.hash,u.search]),f=r.useMemo(()=>((o==null?void 0:o.email)||"").toLowerCase()===((n==null?void 0:n.email)||"").toLowerCase(),[o,n]),B=async()=>{if(window.confirm("Delete this post?"))try{await ee({school:l,id:n._id}),alert("Post deleted."),$(P("/dashboard?tab=free"))}catch(e){alert("Delete failed: "+((e==null?void 0:e.message)||"Unknown error"))}},Y=e=>{const s={upCount:w,downCount:v,myVote:d};let t=w,c=v,m=d;return e==="up"?d==="up"?(t-=1,m=null):d==="down"?(c-=1,t+=1,m="up"):(t+=1,m="up"):d==="down"?(c-=1,m=null):d==="up"?(t-=1,c+=1,m="down"):(c+=1,m="down"),g(t),y(c),E(m),s},_=async e=>{if(!o){alert("Please log in to vote.");return}const s=Y(e);try{const t=await te({school:l,id:n._id,dir:e});typeof(t==null?void 0:t.upCount)=="number"&&g(t.upCount),typeof(t==null?void 0:t.downCount)=="number"&&y(t.downCount),typeof(t==null?void 0:t.myVote)<"u"&&E(t.myVote)}catch(t){g(s.upCount),y(s.downCount),E(s.myVote),alert("Vote failed: "+((t==null?void 0:t.message)||"Unknown error"))}},z=async()=>{const e=D.trim(),s=V.trim();if(!(!e||!s)){M(!0);try{const t=await ae({school:l,id:n._id,title:e,content:s}),c=(t==null?void 0:t.post)||t;C(c),N(!1)}catch(t){alert("Update failed: "+((t==null?void 0:t.message)||"Unknown error"))}finally{M(!1)}}};return L?a.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-red-700",style:{backgroundColor:(i==null?void 0:i.bg)||"#f6f3ff"}},L):n?a.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(i==null?void 0:i.bg)||"#f6f3ff"}},a.createElement("div",{className:"mx-auto max-w-3xl"},a.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},a.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},x?a.createElement("input",{value:D,onChange:e=>b(e.target.value),placeholder:"Title",className:"w-full rounded-xl border border-gray-300 px-3 py-2 text-lg font-semibold text-gray-900 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):a.createElement("h1",{className:"text-2xl font-bold text-gray-900"},n.title),a.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",a.createElement("span",{className:"font-medium"},"anonymous")," ‚Ä¢"," ",S(n.createdAt).fromNow())),a.createElement("div",{className:"p-5 sm:p-6"},x?a.createElement("textarea",{value:V,onChange:e=>h(e.target.value),placeholder:"Content",className:"h-56 w-full resize-y rounded-xl border border-gray-300 px-3 py-2 text-sm text-gray-800 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):a.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},a.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},n.content)),a.createElement("div",{className:"mt-6 flex flex-wrap items-center gap-3"},a.createElement("div",{className:"flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-2 py-1"},a.createElement("button",{onClick:()=>_("up"),disabled:!o||f,className:`rounded-md px-3 py-1 text-sm font-semibold ${d==="up"?"bg-green-600 text-white":"bg-gray-100 text-gray-800 hover:bg-gray-200"} disabled:opacity-60`,title:o?f?"You can‚Äôt vote on your own post.":"Upvote":"Log in to vote","aria-label":"Upvote"},"üëç ",w),a.createElement("button",{onClick:()=>_("down"),disabled:!o||f,className:`rounded-md px-3 py-1 text-sm font-semibold ${d==="down"?"bg-red-600 text-white":"bg-gray-100 text-gray-800 hover:bg-gray-200"} disabled:opacity-60`,title:o?f?"You can‚Äôt vote on your own post.":"Downvote":"Log in to vote","aria-label":"Downvote"},"üëé ",v),a.createElement("span",{className:"ml-2 text-sm font-medium text-gray-700"},"Score: ",j)),f&&!x&&a.createElement(a.Fragment,null,a.createElement("button",{onClick:()=>N(!0),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:"#6b46c1"}},"Edit"),a.createElement("button",{onClick:B,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")),f&&x&&a.createElement(a.Fragment,null,a.createElement("button",{onClick:z,disabled:F,className:"rounded-xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-black disabled:opacity-60"},F?"Saving‚Ä¶":"Save"),a.createElement("button",{onClick:()=>{b((n==null?void 0:n.title)||""),h((n==null?void 0:n.content)||""),N(!1)},className:"rounded-xl border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-800 shadow-sm hover:bg-gray-50"},"Cancel")),a.createElement(J,{to:P("/dashboard?tab=free"),className:"ml-auto text-sm font-medium text-blue-600 underline underline-offset-2"},"‚Üê Back to List")))),(n==null?void 0:n._id)&&a.createElement("div",{className:"mt-6 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm sm:p-6"},a.createElement(K,{postId:n._id,authorEmail:n.email,highlightId:I,anonymousMode:!0})))):a.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-gray-600",style:{backgroundColor:(i==null?void 0:i.bg)||"#f6f3ff"}},"Loading‚Ä¶")}export{de as default};
