import{i as W,p as H,f as K,u as Q,a as V,c as X,l as Z,b as ee,d as te,r as n,R as e,g as k,h as ae}from"./index-ee6df2cf.js";import{C as se}from"./CommentSection-70bf13f4.js";import{r as re}from"./relativeTime-8c3fb35c.js";import{a as ne,b as oe,d as le,t as ce,u as ie}from"./careerPosts-938a6253.js";const A="https://api.cnapss.com/api".replace(/\/$/,"");function de({school:m,targetId:i,initialMessage:u}){return H(`${A}/${m}/request`,{targetId:i,initialMessage:u})}function me({school:m,targetId:i}){const u=new URL(`${A}/${m}/request/exists`);return u.searchParams.set("targetId",i),W(u.toString())}k.extend(re);k.locale("en");function be(){var j;const{id:m}=K(),i=Q(),u=V(),{user:r,token:x}=X(),{ensureAuth:g}=Z(),{school:o,schoolTheme:c}=ee(),b=te(),[a,h]=n.useState(null),[S,F]=n.useState(""),[y,E]=n.useState(!1),[q,v]=n.useState(""),[I,w]=n.useState(""),[P,U]=n.useState(!1),[D,C]=n.useState(!1),[L,M]=n.useState(""),[R,$]=n.useState(!1),[d,T]=n.useState({exists:!1,conversationId:null}),_=async()=>{try{const t=x?await ne({school:o,id:m}):await oe({school:o,id:m});h(t),v((t==null?void 0:t.title)||""),w((t==null?void 0:t.content)||"")}catch(t){F(t.message||"Failed to load the post.")}};n.useEffect(()=>{_()},[m,o,x]),n.useEffect(()=>{const s=new URLSearchParams(u.search).get("nid");async function l(){if(!(!s||!(r!=null&&r.email)||!o))try{const N="https://api.cnapss.com/api".replace(/\/+$/,"");await ae(`${N}/${o}/notification/mark-read`,{method:"POST",headers:{"Content-Type":"application/json"},body:{commentId:s,email:r.email}})}catch{}}l()},[u.search,r==null?void 0:r.email,o]);const f=n.useMemo(()=>((r==null?void 0:r.email)||"").toLowerCase()===((a==null?void 0:a.email)||"").toLowerCase(),[r,a]),p=n.useMemo(()=>String((a==null?void 0:a.postType)||(a==null?void 0:a.type)||"").toLowerCase()==="looking_for",[a]);n.useEffect(()=>{let t=!0;return(async()=>{if(!(!x||!o||!(a!=null&&a._id)||!p))try{const s=await me({school:o,targetId:a._id});if(!t)return;T({exists:!!(s!=null&&s.exists),conversationId:(s==null?void 0:s.conversationId)||null})}catch{}})(),()=>{t=!1}},[x,o,a==null?void 0:a._id,p]);const z=async()=>{g(async()=>{if(window.confirm("Delete this post?"))try{await le({school:o,id:a._id}),alert("Post deleted."),i(b("/dashboard?tab=academic"))}catch(t){alert("Delete failed: "+(t.message||"Unknown error"))}})},O=async()=>{g(async()=>{try{await ce({school:o,id:a._id}),h(t=>t&&{...t,thumbsUpUsers:(t.thumbsUpUsers||[]).includes(((r==null?void 0:r.email)||"").toLowerCase())?t.thumbsUpUsers.filter(s=>s.toLowerCase()!==((r==null?void 0:r.email)||"").toLowerCase()):[...t.thumbsUpUsers||[],((r==null?void 0:r.email)||"").toLowerCase()]}),await _()}catch(t){alert("Failed to like: "+(t.message||"Unknown error"))}})},B=async()=>{g(async()=>{const t=q.trim(),s=I.trim();if(!(!t||!s)){U(!0);try{const l=await ie({school:o,id:a._id,title:t,content:s}),N=(l==null?void 0:l.post)||l;h(N),E(!1)}catch(l){alert("Update failed: "+(l.message||"Unknown error"))}finally{U(!1)}}})},J=()=>{v((a==null?void 0:a.title)||""),w((a==null?void 0:a.content)||""),E(!1)},Y=()=>g(()=>{d.exists&&d.conversationId?i(b(`/messages?conversation=${d.conversationId}`)):C(!0)}),G=()=>g(async()=>{if(!p)return;const t=(L||"").trim();if(!t){alert("Write a short hello message.");return}$(!0);try{const s=await de({school:o,targetId:a._id,initialMessage:t}),l=s==null?void 0:s.conversationId;l?(C(!1),i(b(`/messages?conversation=${l}`))):alert("Sent, but failed to find the conversation ID.")}catch(s){alert((s==null?void 0:s.message)||"Failed to send request.")}finally{$(!1)}});return S?e.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-red-700",style:{backgroundColor:(c==null?void 0:c.bg)||"#f6f3ff"}},S):a?e.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(c==null?void 0:c.bg)||"#f6f3ff"}},e.createElement("div",{className:"mx-auto max-w-3xl"},e.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},e.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},y?e.createElement("input",{value:q,onChange:t=>v(t.target.value),placeholder:"Title",className:"w-full rounded-xl border border-gray-300 px-3 py-2 text-lg font-semibold text-gray-900 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):e.createElement("h1",{className:"text-2xl font-bold text-gray-900"},a.title),e.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",e.createElement("span",{className:"font-medium"},"anonymous")," • ",k(a.createdAt).fromNow())),e.createElement("div",{className:"p-5 sm:p-6"},y?e.createElement("textarea",{value:I,onChange:t=>w(t.target.value),placeholder:"Content",className:"h-56 w-full resize-y rounded-xl border border-gray-300 px-3 py-2 text-sm text-gray-800 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):e.createElement("div",{className:"prose max-w-none whitespace-pre-wrap text-sm text-gray-900"},a.content)),e.createElement("div",{className:"flex items-center justify-between border-t border-gray-100 px-5 py-3 sm:px-6"},e.createElement("div",{className:"flex items-center gap-2"},e.createElement("button",{onClick:O,disabled:f,className:"rounded-lg border px-3 py-1 text-sm hover:bg-gray-50 disabled:opacity-60",title:f?"You can’t like your own post.":"Like post"},"👍 Like"),e.createElement("span",{className:"text-xs text-gray-500"},((j=a.thumbsUpUsers)==null?void 0:j.length)||0," likes")),e.createElement("div",{className:"flex items-center gap-2"},f&&!y&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>E(!0),className:"rounded-lg border px-3 py-1 text-sm hover:bg-gray-50"},"✏️ Edit"),e.createElement("button",{onClick:z,className:"rounded-lg border px-3 py-1 text-sm text-red-600 hover:bg-red-50"},"🗑️ Delete")),f&&y&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:B,disabled:P,className:"rounded-lg border px-3 py-1 text-sm text-white",style:{backgroundColor:"#111827"}},P?"Saving...":"Save"),e.createElement("button",{onClick:J,className:"rounded-lg border px-3 py-1 text-sm"},"Cancel")),!f&&p&&e.createElement("button",{onClick:Y,className:"rounded-lg border px-3 py-1 text-sm",title:d.exists?"You already requested":"Send request (first message)",disabled:d.exists&&!!d.conversationId},d.exists&&d.conversationId?"Requested":"Send request"))),e.createElement("div",{className:"border-t border-gray-100 p-5 sm:p-6"},e.createElement(se,{postId:a._id,authorEmail:a.email}))),e.createElement("div",{className:"mt-6"},e.createElement("button",{onClick:()=>i(b("/dashboard?tab=academic")),className:"text-sm text-gray-600 hover:underline"},"← Back to list"))),D&&e.createElement("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4"},e.createElement("div",{className:"w-full max-w-md rounded-2xl bg-white p-5 shadow-xl"},e.createElement("h3",{className:"mb-2 text-lg font-semibold"},"Send request"),e.createElement("p",{className:"mb-3 text-sm text-gray-600"},"This sends your first message to the author. A conversation will be created."),e.createElement("textarea",{value:L,onChange:t=>M(t.target.value),placeholder:"Say hello and what you’re looking for…",className:"h-28 w-full resize-none rounded-xl border px-3 py-2 text-sm"}),e.createElement("div",{className:"mt-3 flex justify-end gap-2"},e.createElement("button",{onClick:()=>C(!1),className:"rounded-lg border px-3 py-1 text-sm"},"Cancel"),e.createElement("button",{onClick:G,disabled:R,className:"rounded-lg bg-gray-900 px-3 py-1 text-sm font-semibold text-white disabled:opacity-60"},R?"Sending…":"Send"))))):e.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-gray-600",style:{backgroundColor:(c==null?void 0:c.bg)||"#f6f3ff"}},"Loading…")}export{be as default};
