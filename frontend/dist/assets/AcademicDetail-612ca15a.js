import{e as z,u as G,b as O,c as Q,r as n,R as t}from"./index-e0330f19.js";import{a as W,b as H,d as J}from"./academicPosts-01d2e02d.js";import{a as R}from"./http-a6fe908c.js";import{U as K,V as X,C as Y}from"./CommentSection-35da0c35.js";import"./relativeTime-133d5aca.js";import"./useLoginGate-dc2fc1b0.js";async function Z({school:l,targetId:a,message:m}){const c="https://api.cnapss.com/api".replace(/\/$/,"");return R(`${c}/${l}/request`,{method:"POST",headers:{"Content-Type":"application/json"},body:{targetId:a,initialMessage:m}})}async function ee({school:l,targetId:a}){const m="https://api.cnapss.com/api".replace(/\/$/,""),c=new URL(`${m}/${l}/request/exists`);return c.searchParams.set("targetId",a),R(c.toString(),{method:"GET"})}const te={lecture_notes:"Lecture Notes",syllabus:"Syllabus",past_exams:"Past Exams",quiz_prep:"Quiz Prep"};function se(l=""){const a=String(l||"").toLowerCase().replace(/[\s-]+/g,"_");return a.includes("course_material")?"📝":a.includes("study")?"👥":a.includes("coffee")?"☕️":"📌"}function ce(){const{school:l,id:a}=z(),m=G(),{school:c}=O(),o=l||c||"nyu",{user:i}=Q(),[r,f]=n.useState({loading:!0,error:"",post:null}),[p,w]=n.useState(""),[S,N]=n.useState(!1),[g,d]=n.useState(""),[x,v]=n.useState(!1);n.useEffect(()=>{let e=!0;return(async()=>{try{const s=await W({school:o,id:a});if(!e)return;f({loading:!1,error:"",post:s})}catch(s){if(!e)return;f({loading:!1,error:(s==null?void 0:s.message)||"Failed to load post.",post:null})}})(),()=>{e=!1}},[o,a]),n.useEffect(()=>{if(!i)return;let e=!0;return(async()=>{try{const s=await H({school:o,id:a});if(!e)return;f(u=>({...u,post:s||u.post}))}catch{}})(),()=>{e=!1}},[i,o,a]),n.useEffect(()=>{let e=!0;return(async()=>{try{if(!i)return;const s=await ee({school:o,targetId:a});if(!e)return;v(!!(s!=null&&s.exists))}catch{}})(),()=>{e=!1}},[o,a,i]);const h=n.useMemo(()=>{const e=r.post||{},s=(e.mode||e.postType||e.type||(e.lookingFor?"looking_for":"general")||"general").toString().toLowerCase();return{isSeeking:s==="looking_for"||s==="seeking",mode:s,kind:e.kind||""}},[r.post]),k=n.useMemo(()=>{var L,M,_;const e=r.post,s=i;if(!e||!s)return!1;const u=String(s.email||"").toLowerCase(),D=[s.id,s._id].filter(Boolean).map(String),$=[e.email,e.authorEmail,e.userEmail,(L=e.author)==null?void 0:L.email].filter(Boolean).map(E=>String(E).toLowerCase()),F=[e.userId,e.authorId,(M=e.author)==null?void 0:M._id,(_=e.author)==null?void 0:_.id].filter(Boolean).map(String),j=u&&$.includes(u),U=F.some(E=>D.includes(E)),V=!!e.isMine;return j||U||V},[i,r.post]),I=async()=>{if(k&&window.confirm("Delete this post?"))try{await J({school:o,id:a}),alert("Post deleted."),m(`/${o}/academic`)}catch(e){alert("Delete failed: "+((e==null?void 0:e.message)||"Unknown error"))}};if(r.loading)return t.createElement("div",{className:"p-6 text-gray-500"},"Loading…");if(r.error)return t.createElement("div",{className:"p-6 text-red-600"},r.error);if(!r.post)return t.createElement("div",{className:"p-6 text-gray-500"},"Post not found.");const{title:T,content:B,createdAt:q,kind:b,professor:y,materials:P=[]}=r.post,A=String(b||"").toLowerCase().replace(/[\s-]+/g,"_")==="course_materials",C=(Array.isArray(P)?P:[]).map(e=>te[e]||e).filter(Boolean);return t.createElement("div",{className:"max-w-3xl mx-auto px-4 py-6"},t.createElement("article",{className:"bg-white rounded-2xl shadow border border-slate-200 overflow-hidden"},t.createElement("header",{className:"px-5 py-4 border-b border-slate-200"},t.createElement("div",{className:"flex items-center justify-between text-sm text-slate-500"},t.createElement("div",{className:"inline-flex items-center gap-2"},t.createElement("span",null,h.isSeeking?se(b):"💬"),t.createElement("span",{className:"font-medium"},h.isSeeking?"Seeking":"General question"),A&&t.createElement("span",{className:"text-slate-400"},"• Course Materials")),t.createElement("div",{className:"flex items-center gap-3"},t.createElement("time",{dateTime:q},new Date(q).toLocaleString()),k&&t.createElement("button",{onClick:I,className:"ml-2 rounded-xl bg-red-500 px-3 py-1.5 text-xs font-semibold text-white hover:bg-red-600",title:"Delete this post"},"Delete"))),t.createElement("h1",{className:"mt-2 text-2xl font-semibold text-slate-900"},T),t.createElement("div",{className:"mt-3 flex items-center justify-between"},t.createElement(K,{username:r.post.nickname,tier:r.post.authorTier,className:"text-sm"}),t.createElement(X,{targetType:"Post",targetId:a,initialCounts:r.post.counts,initialVote:r.post.myVote,className:"scale-90"})),A&&(C.length||y)?t.createElement("div",{className:"mt-3 flex flex-wrap items-center gap-2"},C.map(e=>t.createElement("span",{key:e,className:"inline-flex items-center rounded-full border border-slate-300 bg-slate-50 px-3 py-1 text-xs text-slate-700"},e)),y&&t.createElement("span",{className:"inline-flex items-center rounded-full border border-slate-300 bg-slate-50 px-3 py-1 text-xs text-slate-700"},"Professor: ",y)):null),t.createElement("div",{className:"px-5 py-5 whitespace-pre-wrap text-[15px] leading-7 text-slate-800"},B),h.isSeeking?t.createElement("div",{className:"px-5 py-5 border-t border-slate-200 bg-slate-50"},t.createElement("h2",{className:"text-lg font-semibold mb-2"},"Send a Request"),t.createElement("p",{className:"text-sm text-slate-600 mb-3"},"This post doesn’t have comments. Send a private request to the author instead."),t.createElement("form",{onSubmit:async e=>{if(e.preventDefault(),!i)return d("Please log in to send a request.");if(!p.trim())return d("Please write a short message.");N(!0),d("");try{await Z({school:o,targetId:a,message:p.trim()}),w(""),v(!0),d("Request sent! Check Messages.")}catch(s){d((s==null?void 0:s.message)||"Failed to send request.")}finally{N(!1)}},className:"space-y-3"},t.createElement("textarea",{value:p,onChange:e=>w(e.target.value),placeholder:"Write a short message (who you are / what you need)…",rows:4,className:"w-full rounded-xl border border-slate-300 px-3 py-2 text-[14px] focus:outline-none focus:ring-2 focus:ring-slate-900/10",disabled:x}),t.createElement("div",{className:"flex items-center justify-between"},t.createElement("p",{className:"text-xs text-slate-500"},"Target: ",t.createElement("strong",null,"Academic · ",b||"general")),t.createElement("button",{type:"submit",disabled:S||x||!p.trim(),className:"rounded-xl bg-black px-4 py-2 text-sm font-semibold text-white disabled:opacity-60"},x?"Already requested":S?"Sending…":"Send request")),!!g&&t.createElement("div",{className:`text-sm px-3 py-2 rounded-lg border ${g.includes("sent")?"border-green-200 bg-green-50 text-green-700":"border-red-200 bg-red-50 text-red-700"}`},g))):t.createElement("div",{className:"px-5 py-5 border-t border-slate-200 bg-white"},t.createElement(Y,{postId:a}))))}export{ce as default};
