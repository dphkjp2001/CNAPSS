import{f as Q,u as W,a as H,c as V,b as X,d as Z,r as n,R as t}from"./index-45e03a1f.js";import{C as ee}from"./CommentSection-fc363c30.js";import{d as w,r as te}from"./relativeTime-0c07a19c.js";import{a as ae,b as se,d as ne,t as re,u as oe}from"./careerPosts-80fe931c.js";import{u as le}from"./useLoginGate-5051c4c3.js";import{g as ie,p as ce,a as de}from"./http-3e12da79.js";const U="https://api.cnapss.com/api".replace(/\/$/,"");function me({school:r,targetId:o,initialMessage:i}){return ce(`${U}/${r}/request`,{targetId:o,initialMessage:i})}function ue({school:r,targetId:o}){const i=new URL(`${U}/${r}/request/exists`);return i.searchParams.set("targetId",o),ie(i.toString())}w.extend(te);w.locale("en");const ge=(r,o=!1)=>{const i=String(r||(o?"looking_for":"")).toLowerCase();return i==="looking_for"||i==="looking"||i==="lf"||i==="seeking"?"seeking":"question"},fe=r=>{const o=String(r||"").toLowerCase();return o==="study_group"?"study_mate":o},xe=r=>r==="course_materials"?"Course Materials":r==="study_mate"?"Study Mate":r==="coffee_chat"?"Coffee Chat":"";function ke(){var M;const{id:r}=Q(),o=W(),i=H(),{user:c,token:y}=V(),{ensureAuth:f}=le(),{school:l,schoolTheme:m}=X(),p=Z(),[e,N]=n.useState(null),[C,j]=n.useState(""),[b,h]=n.useState(!1),[A,D]=n.useState(""),[S,q]=n.useState(""),[I,P]=n.useState(!1),[T,E]=n.useState(!1),[_,z]=n.useState(""),[L,R]=n.useState(!1),[u,O]=n.useState({exists:!1,conversationId:null}),$=async()=>{try{const a=y?await ae({school:l,id:r}):await se({school:l,id:r});N(a),D((a==null?void 0:a.title)||""),q((a==null?void 0:a.content)||"")}catch(a){j(a.message||"Failed to load the post.")}};n.useEffect(()=>{$()},[r,l,y]),n.useEffect(()=>{const s=new URLSearchParams(i.search).get("nid");async function d(){if(!(!s||!(c!=null&&c.email)||!l))try{const k="https://api.cnapss.com/api".replace(/\/+$/,"");await de(`${k}/${l}/notification/mark-read`,{method:"POST",headers:{"Content-Type":"application/json"},body:{commentId:s,email:c.email}})}catch{}}d()},[i.search,c==null?void 0:c.email,l]);const x=n.useMemo(()=>((c==null?void 0:c.email)||"").toLowerCase()===((e==null?void 0:e.email)||"").toLowerCase(),[c,e]),v=n.useMemo(()=>ge((e==null?void 0:e.postType)||(e==null?void 0:e.type),(e==null?void 0:e.lookingFor)||(e==null?void 0:e.isLookingFor)),[e]),g=v==="seeking",F=n.useMemo(()=>g?fe(e==null?void 0:e.kind):"",[g,e==null?void 0:e.kind]);n.useEffect(()=>{let a=!0;return(async()=>{if(!(!y||!l||!(e!=null&&e._id)||!g))try{const s=await ue({school:l,targetId:e._id});if(!a)return;O({exists:!!(s!=null&&s.exists),conversationId:(s==null?void 0:s.conversationId)||null})}catch{}})(),()=>{a=!1}},[y,l,e==null?void 0:e._id,g]);const B=async()=>{f(async()=>{if(window.confirm("Delete this post?"))try{await ne({school:l,id:e._id}),alert("Post deleted."),o(p("/dashboard?tab=academic"))}catch(a){alert("Delete failed: "+(a.message||"Unknown error"))}})},G=async()=>{f(async()=>{try{await re({school:l,id:e._id}),await $()}catch(a){alert("Failed to like: "+(a.message||"Unknown error"))}})},J=async()=>{f(async()=>{const a=A.trim(),s=S.trim();if(a){P(!0);try{const d=await oe({school:l,id:e._id,title:a,content:s,postType:v,kind:F}),k=(d==null?void 0:d.post)||d;N(k),h(!1)}catch(d){alert("Update failed: "+(d.message||"Unknown error"))}finally{P(!1)}}})},Y=()=>f(()=>{u.exists&&u.conversationId?o(p(`/messages?conversation=${u.conversationId}`)):E(!0)}),K=()=>f(async()=>{if(!g)return;const a=(_||"").trim();if(!a){alert("Write a short hello message.");return}R(!0);try{const s=await me({school:l,targetId:e._id,initialMessage:a}),d=s==null?void 0:s.conversationId;d?(E(!1),o(p(`/messages?conversation=${d}`))):alert("Sent, but failed to find the conversation ID.")}catch(s){alert((s==null?void 0:s.message)||"Failed to send request.")}finally{R(!1)}});return C?t.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-red-700",style:{backgroundColor:(m==null?void 0:m.bg)||"#f6f3ff"}},C):e?t.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(m==null?void 0:m.bg)||"#f6f3ff"}},t.createElement("div",{className:"mx-auto max-w-3xl"},t.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},t.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},t.createElement("div",{className:"flex items-center gap-2"},t.createElement("h1",{className:"text-2xl font-bold text-gray-900"},e.title),t.createElement("span",{className:"rounded-full border px-2 py-0.5 text-xs text-gray-700"},v==="question"?"General Question":`Seeking Â· ${xe(F)}`)),t.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",t.createElement("span",{className:"font-medium"},"anonymous")," â€¢ ",w(e.createdAt).fromNow())),t.createElement("div",{className:"p-5 sm:p-6"},b?t.createElement("textarea",{value:S,onChange:a=>q(a.target.value),placeholder:"Content",className:"h-56 w-full resize-y rounded-xl border border-gray-300 px-3 py-2 text-sm text-gray-800 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):t.createElement("div",{className:"prose max-w-none whitespace-pre-wrap text-sm text-gray-900"},e.content)),t.createElement("div",{className:"flex items-center justify-between border-t border-gray-100 px-5 py-3 sm:px-6"},t.createElement("div",{className:"flex items-center gap-2"},t.createElement("button",{onClick:G,disabled:x,className:"rounded-lg border px-3 py-1 text-sm hover:bg-gray-50 disabled:opacity-60",title:x?"You canâ€™t like your own post.":"Like post"},"ðŸ‘ Like"),t.createElement("span",{className:"text-xs text-gray-500"},((M=e.thumbsUpUsers)==null?void 0:M.length)||0," likes")),t.createElement("div",{className:"flex items-center gap-2"},x&&!b&&t.createElement(t.Fragment,null,t.createElement("button",{onClick:()=>h(!0),className:"rounded-lg border px-3 py-1 text-sm hover:bg-gray-50"},"âœï¸ Edit"),t.createElement("button",{onClick:B,className:"rounded-lg border px-3 py-1 text-sm text-red-600 hover:bg-red-50"},"ðŸ—‘ï¸ Delete")),x&&b&&t.createElement(t.Fragment,null,t.createElement("button",{onClick:J,disabled:I,className:"rounded-lg border px-3 py-1 text-sm text-white",style:{backgroundColor:"#111827"}},I?"Saving...":"Save"),t.createElement("button",{onClick:()=>h(!1),className:"rounded-lg border px-3 py-1 text-sm"},"Cancel")),!x&&g&&t.createElement("button",{onClick:Y,className:"rounded-lg border px-3 py-1 text-sm",title:u.exists?"You already requested":"Send request (first message)",disabled:u.exists&&!!u.conversationId},u.exists&&u.conversationId?"Requested":"Send request"))),t.createElement("div",{className:"border-t border-gray-100 p-5 sm:p-6"},t.createElement(ee,{postId:e._id,authorEmail:e.email}))),t.createElement("div",{className:"mt-6"},t.createElement("button",{onClick:()=>o(p("/dashboard?tab=academic")),className:"text-sm text-gray-600 hover:underline"},"â† Back to list"))),T&&t.createElement("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4"},t.createElement("div",{className:"w-full max-w-md rounded-2xl bg-white p-5 shadow-xl"},t.createElement("h3",{className:"mb-2 text-lg font-semibold"},"Send request"),t.createElement("p",{className:"mb-3 text-sm text-gray-600"},"This sends your first message to the author. A conversation will be created."),t.createElement("textarea",{value:_,onChange:a=>z(a.target.value),placeholder:"Say hello and what youâ€™re looking forâ€¦",className:"h-28 w-full resize-none rounded-xl border px-3 py-2 text-sm"}),t.createElement("div",{className:"mt-3 flex justify-end gap-2"},t.createElement("button",{onClick:()=>E(!1),className:"rounded-lg border px-3 py-1 text-sm"},"Cancel"),t.createElement("button",{onClick:K,disabled:L,className:"rounded-lg bg-gray-900 px-3 py-1 text-sm font-semibold text-white disabled:opacity-60"},L?"Sendingâ€¦":"Send"))))):t.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-gray-600",style:{backgroundColor:(m==null?void 0:m.bg)||"#f6f3ff"}},"Loadingâ€¦")}export{ke as default};
