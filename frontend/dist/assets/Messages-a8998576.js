import{h as F,m as O,i as z,p as P,u as H,a as W,e as U,r as f,R as a,f as q,n as G}from"./index-8d6ce387.js";import{a as K,d as N,r as V}from"./relativeTime-ae87a002.js";var J={exports:{}};(function(r,m){(function(c,d){r.exports=d()})(F,function(){var c={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"};return function(d,M,h){var o=M.prototype,_=o.format;h.en.formats=c,o.format=function(y){y===void 0&&(y="YYYY-MM-DDTHH:mm:ssZ");var w=this.$locale().formats,n=function(p,u){return p.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,function(x,g,b){var v=b&&b.toUpperCase();return g||u[b]||c[b]||u[v].replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,function(S,k,C){return k||C.slice(1)})})}(y,w===void 0?{}:w);return _.call(this,n)}}})})(J);var Z=J.exports;const Q=O(Z);var X={exports:{}};(function(r,m){(function(c,d){r.exports=d(K)})(F,function(c){function d(o){return o&&typeof o=="object"&&"default"in o?o:{default:o}}var M=d(c),h={name:"ko",weekdays:"일요일_월요일_화요일_수요일_목요일_금요일_토요일".split("_"),weekdaysShort:"일_월_화_수_목_금_토".split("_"),weekdaysMin:"일_월_화_수_목_금_토".split("_"),months:"1월_2월_3월_4월_5월_6월_7월_8월_9월_10월_11월_12월".split("_"),monthsShort:"1월_2월_3월_4월_5월_6월_7월_8월_9월_10월_11월_12월".split("_"),ordinal:function(o){return o+"일"},formats:{LT:"A h:mm",LTS:"A h:mm:ss",L:"YYYY.MM.DD.",LL:"YYYY년 MMMM D일",LLL:"YYYY년 MMMM D일 A h:mm",LLLL:"YYYY년 MMMM D일 dddd A h:mm",l:"YYYY.MM.DD.",ll:"YYYY년 MMMM D일",lll:"YYYY년 MMMM D일 A h:mm",llll:"YYYY년 MMMM D일 dddd A h:mm"},meridiem:function(o){return o<12?"오전":"오후"},relativeTime:{future:"%s 후",past:"%s 전",s:"몇 초",m:"1분",mm:"%d분",h:"한 시간",hh:"%d시간",d:"하루",dd:"%d일",M:"한 달",MM:"%d달",y:"일 년",yy:"%d년"}};return M.default.locale(h,null,!0),h})})(X);const R="https://api.cnapss.com/api".replace(/\/$/,"");function I({school:r,token:m}){return z(`${R}/${r}/chat/conversations`,{headers:{Authorization:`Bearer ${m}`}})}function ee({school:r,token:m,conversationId:c,cursor:d,limit:M=50}){const h=new URL(`${R}/${r}/chat/conversations/${c}/messages`);return d&&h.searchParams.set("cursor",d),h.searchParams.set("limit",String(M)),z(h.toString(),{headers:{Authorization:`Bearer ${m}`}})}function te({school:r,token:m,conversationId:c,content:d}){return P(`${R}/${r}/chat/conversations/${c}/messages`,{content:d},{headers:{Authorization:`Bearer ${m}`}})}function ae({school:r,token:m,conversationId:c}){return P(`${R}/${r}/chat/conversations/${c}/read`,{},{headers:{Authorization:`Bearer ${m}`}})}N.locale("ko");N.extend(V);N.extend(Q);function re({conversationId:r,userEmail:m,onClose:c,fullSize:d=!1,otherNickname:M,otherEmail:h}){const{user:o,token:_}=H()||{},{school:y}=W()||{},{socket:w,emit:n,on:p,off:u}=U(),x=((o==null?void 0:o.email)||m||"").toLowerCase(),[g,b]=f.useState([]),[v,S]=f.useState(""),[k,C]=f.useState(!1),[D,$]=f.useState(!1),A=f.useRef(null);f.useEffect(()=>{if(!r||!_||!y)return;let t=!0;return(async()=>{try{$(!0);const l=await ee({school:y,token:_,conversationId:r});if(!t)return;b((Array.isArray(l)?l:[]).reverse()),n==null||n("chat:read",{conversationId:r});try{await ae({school:y,token:_,conversationId:r})}catch{}}finally{t&&$(!1)}})(),()=>{t=!1}},[r,_,y,n]),f.useEffect(()=>{if(!r||!w)return;n==null||n("chat:join",{conversationId:r});const t=i=>{i.conversationId===r&&(b(E=>E.some(L=>L._id&&i._id&&String(L._id)===String(i._id))?E:[...E,i]),n==null||n("chat:read",{conversationId:r}))},l=({conversationId:i,reader:E})=>{i===r&&b(T=>T.map(L=>{var j;return(j=L.readBy)!=null&&j.includes(E)?L:{...L,readBy:[...L.readBy||[],E]}}))};return p==null||p("chat:receive",t),p==null||p("chat:read:updated",l),()=>{u==null||u("chat:receive",t),u==null||u("chat:read:updated",l)}},[w,n,p,u,r]);const Y=async()=>{const t=v.trim();if(!(!t||!r))try{const l=await te({school:y,token:_,conversationId:r,content:t});b(i=>[...i,l])}catch(l){console.error("send failed",l),alert("메시지 전송 실패")}finally{S("")}};f.useEffect(()=>{var t;(t=A.current)==null||t.scrollIntoView({behavior:"smooth",block:"nearest"})},[g]);const e=(t,l)=>{var i;return l===0||!N(t.createdAt).isSame((i=g[l-1])==null?void 0:i.createdAt,"day")},s=[...g].reverse().find(t=>(t.sender||"").toLowerCase()===x&&(t.readBy||[]).map(l=>l.toLowerCase()).includes((h||"").toLowerCase()));return a.createElement("div",{className:`relative border rounded-lg shadow bg-white flex flex-col ${d?"w-full h-full":"w-[360px]"}`},c&&a.createElement("button",{onClick:c,className:"absolute top-2 right-2 text-gray-400 hover:text-black text-xl"},"×"),a.createElement("div",{className:"flex items-center gap-2 border-b p-2 font-semibold"},a.createElement("span",null,"🗨️"),a.createElement("span",null,M||"Chat")),a.createElement("div",{className:"flex-1 overflow-y-auto p-3 space-y-2"},D&&a.createElement("div",{className:"text-sm text-gray-500"},"Loading..."),g.map((t,l)=>a.createElement("div",{key:t._id||l},e(t,l)&&a.createElement("div",{className:"text-center text-xs text-gray-400 my-2"},N(t.createdAt).format("YYYY년 M월 D일")),a.createElement("div",{className:`flex ${(t.sender||"").toLowerCase()===x?"justify-end":"justify-start"}`},a.createElement("div",{className:"max-w-xs"},a.createElement("div",{className:`px-3 py-1 rounded-lg break-words ${(t.sender||"").toLowerCase()===x?"bg-blue-600 text-white":"bg-gray-200 text-black"}`},t.content),a.createElement("div",{className:`text-[11px] mt-1 ${(t.sender||"").toLowerCase()===x?"text-right text-gray-400":"text-left text-gray-500"}`},N(t.createdAt).format("A h:mm"),t===s&&a.createElement("span",{className:"ml-1 text-blue-500 font-medium"},"Seen")))))),a.createElement("div",{ref:A})),a.createElement("div",{className:"flex gap-2 p-2 border-t"},a.createElement("input",{type:"text",className:"flex-1 border rounded p-2",value:v,onChange:t=>S(t.target.value),onCompositionStart:()=>C(!0),onCompositionEnd:()=>C(!1),onKeyDown:t=>{t.key==="Enter"&&!k&&Y()},placeholder:"메시지를 입력하세요..."}),a.createElement("button",{onClick:Y,disabled:!v.trim(),className:"bg-blue-600 text-white px-4 rounded hover:bg-blue-700 disabled:opacity-50"},"Send")))}function oe(){const{user:r,token:m}=H()||{},{school:c}=q(),[d,M]=G(),{on:h}=U()||{},[o,_]=f.useState([]),[y,w]=f.useState(!0),[n,p]=f.useState(null),[u,x]=f.useState("all"),g=(c||"").toLowerCase(),b=f.useMemo(()=>((r==null?void 0:r.email)||"").toLowerCase(),[r]),v=f.useCallback(async()=>{if(!(!m||!g)){w(!0);try{const e=await I({school:g,token:m}),s=Array.isArray(e)?e:Array.isArray(e==null?void 0:e.items)?e.items:[];return _(s),s}finally{w(!1)}}},[g,m]);f.useEffect(()=>{let e=!0;(async()=>{const t=await v();if(!e)return;const l=d.get("conversation");if(l&&Array.isArray(t)){const i=t.find(E=>String(E._id)===String(l));i&&(p(i),x(k(i==null?void 0:i.source,i==null?void 0:i.itemId)))}})();const s=h==null?void 0:h("chat:new-message",()=>{v()});return()=>{e=!1,typeof s=="function"&&s()}},[v,h,d]);const S=e=>{const s=String((e==null?void 0:e.source)||"").toLowerCase();return s==="market"?"market":s==="coursehub_wtb"?"coursehub_wtb":s==="coursehub"?"coursehub":e!=null&&e.itemId?"market":"dm"},k=(e,s)=>{const t=String(e||"").toLowerCase();return t==="market"?"market":t==="coursehub_wtb"?"coursehub_wtb":t==="coursehub"?"coursehub":s?"market":"all"},C=e=>{const s=S(e);return s==="market"?"🛒 Market":s==="coursehub_wtb"?"🎓 CourseHub — Wanted":s==="coursehub"?"🎓 CourseHub — For Sale":"💬 DM"},D=e=>{const s=String((e==null?void 0:e.buyer)||"").toLowerCase(),t=String((e==null?void 0:e.seller)||"").toLowerCase();return s===b?t:s},$=e=>e?String(e).split("@")[0]:"Unknown",A=e=>{const s=e==null?void 0:e.resourceTitle;return s&&s.trim()?s:$(D(e))},Y=f.useMemo(()=>u==="all"?o:o.filter(e=>S(e)===u),[o,u]);return f.useEffect(()=>{const e=n!=null&&n._id?String(n._id):null,s=new URLSearchParams(d.toString());e?s.set("conversation",e):s.delete("conversation"),M(s,{replace:!0})},[n]),a.createElement("div",{className:"mx-auto flex h-[calc(100vh-120px)] max-w-6xl gap-4 p-4"},a.createElement("div",{className:"flex w-[340px] shrink-0 flex-col rounded-2xl border bg-white"},a.createElement("div",{className:"flex flex-wrap gap-2 p-3"},a.createElement(B,{active:u==="all",onClick:()=>x("all")},"All"),a.createElement(B,{active:u==="market",onClick:()=>x("market")},"Marketplace"),a.createElement(B,{active:u==="coursehub",onClick:()=>x("coursehub")},"CourseHub – For Sale"),a.createElement(B,{active:u==="coursehub_wtb",onClick:()=>x("coursehub_wtb")},"CourseHub – Wanted")),a.createElement("div",{className:"min-h-0 grow overflow-y-auto"},y?a.createElement("div",{className:"p-3 text-sm text-gray-500"},"Loading…"):Y!=null&&Y.length?a.createElement("ul",{className:"divide-y"},Y.map(e=>{const s=(n==null?void 0:n._id)===e._id;return a.createElement("li",{key:e._id},a.createElement("button",{onClick:()=>{p(e),x(k(e==null?void 0:e.source,e==null?void 0:e.itemId))},className:"flex w-full items-center justify-between gap-2 px-3 py-3 text-left hover:bg-gray-50 "+(s?"bg-violet-50":"")},a.createElement("div",{className:"min-w-0"},a.createElement("div",{className:"flex items-center gap-2"},a.createElement("span",{className:"whitespace-nowrap rounded-full bg-gray-800 px-2 py-0.5 text-[11px] font-semibold text-white"},C(e)),a.createElement("span",{className:"truncate text-sm font-semibold text-gray-900"},A(e))),e.lastMessage?a.createElement("div",{className:"truncate text-xs text-gray-500"},e.lastMessage):null)))})):a.createElement("div",{className:"p-3 text-sm text-gray-500"},"No conversations."))),a.createElement("div",{className:"min-w-0 grow rounded-2xl border bg-white"},n?a.createElement(re,{conversationId:n._id,userEmail:r==null?void 0:r.email,otherEmail:D(n),otherNickname:A(n),fullSize:!0}):a.createElement("div",{className:"mt-20 text-center text-gray-400"},"🧭 왼쪽에서 채팅을 선택하세요.")))}function B({active:r,children:m,onClick:c}){return a.createElement("button",{onClick:c,className:"rounded-full px-3 py-1 text-xs font-semibold "+(r?"bg-violet-600 text-white":"border border-gray-300 bg-white text-gray-700 hover:bg-gray-50")},m)}export{oe as default};
