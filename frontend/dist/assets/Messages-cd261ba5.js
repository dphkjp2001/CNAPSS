import{l as b,a as w,f as k,r as c,R as a,C}from"./index-fb9d96f6.js";const l=b("https://api.cnapss.com",{transports:["websocket"]});function $(){const{user:t}=w(),{school:E}=k(),[h,i]=c.useState([]),[o,x]=c.useState(null),v="https://api.cnapss.com/api".replace(/\/+$/,""),m=(E||localStorage.getItem("selectedSchool")||"").toLowerCase(),f=async()=>{if(t!=null&&t.email)try{const e=encodeURIComponent(t.email),n=m?`?school=${encodeURIComponent(m)}`:"",s=await fetch(`${v}/chat/conversations/${e}${n}`);if(!s.ok){const d=await s.text().catch(()=>"");throw new Error(d||`HTTP ${s.status}`)}const r=await s.json();if(!Array.isArray(r))throw new Error("Invalid response shape");i(r)}catch(e){console.error("❌ 대화 불러오기 실패:",e.message),i([])}};c.useEffect(()=>{f()},[t==null?void 0:t.email,m]),c.useEffect(()=>{const e=()=>f(),n=({conversationId:s,lastMessage:r,updatedAt:d})=>{i(N=>N.map(p=>p._id===s?{...p,lastMessage:r,updatedAt:d}:p))};return l.on("receiveMessage",e),l.on("conversationUpdated",n),()=>{l.off("receiveMessage",e),l.off("conversationUpdated",n)}},[]);const u=e=>e.buyer===(t==null?void 0:t.email)?e.sellerNickname:e.buyerNickname,y=e=>e.buyer===(t==null?void 0:t.email)?e.seller:e.buyer,g=e=>{var n;return((n=e.messages)==null?void 0:n.filter(s=>{var r;return s.sender!==(t==null?void 0:t.email)&&!((r=s.readBy)!=null&&r.includes(t==null?void 0:t.email))}).length)||0};return a.createElement("div",{className:"flex h-[calc(100vh-80px)]"},a.createElement("div",{className:"w-80 border-r p-4"},a.createElement("h2",{className:"text-lg font-bold mb-4"},"💬 Messages"),a.createElement("div",{className:"space-y-2"},h.length===0&&a.createElement("p",{className:"text-sm text-gray-500"},"진행 중인 채팅이 없습니다."),h.map(e=>a.createElement("div",{key:e._id,onClick:()=>x(e),className:`cursor-pointer p-3 rounded-lg relative ${(o==null?void 0:o._id)===e._id?"bg-blue-100":"hover:bg-gray-100"}`},a.createElement("p",{className:"font-medium"},u(e)),a.createElement("p",{className:"text-sm text-gray-500 truncate"},e.lastMessage||"(메시지 없음)"),g(e)>0&&a.createElement("span",{className:"absolute top-2 right-2 text-xs bg-red-500 text-white px-1.5 py-0.5 rounded-full"},g(e)))))),a.createElement("div",{className:"flex-1 p-4"},o?a.createElement(C,{conversationId:o._id,userEmail:t.email,otherEmail:y(o),fullSize:!0,otherNickname:u(o)}):a.createElement("div",{className:"text-center text-gray-400 mt-20"},"🧭 왼쪽에서 채팅을 선택하세요.")))}export{$ as default};
