import{f as A,u as I,a as T,c as $,b as B,d as M,r,R as t,L as z}from"./index-076cbd2a.js";import{C as H}from"./CommentSection-879ea3da.js";import{d as p,r as O}from"./relativeTime-97901206.js";import{a as W,b as Y,d as q,t as G,u as J}from"./posts-533066e6.js";import{a as K}from"./http-b5e27cd5.js";import"./useLoginGate-5dc1179c.js";p.extend(O);p.locale("en");function ae(){var L;const{id:m}=A(),F=I(),c=T(),{user:a,token:w}=$(),{school:n,schoolTheme:l}=B(),E=M(),[s,d]=r.useState(null),[v,u]=r.useState(""),[g,x]=r.useState(!1),[C,f]=r.useState(""),[N,h]=r.useState(""),[k,S]=r.useState(!1),P=!!(a!=null&&a.email||w&&String(w).length>0),U=async()=>{u("");try{const e=await W({school:n,id:m});d(e),f((e==null?void 0:e.title)||""),h((e==null?void 0:e.content)||"");return}catch(e){if((e==null?void 0:e.status)!==404){u((e==null?void 0:e.message)||"Failed to load the post.");return}}if(P)try{const e=await Y({school:n,id:m});d(e),f((e==null?void 0:e.title)||""),h((e==null?void 0:e.content)||"")}catch(e){u((e==null?void 0:e.message)||"Failed to load the post.")}else u("Post not found.")};r.useEffect(()=>{!n||!m||U()},[m,n,P]),r.useEffect(()=>{const i=new URLSearchParams(c.search).get("nid");async function o(){if(!(!i||!(a!=null&&a.email)||!n))try{const y="https://api.cnapss.com/api".replace(/\/+$/,"");await K(`${y}/${n}/notification/mark-read`,{method:"POST",headers:{"Content-Type":"application/json"},body:{commentId:i,email:a.email}})}catch{}}o()},[c.search,a==null?void 0:a.email,n]);const D=r.useMemo(()=>{const e=c.hash||"",i=e.startsWith("#comment-")?e.slice(9):null,o=new URLSearchParams(c.search).get("nid");return i||o||null},[c.hash,c.search]),b=r.useMemo(()=>((a==null?void 0:a.email)||"").toLowerCase()===((s==null?void 0:s.email)||"").toLowerCase(),[a,s]),R=async()=>{if(window.confirm("Delete this post?"))try{await q({school:n,id:s._id}),alert("Post deleted."),F(E("/dashboard?tab=free"))}catch(e){alert("Delete failed: "+((e==null?void 0:e.message)||"Unknown error"))}},_=async()=>{if(a)try{await G({school:n,id:s._id}),d(e=>e&&{...e,thumbsUpUsers:(e.thumbsUpUsers||[]).includes(((a==null?void 0:a.email)||"").toLowerCase())?e.thumbsUpUsers.filter(i=>i.toLowerCase()!==((a==null?void 0:a.email)||"").toLowerCase()):[...e.thumbsUpUsers||[],((a==null?void 0:a.email)||"").toLowerCase()]}),await U()}catch(e){alert("Failed to like: "+((e==null?void 0:e.message)||"Unknown error"))}},j=async()=>{const e=C.trim(),i=N.trim();if(!(!e||!i)){S(!0);try{const o=await J({school:n,id:s._id,title:e,content:i}),y=(o==null?void 0:o.post)||o;d(y),x(!1)}catch(o){alert("Update failed: "+((o==null?void 0:o.message)||"Unknown error"))}finally{S(!1)}}};return v?t.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-red-700",style:{backgroundColor:(l==null?void 0:l.bg)||"#f6f3ff"}},v):s?t.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(l==null?void 0:l.bg)||"#f6f3ff"}},t.createElement("div",{className:"mx-auto max-w-3xl"},t.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},t.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},g?t.createElement("input",{value:C,onChange:e=>f(e.target.value),placeholder:"Title",className:"w-full rounded-xl border border-gray-300 px-3 py-2 text-lg font-semibold text-gray-900 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):t.createElement("h1",{className:"text-2xl font-bold text-gray-900"},s.title),t.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",t.createElement("span",{className:"font-medium"},"anonymous")," ‚Ä¢"," ",p(s.createdAt).fromNow())),t.createElement("div",{className:"p-5 sm:p-6"},g?t.createElement("textarea",{value:N,onChange:e=>h(e.target.value),placeholder:"Content",className:"h-56 w-full resize-y rounded-xl border border-gray-300 px-3 py-2 text-sm text-gray-800 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):t.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},t.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},s.content)),t.createElement("div",{className:"mt-6 flex flex-wrap items-center gap-3"},t.createElement("button",{onClick:_,disabled:!a||b,className:"rounded-xl border border-gray-300 bg-white px-3 py-1.5 text-sm text-gray-800 shadow-sm hover:bg-gray-50 disabled:opacity-60","aria-label":"like post",title:a?b?"You can‚Äôt like your own post.":"Like post":"Log in to like (disabled for guests)"},"üëç ",((L=s.thumbsUpUsers)==null?void 0:L.length)||0),b&&!g&&t.createElement(t.Fragment,null,t.createElement("button",{onClick:()=>x(!0),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:"#6b46c1"}},"Edit"),t.createElement("button",{onClick:R,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")),b&&g&&t.createElement(t.Fragment,null,t.createElement("button",{onClick:j,disabled:k,className:"rounded-xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-black disabled:opacity-60"},k?"Saving‚Ä¶":"Save"),t.createElement("button",{onClick:()=>{f((s==null?void 0:s.title)||""),h((s==null?void 0:s.content)||""),x(!1)},className:"rounded-xl border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-800 shadow-sm hover:bg-gray-50"},"Cancel")),t.createElement(z,{to:E("/dashboard?tab=free"),className:"ml-auto text-sm font-medium text-blue-600 underline underline-offset-2"},"‚Üê Back to List")))),(s==null?void 0:s._id)&&t.createElement("div",{className:"mt-6 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm sm:p-6"},t.createElement(H,{postId:s._id,authorEmail:s.email,highlightId:D})))):t.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-gray-600",style:{backgroundColor:(l==null?void 0:l.bg)||"#f6f3ff"}},"Loading‚Ä¶")}export{ae as default};
