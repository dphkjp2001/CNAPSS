import{o as P,v as J,m as K,p as U,c as z,b as G,q,r as c,R as a,f as O,s as V}from"./index-48998c15.js";import{a as Z,d as A,r as Q}from"./relativeTime-e44c1e0c.js";var H={exports:{}};(function(r,u){(function(l,i){r.exports=i()})(P,function(){var l={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"};return function(i,M,m){var o=M.prototype,v=o.format;m.en.formats=l,o.format=function(_){_===void 0&&(_="YYYY-MM-DDTHH:mm:ssZ");var Y=this.$locale().formats,s=function(d,x){return d.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,function(f,g,h){var E=h&&h.toUpperCase();return g||x[h]||l[h]||x[E].replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,function(w,b,L){return b||L.slice(1)})})}(_,Y===void 0?{}:Y);return v.call(this,s)}}})})(H);var W=H.exports;const X=J(W);var I={exports:{}};(function(r,u){(function(l,i){r.exports=i(Z)})(P,function(l){function i(o){return o&&typeof o=="object"&&"default"in o?o:{default:o}}var M=i(l),m={name:"ko",weekdays:"일요일_월요일_화요일_수요일_목요일_금요일_토요일".split("_"),weekdaysShort:"일_월_화_수_목_금_토".split("_"),weekdaysMin:"일_월_화_수_목_금_토".split("_"),months:"1월_2월_3월_4월_5월_6월_7월_8월_9월_10월_11월_12월".split("_"),monthsShort:"1월_2월_3월_4월_5월_6월_7월_8월_9월_10월_11월_12월".split("_"),ordinal:function(o){return o+"일"},formats:{LT:"A h:mm",LTS:"A h:mm:ss",L:"YYYY.MM.DD.",LL:"YYYY년 MMMM D일",LLL:"YYYY년 MMMM D일 A h:mm",LLLL:"YYYY년 MMMM D일 dddd A h:mm",l:"YYYY.MM.DD.",ll:"YYYY년 MMMM D일",lll:"YYYY년 MMMM D일 A h:mm",llll:"YYYY년 MMMM D일 dddd A h:mm"},meridiem:function(o){return o<12?"오전":"오후"},relativeTime:{future:"%s 후",past:"%s 전",s:"몇 초",m:"1분",mm:"%d분",h:"한 시간",hh:"%d시간",d:"하루",dd:"%d일",M:"한 달",MM:"%d달",y:"일 년",yy:"%d년"}};return M.default.locale(m,null,!0),m})})(I);const j="https://api.cnapss.com/api".replace(/\/$/,"");function ee({school:r,token:u}){return K(`${j}/${r}/chat/conversations`)}function te({school:r,token:u,conversationId:l,cursor:i,limit:M=50}){const m=new URL(`${j}/${r}/chat/conversations/${l}/messages`);return i&&m.searchParams.set("cursor",i),m.searchParams.set("limit",String(M)),K(m.toString())}function ae({school:r,token:u,conversationId:l,content:i}){return U(`${j}/${r}/chat/conversations/${l}/messages`,{content:i})}function re({school:r,token:u,conversationId:l}){return U(`${j}/${r}/chat/conversations/${l}/read`,{})}A.locale("ko");A.extend(Q);A.extend(X);function se({conversationId:r,userEmail:u,onClose:l,fullSize:i=!1,otherNickname:M,otherEmail:m}){const{user:o,token:v}=z()||{},{school:_}=G()||{},{socket:Y,emit:s,on:d,off:x}=q(),f=((o==null?void 0:o.email)||u||"").toLowerCase(),[g,h]=c.useState([]),[E,w]=c.useState(""),[b,L]=c.useState(!1),[F,D]=c.useState(!1),T=c.useRef(null);c.useEffect(()=>{if(!r||!v||!_)return;let e=!0;return(async()=>{try{D(!0);const n=await te({school:_,token:v,conversationId:r});if(!e)return;h((Array.isArray(n)?n:[]).reverse()),s==null||s("chat:read",{conversationId:r});try{await re({school:_,token:v,conversationId:r})}catch{}}finally{e&&D(!1)}})(),()=>{e=!1}},[r,v,_,s]),c.useEffect(()=>{if(!r||!Y)return;s==null||s("chat:join",{conversationId:r});const e=y=>{String(y.conversationId)===String(r)&&(h(N=>N.some(k=>k._id&&y._id&&String(k._id)===String(y._id))?N:[...N,y]),s==null||s("chat:read",{conversationId:r}))},n=({conversationId:y,reader:N})=>{String(y)===String(r)&&h(B=>B.map(k=>(k.readBy||[]).includes(N)?k:{...k,readBy:[...k.readBy||[],N]}))},p=d==null?void 0:d("chat:receive",e),S=d==null?void 0:d("chat:read:updated",n);return()=>{typeof p=="function"&&p(),typeof S=="function"&&S()}},[Y,s,d,r]);const $=async()=>{const e=E.trim();if(!(!e||!r))try{const n=await ae({school:_,token:v,conversationId:r,content:e});h(p=>(n==null?void 0:n._id)&&p.some(y=>String(y._id)===String(n._id))?p:[...p,n])}catch(n){console.error("send failed",n),alert("메시지 전송 실패")}finally{w("")}};c.useEffect(()=>{var e;(e=T.current)==null||e.scrollIntoView({behavior:"smooth",block:"nearest"})},[g]);const C=(e,n)=>{var p;return n===0||!A(e.createdAt).isSame((p=g[n-1])==null?void 0:p.createdAt,"day")},t=[...g].reverse().find(e=>(e.sender||"").toLowerCase()===f&&(e.readBy||[]).map(n=>n.toLowerCase()).includes((m||"").toLowerCase()));return a.createElement("div",{className:`relative border rounded-lg shadow bg-white flex flex-col ${i?"w-full h-full":"w-[360px]"}`},l&&a.createElement("button",{onClick:l,className:"absolute top-2 right-2 text-gray-400 hover:text-black text-xl"},"×"),a.createElement("div",{className:"flex items-center gap-2 border-b p-2 font-semibold"},a.createElement("span",null,"🗨️"),a.createElement("span",null,M||"Chat")),a.createElement("div",{className:"flex-1 overflow-y-auto p-3 space-y-2"},F&&a.createElement("div",{className:"text-sm text-gray-500"},"Loading..."),g.map((e,n)=>a.createElement("div",{key:e._id||n},C(e,n)&&a.createElement("div",{className:"text-center text-xs text-gray-400 my-2"},A(e.createdAt).format("YYYY년 M월 D일")),a.createElement("div",{className:`flex ${(e.sender||"").toLowerCase()===f?"justify-end":"justify-start"}`},a.createElement("div",{className:"max-w-xs"},a.createElement("div",{className:`px-3 py-1 rounded-lg break-words ${(e.sender||"").toLowerCase()===f?"bg-blue-600 text-white":"bg-gray-200 text-black"}`},e.content),a.createElement("div",{className:`text-[11px] mt-1 ${(e.sender||"").toLowerCase()===f?"text-right text-gray-400":"text-left text-gray-500"}`},A(e.createdAt).format("A h:mm"),e===t&&a.createElement("span",{className:"ml-1 text-blue-500 font-medium"},"Seen")))))),a.createElement("div",{ref:T})),a.createElement("div",{className:"flex gap-2 p-2 border-t"},a.createElement("input",{type:"text",className:"flex-1 border rounded p-2",value:E,onChange:e=>w(e.target.value),onCompositionStart:()=>L(!0),onCompositionEnd:()=>L(!1),onKeyDown:e=>{e.key==="Enter"&&!b&&$()},placeholder:"메시지를 입력하세요..."}),a.createElement("button",{onClick:$,disabled:!E.trim(),className:"bg-blue-600 text-white px-4 rounded hover:bg-blue-700 disabled:opacity-50"},"Send")))}function le(){const{user:r,token:u}=z()||{},{school:l}=O(),[i,M]=V(),{on:m}=q()||{},[o,v]=c.useState([]),[_,Y]=c.useState(!0),[s,d]=c.useState(null),[x,f]=c.useState("all"),g=(l||"").toLowerCase(),h=c.useMemo(()=>((r==null?void 0:r.email)||"").toLowerCase(),[r]),E=c.useCallback(async()=>{if(!(!u||!g)){Y(!0);try{const t=await ee({school:g,token:u}),e=Array.isArray(t)?t:Array.isArray(t==null?void 0:t.items)?t.items:[];return v(e),e}finally{Y(!1)}}},[g,u]);c.useEffect(()=>{let t=!0;(async()=>{const n=await E();if(!t)return;const p=i.get("conversation");if(p&&Array.isArray(n)){const S=n.find(y=>String(y._id)===String(p));S&&(d(S),f($(S)))}})();const e=m==null?void 0:m("chat:preview",()=>{E()});return()=>{t=!1,typeof e=="function"&&e()}},[E,m,i]);const w=t=>String(t||"").toLowerCase().replace(/[\s-]+/g,"_"),b=t=>String(t==null?void 0:t.source).toLowerCase()==="looking_for",L=t=>{const e=String((t==null?void 0:t.buyer)||"").toLowerCase(),n=String((t==null?void 0:t.seller)||"").toLowerCase();return e===h?n:e},F=t=>t?String(t).split("@")[0]:"Unknown",D=t=>(t==null?void 0:t.resourceTitle)&&t.resourceTitle.trim()||F(L(t)),T=t=>{if(!b(t))return"💬 DM";const e=w(t==null?void 0:t.seekingKind);return e==="course_materials"?"📝 Materials":e==="study_mate"?"👥 Study Buddy":e==="coffee_chat"?"☕ Coffee Chat":"🎓 Seeking"},$=t=>{if(!b(t))return"all";const e=w(t==null?void 0:t.seekingKind);return e==="course_materials"?"lf_course_materials":e==="study_mate"?"lf_study_mate":e==="coffee_chat"?"lf_coffee_chat":"all"},C=c.useMemo(()=>{if(x==="all")return o;const t=x.replace(/^lf_/,"");return o.filter(e=>b(e)&&w(e==null?void 0:e.seekingKind)===t)},[o,x]);return c.useEffect(()=>{const t=s!=null&&s._id?String(s._id):null,e=new URLSearchParams(i.toString());t?e.set("conversation",t):e.delete("conversation"),M(e,{replace:!0})},[s]),a.createElement("div",{className:"mx-auto flex h-[calc(100vh-120px)] max-w-6xl gap-4 p-4"},a.createElement("div",{className:"flex w-[340px] shrink-0 flex-col rounded-2xl border bg-white"},a.createElement("div",{className:"flex flex-wrap gap-2 p-3"},a.createElement(R,{active:x==="all",onClick:()=>f("all")},"All"),a.createElement(R,{active:x==="lf_course_materials",onClick:()=>f("lf_course_materials")},"Materials"),a.createElement(R,{active:x==="lf_study_mate",onClick:()=>f("lf_study_mate")},"Study Buddy"),a.createElement(R,{active:x==="lf_coffee_chat",onClick:()=>f("lf_coffee_chat")},"Coffee Chat")),a.createElement("div",{className:"min-h-0 grow overflow-y-auto"},_?a.createElement("div",{className:"p-3 text-sm text-gray-500"},"Loading…"):C!=null&&C.length?a.createElement("ul",{className:"divide-y"},C.map(t=>{const e=(s==null?void 0:s._id)===t._id;return a.createElement("li",{key:t._id},a.createElement("button",{onClick:()=>{d(t),f($(t))},className:"flex w-full items-center justify-between gap-2 px-3 py-3 text-left hover:bg-gray-50 "+(e?"bg-violet-50":"")},a.createElement("div",{className:"min-w-0"},a.createElement("div",{className:"flex items-center gap-2"},a.createElement("span",{className:"whitespace-nowrap rounded-full bg-gray-800 px-2 py-0.5 text-[11px] font-semibold text-white"},T(t)),a.createElement("span",{className:"truncate text-sm font-semibold text-gray-900"},D(t))),t.lastMessage?a.createElement("div",{className:"truncate text-xs text-gray-500"},t.lastMessage):null)))})):a.createElement("div",{className:"p-3 text-sm text-gray-500"},"No conversations."))),a.createElement("div",{className:"min-w-0 grow rounded-2xl border bg-white"},s?a.createElement(se,{conversationId:s._id,userEmail:r==null?void 0:r.email,otherEmail:L(s),otherNickname:D(s),fullSize:!0}):a.createElement("div",{className:"mt-20 text-center text-gray-400"},"🧭 왼쪽에서 채팅을 선택하세요.")))}function R({active:r,children:u,onClick:l}){return a.createElement("button",{onClick:l,className:"rounded-full px-3 py-1 text-xs font-semibold "+(r?"bg-violet-600 text-white":"border border-gray-300 bg-white text-gray-700 hover:bg-gray-50")},u)}export{le as default};
