import{f as I,u as C,a as q,b as A,c as D,r as l,R as e,L as g}from"./index-3bf3b025.js";import{g as j,a as F,d as R,s as $}from"./market-fdbf22cb.js";const B=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0});function P(){const{id:n}=I(),u=C(),{user:s}=q(),{school:m,schoolTheme:c}=A(),i=D(),[r,y]=l.useState(null),[o,x]=l.useState(null),[f,b]=l.useState(!1),[d,h]=l.useState(""),[N,E]=l.useState("idle"),[p,v]=l.useState("");l.useEffect(()=>{(async()=>{var a;try{const t=await j({school:m,token:(s==null?void 0:s.token)||((a=localStorage.getItem("token"))==null?void 0:a.replace(/^Bearer /,"")),id:n});y(t),x(Array.isArray(t.images)&&t.images.length>0?t.images[0]:null)}catch(t){console.error("load item failed",t),v("Failed to load the listing.")}})(),s&&(async()=>{var a;try{(await F({school:m,token:(a=localStorage.getItem("token"))==null?void 0:a.replace(/^Bearer /,""),itemId:n,email:s.email})).alreadySent&&E("already")}catch(t){console.error("request-check failed",t)}})()},[n,s,m]);const w=l.useMemo(()=>!!(s!=null&&s.email&&(r!=null&&r.seller)&&s.email===r.seller),[s,r]),k=async()=>{var a;if(window.confirm("Delete this listing?"))try{await R({school:m,token:(a=localStorage.getItem("token"))==null?void 0:a.replace(/^Bearer /,""),id:n}),u(i("/market"))}catch(t){console.error(t),alert("Failed to delete.")}},S=async()=>{var a;if(d.trim())try{const{conversationId:t}=await $({school:m,token:(a=localStorage.getItem("token"))==null?void 0:a.replace(/^Bearer /,""),itemId:n,buyer:s.email,message:d});t?u(i(`/messages?conversation=${t}`)):alert("Unexpected server response.")}catch(t){console.error("send request failed",t),alert("Failed to send the message.")}};return r?e.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:c.bg}},e.createElement("div",{className:"mx-auto max-w-4xl"},e.createElement("div",{className:"rounded-2xl border border-gray-200 bg-white shadow-sm overflow-hidden"},e.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},e.createElement("h1",{className:"text-2xl font-bold text-gray-900"},r.title),e.createElement("div",{className:"mt-1 flex flex-wrap items-center gap-3 text-sm"},e.createElement("span",{className:"font-semibold text-gray-900"},B.format(Number(r.price)||0)),r.sellerNickname&&e.createElement("span",{className:"text-gray-500"},"Seller: ",r.sellerNickname))),e.createElement("div",{className:"grid grid-cols-1 gap-6 p-5 sm:grid-cols-5 sm:p-6"},e.createElement("div",{className:"sm:col-span-3"},e.createElement("button",{type:"button",disabled:!o,onClick:()=>o&&b(!0),className:"block w-full overflow-hidden rounded-xl border border-gray-200 bg-gray-50","aria-label":"open image in lightbox"},o?e.createElement("img",{src:o,alt:"main",className:"aspect-[4/3] w-full object-cover"}):e.createElement("div",{className:"aspect-[4/3] w-full"})),Array.isArray(r.images)&&r.images.length>1&&e.createElement("div",{className:"mt-3 grid grid-cols-4 gap-2"},r.images.map((a,t)=>e.createElement("button",{key:t,type:"button",onClick:()=>x(a),className:`overflow-hidden rounded-lg border ${o===a?"border-gray-900":"border-gray-200"} bg-white focus:outline-none focus:ring-2 focus:ring-gray-900/15`,"aria-label":`thumbnail ${t+1}`},e.createElement("img",{src:a,alt:`thumbnail ${t+1}`,className:"aspect-square w-full object-cover"}))))),e.createElement("div",{className:"sm:col-span-2 flex flex-col"},e.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},e.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},r.description)),w?e.createElement("div",{className:"mt-6 flex gap-2"},e.createElement(g,{to:i(`/market/${n}/edit`),className:"inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:c.primary}},"Edit"),e.createElement("button",{onClick:k,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")):s?e.createElement("div",{className:"mt-6"},N==="already"?e.createElement("div",{className:"rounded-xl border border-gray-200 bg-gray-50 p-3 text-sm text-gray-700"},"Youâ€™ve already sent a request.",e.createElement(g,{to:i("/messages"),className:"ml-2 font-medium text-blue-600 underline"},"Go to Chat ðŸ’¬")):e.createElement("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center"},e.createElement("input",{type:"text",value:d,onChange:a=>h(a.target.value),placeholder:"Ask about pickup, availability, condition, etc.",className:"flex-1 rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10"}),e.createElement("button",{onClick:S,className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:c.primary}},"Send"))):e.createElement("div",{className:"mt-6 rounded-xl border border-gray-200 bg-gray-50 p-3 text-sm text-gray-700"},"Please ",e.createElement(g,{className:"text-blue-600 underline",to:i("/login")},"log in")," to contact the seller."))),p&&e.createElement("div",{className:"border-t border-gray-100 px-5 py-4 text-sm text-red-700 sm:px-6"},p))),f&&o&&e.createElement("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/70",onClick:()=>b(!1)},e.createElement("img",{src:o,alt:"zoomed",className:"max-h-[90vh] max-w-[90vw] rounded shadow-lg"}))):e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-gray-600",style:{backgroundColor:(c==null?void 0:c.bg)||"#f6f3ff"}},"Loadingâ€¦")}export{P as default};
