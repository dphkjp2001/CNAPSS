import{l as y,a as v,r as c,R as t,C as N}from"./index-6592f118.js";const o=y("https://api.cnapss.com",{transports:["websocket"]});function k(){const{user:a}=v(),[m,d]=c.useState([]),[r,f]=c.useState(null),p=async()=>{if(a!=null&&a.email)try{const e=await fetch(`https://api.cnapss.com/api/chat/conversations/${a.email}`);if(!e.ok)throw new Error("응답 실패");const s=await e.json();if(!Array.isArray(s))throw new Error("잘못된 데이터 형식");d(s)}catch(e){console.error("❌ 대화 불러오기 실패:",e.message)}};c.useEffect(()=>{p()},[a]),c.useEffect(()=>{const e=()=>p(),s=({conversationId:n,lastMessage:l,updatedAt:g})=>{d(x=>x.map(i=>i._id===n?{...i,lastMessage:l,updatedAt:g}:i))};return o.on("receiveMessage",e),o.on("conversationUpdated",s),()=>{o.off("receiveMessage",e),o.off("conversationUpdated",s)}},[]);const u=e=>e.buyer===a.email?e.sellerNickname:e.buyerNickname,E=e=>e.buyer===a.email?e.seller:e.buyer,h=e=>{var s;return((s=e.messages)==null?void 0:s.filter(n=>{var l;return n.sender!==a.email&&!((l=n.readBy)!=null&&l.includes(a.email))}).length)||0};return t.createElement("div",{className:"flex h-[calc(100vh-80px)]"},t.createElement("div",{className:"w-80 border-r p-4"},t.createElement("h2",{className:"text-lg font-bold mb-4"},"💬 Messages"),t.createElement("div",{className:"space-y-2"},m.length===0&&t.createElement("p",{className:"text-sm text-gray-500"},"진행 중인 채팅이 없습니다."),m.map(e=>t.createElement("div",{key:e._id,onClick:()=>f(e),className:`cursor-pointer p-3 rounded-lg relative ${(r==null?void 0:r._id)===e._id?"bg-blue-100":"hover:bg-gray-100"}`},t.createElement("p",{className:"font-medium"},u(e)),t.createElement("p",{className:"text-sm text-gray-500 truncate"},e.lastMessage||"(메시지 없음)"),h(e)>0&&t.createElement("span",{className:"absolute top-2 right-2 text-xs bg-red-500 text-white px-1.5 py-0.5 rounded-full"},h(e)))))),t.createElement("div",{className:"flex-1 p-4"},r?t.createElement(N,{conversationId:r._id,userEmail:a.email,otherEmail:E(r),fullSize:!0,otherNickname:u(r)}):t.createElement("div",{className:"text-center text-gray-400 mt-20"},"🧭 왼쪽에서 채팅을 선택하세요.")))}export{k as default};
