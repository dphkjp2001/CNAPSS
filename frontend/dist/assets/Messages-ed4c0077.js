import{g as B,j as W,c as H,b as q,h as U,r as m,R as t,f as G,i as K}from"./index-45e03a1f.js";import{a as V,d as A,r as Z}from"./relativeTime-0c07a19c.js";import{g as z,p as J}from"./http-3e12da79.js";var O={exports:{}};(function(a,f){(function(i,u){a.exports=u()})(B,function(){var i={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"};return function(u,_,d){var l=_.prototype,M=l.format;d.en.formats=i,l.format=function(x){x===void 0&&(x="YYYY-MM-DDTHH:mm:ssZ");var v=this.$locale().formats,n=function(p,g){return p.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,function(h,b,y){var w=y&&y.toUpperCase();return b||g[y]||i[y]||g[w].replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,function(L,k,C){return k||C.slice(1)})})}(x,v===void 0?{}:v);return M.call(this,n)}}})})(O);var Q=O.exports;const X=W(Q);var I={exports:{}};(function(a,f){(function(i,u){a.exports=u(V)})(B,function(i){function u(l){return l&&typeof l=="object"&&"default"in l?l:{default:l}}var _=u(i),d={name:"ko",weekdays:"일요일_월요일_화요일_수요일_목요일_금요일_토요일".split("_"),weekdaysShort:"일_월_화_수_목_금_토".split("_"),weekdaysMin:"일_월_화_수_목_금_토".split("_"),months:"1월_2월_3월_4월_5월_6월_7월_8월_9월_10월_11월_12월".split("_"),monthsShort:"1월_2월_3월_4월_5월_6월_7월_8월_9월_10월_11월_12월".split("_"),ordinal:function(l){return l+"일"},formats:{LT:"A h:mm",LTS:"A h:mm:ss",L:"YYYY.MM.DD.",LL:"YYYY년 MMMM D일",LLL:"YYYY년 MMMM D일 A h:mm",LLLL:"YYYY년 MMMM D일 dddd A h:mm",l:"YYYY.MM.DD.",ll:"YYYY년 MMMM D일",lll:"YYYY년 MMMM D일 A h:mm",llll:"YYYY년 MMMM D일 dddd A h:mm"},meridiem:function(l){return l<12?"오전":"오후"},relativeTime:{future:"%s 후",past:"%s 전",s:"몇 초",m:"1분",mm:"%d분",h:"한 시간",hh:"%d시간",d:"하루",dd:"%d일",M:"한 달",MM:"%d달",y:"일 년",yy:"%d년"}};return _.default.locale(d,null,!0),d})})(I);const F="https://api.cnapss.com/api".replace(/\/$/,"");function ee({school:a,token:f}){return z(`${F}/${a}/chat/conversations`)}function te({school:a,token:f,conversationId:i,cursor:u,limit:_=50}){const d=new URL(`${F}/${a}/chat/conversations/${i}/messages`);return u&&d.searchParams.set("cursor",u),d.searchParams.set("limit",String(_)),z(d.toString())}function re({school:a,token:f,conversationId:i,content:u}){return J(`${F}/${a}/chat/conversations/${i}/messages`,{content:u})}function ae({school:a,token:f,conversationId:i}){return J(`${F}/${a}/chat/conversations/${i}/read`,{})}A.locale("ko");A.extend(Z);A.extend(X);function se({conversationId:a,userEmail:f,onClose:i,fullSize:u=!1,otherNickname:_,otherEmail:d}){const{user:l,token:M}=H()||{},{school:x}=q()||{},{socket:v,emit:n,on:p,off:g}=U(),h=((l==null?void 0:l.email)||f||"").toLowerCase(),[b,y]=m.useState([]),[w,L]=m.useState(""),[k,C]=m.useState(!1),[j,R]=m.useState(!1),D=m.useRef(null);m.useEffect(()=>{if(!a||!M||!x)return;let r=!0;return(async()=>{try{R(!0);const o=await te({school:x,token:M,conversationId:a});if(!r)return;y((Array.isArray(o)?o:[]).reverse()),n==null||n("chat:read",{conversationId:a});try{await ae({school:x,token:M,conversationId:a})}catch{}}finally{r&&R(!1)}})(),()=>{r=!1}},[a,M,x,n]),m.useEffect(()=>{if(!a||!v)return;n==null||n("chat:join",{conversationId:a});const r=E=>{String(E.conversationId)===String(a)&&(y(N=>N.some(S=>S._id&&E._id&&String(S._id)===String(E._id))?N:[...N,E]),n==null||n("chat:read",{conversationId:a}))},o=({conversationId:E,reader:N})=>{String(E)===String(a)&&y(P=>P.map(S=>(S.readBy||[]).includes(N)?S:{...S,readBy:[...S.readBy||[],N]}))},c=p==null?void 0:p("chat:receive",r),$=p==null?void 0:p("chat:read:updated",o);return()=>{typeof c=="function"&&c(),typeof $=="function"&&$()}},[v,n,p,a]);const Y=async()=>{const r=w.trim();if(!(!r||!a))try{const o=await re({school:x,token:M,conversationId:a,content:r});y(c=>(o==null?void 0:o._id)&&c.some(E=>String(E._id)===String(o._id))?c:[...c,o])}catch(o){console.error("send failed",o),alert("메시지 전송 실패")}finally{L("")}};m.useEffect(()=>{var r;(r=D.current)==null||r.scrollIntoView({behavior:"smooth",block:"nearest"})},[b]);const e=(r,o)=>{var c;return o===0||!A(r.createdAt).isSame((c=b[o-1])==null?void 0:c.createdAt,"day")},s=[...b].reverse().find(r=>(r.sender||"").toLowerCase()===h&&(r.readBy||[]).map(o=>o.toLowerCase()).includes((d||"").toLowerCase()));return t.createElement("div",{className:`relative border rounded-lg shadow bg-white flex flex-col ${u?"w-full h-full":"w-[360px]"}`},i&&t.createElement("button",{onClick:i,className:"absolute top-2 right-2 text-gray-400 hover:text-black text-xl"},"×"),t.createElement("div",{className:"flex items-center gap-2 border-b p-2 font-semibold"},t.createElement("span",null,"🗨️"),t.createElement("span",null,_||"Chat")),t.createElement("div",{className:"flex-1 overflow-y-auto p-3 space-y-2"},j&&t.createElement("div",{className:"text-sm text-gray-500"},"Loading..."),b.map((r,o)=>t.createElement("div",{key:r._id||o},e(r,o)&&t.createElement("div",{className:"text-center text-xs text-gray-400 my-2"},A(r.createdAt).format("YYYY년 M월 D일")),t.createElement("div",{className:`flex ${(r.sender||"").toLowerCase()===h?"justify-end":"justify-start"}`},t.createElement("div",{className:"max-w-xs"},t.createElement("div",{className:`px-3 py-1 rounded-lg break-words ${(r.sender||"").toLowerCase()===h?"bg-blue-600 text-white":"bg-gray-200 text-black"}`},r.content),t.createElement("div",{className:`text-[11px] mt-1 ${(r.sender||"").toLowerCase()===h?"text-right text-gray-400":"text-left text-gray-500"}`},A(r.createdAt).format("A h:mm"),r===s&&t.createElement("span",{className:"ml-1 text-blue-500 font-medium"},"Seen")))))),t.createElement("div",{ref:D})),t.createElement("div",{className:"flex gap-2 p-2 border-t"},t.createElement("input",{type:"text",className:"flex-1 border rounded p-2",value:w,onChange:r=>L(r.target.value),onCompositionStart:()=>C(!0),onCompositionEnd:()=>C(!1),onKeyDown:r=>{r.key==="Enter"&&!k&&Y()},placeholder:"메시지를 입력하세요..."}),t.createElement("button",{onClick:Y,disabled:!w.trim(),className:"bg-blue-600 text-white px-4 rounded hover:bg-blue-700 disabled:opacity-50"},"Send")))}function ie(){const{user:a,token:f}=H()||{},{school:i}=G(),[u,_]=K(),{on:d}=U()||{},[l,M]=m.useState([]),[x,v]=m.useState(!0),[n,p]=m.useState(null),[g,h]=m.useState("all"),b=(i||"").toLowerCase(),y=m.useMemo(()=>((a==null?void 0:a.email)||"").toLowerCase(),[a]),w=m.useCallback(async()=>{if(!(!f||!b)){v(!0);try{const e=await ee({school:b,token:f}),s=Array.isArray(e)?e:Array.isArray(e==null?void 0:e.items)?e.items:[];return M(s),s}finally{v(!1)}}},[b,f]);m.useEffect(()=>{let e=!0;(async()=>{const r=await w();if(!e)return;const o=u.get("conversation");if(o&&Array.isArray(r)){const c=r.find($=>String($._id)===String(o));c&&(p(c),h(k(c==null?void 0:c.source,c==null?void 0:c.itemId)))}})();const s=d==null?void 0:d("chat:preview",()=>{w()});return()=>{e=!1,typeof s=="function"&&s()}},[w,d,u]);const L=e=>{const s=String((e==null?void 0:e.source)||"").toLowerCase();return s==="market"?"market":s==="coursehub_wtb"?"coursehub_wtb":s==="coursehub"?"coursehub":e!=null&&e.itemId?"market":"dm"},k=(e,s)=>{const r=String(e||"").toLowerCase();return r==="market"?"market":r==="coursehub_wtb"?"coursehub_wtb":r==="coursehub"?"coursehub":s?"market":"all"},C=e=>{const s=L(e);return s==="market"?"🛒 Market":s==="coursehub_wtb"?"🎓 CourseHub — Wanted":s==="coursehub"?"🎓 CourseHub — For Sale":"💬 DM"},j=e=>{const s=String((e==null?void 0:e.buyer)||"").toLowerCase(),r=String((e==null?void 0:e.seller)||"").toLowerCase();return s===y?r:s},R=e=>e?String(e).split("@")[0]:"Unknown",D=e=>{const s=e==null?void 0:e.resourceTitle;return s&&s.trim()?s:R(j(e))},Y=m.useMemo(()=>g==="all"?l:l.filter(e=>L(e)===g),[l,g]);return m.useEffect(()=>{const e=n!=null&&n._id?String(n._id):null,s=new URLSearchParams(u.toString());e?s.set("conversation",e):s.delete("conversation"),_(s,{replace:!0})},[n]),t.createElement("div",{className:"mx-auto flex h-[calc(100vh-120px)] max-w-6xl gap-4 p-4"},t.createElement("div",{className:"flex w-[340px] shrink-0 flex-col rounded-2xl border bg-white"},t.createElement("div",{className:"flex flex-wrap gap-2 p-3"},t.createElement(T,{active:g==="all",onClick:()=>h("all")},"All"),t.createElement(T,{active:g==="market",onClick:()=>h("market")},"Marketplace"),t.createElement(T,{active:g==="coursehub",onClick:()=>h("coursehub")},"CourseHub – For Sale"),t.createElement(T,{active:g==="coursehub_wtb",onClick:()=>h("coursehub_wtb")},"CourseHub – Wanted")),t.createElement("div",{className:"min-h-0 grow overflow-y-auto"},x?t.createElement("div",{className:"p-3 text-sm text-gray-500"},"Loading…"):Y!=null&&Y.length?t.createElement("ul",{className:"divide-y"},Y.map(e=>{const s=(n==null?void 0:n._id)===e._id;return t.createElement("li",{key:e._id},t.createElement("button",{onClick:()=>{p(e),h(k(e==null?void 0:e.source,e==null?void 0:e.itemId))},className:"flex w-full items-center justify-between gap-2 px-3 py-3 text-left hover:bg-gray-50 "+(s?"bg-violet-50":"")},t.createElement("div",{className:"min-w-0"},t.createElement("div",{className:"flex items-center gap-2"},t.createElement("span",{className:"whitespace-nowrap rounded-full bg-gray-800 px-2 py-0.5 text-[11px] font-semibold text-white"},C(e)),t.createElement("span",{className:"truncate text-sm font-semibold text-gray-900"},D(e))),e.lastMessage?t.createElement("div",{className:"truncate text-xs text-gray-500"},e.lastMessage):null)))})):t.createElement("div",{className:"p-3 text-sm text-gray-500"},"No conversations."))),t.createElement("div",{className:"min-w-0 grow rounded-2xl border bg-white"},n?t.createElement(se,{conversationId:n._id,userEmail:a==null?void 0:a.email,otherEmail:j(n),otherNickname:D(n),fullSize:!0}):t.createElement("div",{className:"mt-20 text-center text-gray-400"},"🧭 왼쪽에서 채팅을 선택하세요.")))}function T({active:a,children:f,onClick:i}){return t.createElement("button",{onClick:i,className:"rounded-full px-3 py-1 text-xs font-semibold "+(a?"bg-violet-600 text-white":"border border-gray-300 bg-white text-gray-700 hover:bg-gray-50")},f)}export{ie as default};
