import{f as q,u as A,a as D,b as I,c as j,r as l,R as e,L as x}from"./index-7ad9052d.js";import{a as g}from"./axios-b5ee139b.js";const F=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0});function P(){const{id:o}=q(),p=A(),{user:r}=D(),{school:m,schoolTheme:c}=I(),i=j(),d="https://api.cnapss.com/api",[a,h]=l.useState(null),[n,b]=l.useState(null),[N,y]=l.useState(!1),[u,E]=l.useState(""),[v,w]=l.useState("idle"),[f,k]=l.useState("");l.useEffect(()=>{(async()=>{try{const s=(await g.get(`${d}/market/${o}`,{params:{school:m}})).data;h(s),b(Array.isArray(s.images)&&s.images.length>0?s.images[0]:null)}catch(t){console.error("load item failed",t),k("Failed to load the listing.")}})(),r&&(async()=>{try{(await g.get(`${d}/market/request/${o}/${r.email}`,{params:{school:m}})).data.alreadySent&&w("already")}catch(t){console.error("request-check failed",t)}})()},[o,d,r,m]);const S=l.useMemo(()=>!!(r!=null&&r.email&&(a!=null&&a.seller)&&r.email===a.seller),[r,a]),$=async()=>{if(window.confirm("Delete this listing?"))try{await g.delete(`${d}/market/${o}`,{data:{school:m}}),p(i("/market"))}catch(t){console.error(t),alert("Failed to delete.")}},C=async()=>{if(u.trim())try{const t=await g.post(`${d}/market/request`,{itemId:o,buyer:r.email,message:u,school:m}),{conversationId:s}=t.data;s?p(i(`/messages?conversation=${s}`)):alert("Unexpected server response.")}catch(t){console.error("send request failed",t),alert("Failed to send the message.")}};return a?e.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:c.bg}},e.createElement("div",{className:"mx-auto max-w-4xl"},e.createElement("div",{className:"rounded-2xl border border-gray-200 bg-white shadow-sm overflow-hidden"},e.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},e.createElement("h1",{className:"text-2xl font-bold text-gray-900"},a.title),e.createElement("div",{className:"mt-1 flex flex-wrap items-center gap-3 text-sm"},e.createElement("span",{className:"font-semibold text-gray-900"},F.format(Number(a.price)||0)),a.sellerNickname&&e.createElement("span",{className:"text-gray-500"},"Seller: ",a.sellerNickname))),e.createElement("div",{className:"grid grid-cols-1 gap-6 p-5 sm:grid-cols-5 sm:p-6"},e.createElement("div",{className:"sm:col-span-3"},e.createElement("button",{type:"button",disabled:!n,onClick:()=>n&&y(!0),className:"block w-full overflow-hidden rounded-xl border border-gray-200 bg-gray-50","aria-label":"open image in lightbox"},n?e.createElement("img",{src:n,alt:"main",className:"aspect-[4/3] w-full object-cover"}):e.createElement("div",{className:"aspect-[4/3] w-full"})),Array.isArray(a.images)&&a.images.length>1&&e.createElement("div",{className:"mt-3 grid grid-cols-4 gap-2"},a.images.map((t,s)=>e.createElement("button",{key:s,type:"button",onClick:()=>b(t),className:`overflow-hidden rounded-lg border ${n===t?"border-gray-900":"border-gray-200"} bg-white focus:outline-none focus:ring-2 focus:ring-gray-900/15`,"aria-label":`thumbnail ${s+1}`},e.createElement("img",{src:t,alt:`thumbnail ${s+1}`,className:"aspect-square w-full object-cover"}))))),e.createElement("div",{className:"sm:col-span-2 flex flex-col"},e.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},e.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},a.description)),S?e.createElement("div",{className:"mt-6 flex gap-2"},e.createElement(x,{to:i(`/market/${o}/edit`),className:"inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:c.primary}},"Edit"),e.createElement("button",{onClick:$,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")):r?e.createElement("div",{className:"mt-6"},v==="already"?e.createElement("div",{className:"rounded-xl border border-gray-200 bg-gray-50 p-3 text-sm text-gray-700"},"Youâ€™ve already sent a request.",e.createElement(x,{to:i("/messages"),className:"ml-2 font-medium text-blue-600 underline"},"Go to Chat ðŸ’¬")):e.createElement("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center"},e.createElement("input",{type:"text",value:u,onChange:t=>E(t.target.value),placeholder:"Ask about pickup, availability, condition, etc.",className:"flex-1 rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10"}),e.createElement("button",{onClick:C,className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:c.primary}},"Send"))):e.createElement("div",{className:"mt-6 rounded-xl border border-gray-200 bg-gray-50 p-3 text-sm text-gray-700"},"Please ",e.createElement(x,{className:"text-blue-600 underline",to:i("/login")},"log in")," to contact the seller."))),f&&e.createElement("div",{className:"border-t border-gray-100 px-5 py-4 text-sm text-red-700 sm:px-6"},f))),N&&n&&e.createElement("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/70",onClick:()=>y(!1)},e.createElement("img",{src:n,alt:"zoomed",className:"max-h-[90vh] max-w-[90vw] rounded shadow-lg"}))):e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-gray-600",style:{backgroundColor:(c==null?void 0:c.bg)||"#f6f3ff"}},"Loadingâ€¦")}export{P as default};
