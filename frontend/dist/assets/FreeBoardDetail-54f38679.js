import{a as A,b as L,r as i,R as e,A as $,d as w,c as O,e as B,u as K,L as J}from"./index-c0efd8a8.js";import{u as W}from"./schoolPath-4b46817e.js";import"./en-55dd51c1.js";import{d as q,e as M,t as z}from"./posts-806c274d.js";const k="https://api.cnapss.com/api",G=async(l,c="freeboard",a=null)=>{const n=a?`?type=${c}&email=${a}`:`?type=${c}`,s=await fetch(`${k}/comments/${l}${n}`),u=await s.json();if(!s.ok)throw new Error("ÎåìÍ∏Ä Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®");return u},F=async({postId:l,email:c,content:a,parentId:n=null})=>{const s=await fetch(`${k}/comments/${l}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:c,content:a,parentId:n})}),u=await s.json();if(!s.ok)throw new Error(u.message||"ÎåìÍ∏Ä Îì±Î°ù Ïã§Ìå®");return u},H=async({commentId:l,email:c,content:a})=>{const n=await fetch(`${k}/comments/${l}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:c,content:a})}),s=await n.json();if(!n.ok)throw new Error(s.message||"ÎåìÍ∏Ä ÏàòÏ†ï Ïã§Ìå®");return s},Q=async({commentId:l,email:c})=>{const a=await fetch(`${k}/comments/${l}`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:c})}),n=await a.json();if(!a.ok)throw new Error(n.message||"ÎåìÍ∏Ä ÏÇ≠Ï†ú Ïã§Ìå®");return n},V=async({commentId:l,email:c})=>{const a=await fetch(`${k}/comments/${l}/thumb`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:c})}),n=await a.json();if(!a.ok)throw new Error(n.message||"Ï∂îÏ≤ú Ïã§Ìå®");return n};w.extend(O);w.locale("en");function X({postId:l,postAuthorEmail:c}){const{user:a}=A(),{schoolTheme:n}=L(),[s,u]=i.useState([]),[m,E]=i.useState(""),[N,p]=i.useState(null),[b,x]=i.useState(""),[v,C]=i.useState(null),[h,d]=i.useState(""),P=i.useCallback(t=>{const o={};let g=1;return c&&(o[c]=`anonymous${g++}`),t.map(r=>(o[r.email]||(o[r.email]=`anonymous${g++}`),{...r,anonymousId:o[r.email]}))},[c]),y=i.useCallback(async()=>{try{const t=await G(l,"freeboard");u(P(t))}catch(t){console.error("fetchComments failed:",t),alert("Failed to load comments.")}},[l,P]);i.useEffect(()=>{y()},[y]);const _=async()=>{if(m.trim())try{await F({postId:l,email:a.email,content:m}),E(""),y()}catch(t){alert(t.message||"Failed to post comment.")}},U=async t=>{if(h.trim())try{await F({postId:l,email:a.email,content:h,parentId:t}),d(""),C(null),y()}catch(o){alert(o.message||"Failed to post reply.")}},I=async t=>{if(window.confirm("Delete this comment?"))try{await Q({commentId:t,email:a.email}),y()}catch(o){alert(o.message||"Failed to delete comment.")}},R=async t=>{if(!b.trim()){p(null);return}try{await H({commentId:t,email:a.email,content:b}),p(null),x(""),y()}catch(o){alert(o.message||"Failed to update comment.")}},T=async t=>{try{await V({commentId:t,email:a.email}),y()}catch(o){alert(o.message||"Failed to like comment.")}},S=(t,o,g=null)=>{t.key==="Enter"&&!t.shiftKey?(t.preventDefault(),o==="comment"&&_(),o==="reply"&&U(g)):t.key==="Escape"&&(o==="comment"&&E(""),o==="reply"&&(d(""),C(null)))},j=(t=null)=>{const o=s.filter(r=>(r.parentId||null)===t).sort((r,D)=>new Date(r.createdAt)-new Date(D.createdAt));if(!o.length)return null;const g=t!==null;return e.createElement("ul",{className:g?"ml-5 border-l-2 border-gray-200 pl-4 space-y-3":"space-y-4"},o.map(r=>{const D=(a==null?void 0:a.email)===r.email;return e.createElement("li",{key:r._id,className:g?"rounded-xl bg-gray-50 p-3":"border-b border-gray-100 pb-4"},e.createElement("div",{className:"flex items-center gap-2 text-xs text-gray-500"},e.createElement("span",{className:"font-semibold text-gray-800"},r.anonymousId),e.createElement("span",null,"‚Ä¢"),e.createElement("span",null,r.createdAt?w(r.createdAt).fromNow():"")),N===r._id?e.createElement("div",{className:"mt-2 flex items-center gap-2"},e.createElement("input",{value:b,onChange:f=>x(f.target.value),onKeyDown:f=>S(f,"comment"),className:"w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10",placeholder:"Edit your comment",autoFocus:!0}),e.createElement($,{onClick:()=>R(r._id),loadingText:"Saving‚Ä¶",className:"rounded-xl px-3 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:(n==null?void 0:n.primary)||"#6b46c1"}},"Save"),e.createElement("button",{onClick:()=>{p(null),x("")},className:"rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-800 shadow-sm hover:bg-gray-50"},"Cancel")):e.createElement("p",{className:"mt-1 whitespace-pre-wrap text-sm text-gray-800"},r.content),N!==r._id&&e.createElement("div",{className:"mt-2 flex flex-wrap items-center gap-2 text-xs"},e.createElement("button",{onClick:()=>T(r._id),className:"rounded-lg border border-gray-300 bg-white px-2.5 py-1 text-gray-700 shadow-sm hover:bg-gray-50"},"üëç ",r.thumbsUp||0),e.createElement("button",{onClick:()=>C(r._id),className:"rounded-lg border border-gray-300 bg-white px-2.5 py-1 text-gray-700 shadow-sm hover:bg-gray-50"},"‚Ü©Ô∏è Reply"),D&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>{p(r._id),x(r.content)},className:"rounded-lg border border-gray-300 bg-white px-2.5 py-1 text-gray-700 shadow-sm hover:bg-gray-50"},"‚úèÔ∏è Edit"),e.createElement($,{onClick:()=>I(r._id),loadingText:"Deleting‚Ä¶",className:"rounded-lg bg-red-500 px-2.5 py-1 font-medium text-white shadow hover:bg-red-600"},"üóëÔ∏è Delete"))),v===r._id&&e.createElement("div",{className:"mt-3 flex items-center gap-2"},e.createElement("textarea",{rows:2,value:h,onChange:f=>d(f.target.value),onKeyDown:f=>S(f,"reply",r._id),className:"w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10",placeholder:"Write a reply‚Ä¶ (Enter = submit, Shift+Enter = newline, Esc = cancel)"})),j(r._id))}))};return e.createElement("div",{className:"mt-8"},e.createElement("h3",{className:"mb-3 text-lg font-bold text-gray-900"},"üí¨ Comments"),e.createElement("form",{onSubmit:t=>t.preventDefault(),className:"mb-4 flex gap-2"},e.createElement("textarea",{rows:2,value:m,onChange:t=>E(t.target.value),onKeyDown:t=>S(t,"comment"),className:"w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10",placeholder:"Write a comment‚Ä¶ (Enter = submit, Shift+Enter = newline, Esc = clear)"}),e.createElement($,{onClick:_,loadingText:"Posting‚Ä¶",className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:(n==null?void 0:n.primary)||"#6b46c1"}},"Post")),j())}w.extend(O);w.locale("en");function ae(){var h;const{id:l}=B(),c=K(),{user:a}=A(),{school:n,schoolTheme:s}=L(),u=W(),[m,E]=i.useState(null),[N,p]=i.useState(""),b=async()=>{try{const d=await q(l,n);E(d)}catch(d){p(d.message||"Failed to load the post.")}};i.useEffect(()=>{b()},[l,n]);const x=i.useMemo(()=>(a==null?void 0:a.email)===(m==null?void 0:m.email),[a,m]),v=async()=>{if(window.confirm("Delete this post?"))try{await M(l,a.email,n),alert("Post deleted."),c(u("/freeboard"))}catch(d){alert("Delete failed: "+(d.message||"Unknown error"))}},C=async()=>{try{await z(l,a.email),await b()}catch(d){alert("Failed to like: "+(d.message||"Unknown error"))}};return N?e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-red-700",style:{backgroundColor:(s==null?void 0:s.bg)||"#f6f3ff"}},N):m?e.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(s==null?void 0:s.bg)||"#f6f3ff"}},e.createElement("div",{className:"mx-auto max-w-3xl"},e.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},e.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},e.createElement("h1",{className:"text-2xl font-bold text-gray-900"},m.title),e.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",e.createElement("span",{className:"font-medium"},"anonymous")," ‚Ä¢ ",w(m.createdAt).fromNow())),e.createElement("div",{className:"p-5 sm:p-6"},e.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},e.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},m.content)),e.createElement("div",{className:"mt-6 flex flex-wrap items-center gap-3"},e.createElement("button",{onClick:C,className:"rounded-xl border border-gray-300 bg-white px-3 py-1.5 text-sm text-gray-800 shadow-sm hover:bg-gray-50","aria-label":"like post"},"üëç ",((h=m.thumbsUpUsers)==null?void 0:h.length)||0),x&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>c(u(`/freeboard/edit/${m._id}`)),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:(s==null?void 0:s.primary)||"#6b46c1"}},"Edit"),e.createElement("button",{onClick:v,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")),e.createElement(J,{to:u("/freeboard"),className:"ml-auto text-sm font-medium text-blue-600 underline underline-offset-2"},"‚Üê Back to List")))),(m==null?void 0:m._id)&&e.createElement("div",{className:"mt-6 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm sm:p-6"},e.createElement(X,{postId:m._id,postAuthorEmail:m.email})))):e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-gray-600",style:{backgroundColor:(s==null?void 0:s.bg)||"#f6f3ff"}},"Loading‚Ä¶")}export{ae as default};
