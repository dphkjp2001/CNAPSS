import{f as L,u as G,d as q,c as B,b as $,r as u,R as e}from"./index-c9998775.js";import{a as O,u as J}from"./market-e619ef15.js";import{u as V}from"./uploadToCloudinary-dc971086.js";import"./http-a6fe908c.js";const C=3,X=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0});function Q(){const{id:x}=L(),y=G();q();const{user:b,token:h}=B(),{school:d,schoolTheme:l}=$(),v=u.useRef(null),[s,N]=u.useState({title:"",description:"",price:""}),[i,g]=u.useState([]),[A,D]=u.useState(!0),[k,E]=u.useState(""),S=u.useMemo(()=>!(!s.title.trim()||!s.price||Number.isNaN(Number(s.price))||Number(s.price)<0),[s.title,s.price]);u.useEffect(()=>{let t=!1;return(async()=>{try{const r=await O({school:d,token:h,id:x});if(t)return;if(r.seller!==(b==null?void 0:b.email)){alert("You donâ€™t have permission to edit this listing."),y("/"+d+"/market");return}N({title:r.title||"",description:r.description||"",price:String(r.price??"")});const a=Array.isArray(r.images)?r.images:[];g(a.map((c,n)=>({url:c,isCover:n===0})))}catch(r){console.error(r),alert("Failed to load the listing."),y("/"+d+"/market")}finally{t||D(!1)}})(),()=>{t=!0}},[x,d,h]);const I=t=>{const{name:r,value:a}=t.target;N(c=>({...c,[r]:a}))},P=t=>{const r=t.target.value.replace(/[^\d.]/g,"");N(a=>({...a,price:r}))},F=t=>typeof t=="string"?t:(t==null?void 0:t.secure_url)||(t==null?void 0:t.url)||"",j=async t=>{const r=Math.max(0,C-i.length),a=Array.from(t||[]).slice(0,r);if(!a.length)return;const c=a.map((n,o)=>({url:URL.createObjectURL(n),uploading:!0,isCover:i.length===0&&o===0}));g(n=>[...n,...c]);for(let n=0;n<a.length;n++)try{const o=await V(a[n]),w=F(o);g(p=>{const m=[...p],f=m.findIndex(_=>_.uploading);return f!==-1&&(m[f]={...m[f],url:w,public_id:typeof o=="object"?o.public_id:void 0,uploading:!1}),m})}catch(o){console.error("image upload failed",o),g(w=>{const p=[...w],m=p.findIndex(f=>f.uploading);return m!==-1&&p.splice(m,1),p}),E("Failed to upload one or more images.")}v.current&&(v.current.value="")},U=t=>{g(r=>{const a=r.filter((c,n)=>n!==t);return a.length>0&&(a[0].isCover=!0),a})},M=t=>{g(r=>{const a={...r[t],isCover:!0},c=r.filter((n,o)=>o!==t).map(n=>({...n,isCover:!1}));return[a,...c]})},R=async t=>{if(t.preventDefault(),!(!S||i.some(r=>r.uploading)))try{E(""),await J({school:d,token:h,id:x,payload:{title:s.title.trim(),description:s.description.trim(),price:Number(s.price),images:i.map(r=>r.url)}}),y("/"+d+"/market/"+x)}catch(r){console.error(r),E("Failed to save changes. Please try again.")}};return A?e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-gray-600",style:{backgroundColor:(l==null?void 0:l.bg)||"#f6f3ff"}},"Loadingâ€¦"):e.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(l==null?void 0:l.bg)||"#f6f3ff"}},e.createElement("div",{className:"mx-auto max-w-3xl"},e.createElement("div",{className:"rounded-2xl border border-gray-200 bg-white shadow-sm"},e.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},e.createElement("h1",{className:"text-xl font-bold text-gray-900"},"Edit Listing"),e.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Update photos, title, price, and description. The first photo is used as the cover.")),e.createElement("form",{onSubmit:R,className:"p-5 sm:p-6 space-y-6"},e.createElement("section",null,e.createElement("label",{className:"block text-sm font-medium text-gray-900"},"Photos ",e.createElement("span",{className:"font-normal text-gray-400"},"(up to ",C,")")),e.createElement("div",{className:"mt-2 flex flex-col items-center justify-center rounded-xl border-2 border-dashed border-gray-300 bg-gray-50/60 p-6 text-center transition hover:bg-gray-50",onDragOver:t=>t.preventDefault(),onDrop:t=>{t.preventDefault(),!(i.length>=C)&&j(t.dataTransfer.files)}},e.createElement("input",{id:"file-input",ref:v,type:"file",accept:"image/*",multiple:!0,onChange:t=>j(t.target.files),className:"hidden"}),e.createElement("div",{className:"text-3xl"},"ðŸ–¼ï¸"),e.createElement("p",{className:"mt-2 text-sm text-gray-700"},"Drag & drop images here, or"," ",e.createElement("label",{htmlFor:"file-input",className:"cursor-pointer font-medium text-gray-900 underline underline-offset-2"},"browse")),e.createElement("p",{className:"text-xs text-gray-500 mt-1"},"PNG/JPG, up to ~5MB each")),i.length>0&&e.createElement("div",{className:"mt-4 grid grid-cols-2 gap-3 sm:grid-cols-3"},i.map((t,r)=>e.createElement("div",{key:r,className:"group relative overflow-hidden rounded-xl border border-gray-200 bg-white shadow-sm"},e.createElement("div",{className:"aspect-[4/3] bg-gray-50"},e.createElement("img",{src:t.url,alt:`photo ${r+1}`,className:`h-full w-full object-cover ${t.uploading?"opacity-60":""}`})),e.createElement("div",{className:"absolute inset-x-0 bottom-0 flex items-center justify-between gap-2 p-2"},e.createElement("button",{type:"button",onClick:()=>M(r),className:"rounded-md bg-white/90 px-2 py-1 text-xs font-medium text-gray-800 shadow hover:bg-white"},r===0?"Cover":"Set as cover"),e.createElement("button",{type:"button",onClick:()=>U(r),className:"rounded-md bg-white/90 px-2 py-1 text-xs font-medium text-red-600 shadow hover:bg-white"},"Remove")),t.uploading&&e.createElement("div",{className:"absolute inset-0 flex items-center justify-center bg-white/60 text-xs text-gray-700"},"Uploadingâ€¦"))))),e.createElement("section",{className:"grid grid-cols-1 gap-4 sm:grid-cols-3"},e.createElement("div",{className:"sm:col-span-2"},e.createElement("label",{className:"block text-sm font-medium text-gray-900"},"Title"),e.createElement("input",{name:"title",value:s.title,onChange:I,placeholder:"e.g., iPad Air 64GB (Blue)",className:"mt-2 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10",required:!0})),e.createElement("div",null,e.createElement("label",{className:"block text-sm font-medium text-gray-900"},"Price"),e.createElement("div",{className:"mt-2 flex items-center rounded-xl border border-gray-300 bg-white px-3 py-2 shadow-sm focus-within:ring-2 focus-within:ring-gray-900/10"},e.createElement("span",{className:"mr-2 text-gray-500"},"$"),e.createElement("input",{name:"price",value:s.price,onChange:P,inputMode:"decimal",placeholder:"0",className:"w-full text-sm text-gray-900 placeholder:text-gray-400 focus:outline-none",required:!0})),s.price&&e.createElement("p",{className:"mt-1 text-xs text-gray-500"},X.format(Number(s.price)||0)))),e.createElement("section",null,e.createElement("label",{className:"block text-sm font-medium text-gray-900"},"Description"),e.createElement("textarea",{name:"description",value:s.description,onChange:I,rows:5,placeholder:"Add key details, usage, defects, pickup options, etc.",className:"mt-2 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10",required:!0})),k&&e.createElement("div",{className:"rounded-xl border border-red-200 bg-red-50 p-3 text-sm text-red-700"},k),e.createElement("div",{className:"flex items-center justify-end gap-2 border-t border-gray-100 pt-4"},e.createElement("button",{type:"button",onClick:()=>y(-1),className:"rounded-xl border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-800 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-900/10"},"Cancel"),e.createElement("button",{type:"submit",disabled:!S||i.some(t=>t.uploading),className:"inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold text-white shadow transition disabled:cursor-not-allowed disabled:opacity-60",style:{backgroundColor:(l==null?void 0:l.primary)||"#6b46c1"}},"Save Changes"))))))}export{Q as default};
