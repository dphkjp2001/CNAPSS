import{a as A,b as L,r as c,R as e,A as $,d as x,c as O,e as B,u as K,L as J}from"./index-1baf5031.js";import"./en-27c7a75d.js";import{a as W,d as q,t as M}from"./posts-ea4b05b3.js";const N="https://api.cnapss.com/api",z=async(l,m="freeboard",r=null)=>{const t=r?`?type=${m}&email=${r}`:`?type=${m}`,s=await fetch(`${N}/comments/${l}${t}`),d=await s.json();if(!s.ok)throw new Error("ÎåìÍ∏Ä Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®");return d},F=async({postId:l,email:m,content:r,parentId:t=null})=>{const s=await fetch(`${N}/comments/${l}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:m,content:r,parentId:t})}),d=await s.json();if(!s.ok)throw new Error(d.message||"ÎåìÍ∏Ä Îì±Î°ù Ïã§Ìå®");return d},G=async({commentId:l,email:m,content:r})=>{const t=await fetch(`${N}/comments/${l}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:m,content:r})}),s=await t.json();if(!t.ok)throw new Error(s.message||"ÎåìÍ∏Ä ÏàòÏ†ï Ïã§Ìå®");return s},H=async({commentId:l,email:m})=>{const r=await fetch(`${N}/comments/${l}`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:m})}),t=await r.json();if(!r.ok)throw new Error(t.message||"ÎåìÍ∏Ä ÏÇ≠Ï†ú Ïã§Ìå®");return t},Q=async({commentId:l,email:m})=>{const r=await fetch(`${N}/comments/${l}/thumb`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:m})}),t=await r.json();if(!r.ok)throw new Error(t.message||"Ï∂îÏ≤ú Ïã§Ìå®");return t};x.extend(O);x.locale("en");function V({postId:l,postAuthorEmail:m}){const{user:r}=A(),{schoolTheme:t}=L(),[s,d]=c.useState([]),[f,w]=c.useState(""),[h,p]=c.useState(null),[E,b]=c.useState(""),[C,i]=c.useState(null),[k,v]=c.useState(""),_=c.useCallback(a=>{const o={};let y=1;return m&&(o[m]=`anonymous${y++}`),a.map(n=>(o[n.email]||(o[n.email]=`anonymous${y++}`),{...n,anonymousId:o[n.email]}))},[m]),u=c.useCallback(async()=>{try{const a=await z(l,"freeboard");d(_(a))}catch(a){console.error("fetchComments failed:",a),alert("Failed to load comments.")}},[l,_]);c.useEffect(()=>{u()},[u]);const P=async()=>{if(f.trim())try{await F({postId:l,email:r.email,content:f}),w(""),u()}catch(a){alert(a.message||"Failed to post comment.")}},U=async a=>{if(k.trim())try{await F({postId:l,email:r.email,content:k,parentId:a}),v(""),i(null),u()}catch(o){alert(o.message||"Failed to post reply.")}},I=async a=>{if(window.confirm("Delete this comment?"))try{await H({commentId:a,email:r.email}),u()}catch(o){alert(o.message||"Failed to delete comment.")}},R=async a=>{if(!E.trim()){p(null);return}try{await G({commentId:a,email:r.email,content:E}),p(null),b(""),u()}catch(o){alert(o.message||"Failed to update comment.")}},T=async a=>{try{await Q({commentId:a,email:r.email}),u()}catch(o){alert(o.message||"Failed to like comment.")}},S=(a,o,y=null)=>{a.key==="Enter"&&!a.shiftKey?(a.preventDefault(),o==="comment"&&P(),o==="reply"&&U(y)):a.key==="Escape"&&(o==="comment"&&w(""),o==="reply"&&(v(""),i(null)))},j=(a=null)=>{const o=s.filter(n=>(n.parentId||null)===a).sort((n,D)=>new Date(n.createdAt)-new Date(D.createdAt));if(!o.length)return null;const y=a!==null;return e.createElement("ul",{className:y?"ml-5 border-l-2 border-gray-200 pl-4 space-y-3":"space-y-4"},o.map(n=>{const D=(r==null?void 0:r.email)===n.email;return e.createElement("li",{key:n._id,className:y?"rounded-xl bg-gray-50 p-3":"border-b border-gray-100 pb-4"},e.createElement("div",{className:"flex items-center gap-2 text-xs text-gray-500"},e.createElement("span",{className:"font-semibold text-gray-800"},n.anonymousId),e.createElement("span",null,"‚Ä¢"),e.createElement("span",null,n.createdAt?x(n.createdAt).fromNow():"")),h===n._id?e.createElement("div",{className:"mt-2 flex items-center gap-2"},e.createElement("input",{value:E,onChange:g=>b(g.target.value),onKeyDown:g=>S(g,"comment"),className:"w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10",placeholder:"Edit your comment",autoFocus:!0}),e.createElement($,{onClick:()=>R(n._id),loadingText:"Saving‚Ä¶",className:"rounded-xl px-3 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:(t==null?void 0:t.primary)||"#6b46c1"}},"Save"),e.createElement("button",{onClick:()=>{p(null),b("")},className:"rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-800 shadow-sm hover:bg-gray-50"},"Cancel")):e.createElement("p",{className:"mt-1 whitespace-pre-wrap text-sm text-gray-800"},n.content),h!==n._id&&e.createElement("div",{className:"mt-2 flex flex-wrap items-center gap-2 text-xs"},e.createElement("button",{onClick:()=>T(n._id),className:"rounded-lg border border-gray-300 bg-white px-2.5 py-1 text-gray-700 shadow-sm hover:bg-gray-50"},"üëç ",n.thumbsUp||0),e.createElement("button",{onClick:()=>i(n._id),className:"rounded-lg border border-gray-300 bg-white px-2.5 py-1 text-gray-700 shadow-sm hover:bg-gray-50"},"‚Ü©Ô∏è Reply"),D&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>{p(n._id),b(n.content)},className:"rounded-lg border border-gray-300 bg-white px-2.5 py-1 text-gray-700 shadow-sm hover:bg-gray-50"},"‚úèÔ∏è Edit"),e.createElement($,{onClick:()=>I(n._id),loadingText:"Deleting‚Ä¶",className:"rounded-lg bg-red-500 px-2.5 py-1 font-medium text-white shadow hover:bg-red-600"},"üóëÔ∏è Delete"))),C===n._id&&e.createElement("div",{className:"mt-3 flex items-center gap-2"},e.createElement("textarea",{rows:2,value:k,onChange:g=>v(g.target.value),onKeyDown:g=>S(g,"reply",n._id),className:"w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10",placeholder:"Write a reply‚Ä¶ (Enter = submit, Shift+Enter = newline, Esc = cancel)"})),j(n._id))}))};return e.createElement("div",{className:"mt-8"},e.createElement("h3",{className:"mb-3 text-lg font-bold text-gray-900"},"üí¨ Comments"),e.createElement("form",{onSubmit:a=>a.preventDefault(),className:"mb-4 flex gap-2"},e.createElement("textarea",{rows:2,value:f,onChange:a=>w(a.target.value),onKeyDown:a=>S(a,"comment"),className:"w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10",placeholder:"Write a comment‚Ä¶ (Enter = submit, Shift+Enter = newline, Esc = clear)"}),e.createElement($,{onClick:P,loadingText:"Posting‚Ä¶",className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:(t==null?void 0:t.primary)||"#6b46c1"}},"Post")),j())}x.extend(O);x.locale("en");function ee(){var C;const{id:l}=B(),m=K(),{user:r}=A(),{schoolTheme:t}=L(),[s,d]=c.useState(null),[f,w]=c.useState(""),h=async()=>{try{const i=await W(l);d(i)}catch(i){w(i.message||"Failed to load the post.")}};c.useEffect(()=>{h()},[l]);const p=c.useMemo(()=>(r==null?void 0:r.email)===(s==null?void 0:s.email),[r,s]),E=async()=>{if(window.confirm("Delete this post?"))try{await q(l,r.email),alert("Post deleted."),m("/freeboard")}catch(i){alert("Delete failed: "+(i.message||"Unknown error"))}},b=async()=>{try{await M(l,r.email),await h()}catch(i){alert("Failed to like: "+(i.message||"Unknown error"))}};return f?e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-red-700",style:{backgroundColor:(t==null?void 0:t.bg)||"#f6f3ff"}},f):s?e.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(t==null?void 0:t.bg)||"#f6f3ff"}},e.createElement("div",{className:"mx-auto max-w-3xl"},e.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},e.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},e.createElement("h1",{className:"text-2xl font-bold text-gray-900"},s.title),e.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",e.createElement("span",{className:"font-medium"},"anonymous")," ‚Ä¢ ",x(s.createdAt).fromNow())),e.createElement("div",{className:"p-5 sm:p-6"},e.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},e.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},s.content)),e.createElement("div",{className:"mt-6 flex flex-wrap items-center gap-3"},e.createElement("button",{onClick:b,className:"rounded-xl border border-gray-300 bg-white px-3 py-1.5 text-sm text-gray-800 shadow-sm hover:bg-gray-50","aria-label":"like post"},"üëç ",((C=s.thumbsUpUsers)==null?void 0:C.length)||0),p&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>m(`/freeboard/edit/${s._id}`),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:(t==null?void 0:t.primary)||"#6b46c1"}},"Edit"),e.createElement("button",{onClick:E,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")),e.createElement(J,{to:"/freeboard",className:"ml-auto text-sm font-medium text-blue-600 underline underline-offset-2"},"‚Üê Back to List")))),(s==null?void 0:s._id)&&e.createElement("div",{className:"mt-6 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm sm:p-6"},e.createElement(V,{postId:s._id,postAuthorEmail:s.email})))):e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-gray-600",style:{backgroundColor:(t==null?void 0:t.bg)||"#f6f3ff"}},"Loading‚Ä¶")}export{ee as default};
