import{u as K,b as ae,g as xe,r as g,R as e,A as Ee,d as T,e as oe,h as we,a as Ce,f as Ne,c as Se,L as ve,i as ke}from"./index-5ad239bc.js";import"./en-31a25268.js";import{d as _e,e as Ie,t as Le}from"./posts-2c0c271e.js";const B="https://api.cnapss.com/api".replace(/\/$/,""),M=l=>({"Content-Type":"application/json",Authorization:`Bearer ${l}`});async function Re({school:l,token:o,postId:h}){const s=String(l||"").toLowerCase().trim(),i=await fetch(`${B}/${s}/comments/${h}`,{headers:M(o)});if(!i.ok)throw new Error("Failed to load comments");return i.json()}async function ne({school:l,token:o,postId:h,content:s,parentId:i=null}){const m=String(l||"").toLowerCase().trim(),u={content:String(s||"").trim()};i&&(u.parentId=String(i));const N=await fetch(`${B}/${m}/comments/${h}`,{method:"POST",headers:M(o),body:JSON.stringify(u)});if(!N.ok)throw new Error("Failed to add comment");return N.json()}async function $e({school:l,token:o,commentId:h,content:s}){const i=String(l||"").toLowerCase().trim(),m=await fetch(`${B}/${i}/comments/${h}`,{method:"PUT",headers:M(o),body:JSON.stringify({content:s})});if(!m.ok)throw new Error("Failed to update comment");return m.json()}async function Ue({school:l,token:o,commentId:h}){const s=String(l||"").toLowerCase().trim(),i=await fetch(`${B}/${s}/comments/${h}`,{method:"DELETE",headers:M(o)});if(!i.ok)throw new Error("Failed to delete comment");return i.json()}async function Pe({school:l,token:o,commentId:h}){const s=String(l||"").toLowerCase().trim(),i=await fetch(`${B}/${s}/comments/${h}/thumbs`,{method:"POST",headers:M(o)});if(!i.ok)throw new Error("Failed to toggle comment like");return i.json()}T.extend(oe);T.locale("en");const p=l=>l==null?"":String(l),O=l=>String(l||"").toLowerCase().trim();function Fe({postId:l,authorEmail:o="",highlightId:h=null}){const{user:s,token:i}=K(),{school:m}=ae(),u=xe(),N=O(s==null?void 0:s.email),f=O(o),[E,x]=g.useState([]),[v,k]=g.useState(!0),[I,L]=g.useState(""),[R,$]=g.useState(""),[_,y]=g.useState(!1),[w,S]=g.useState(!1),[P,F]=g.useState(null),[D,A]=g.useState(""),[z,W]=g.useState(null),[U,j]=g.useState(null),[C,H]=g.useState(""),[re,V]=g.useState(null),[le,q]=g.useState(null),[ie,G]=g.useState(null),[ce,Q]=g.useState(null),X=g.useCallback(async()=>{if(!(!l||!m||!i)){k(!0),L("");try{const t=await Re({school:m,token:i,postId:l});x(Array.isArray(t)?t:[])}catch(t){console.error("comments:load failed",t),L("Failed to load comments."),x([])}finally{k(!1)}}},[l,m,i]);g.useEffect(()=>{X()},[X]),g.useEffect(()=>{if(!(u!=null&&u.emit)||!(u!=null&&u.on)||!l)return;u.emit("post:join",{postId:l});const t=n=>{!n||String(n.postId)!==String(l)||x(a=>a.some(b=>p(b._id)===p(n._id))?a:[...a,n])},r=n=>{!n||String(n.postId)!==String(l)||x(a=>a.map(b=>p(b._id)===p(n._id)?n:b))},d=({_id:n})=>{n&&x(a=>a.filter(b=>p(b._id)!==p(n)))},c=({_id:n,thumbs:a})=>{n&&x(b=>b.map(J=>p(J._id)===p(n)?{...J,thumbsUpUsers:a||[],thumbsCount:(a||[]).length}:J))};return u.on("comment:new",t),u.on("comment:update",r),u.on("comment:delete",d),u.on("comment:thumbs",c),()=>{try{u.emit("post:leave",{postId:l})}catch{}u.off("comment:new",t),u.off("comment:update",r),u.off("comment:delete",d),u.off("comment:thumbs",c)}},[u,l]);const Y=g.useMemo(()=>{const t=new Map;for(const c of E){const n=O(c.email);if(!n)continue;const a=new Date(c.createdAt||0).getTime();t.has(n)?t.set(n,Math.min(t.get(n),a)):t.set(n,a)}const r=Array.from(t.keys()).filter(c=>c&&c!==f);r.sort((c,n)=>(t.get(c)||0)-(t.get(n)||0));const d=new Map;return f&&d.set(f,"anonymous (게시자)"),r.forEach((c,n)=>d.set(c,`anonymous ${n+1}`)),d},[E,f]),me=g.useCallback(t=>Y.get(O(t))||"anonymous",[Y]),Z=g.useMemo(()=>{const t=(E||[]).map(a=>({...a,_id:p(a._id),parentId:a.parentId?p(a.parentId):null,children:[]})),r=new Map;t.forEach(a=>r.set(a._id,a));const d=[];t.forEach(a=>{const b=a.parentId?p(a.parentId):"";b&&r.has(b)?r.get(b).children.push(a):d.push(a)});const c=(a,b)=>new Date(a.createdAt)-new Date(b.createdAt),n=a=>{a.sort(c),a.forEach(b=>n(b.children))};return n(d),d},[E]);g.useEffect(()=>{if(!h||v)return;const t=String(h),d=requestAnimationFrame(()=>{const c=document.getElementById(`comment-${t}`);if(c){try{c.scrollIntoView({behavior:"smooth",block:"center"})}catch{c.scrollIntoView()}Q(t);const n=setTimeout(()=>Q(null),1800);return()=>clearTimeout(n)}});return()=>cancelAnimationFrame(d)},[h,v,E]);const de=(t,r)=>x(d=>d.map(c=>p(c._id)===p(t)?r:c)),ue=t=>x(r=>{const d=p(t),c=new Set([d]);let n=!0;for(;n;)n=!1,r.forEach(a=>{const b=a.parentId?p(a.parentId):"";b&&c.has(b)&&!c.has(p(a._id))&&(c.add(p(a._id)),n=!0)});return r.filter(a=>!c.has(p(a._id)))}),ee=async()=>{const t=R.trim();if(t){y(!0);try{const r=await ne({school:m,token:i,postId:l,content:t});x(d=>[...d,r]),$("")}catch(r){console.error("comments:add root failed",r),alert("Failed to add comment.")}finally{y(!1)}}},ge=()=>{F(null),A("")},pe=async t=>{const r=D.trim();if(!r)return;const d=p(t);W(d);try{const c=await ne({school:m,token:i,postId:l,content:r,parentId:d});x(n=>[...n,c]),ge()}catch(c){console.error("comments:add reply failed",c),alert("Failed to add reply.")}finally{W(null)}},he=t=>{j(p(t._id)),H(t.content||"")},te=()=>{j(null),H("")},fe=async()=>{const t=C.trim();if(!(!t||!U)){V(U);try{const r=await $e({school:m,token:i,commentId:U,content:t});de(U,{...r,_id:p(r._id),parentId:r.parentId?p(r.parentId):null}),te()}catch(r){console.error("comments:update failed",r),alert("Failed to update comment.")}finally{V(null)}}},ye=async t=>{if(!window.confirm("Delete this comment? Replies will also be removed in the list view."))return;const r=p(t);q(r);try{await Ue({school:m,token:i,commentId:r}),ue(r)}catch(d){console.error("comments:delete failed",d),alert("Failed to delete comment.")}finally{q(null)}},be=async t=>{const r=p(t);G(r);try{const d=await Pe({school:m,token:i,commentId:r});x(c=>c.map(n=>{var a;return p(n._id)===r?{...n,thumbsUpUsers:d.thumbs??[],thumbsCount:d.count??(((a=d.thumbs)==null?void 0:a.length)||0)}:n}))}catch(d){console.error("comments:thumb toggle failed",d)}finally{G(null)}};return!s||!i?e.createElement("div",{className:"mt-6 rounded-xl border border-gray-200 bg-white p-4 text-sm text-gray-600"},"Please log in to view and write comments."):e.createElement("div",{className:"mt-8"},e.createElement("h3",{className:"mb-3 text-lg font-semibold text-gray-900"},"Comments"),e.createElement("div",{className:"mb-4 rounded-xl border border-gray-200 bg-white p-3 shadow-sm"},e.createElement("textarea",{value:R,onChange:t=>$(t.target.value),onCompositionStart:()=>S(!0),onCompositionEnd:()=>S(!1),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&!w&&(t.preventDefault(),ee())},placeholder:"Write a comment…",className:"h-20 w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),e.createElement("div",{className:"mt-2 text-right"},e.createElement(Ee,{disabled:_,onClick:ee,className:"rounded-lg bg-gray-900 px-3 py-2 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},_?"Posting…":"Post"))),e.createElement("div",{className:"rounded-xl border border-gray-200 bg-white p-2 sm:p-3"},v?e.createElement("div",{className:"p-3 text-sm text-gray-600"},"Loading…"):I?e.createElement("div",{className:"rounded-lg bg-red-50 p-3 text-sm text-red-700"},I):Z.length===0?e.createElement("div",{className:"p-3 text-sm text-gray-600"},"No comments yet."):e.createElement("ul",{className:"space-y-3"},Z.map(t=>e.createElement(se,{key:t._id,node:t,me:N,getLabel:me,replyingId:P,replyText:D,postingReplyId:z,editingId:U,editText:C,savingId:re,deletingId:le,likingId:ie,onStartReply:r=>F(p(r)),onCancelReply:()=>{F(null),A("")},onChangeReply:A,onSubmitReply:pe,onStartEdit:he,onCancelEdit:te,onChangeEdit:H,onSaveEdit:fe,onDelete:ye,onToggleLike:be,flashId:ce})))))}function se(l){var j;const{node:o,me:h,getLabel:s,replyingId:i,replyText:m,postingReplyId:u,editingId:N,editText:f,savingId:E,deletingId:x,likingId:v,onStartReply:k,onCancelReply:I,onChangeReply:L,onSubmitReply:R,onStartEdit:$,onCancelEdit:_,onChangeEdit:y,onSaveEdit:w,onDelete:S,onToggleLike:P,flashId:F}=l,D=o.thumbs??o.thumbsUpUsers??[],A=D.map(C=>String(C||"").toLowerCase()).includes(h),z=o.thumbsCount??D.length,U=String(F||"")===String(o._id)?"bg-yellow-50 ring-2 ring-yellow-300 rounded-lg p-2 transition-colors":"";return e.createElement("li",null,e.createElement("div",{id:`comment-${o._id}`,className:`flex items-start gap-3 ${U}`},e.createElement("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gray-200"}),e.createElement("div",{className:"min-w-0 flex-1"},e.createElement("div",{className:"flex items-center gap-2"},e.createElement("span",{className:"text-sm font-medium text-gray-900"},s(o.email)),e.createElement("span",{className:"text-xs text-gray-500"},"• ",T(o.createdAt).fromNow())),N===o._id?e.createElement("div",{className:"mt-2"},e.createElement("textarea",{value:f,onChange:C=>y(C.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),e.createElement("div",{className:"mt-2 flex gap-2"},e.createElement("button",{onClick:w,disabled:E===o._id,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},E===o._id?"Saving…":"Save"),e.createElement("button",{onClick:_,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))):e.createElement("p",{className:"mt-1 whitespace-pre-wrap break-words text-sm text-gray-800"},o.content),e.createElement("div",{className:"mt-2 flex items-center gap-3 text-xs text-gray-600"},e.createElement("button",{onClick:()=>P(o._id),disabled:v===o._id,className:`rounded px-2 py-1 ${A?"bg-blue-50 text-blue-600":"hover:bg-gray-100"} disabled:opacity-60`},"👍 ",z),e.createElement("button",{onClick:()=>k(o._id),className:"rounded px-2 py-1 hover:bg-gray-100"},"Reply"),String(o.email||"").toLowerCase()===h&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>$(o),className:"rounded px-2 py-1 hover:bg-gray-100"},"Edit"),e.createElement("button",{onClick:()=>S(o._id),disabled:x===o._id,className:"rounded px-2 py-1 text-red-600 hover:bg-red-50 disabled:opacity-60"},x===o._id?"Deleting…":"Delete"))),((j=o.children)==null?void 0:j.length)>0&&e.createElement("ul",{className:"mt-3 space-y-3 border-l-2 border-gray-200 pl-6"},o.children.map(C=>e.createElement(se,{key:C._id,node:C,me:h,getLabel:s,replyingId:i,replyText:m,postingReplyId:u,editingId:N,editText:f,savingId:E,deletingId:x,likingId:v,onStartReply:k,onCancelReply:I,onChangeReply:L,onSubmitReply:R,onStartEdit:$,onCancelEdit:_,onChangeEdit:y,onSaveEdit:w,onDelete:S,onToggleLike:P,flashId:F}))))),i===o._id&&e.createElement("div",{className:"ml-11 mt-2"},e.createElement("textarea",{value:m,onChange:C=>L(C.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10",placeholder:"Write a reply…"}),e.createElement("div",{className:"mt-2 flex gap-2"},e.createElement("button",{onClick:()=>R(o._id),disabled:u===o._id,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},u===o._id?"Posting…":"Reply"),e.createElement("button",{onClick:I,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))))}T.extend(oe);T.locale("en");function je(){var _;const{id:l}=we(),o=Ce(),h=Ne(),{user:s}=K(),{school:i,schoolTheme:m}=ae(),u=Se(),{token:N}=K(),[f,E]=g.useState(null),[x,v]=g.useState(""),k=async()=>{try{const y=await _e({school:i,token:N,id:l});E(y)}catch(y){v(y.message||"Failed to load the post.")}};g.useEffect(()=>{k()},[l,i]),g.useEffect(()=>{const w=new URLSearchParams(h.search).get("nid");async function S(){if(!(!w||!(s!=null&&s.email)||!i))try{const P="https://api.cnapss.com/api".replace(/\/+$/,"");await ke(`${P}/${i}/notification/mark-read`,{method:"POST",headers:{"Content-Type":"application/json"},body:{commentId:w,email:s.email}})}catch{}}S()},[h.search,s==null?void 0:s.email,i]);const I=g.useMemo(()=>{const y=h.hash||"",w=y.startsWith("#comment-")?y.slice(9):null,S=new URLSearchParams(h.search).get("nid");return w||S||null},[h.hash,h.search]),L=g.useMemo(()=>(s==null?void 0:s.email)===(f==null?void 0:f.email),[s,f]),R=async()=>{if(window.confirm("Delete this post?"))try{await Ie(l,s.email,i),alert("Post deleted."),o(u("/freeboard"))}catch(y){alert("Delete failed: "+(y.message||"Unknown error"))}},$=async()=>{try{await Le({school:i,token:N,id:f._id}),E(y=>y&&{...y,thumbsUpUsers:(y.thumbsUpUsers||[]).includes(((s==null?void 0:s.email)||"").toLowerCase())?y.thumbsUpUsers.filter(w=>w.toLowerCase()!==((s==null?void 0:s.email)||"").toLowerCase()):[...y.thumbsUpUsers||[],((s==null?void 0:s.email)||"").toLowerCase()]}),await k()}catch(y){alert("Failed to like: "+(y.message||"Unknown error"))}};return x?e.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-red-700",style:{backgroundColor:(m==null?void 0:m.bg)||"#f6f3ff"}},x):f?e.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(m==null?void 0:m.bg)||"#f6f3ff"}},e.createElement("div",{className:"mx-auto max-w-3xl"},e.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},e.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},e.createElement("h1",{className:"text-2xl font-bold text-gray-900"},f.title),e.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",e.createElement("span",{className:"font-medium"},"anonymous")," • ",T(f.createdAt).fromNow())),e.createElement("div",{className:"p-5 sm:p-6"},e.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},e.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},f.content)),e.createElement("div",{className:"mt-6 flex flex-wrap items-center gap-3"},e.createElement("button",{onClick:$,className:"rounded-xl border border-gray-300 bg-white px-3 py-1.5 text-sm text-gray-800 shadow-sm hover:bg-gray-50","aria-label":"like post"},"👍 ",((_=f.thumbsUpUsers)==null?void 0:_.length)||0),L&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>o(u(`/freeboard/edit/${f._id}`)),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:(m==null?void 0:m.primary)||"#6b46c1"}},"Edit"),e.createElement("button",{onClick:R,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")),e.createElement(ve,{to:u("/freeboard"),className:"ml-auto text-sm font-medium text-blue-600 underline underline-offset-2"},"← Back to List")))),(f==null?void 0:f._id)&&e.createElement("div",{className:"mt-6 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm sm:p-6"},e.createElement(Fe,{postId:f._id,authorEmail:f.email,highlightId:I})))):e.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-gray-600",style:{backgroundColor:(m==null?void 0:m.bg)||"#f6f3ff"}},"Loading…")}export{je as default};
