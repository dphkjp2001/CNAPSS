import{e as T,u as W,a as q,c as G,b as J,d as K,r,R as a,L as Q}from"./index-d226040e.js";import{C as X}from"./CommentSection-17a11e1d.js";import{d as S,r as Z}from"./relativeTime-388ce8f8.js";import{d as ee,e as te,f as ae,v as ne,u as oe}from"./academicPosts-08304d57.js";import{a as se}from"./http-a6fe908c.js";import"./useLoginGate-9dd25366.js";S.extend(Z);S.locale("en");function ue(){const{id:y}=T(),F=W(),f=q(),{user:o,token:k}=G(),{school:l,schoolTheme:d}=J(),P=K(),[n,C]=r.useState(null),[L,V]=r.useState(""),[h,N]=r.useState(!1),[U,x]=r.useState(""),[D,b]=r.useState(""),[I,R]=r.useState(!1),M=!!(o!=null&&o.email||k&&String(k).length>0),[w,g]=r.useState(0),[v,p]=r.useState(0),[m,E]=r.useState(null),$=w-v,j=async()=>{V("");try{const e=await ee({school:l,id:y});C(e),x((e==null?void 0:e.title)||""),b((e==null?void 0:e.content)||""),g((e==null?void 0:e.upCount)||0),p((e==null?void 0:e.downCount)||0)}catch(e){if((e==null?void 0:e.status)!==404){V((e==null?void 0:e.message)||"Failed to load the post.");return}}if(M)try{const e=await te({school:l,id:y});C(e),x((e==null?void 0:e.title)||""),b((e==null?void 0:e.content)||""),g((e==null?void 0:e.upCount)||0),p((e==null?void 0:e.downCount)||0),E((e==null?void 0:e.myVote)||null)}catch{}};r.useEffect(()=>{!l||!y||j()},[y,l,M]),r.useEffect(()=>{const s=new URLSearchParams(f.search).get("nid");async function t(){if(!(!s||!(o!=null&&o.email)||!l))try{const i="https://api.cnapss.com/api".replace(/\/+$/,"");await se(`${i}/${l}/notification/mark-read`,{method:"POST",headers:{"Content-Type":"application/json"},body:{commentId:s,email:o.email}})}catch{}}t()},[f.search,o==null?void 0:o.email,l]);const A=r.useMemo(()=>{const e=f.hash||"",s=e.startsWith("#comment-")?e.slice(9):null,t=new URLSearchParams(f.search).get("nid");return s||t||null},[f.hash,f.search]),u=r.useMemo(()=>{var c,B;const e=n,s=o;if(!e||!s)return!1;const t=[s.id,s._id].filter(Boolean).map(String);return[e.userId,e.authorId,(c=e.author)==null?void 0:c._id,(B=e.author)==null?void 0:B.id].filter(Boolean).map(String).some(O=>t.includes(O))},[o,n]),z=async()=>{if(window.confirm("Delete this post?"))try{await ae({school:l,id:n._id}),alert("Post deleted."),F(P("/dashboard?tab=free"))}catch(e){alert("Delete failed: "+((e==null?void 0:e.message)||"Unknown error"))}},Y=e=>{const s={upCount:w,downCount:v,myVote:m};let t=w,i=v,c=m;return e==="up"?m==="up"?(t-=1,c=null):m==="down"?(i-=1,t+=1,c="up"):(t+=1,c="up"):m==="down"?(i-=1,c=null):m==="up"?(t-=1,i+=1,c="down"):(i+=1,c="down"),g(t),p(i),E(c),s},_=async e=>{if(!o){alert("Please log in to vote.");return}if(u)return;const s=Y(e);try{const t=await ne({school:l,id:n._id,dir:e});typeof(t==null?void 0:t.upCount)=="number"&&g(t.upCount),typeof(t==null?void 0:t.downCount)=="number"&&p(t.downCount),typeof(t==null?void 0:t.myVote)<"u"&&E(t.myVote)}catch(t){g(s.upCount),p(s.downCount),E(s.myVote),alert("Vote failed: "+((t==null?void 0:t.message)||"Unknown error"))}},H=async()=>{const e=U.trim(),s=D.trim();if(!(!e||!s)){R(!0);try{const t=await oe({school:l,id:n._id,title:e,content:s}),i=(t==null?void 0:t.post)||t;C(i),N(!1)}catch(t){alert("Update failed: "+((t==null?void 0:t.message)||"Unknown error"))}finally{R(!1)}}};return L?a.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-red-700",style:{backgroundColor:(d==null?void 0:d.bg)||"#f6f3ff"}},L):n?a.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(d==null?void 0:d.bg)||"#f6f3ff"}},a.createElement("div",{className:"mx-auto max-w-3xl"},a.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},a.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},h?a.createElement("input",{value:U,onChange:e=>x(e.target.value),placeholder:"Title",className:"w-full rounded-xl border border-gray-300 px-3 py-2 text-lg font-semibold text-gray-900 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):a.createElement("h1",{className:"text-2xl font-bold text-gray-900"},n.title),a.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",a.createElement("span",{className:"font-medium"},"anonymous")," • ",S(n.createdAt).fromNow())),a.createElement("div",{className:"p-5 sm:p-6"},h?a.createElement("textarea",{value:D,onChange:e=>b(e.target.value),placeholder:"Content",className:"h-56 w-full resize-y rounded-xl border border-gray-300 px-3 py-2 text-sm text-gray-800 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):a.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},a.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},n.content)),a.createElement("div",{className:"mt-6 flex flex-wrap items-center gap-3"},a.createElement("div",{className:"flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-2 py-1"},a.createElement("button",{onClick:()=>_("up"),disabled:!o||u,className:`flex items-center gap-1 rounded-md px-3 py-1 text-sm font-semibold ${m==="up"?"text-blue-600":"text-gray-800 hover:bg-gray-100"} disabled:opacity-60`,"aria-label":"Upvote",title:o?u?"You can’t vote on your own post.":"Upvote":"Log in to vote"},a.createElement("svg",{className:"w-4 h-4",viewBox:"0 0 20 20",fill:"currentColor"},a.createElement("path",{fillRule:"evenodd",d:"M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z",clipRule:"evenodd"})),a.createElement("span",null,w)),a.createElement("button",{onClick:()=>_("down"),disabled:!o||u,className:`flex items-center gap-1 rounded-md px-3 py-1 text-sm font-semibold ${m==="down"?"text-red-600":"text-gray-800 hover:bg-gray-100"} disabled:opacity-60`,"aria-label":"Downvote",title:o?u?"You can’t vote on your own post.":"Downvote":"Log in to vote"},a.createElement("svg",{className:"w-4 h-4",viewBox:"0 0 20 20",fill:"currentColor"},a.createElement("path",{fillRule:"evenodd",d:"M16.707 10.293a1 1 0 010 1.414l-6 6a1 1 0 01-1.414 0l-6-6a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l4.293-4.293a1 1 0 011.414 0z",clipRule:"evenodd"})),a.createElement("span",null,v)),a.createElement("span",{className:"ml-2 text-sm font-medium text-gray-700"},"Score: ",$)),u&&!h&&a.createElement(a.Fragment,null,a.createElement("button",{onClick:()=>N(!0),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:"#6b46c1"}},"Edit"),a.createElement("button",{onClick:z,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")),u&&h&&a.createElement(a.Fragment,null,a.createElement("button",{onClick:H,disabled:I,className:"rounded-xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-black disabled:opacity-60"},I?"Saving…":"Save"),a.createElement("button",{onClick:()=>{x((n==null?void 0:n.title)||""),b((n==null?void 0:n.content)||""),N(!1)},className:"rounded-xl border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-800 shadow-sm hover:bg-gray-50"},"Cancel")),a.createElement(Q,{to:P("/dashboard?tab=free"),className:"ml-auto text-sm font-medium text-blue-600 underline underline-offset-2"},"← Back to List")))),(n==null?void 0:n._id)&&a.createElement("div",{className:"mt-6 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm sm:p-6"},a.createElement(X,{postId:n._id,authorEmail:n.email,highlightId:A,anonymousMode:!0})))):a.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-gray-600",style:{backgroundColor:(d==null?void 0:d.bg)||"#f6f3ff"}},"Loading…")}export{ue as default};
