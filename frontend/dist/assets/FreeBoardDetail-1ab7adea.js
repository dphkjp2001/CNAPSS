import{e as Q,u as X,a as Z,c as ee,b as te,d as ae,r,R as a,L as oe}from"./index-30f5175c.js";import{C as ne}from"./CommentSection-e5c66379.js";import{d as k,r as se}from"./relativeTime-31e75a13.js";import{a as re,b as le,d as ie,v as ce,u as de}from"./posts-11cdb806.js";import{a as me}from"./http-a6fe908c.js";import"./useLoginGate-c2aa5c70.js";k.extend(se);k.locale("en");function xe(){const{id:h}=Q(),A=X(),u=Z(),{user:s,token:P}=ee(),{school:i,schoolTheme:c}=te(),L=ae(),[o,C]=r.useState(null),[U,D]=r.useState(""),[p,N]=r.useState(!1),[M,x]=r.useState(""),[V,b]=r.useState(""),[I,_]=r.useState(!1),B=!!(s!=null&&s.email||P&&String(P).length>0),[w,g]=r.useState(0),[E,y]=r.useState(0),[m,v]=r.useState(null),Y=w-E,z=async()=>{D("");try{const e=await re({school:i,id:h});C(e),x((e==null?void 0:e.title)||""),b((e==null?void 0:e.content)||""),g((e==null?void 0:e.upCount)||0),y((e==null?void 0:e.downCount)||0)}catch(e){if((e==null?void 0:e.status)!==404){D((e==null?void 0:e.message)||"Failed to load the post.");return}}if(B)try{const e=await le({school:i,id:h});C(e),x((e==null?void 0:e.title)||""),b((e==null?void 0:e.content)||""),g((e==null?void 0:e.upCount)||0),y((e==null?void 0:e.downCount)||0),v((e==null?void 0:e.myVote)||null)}catch{}};r.useEffect(()=>{!i||!h||z()},[h,i,B]),r.useEffect(()=>{const n=new URLSearchParams(u.search).get("nid");async function t(){if(!(!n||!(s!=null&&s.email)||!i))try{const l="https://api.cnapss.com/api".replace(/\/+$/,"");await me(`${l}/${i}/notification/mark-read`,{method:"POST",headers:{"Content-Type":"application/json"},body:{commentId:n,email:s.email}})}catch{}}t()},[u.search,s==null?void 0:s.email,i]);const H=r.useMemo(()=>{const e=u.hash||"",n=e.startsWith("#comment-")?e.slice(9):null,t=new URLSearchParams(u.search).get("nid");return n||t||null},[u.hash,u.search]),f=r.useMemo(()=>{var R,$,j;const e=o,n=s;if(!e||!n)return!1;const t=String(n.email||"").toLowerCase(),l=[n.id,n._id].filter(Boolean).map(String),d=[e.email,e.authorEmail,e.userEmail,(R=e.author)==null?void 0:R.email].filter(Boolean).map(S=>String(S).toLowerCase()),q=[e.userId,e.authorId,($=e.author)==null?void 0:$._id,(j=e.author)==null?void 0:j.id].filter(Boolean).map(String),G=t&&d.includes(t),J=q.some(S=>l.includes(S)),K=!!e.isMine;return G||J||K},[s,o]),O=async()=>{if(window.confirm("Delete this post?"))try{await ie({school:i,id:o._id}),alert("Post deleted."),A(L("/dashboard?tab=free"))}catch(e){alert("Delete failed: "+((e==null?void 0:e.message)||"Unknown error"))}},T=e=>{const n={upCount:w,downCount:E,myVote:m};let t=w,l=E,d=m;return e==="up"?m==="up"?(t-=1,d=null):m==="down"?(l-=1,t+=1,d="up"):(t+=1,d="up"):m==="down"?(l-=1,d=null):m==="up"?(t-=1,l+=1,d="down"):(l+=1,d="down"),g(t),y(l),v(d),n},F=async e=>{if(!s){alert("Please log in to vote.");return}const n=T(e);try{const t=await ce({school:i,id:o._id,dir:e});typeof(t==null?void 0:t.upCount)=="number"&&g(t.upCount),typeof(t==null?void 0:t.downCount)=="number"&&y(t.downCount),typeof(t==null?void 0:t.myVote)<"u"&&v(t.myVote)}catch(t){g(n.upCount),y(n.downCount),v(n.myVote),alert("Vote failed: "+((t==null?void 0:t.message)||"Unknown error"))}},W=async()=>{const e=M.trim(),n=V.trim();if(!(!e||!n)){_(!0);try{const t=await de({school:i,id:o._id,title:e,content:n}),l=(t==null?void 0:t.post)||t;C(l),N(!1)}catch(t){alert("Update failed: "+((t==null?void 0:t.message)||"Unknown error"))}finally{_(!1)}}};return U?a.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-red-700",style:{backgroundColor:(c==null?void 0:c.bg)||"#f6f3ff"}},U):o?a.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(c==null?void 0:c.bg)||"#f6f3ff"}},a.createElement("div",{className:"mx-auto max-w-3xl"},a.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},a.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},p?a.createElement("input",{value:M,onChange:e=>x(e.target.value),placeholder:"Title",className:"w-full rounded-xl border border-gray-300 px-3 py-2 text-lg font-semibold text-gray-900 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):a.createElement("h1",{className:"text-2xl font-bold text-gray-900"},o.title),a.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",a.createElement("span",{className:"font-medium"},"anonymous")," ‚Ä¢"," ",k(o.createdAt).fromNow())),a.createElement("div",{className:"p-5 sm:p-6"},p?a.createElement("textarea",{value:V,onChange:e=>b(e.target.value),placeholder:"Content",className:"h-56 w-full resize-y rounded-xl border border-gray-300 px-3 py-2 text-sm text-gray-800 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):a.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},a.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},o.content)),a.createElement("div",{className:"mt-6 flex flex-wrap items-center gap-3"},a.createElement("div",{className:"flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-2 py-1"},a.createElement("button",{onClick:()=>F("up"),disabled:!s||f,className:`rounded-md px-3 py-1 text-sm font-semibold ${m==="up"?"bg-green-600 text-white":"bg-gray-100 text-gray-800 hover:bg-gray-200"} disabled:opacity-60`,title:s?f?"You can‚Äôt vote on your own post.":"Upvote":"Log in to vote","aria-label":"Upvote"},"üëç ",w),a.createElement("button",{onClick:()=>F("down"),disabled:!s||f,className:`rounded-md px-3 py-1 text-sm font-semibold ${m==="down"?"bg-red-600 text-white":"bg-gray-100 text-gray-800 hover:bg-gray-200"} disabled:opacity-60`,title:s?f?"You can‚Äôt vote on your own post.":"Downvote":"Log in to vote","aria-label":"Downvote"},"üëé ",E),a.createElement("span",{className:"ml-2 text-sm font-medium text-gray-700"},"Score: ",Y)),f&&!p&&a.createElement(a.Fragment,null,a.createElement("button",{onClick:()=>N(!0),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:"#6b46c1"}},"Edit"),a.createElement("button",{onClick:O,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")),f&&p&&a.createElement(a.Fragment,null,a.createElement("button",{onClick:W,disabled:I,className:"rounded-xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-black disabled:opacity-60"},I?"Saving‚Ä¶":"Save"),a.createElement("button",{onClick:()=>{x((o==null?void 0:o.title)||""),b((o==null?void 0:o.content)||""),N(!1)},className:"rounded-xl border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-800 shadow-sm hover:bg-gray-50"},"Cancel")),a.createElement(oe,{to:L("/dashboard?tab=free"),className:"ml-auto text-sm font-medium text-blue-600 underline underline-offset-2"},"‚Üê Back to List")))),(o==null?void 0:o._id)&&a.createElement("div",{className:"mt-6 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm sm:p-6"},a.createElement(ne,{postId:o._id,authorEmail:o.email,highlightId:H,anonymousMode:!0})))):a.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-gray-600",style:{backgroundColor:(c==null?void 0:c.bg)||"#f6f3ff"}},"Loading‚Ä¶")}export{xe as default};
