import{u as pe,a as ye,k as be,r as c,R as n,A as te}from"./index-1bcd2688.js";import{d as Y,r as he}from"./relativeTime-22b41f1c.js";import"./en-a5236f17.js";import{u as xe}from"./useLoginGate-77c58ffc.js";const R="https://api.cnapss.com/api".replace(/\/$/,""),U=e=>({"Content-Type":"application/json",Authorization:`Bearer ${e}`});async function Ee({school:e,token:f,postId:d}){const i=String(e||"").toLowerCase().trim(),r=await fetch(`${R}/${i}/comments/${d}`,{headers:U(f)});if(!r.ok)throw new Error("Failed to load comments");return r.json()}async function ee({school:e,token:f,postId:d,content:i,parentId:r=null}){const g=String(e||"").toLowerCase().trim(),s={content:String(i||"").trim()};r&&(s.parentId=String(r));const x=await fetch(`${R}/${g}/comments/${d}`,{method:"POST",headers:U(f),body:JSON.stringify(s)});if(!x.ok)throw new Error("Failed to add comment");return x.json()}async function we({school:e,token:f,commentId:d,content:i}){const r=String(e||"").toLowerCase().trim(),g=await fetch(`${R}/${r}/comments/${d}`,{method:"PUT",headers:U(f),body:JSON.stringify({content:i})});if(!g.ok)throw new Error("Failed to update comment");return g.json()}async function Ne({school:e,token:f,commentId:d}){const i=String(e||"").toLowerCase().trim(),r=await fetch(`${R}/${i}/comments/${d}`,{method:"DELETE",headers:U(f)});if(!r.ok)throw new Error("Failed to delete comment");return r.json()}async function Se({school:e,token:f,commentId:d}){const i=String(e||"").toLowerCase().trim(),r=await fetch(`${R}/${i}/comments/${d}/thumbs`,{method:"POST",headers:U(f)});if(!r.ok)throw new Error("Failed to toggle comment like");return r.json()}Y.extend(he);Y.locale("en");const m=e=>e==null?"":String(e),S=e=>String(e||"").toLowerCase().trim();function $e({postId:e,authorEmail:f="",highlightId:d=null}){const{user:i,token:r}=pe(),{school:g}=ye(),s=be(),{ensureAuth:x}=xe(),C=S(i==null?void 0:i.email),b=S(f),[E,h]=c.useState([]),[O,_]=c.useState(!0),[k,$]=c.useState(""),[L,T]=c.useState(""),[F,P]=c.useState(!1),[z,j]=c.useState(!1),[w,v]=c.useState(null),[A,B]=c.useState(""),[J,D]=c.useState(null),[p,K]=c.useState(null),[ae,I]=c.useState(""),[oe,G]=c.useState(null),[re,H]=c.useState(null),[se,V]=c.useState(null),[le,q]=c.useState(d||null),Q=c.useCallback(async()=>{if(!(!e||!g)){_(!0),$("");try{const t=await Ee({school:g,token:r,postId:e});h(Array.isArray(t)?t:[])}catch(t){console.error("comments:load failed",t),$("Failed to load comments."),h([])}finally{_(!1)}}},[e,g,r]);c.useEffect(()=>{Q()},[Q]),c.useEffect(()=>{if(!(s!=null&&s.emit)||!(s!=null&&s.on)||!e)return;s.emit("post:join",{postId:e});const t=a=>{!a||String(a.postId)!==String(e)||h(y=>y.some(N=>m(N._id)===m(a._id))?y:[...y,a])},l=a=>{!a||String(a.postId)!==String(e)||h(y=>y.map(N=>m(N._id)===m(a._id)?a:N))},u=({_id:a})=>{a&&h(y=>y.filter(N=>m(N._id)!==m(a)))},o=({_id:a,thumbs:y})=>{a&&h(N=>N.map(W=>m(W._id)===m(a)?{...W,thumbsUpUsers:y||[],thumbsCount:(y||[]).length}:W))};return s.on("comment:new",t),s.on("comment:update",l),s.on("comment:delete",u),s.on("comment:thumbs",o),()=>{try{s.emit("post:leave",{postId:e})}catch{}s.off("comment:new",t),s.off("comment:update",l),s.off("comment:delete",u),s.off("comment:thumbs",o)}},[s,e]);const X=c.useMemo(()=>{const t=new Map;for(const o of E){const a=S(o.email);if(!a)continue;const y=new Date(o.createdAt||0).getTime();t.has(a)?t.set(a,Math.min(t.get(a),y)):t.set(a,y)}const l=Array.from(t.keys()).filter(o=>o&&o!==b);l.sort((o,a)=>(t.get(o)||0)-(t.get(a)||0));const u=new Map;return b&&u.set(b,"anonymous (OP)"),l.forEach((o,a)=>u.set(o,`anonymous ${a+1}`)),u},[E,b]),me=c.useCallback(t=>X.get(S(t))||"anonymous",[X]);c.useEffect(()=>{if(!d)return;q(d);const t=setTimeout(()=>q(null),1500);return()=>clearTimeout(t)},[d]);const{roots:ce,childrenMap:ie}=c.useMemo(()=>{const t=(E||[]).map(o=>({...o,_id:m(o._id),parentId:m(o.parentId)||null})),l=new Map,u=[];for(const o of t){o.parentId||u.push(o);const a=l.get(o.parentId||"__root__")||[];a.push(o),l.set(o.parentId||"__root__",a)}return{roots:u,childrenMap:l}},[E]),M=()=>!i||!r?(x(),!1):!0,Z=async()=>{const t=L.trim();if(t&&M()){P(!0);try{await ee({school:g,token:r,postId:e,content:t,parentId:null}),T("")}catch(l){console.error("comments:add root failed",l),alert("Failed to add comment.")}finally{P(!1)}}},de=async t=>{const l=A.trim();if(!l||!M())return;const u=m(t);D(u);try{await ee({school:g,token:r,postId:e,content:l,parentId:u}),v(null),B("")}catch(o){console.error("comments:add reply failed",o),alert("Failed to add reply.")}finally{D(null)}},ue=async()=>{const t=ae.trim();if(!(!t||!p)&&M()){G(p);try{await we({school:g,token:r,commentId:p,content:t}),K(null),I("")}catch(l){console.error("comments:update failed",l),alert("Failed to update comment.")}finally{G(null)}}},fe=async t=>{if(!M()||!window.confirm("Delete this comment?"))return;const l=m(t);H(l);try{await Ne({school:g,token:r,commentId:l})}catch(u){console.error("comments:delete failed",u),alert("Failed to delete comment.")}finally{H(null)}},ge=async(t,l)=>{if(!M()||S(l)===C)return;const u=m(t);V(u);try{await Se({school:g,token:r,commentId:u})}catch(o){console.error("comments:thumb toggle failed",o)}finally{V(null)}};return n.createElement("div",{className:"mt-8"},n.createElement("h3",{className:"mb-3 text-lg font-semibold text-gray-900"},"Comments"),n.createElement("div",{className:"mb-4 rounded-xl border bg-white p-3 shadow-sm"},n.createElement("textarea",{value:L,onChange:t=>T(t.target.value),onCompositionStart:()=>j(!0),onCompositionEnd:()=>j(!1),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&!z&&(t.preventDefault(),Z())},placeholder:"Write a comment…",className:"h-20 w-full resize-none rounded-lg border px-3 py-2 text-sm"}),n.createElement("div",{className:"mt-2 flex items-center justify-between"},!i&&n.createElement("span",{className:"text-xs text-gray-500"},"You’ll be asked to log in when you post."),n.createElement(te,{disabled:F,onClick:Z,className:"rounded-lg bg-gray-900 px-3 py-2 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},F?"Posting…":"Post"))),n.createElement("div",{className:"rounded-xl border bg-white p-2 sm:p-3"},O?n.createElement("div",{className:"p-3 text-sm text-gray-600"},"Loading…"):k?n.createElement("div",{className:"rounded-lg bg-red-50 p-3 text-sm text-red-700"},k):E.length===0?n.createElement("div",{className:"p-3 text-sm text-gray-600"},"No comments yet."):n.createElement("ul",{className:"space-y-3"},ce.map(t=>n.createElement(ne,{key:m(t._id),node:t,depth:0,me:C,labelOf:me,childrenMap:ie,replyingId:w,replyText:A,postingReplyId:J,setReplyingId:v,setReplyText:B,submitReply:de,onToggleLike:ge,likingId:se,deletingId:re,savingId:oe,onStartEdit:l=>{K(m(l._id)),I(l.content||"")},onCancelEdit:()=>{K(null),I("")},onChangeEdit:I,onSaveEdit:ue,onDelete:fe,editingId:p,flashId:le,isAuthed:!!i})))))}function ne({node:e,depth:f,me:d,labelOf:i,childrenMap:r,replyingId:g,replyText:s,postingReplyId:x,setReplyingId:C,setReplyText:b,submitReply:E,onToggleLike:h,likingId:O,deletingId:_,savingId:k,onStartEdit:$,onCancelEdit:L,onChangeEdit:T,onSaveEdit:F,onDelete:P,editingId:z,flashId:j,isAuthed:w}){const v=S(e.email)===d,A=e.thumbs??e.thumbsUpUsers??[],B=A.map(p=>S(p)).includes(d),J=e.thumbsCount??A.length,D=(r.get(m(e._id))||[]).filter(p=>m(p._id)!==m(e._id));return n.createElement("li",null,n.createElement("div",{id:`comment-${e._id}`,className:`flex items-start gap-3 rounded-lg p-2 ${j===m(e._id)?"bg-yellow-50":""} ${f?"border-l border-gray-200 pl-4":""}`,style:{marginLeft:f?f*30:0}},n.createElement("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gray-200"}),n.createElement("div",{className:"min-w-0 flex-1"},n.createElement("div",{className:"flex items-center gap-2"},n.createElement("span",{className:"text-sm font-medium text-gray-900"},i(e.email)),n.createElement("span",{className:"text-xs text-gray-500"},"• ",Y(e.createdAt).fromNow())),z===m(e._id)?n.createElement("div",{className:"mt-2"},n.createElement("textarea",{defaultValue:e.content,onChange:p=>T(p.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),n.createElement("div",{className:"mt-2 flex gap-2"},n.createElement("button",{onClick:F,disabled:k===e._id||!w,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60",title:w?"Save":"Log in to edit"},k===e._id?"Saving…":"Save"),n.createElement("button",{onClick:L,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))):n.createElement("p",{className:"mt-1 whitespace-pre-wrap break-words text-sm text-gray-800"},e.content),n.createElement("div",{className:"mt-2 flex items-center gap-3 text-xs text-gray-600"},n.createElement("button",{onClick:()=>h(e._id,e.email),disabled:O===e._id||v||!w,className:`rounded px-2 py-1 ${B?"bg-blue-50 text-blue-600":"hover:bg-gray-100"} disabled:opacity-60`,title:w?v?"You can’t like your own comment.":"Like comment":"Log in to like"},"👍 ",J),n.createElement("button",{onClick:()=>{C(m(e._id)),b("")},className:"rounded px-2 py-1 hover:bg-gray-100",title:"Reply"},"Reply"),w&&v&&n.createElement(n.Fragment,null,n.createElement("button",{onClick:()=>$(e),className:"rounded px-2 py-1 hover:bg-gray-100"},"Edit"),n.createElement("button",{onClick:()=>P(e._id),disabled:_===e._id,className:"rounded px-2 py-1 text-red-600 hover:bg-red-50 disabled:opacity-60"},_===e._id?"Deleting…":"Delete"))),g===m(e._id)&&n.createElement("div",{className:"mt-2 rounded-lg border bg-white p-2"},n.createElement("textarea",{value:s,onChange:p=>b(p.target.value),placeholder:"Write a reply…",className:"h-16 w-full resize-none rounded-md border px-3 py-2 text-sm"}),n.createElement("div",{className:"mt-2 flex items-center gap-2"},n.createElement(te,{onClick:()=>E(e._id),disabled:x===e._id||!s.trim(),className:"rounded-md bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},x===e._id?"Posting…":"Reply"),n.createElement("button",{onClick:()=>{C(null),b("")},className:"rounded-md border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))))),D.length>0&&n.createElement("ul",{className:"mt-2 space-y-3"},D.map(p=>n.createElement(ne,{key:m(p._id),node:p,depth:Math.min(f+1,6),me:d,labelOf:i,childrenMap:r,replyingId:g,replyText:s,postingReplyId:x,setReplyingId:C,setReplyText:b,submitReply:E,onToggleLike:h,likingId:O,deletingId:_,savingId:k,onStartEdit:$,onCancelEdit:L,onChangeEdit:T,onSaveEdit:F,onDelete:P,editingId:z,flashId:j,isAuthed:w}))))}export{$e as C};
