import{f as R,b as D,u as F,a as M,c as A,r as l,R as e}from"./index-9bd58617.js";import{g as $,a as P,s as U,d as L}from"./market-4bdeb851.js";const O=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0});function G(){const{id:o}=R(),m=D(),{user:d,token:c}=F(),{school:i,schoolTheme:r}=M(),u=A(),[n,h]=l.useState(null),[S,k]=l.useState(!0),[y,p]=l.useState(!1),[I,v]=l.useState(!1),[x,E]=l.useState(null),[b,N]=l.useState(""),[w,g]=l.useState(""),f=l.useMemo(()=>!!d&&!!n&&d.email===n.seller,[d,n]);l.useEffect(()=>{let s=!0;return(async()=>{var t;try{const a=await $({school:i,token:c,id:o});if(!s)return;h(a)}catch(a){console.error(a),g(((t=a==null?void 0:a.payload)==null?void 0:t.message)||"Failed to load the item.")}finally{s&&k(!1)}})(),()=>{s=!1}},[i,c,o]),l.useEffect(()=>{let s=!0;return(async()=>{if(!(!n||f||!d))try{const t=await P({school:i,token:c,itemId:o});if(!s)return;v(!!(t!=null&&t.alreadySent)),E((t==null?void 0:t.conversationId)||null)}catch(t){console.warn("checkRequest failed:",t)}})(),()=>{s=!1}},[n,f,d,i,c,o]);const C=async()=>{var t;const s=String(b||"").trim();if(s)try{p(!0),g("");const a=await U({school:i,token:c,itemId:o,message:s});v(!0),E((a==null?void 0:a.conversationId)||null),N(""),a!=null&&a.conversationId&&m(u("messages")+`?conversation=${a.conversationId}`)}catch(a){console.error("send request failed",a),g((a==null?void 0:a.message)||((t=a==null?void 0:a.payload)==null?void 0:t.message)||"Failed to send request.")}finally{p(!1)}},j=async()=>{var s;if(window.confirm("Delete this listing? This cannot be undone."))try{await L({school:i,token:c,id:o}),m(u("/market"))}catch(t){console.error(t),g(((s=t==null?void 0:t.payload)==null?void 0:s.message)||"Failed to delete the item.")}},q=()=>{m(u(`/market/${o}/edit`))};return S?e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-gray-600",style:{backgroundColor:(r==null?void 0:r.bg)||"#f6f3ff"}},"Loading…"):n?e.createElement("div",{className:"min-h-screen px-4 py-8",style:{backgroundColor:(r==null?void 0:r.bg)||"#f6f3ff"}},e.createElement("div",{className:"mx-auto max-w-5xl"},e.createElement("div",{className:"mb-4 flex items-start justify-between gap-3"},e.createElement("h1",{className:"text-2xl font-bold text-gray-900"},n.title),f&&e.createElement("div",{className:"flex items-center gap-2"},e.createElement("button",{onClick:q,className:"rounded-lg px-3 py-1.5 text-sm font-semibold text-white shadow",style:{backgroundColor:(r==null?void 0:r.primary)||"#6b46c1"}},"Edit"),e.createElement("button",{onClick:j,className:"rounded-lg bg-red-500 px-3 py-1.5 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete"))),e.createElement("div",{className:"grid grid-cols-1 gap-8 md:grid-cols-3"},e.createElement("div",{className:"md:col-span-2"},Array.isArray(n.images)&&n.images.length>0?e.createElement(e.Fragment,null,e.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},e.createElement("img",{src:n.images[0],alt:"cover",className:"w-full object-cover",style:{aspectRatio:"4/3"}})),n.images.length>1&&e.createElement("div",{className:"mt-3 flex gap-2"},n.images.slice(1).map((s,t)=>e.createElement("img",{key:t,src:s,alt:`thumb ${t+2}`,className:"h-16 w-16 rounded-lg object-cover ring-1 ring-gray-200"})))):e.createElement("div",{className:"flex h-64 items-center justify-center rounded-2xl border border-dashed border-gray-300 text-sm text-gray-500"},"No images")),e.createElement("div",{className:"space-y-4"},e.createElement("div",{className:"rounded-2xl border border-gray-200 bg-white p-4 shadow-sm"},e.createElement("div",{className:"text-xl font-semibold text-gray-900"},O.format(n.price)),e.createElement("div",{className:"mt-1 text-sm text-gray-600"},"Seller:"," ",e.createElement("span",{className:"font-medium"},n.sellerNickname||"Unknown")),e.createElement("div",{className:"mt-3 text-sm text-gray-700 whitespace-pre-wrap"},n.description||"No description")),!f&&e.createElement("div",{className:"rounded-2xl border border-gray-200 bg-white p-4 shadow-sm"},e.createElement("div",{className:"mb-2 text-sm font-medium text-gray-900"},"Send a request"),I?e.createElement("div",{className:"flex items-center justify-between gap-2"},e.createElement("div",{className:"text-xs text-green-700"},"Request already sent."),x&&e.createElement("button",{onClick:()=>m(u("messages")+(x?`?conversation=${x}`:"")),className:"rounded-lg bg-gray-900 px-3 py-1.5 text-xs font-semibold text-white"},"Open chat")):e.createElement("div",{className:"flex flex-col gap-2"},e.createElement("input",{type:"text",className:"rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10",placeholder:"Say hi and mention pickup/payment details…",value:b,onChange:s=>N(s.target.value),disabled:y}),e.createElement("button",{onClick:C,disabled:y||!b.trim(),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white disabled:cursor-not-allowed disabled:opacity-60",style:{backgroundColor:(r==null?void 0:r.primary)||"#6b46c1"}},y?"Sending…":"Send"))),w&&e.createElement("div",{className:"rounded-xl border border-red-200 bg-red-50 p-3 text-sm text-red-700"},w))))):e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-gray-600",style:{backgroundColor:(r==null?void 0:r.bg)||"#f6f3ff"}},"Item not found.")}export{G as default};
