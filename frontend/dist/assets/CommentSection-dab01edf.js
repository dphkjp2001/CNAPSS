import{g as ge,c as ye,b as pe,h as be,r as u,R as n,A as ee}from"./index-57ec5dc6.js";import{d as K,r as he}from"./relativeTime-eb576654.js";import{u as xe}from"./useLoginGate-71676d05.js";var we={exports:{}};(function(e,d){(function(l,a){e.exports=a()})(ge,function(){return{name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(l){var a=["th","st","nd","rd"],r=l%100;return"["+l+(a[(r-20)%10]||a[r]||a[0])+"]"}}})})(we);const $="https://api.cnapss.com/api".replace(/\/$/,""),R=e=>e?{"Content-Type":"application/json",Authorization:`Bearer ${e}`}:{"Content-Type":"application/json"};async function Ee({school:e,postId:d}){const l=String(e||"").toLowerCase().trim(),a=await fetch(`${$}/public/${l}/comments/${d}`,{method:"GET"});if(!a.ok)throw new Error("Failed to load comments");return a.json()}async function _e({school:e,token:d,postId:l}){const a=String(e||"").toLowerCase().trim();if(!d)return Ee({school:a,postId:l});const r=await fetch(`${$}/${a}/comments/${l}`,{headers:R(d)});if(!r.ok)throw new Error("Failed to load comments");return r.json()}async function Z({school:e,token:d,postId:l,content:a,parentId:r=null}){const g=String(e||"").toLowerCase().trim(),c={content:String(a||"").trim()};r&&(c.parentId=String(r));const x=await fetch(`${$}/${g}/comments/${l}`,{method:"POST",headers:R(d),body:JSON.stringify(c)});if(!x.ok)throw new Error("Failed to add comment");return x.json()}async function Se({school:e,token:d,commentId:l,content:a}){const r=String(e||"").toLowerCase().trim(),g=await fetch(`${$}/${r}/comments/${l}`,{method:"PUT",headers:R(d),body:JSON.stringify({content:a})});if(!g.ok)throw new Error("Failed to update comment");return g.json()}async function Ne({school:e,token:d,commentId:l}){const a=String(e||"").toLowerCase().trim(),r=await fetch(`${$}/${a}/comments/${l}`,{method:"DELETE",headers:R(d)});if(!r.ok)throw new Error("Failed to delete comment");return r.json()}async function Ce({school:e,token:d,commentId:l}){const a=String(e||"").toLowerCase().trim(),r=await fetch(`${$}/${a}/comments/${l}/thumbs`,{method:"POST",headers:R(d)});if(!r.ok)throw new Error("Failed to toggle comment like");return r.json()}K.extend(he);K.locale("en");const i=e=>e==null?"":String(e),k=e=>String(e||"").toLowerCase().trim();function Le({postId:e,authorEmail:d="",highlightId:l=null}){const{user:a,token:r}=ye(),{school:g}=pe(),c=be(),{ensureAuth:x}=xe(),S=k(a==null?void 0:a.email),b=k(d),[w,h]=u.useState([]),[U,N]=u.useState(!0),[C,L]=u.useState(""),[T,F]=u.useState(""),[A,P]=u.useState(!1),[J,j]=u.useState(!1),[E,v]=u.useState(null),[M,z]=u.useState(""),[G,D]=u.useState(null),[y,I]=u.useState(null),[ne,B]=u.useState(""),[ae,Y]=u.useState(null),[oe,H]=u.useState(null),[re,V]=u.useState(null),[se,q]=u.useState(l||null),Q=u.useCallback(async()=>{if(!(!e||!g)){N(!0),L("");try{const t=await _e({school:g,token:r,postId:e});h(Array.isArray(t)?t:[])}catch(t){console.error("comments:load failed",t),L("Failed to load comments."),h([])}finally{N(!1)}}},[e,g,r]);u.useEffect(()=>{Q()},[Q]),u.useEffect(()=>{if(!(c!=null&&c.emit)||!(c!=null&&c.on)||!e)return;c.emit("post:join",{postId:e});const t=o=>{!o||String(o.postId)!==String(e)||h(p=>p.some(_=>i(_._id)===i(o._id))?p:[...p,o])},m=o=>{!o||String(o.postId)!==String(e)||h(p=>p.map(_=>i(_._id)===i(o._id)?o:_))},f=({_id:o})=>{o&&h(p=>p.filter(_=>i(_._id)!==i(o)))},s=({_id:o,thumbs:p})=>{o&&h(_=>_.map(W=>i(W._id)===i(o)?{...W,thumbsUpUsers:p||[],thumbsCount:(p||[]).length}:W))};return c.on("comment:new",t),c.on("comment:update",m),c.on("comment:delete",f),c.on("comment:thumbs",s),()=>{try{c.emit("post:leave",{postId:e})}catch{}c.off("comment:new",t),c.off("comment:update",m),c.off("comment:delete",f),c.off("comment:thumbs",s)}},[c,e]),u.useMemo(()=>{const t=new Map;for(const s of w){const o=k(s.email);if(!o)continue;const p=new Date(s.createdAt||0).getTime();t.has(o)?t.set(o,Math.min(t.get(o),p)):t.set(o,p)}const m=Array.from(t.keys()).filter(s=>s&&s!==b);m.sort((s,o)=>(t.get(s)||0)-(t.get(o)||0));const f=new Map;return b&&f.set(b,"anonymous (OP)"),m.forEach((s,o)=>f.set(s,`anonymous ${o+1}`)),f},[w,b]);const le=u.useCallback(t=>t.anonymous?t.isPostAuthor?"Anonymous (OP)":"Anonymous":t.authorNickname,[]);u.useEffect(()=>{if(!l)return;q(l);const t=setTimeout(()=>q(null),1500);return()=>clearTimeout(t)},[l]);const{roots:ce,childrenMap:me}=u.useMemo(()=>{const t=(w||[]).map(s=>({...s,_id:i(s._id),parentId:i(s.parentId)||null})),m=new Map,f=[];for(const s of t){s.parentId||f.push(s);const o=m.get(s.parentId||"__root__")||[];o.push(s),m.set(s.parentId||"__root__",o)}return{roots:f,childrenMap:m}},[w]),O=()=>!a||!r?(x(),!1):!0,X=async()=>{const t=T.trim();if(t&&O()){P(!0);try{await Z({school:g,token:r,postId:e,content:t,parentId:null}),F("")}catch(m){console.error("comments:add root failed",m),alert("Failed to add comment.")}finally{P(!1)}}},ie=async t=>{const m=M.trim();if(!m||!O())return;const f=i(t);D(f);try{await Z({school:g,token:r,postId:e,content:m,parentId:f}),v(null),z("")}catch(s){console.error("comments:add reply failed",s),alert("Failed to add reply.")}finally{D(null)}},ue=async()=>{const t=ne.trim();if(!(!t||!y)&&O()){Y(y);try{await Se({school:g,token:r,commentId:y,content:t}),I(null),B("")}catch(m){console.error("comments:update failed",m),alert("Failed to update comment.")}finally{Y(null)}}},de=async t=>{if(!O()||!window.confirm("Delete this comment?"))return;const m=i(t);H(m);try{await Ne({school:g,token:r,commentId:m})}catch(f){console.error("comments:delete failed",f),alert("Failed to delete comment.")}finally{H(null)}},fe=async(t,m)=>{if(!O()||k(m)===S)return;const f=i(t);V(f);try{await Ce({school:g,token:r,commentId:f})}catch(s){console.error("comments:thumb toggle failed",s)}finally{V(null)}};return n.createElement("div",{className:"mt-8"},n.createElement("h3",{className:"mb-3 text-lg font-semibold text-gray-900"},"Comments"),n.createElement("div",{className:"mb-4 rounded-xl border bg-white p-3 shadow-sm"},n.createElement("textarea",{value:T,onChange:t=>F(t.target.value),onCompositionStart:()=>j(!0),onCompositionEnd:()=>j(!1),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&!J&&(t.preventDefault(),X())},placeholder:"Write a commentâ€¦",className:"h-20 w-full resize-none rounded-lg border px-3 py-2 text-sm"}),n.createElement("div",{className:"mt-2 flex items-center justify-between"},!a&&n.createElement("span",{className:"text-xs text-gray-500"},"Youâ€™ll be asked to log in when you post."),n.createElement(ee,{disabled:A,onClick:X,className:"rounded-lg bg-gray-900 px-3 py-2 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},A?"Postingâ€¦":"Post"))),n.createElement("div",{className:"rounded-xl border bg-white p-2 sm:p-3"},U?n.createElement("div",{className:"p-3 text-sm text-gray-600"},"Loadingâ€¦"):C?n.createElement("div",{className:"rounded-lg bg-red-50 p-3 text-sm text-red-700"},C):w.length===0?n.createElement("div",{className:"p-3 text-sm text-gray-600"},"No comments yet."):n.createElement("ul",{className:"space-y-3"},ce.map(t=>n.createElement(te,{key:i(t._id),node:t,depth:0,me:S,getAuthorLabel:le,childrenMap:me,replyingId:E,replyText:M,postingReplyId:G,setReplyingId:v,setReplyText:z,submitReply:ie,onToggleLike:fe,likingId:re,deletingId:oe,savingId:ae,onStartEdit:m=>{I(i(m._id)),B(m.content||"")},onCancelEdit:()=>{I(null),B("")},onChangeEdit:B,onSaveEdit:ue,onDelete:de,editingId:y,flashId:se,isAuthed:!!a})))))}function te({node:e,depth:d,me:l,getAuthorLabel:a,childrenMap:r,replyingId:g,replyText:c,postingReplyId:x,setReplyingId:S,setReplyText:b,submitReply:w,onToggleLike:h,likingId:U,deletingId:N,savingId:C,onStartEdit:L,onCancelEdit:T,onChangeEdit:F,onSaveEdit:A,onDelete:P,editingId:J,flashId:j,isAuthed:E}){const v=k(e.email)===l,M=e.thumbs??e.thumbsUpUsers??[],z=M.map(y=>k(y)).includes(l),G=e.thumbsCount??M.length,D=(r.get(i(e._id))||[]).filter(y=>i(y._id)!==i(e._id));return n.createElement("li",null,n.createElement("div",{id:`comment-${e._id}`,className:`flex items-start gap-3 rounded-lg p-2 ${j===i(e._id)?"bg-yellow-50":""} ${d?"border-l border-gray-200 pl-4":""}`,style:{marginLeft:d?d*30:0}},n.createElement("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gray-200"}),n.createElement("div",{className:"min-w-0 flex-1"},n.createElement("div",{className:"flex items-center gap-2"},n.createElement("span",{className:"text-sm font-medium text-gray-900"},a(e)),n.createElement("span",{className:"text-xs text-gray-500"},"â€¢ ",K(e.createdAt).fromNow())),J===i(e._id)?n.createElement("div",{className:"mt-2"},n.createElement("textarea",{defaultValue:e.content,onChange:y=>F(y.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),n.createElement("div",{className:"mt-2 flex gap-2"},n.createElement("button",{onClick:A,disabled:C===e._id||!E,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60",title:E?"Save":"Log in to edit"},C===e._id?"Savingâ€¦":"Save"),n.createElement("button",{onClick:T,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))):n.createElement("p",{className:"mt-1 whitespace-pre-wrap break-words text-sm text-gray-800"},e.content),n.createElement("div",{className:"mt-2 flex items-center gap-3 text-xs text-gray-600"},n.createElement("button",{onClick:()=>h(e._id,e.email),disabled:U===e._id||v||!E,className:`rounded px-2 py-1 ${z?"bg-blue-50 text-blue-600":"hover:bg-gray-100"} disabled:opacity-60`,title:E?v?"You canâ€™t like your own comment.":"Like comment":"Log in to like"},"ðŸ‘ ",G),n.createElement("button",{onClick:()=>{S(i(e._id)),b("")},className:"rounded px-2 py-1 hover:bg-gray-100",title:"Reply"},"Reply"),E&&v&&n.createElement(n.Fragment,null,n.createElement("button",{onClick:()=>L(e),className:"rounded px-2 py-1 hover:bg-gray-100"},"Edit"),n.createElement("button",{onClick:()=>P(e._id),disabled:N===e._id,className:"rounded px-2 py-1 text-red-600 hover:bg-red-50 disabled:opacity-60"},N===e._id?"Deletingâ€¦":"Delete"))),g===i(e._id)&&n.createElement("div",{className:"mt-2 rounded-lg border bg-white p-2"},n.createElement("textarea",{value:c,onChange:y=>b(y.target.value),placeholder:"Write a replyâ€¦",className:"h-16 w-full resize-none rounded-md border px-3 py-2 text-sm"}),n.createElement("div",{className:"mt-2 flex items-center gap-2"},n.createElement(ee,{onClick:()=>w(e._id),disabled:x===e._id||!c.trim(),className:"rounded-md bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},x===e._id?"Postingâ€¦":"Reply"),n.createElement("button",{onClick:()=>{S(null),b("")},className:"rounded-md border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))))),D.length>0&&n.createElement("ul",{className:"mt-2 space-y-3"},D.map(y=>n.createElement(te,{key:i(y._id),node:y,depth:Math.min(d+1,6),me:l,getAuthorLabel:a,childrenMap:r,replyingId:g,replyText:c,postingReplyId:x,setReplyingId:S,setReplyText:b,submitReply:w,onToggleLike:h,likingId:U,deletingId:N,savingId:C,onStartEdit:L,onCancelEdit:T,onChangeEdit:F,onSaveEdit:A,onDelete:P,editingId:J,flashId:j,isAuthed:E}))))}export{Le as C};
