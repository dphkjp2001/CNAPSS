import{e as q,u as G,a as J,c as K,b as Q,d as X,r,R as t,L as Z}from"./index-1bfae1a9.js";import{C as ee}from"./CommentSection-af9011ac.js";import{d as N,r as te}from"./relativeTime-f6ae5453.js";import{u as ae,d as ne,e as oe,f as se,v as re}from"./academicPosts-3f24bdec.js";import{a as le}from"./http-e19067b4.js";import"./useLoginGate-b769887f.js";N.extend(te);N.locale("en");function ge(){const{id:m}=q(),z=G(),d=J(),{user:o,token:S}=K(),{school:l,schoolTheme:c}=Q(),k=X(),[n,b]=r.useState(null),[P,L]=r.useState(""),[u,w]=r.useState(!1),[V,f]=r.useState(""),[I,g]=r.useState(""),[R,U]=r.useState(!1),B=!!(o!=null&&o.email||S&&String(S).length>0),[D,v]=r.useState(0),[_,E]=r.useState(0),[y,$]=r.useState(null),[C,A]=r.useState(!1),Y=D-_,H=async()=>{L("");try{const e=await ne({school:l,id:m});b(e),f((e==null?void 0:e.title)||""),g((e==null?void 0:e.content)||""),v((e==null?void 0:e.upCount)||0),E((e==null?void 0:e.downCount)||0)}catch(e){if((e==null?void 0:e.status)!==404){L((e==null?void 0:e.message)||"Failed to load the post.");return}}if(B)try{const e=await oe({school:l,id:m});b(e),f((e==null?void 0:e.title)||""),g((e==null?void 0:e.content)||""),v((e==null?void 0:e.upCount)||0),E((e==null?void 0:e.downCount)||0),$((e==null?void 0:e.myVote)??null)}catch{}};r.useEffect(()=>{!l||!m||H()},[m,l,B]),r.useEffect(()=>{const a=new URLSearchParams(d.search).get("nid");async function s(){if(!(!a||!(o!=null&&o.email)||!l))try{const x="https://api.cnapss.com/api".replace(/\/+$/,"");await le(`${x}/${l}/notification/mark-read`,{method:"POST",headers:{"Content-Type":"application/json"},body:{commentId:a,email:o.email}})}catch{}}s()},[d.search,o==null?void 0:o.email,l]);const O=r.useMemo(()=>{const e=d.hash||"",a=e.startsWith("#comment-")?e.slice(9):null,s=new URLSearchParams(d.search).get("nid");return a||s||null},[d.hash,d.search]),i=r.useMemo(()=>{var F,j;const e=n,a=o;if(!e||!a)return!1;const s=[a.id,a._id].filter(Boolean).map(String);return[e.userId,e.authorId,(F=e.author)==null?void 0:F._id,(j=e.author)==null?void 0:j.id].filter(Boolean).map(String).some(W=>s.includes(W))},[o,n]),T=async()=>{if(window.confirm("Delete this post?"))try{await se({school:l,id:n._id}),alert("Post deleted."),z(k("/dashboard?tab=free"))}catch(e){alert("Delete failed: "+((e==null?void 0:e.message)||"Unknown error"))}},M=async e=>{if(!o){alert("Please log in to vote.");return}if(!(i||C)&&!(y&&y!==e)){A(!0);try{const a=await re({school:l,id:n._id,dir:e});typeof(a==null?void 0:a.upCount)=="number"&&v(a.upCount),typeof(a==null?void 0:a.downCount)=="number"&&E(a.downCount),typeof(a==null?void 0:a.myVote)<"u"&&$(a.myVote)}catch(a){alert("Vote failed: "+((a==null?void 0:a.message)||"Unknown error"))}finally{A(!1)}}},p=y==="up",h=y==="down";return P?t.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-red-700",style:{backgroundColor:(c==null?void 0:c.bg)||"#f6f3ff"}},P):n?t.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(c==null?void 0:c.bg)||"#f6f3ff"}},t.createElement("div",{className:"mx-auto max-w-3xl"},t.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},t.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},u?t.createElement("input",{value:V,onChange:e=>f(e.target.value),placeholder:"Title",className:"w-full rounded-xl border border-gray-300 px-3 py-2 text-lg font-semibold text-gray-900 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):t.createElement("h1",{className:"text-2xl font-bold text-gray-900"},n.title),t.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",t.createElement("span",{className:"font-medium"},"anonymous")," • ",N(n.createdAt).fromNow())),t.createElement("div",{className:"p-5 sm:p-6"},u?t.createElement("textarea",{value:I,onChange:e=>g(e.target.value),placeholder:"Content",className:"h-56 w-full resize-y rounded-xl border border-gray-300 px-3 py-2 text-sm text-gray-800 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):t.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},t.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},n.content)),t.createElement("div",{className:"mt-6 flex flex-wrap items-center gap-3"},t.createElement("div",{className:"flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-2 py-1"},t.createElement("button",{onClick:()=>M("up"),disabled:!o||i||C||h,className:`flex items-center gap-1 rounded-md px-3 py-1 text-sm font-semibold ${p?"text-red-600":"text-gray-800 hover:bg-gray-100"} disabled:opacity-60`,"aria-label":"Upvote",title:o?i?"You can’t vote on your own post.":h?"Cancel your downvote first":"Upvote":"Log in to vote"},t.createElement("svg",{className:`w-4 h-4 ${p?"text-red-600":""}`,viewBox:"0 0 20 20",fill:"currentColor"},t.createElement("path",{fillRule:"evenodd",d:"M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z",clipRule:"evenodd"})),t.createElement("span",null,D)),t.createElement("button",{onClick:()=>M("down"),disabled:!o||i||C||p,className:`flex items-center gap-1 rounded-md px-3 py-1 text-sm font-semibold ${h?"text-blue-600":"text-gray-800 hover:bg-gray-100"} disabled:opacity-60`,"aria-label":"Downvote",title:o?i?"You can’t vote on your own post.":p?"Cancel your upvote first":"Downvote":"Log in to vote"},t.createElement("svg",{className:`w-4 h-4 ${h?"text-blue-600":""}`,viewBox:"0 0 20 20",fill:"currentColor"},t.createElement("path",{fillRule:"evenodd",d:"M16.707 10.293a1 1 0 010 1.414l-6 6a1 1 0 01-1.414 0l-6-6a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l4.293-4.293a1 1 0 011.414 0z",clipRule:"evenodd"})),t.createElement("span",null,_)),t.createElement("span",{className:"ml-2 text-sm font-medium text-gray-700"},"Score: ",Y)),i&&!u&&t.createElement(t.Fragment,null,t.createElement("button",{onClick:()=>w(!0),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:"#6b46c1"}},"Edit"),t.createElement("button",{onClick:T,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")),i&&u&&t.createElement(t.Fragment,null,t.createElement("button",{onClick:async()=>{const e=V.trim(),a=I.trim();if(!(!e||!a)){U(!0);try{const s=await ae({school:l,id:n._id,title:e,content:a}),x=(s==null?void 0:s.post)||s;b(x),w(!1)}catch(s){alert("Update failed: "+((s==null?void 0:s.message)||"Unknown error"))}finally{U(!1)}}},disabled:R,className:"rounded-xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-black disabled:opacity-60"},R?"Saving…":"Save"),t.createElement("button",{onClick:()=>{f((n==null?void 0:n.title)||""),g((n==null?void 0:n.content)||""),w(!1)},className:"rounded-xl border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-800 shadow-sm hover:bg-gray-50"},"Cancel")),t.createElement(Z,{to:k("/dashboard?tab=free"),className:"ml-auto text-sm font-medium text-blue-600 underline underline-offset-2"},"← Back to List")))),(n==null?void 0:n._id)&&t.createElement("div",{className:"mt-6 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm sm:p-6"},t.createElement(ee,{postId:n._id,authorEmail:n.email,highlightId:O,anonymousMode:!0})))):t.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-gray-600",style:{backgroundColor:(c==null?void 0:c.bg)||"#f6f3ff"}},"Loading…")}export{ge as default};
