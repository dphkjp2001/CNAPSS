import{r,a as Q,b as X,R as t}from"./index-3bf3b025.js";import{u as ee,c as te,l as H,b as q,e as ae,d as ne,M as se,T as re,a as O,L as V,P as B}from"./leaflet-c27fbebc.js";function le(n,s,a){s.center!==a.center&&n.setLatLng(s.center),s.radius!=null&&s.radius!==a.radius&&n.setRadius(s.radius)}function oe(){return ee().map}const D=te(function({center:s,children:a,...c},o){const f=new H.Circle(s,c);return q(f,ae(o,{overlayContainer:f}))},le),ce=ne(function(s,a){const c=new H.Tooltip(s,a.overlayContainer);return q(c,a)},function(s,a,{position:c},o){r.useEffect(function(){const m=a.overlayContainer;if(m==null)return;const{instance:u}=s,d=g=>{g.tooltip===u&&(c!=null&&u.setLatLng(c),u.update(),o(!0))},x=g=>{g.tooltip===u&&o(!1)};return m.on({tooltipopen:d,tooltipclose:x}),m.bindTooltip(u),function(){m.off({tooltipopen:d,tooltipclose:x}),m._map!=null&&m.unbindTooltip()}},[s,a,o,c])}),W="https://api.cnapss.com/api".replace(/\/$/,""),Y=n=>({"Content-Type":"application/json",Authorization:`Bearer ${n}`});async function ie({school:n,token:s,address:a,lat:c,lon:o,radius:f,types:m=["restaurant","cafe","fast food"],minRating:u=0,minReviews:d=0,sortBy:x="best_match",term:g=""}){const k=String(n||"").toLowerCase().trim(),h=new URLSearchParams({...a&&{address:a},...c!=null&&{lat:c},...o!=null&&{lon:o},...f!=null&&{radius:f},types:m.join(","),minRating:u,minReviews:d,sortBy:x,...g&&{term:g}}),E=await fetch(`${W}/${k}/places/nearby?${h.toString()}`,{headers:Y(s)});if(!E.ok)throw new Error(`Failed to load places: ${E.status}`);return E.json()}async function me({school:n,token:s,text:a,lat:c,lon:o,limit:f=8}){const m=String(n||"").toLowerCase().trim(),u=new URLSearchParams({text:String(a||""),...c!=null&&{latitude:String(c)},...o!=null&&{longitude:String(o)},limit:String(f)}),d=await fetch(`${W}/${m}/places/suggest?${u.toString()}`,{headers:Y(s)});if(!d.ok)throw new Error("Failed to load suggestions");return d.json()}function ue({center:n}){const s=oe();return r.useEffect(()=>{n!=null&&n.lat&&(n!=null&&n.lon)&&s.setView([n.lat,n.lon],s.getZoom(),{animate:!0})},[n,s]),null}const de=V.divIcon({className:"w-3 h-3 rounded-full bg-rose-600 ring-2 ring-white shadow-[0_0_0_2px_rgba(244,63,94,0.35)]",iconSize:[12,12],iconAnchor:[6,6]});function pe(){const{token:n}=Q(),{school:s}=X(),[a,c]=r.useState({lat:40.729513,lon:-73.997649}),[o,f]=r.useState(1200),[m,u]=r.useState(["restaurant","cafe","fast food"]),[d,x]=r.useState(0),[g,k]=r.useState(0),[h,E]=r.useState("best_match"),[y,$]=r.useState(""),[w,Z]=r.useState(!1),[p,T]=r.useState([]),[N,L]=r.useState(null),[_,R]=r.useState(!1),[I,P]=r.useState(""),[j,F]=r.useState(!1),[b,M]=r.useState([]),[U,S]=r.useState(!1),[A,C]=r.useState(-1),K=r.useRef(null),v=r.useMemo(()=>String(s||"").toUpperCase(),[s]);if(!n)return t.createElement("div",{className:"mx-auto max-w-4xl p-6"},t.createElement("div",{className:"rounded-xl border border-gray-200 bg-white p-6 text-sm text-gray-700"},"Please log in to use Food Map."));r.useEffect(()=>{let e=!1;return(async()=>{var l;try{R(!0),P(""),F(!1);const i=await ie({school:s,token:n,...w?{address:y}:{term:y},radius:o,types:m,minRating:d,minReviews:g,sortBy:h});if(e)return;c(i.center||a),T(Array.isArray(i.items)?i.items:[]),!N&&((l=i.items)!=null&&l.length)&&L(i.items[0].id)}catch(i){if(e)return;i&&i.code==="FEATURE_UNAVAILABLE"?(F(!0),T([])):(P("Failed to load places."),T([]))}finally{e||R(!1)}})(),()=>{e=!0}},[s,n,o,m.join("|"),d,g,h,y,w]),r.useEffect(()=>{let e;const l=y.trim();return l.length>=2?e=setTimeout(async()=>{try{const{suggestions:i}=await me({school:s,token:n,text:l,lat:a.lat,lon:a.lon,limit:8});M(i||[]),S(!0),C(-1)}catch{M([]),S(!1)}},220):(M([]),S(!1)),()=>clearTimeout(e)},[y,s,n,a]),r.useMemo(()=>p.find(e=>e.id===N)||null,[p,N]);const z=e=>{$(e.text||""),S(!1)},G=e=>{u(l=>l.includes(e)?l.filter(i=>i!==e):[...l,e])};return t.createElement("div",{className:"flex h-[calc(100vh-80px)]"},t.createElement("div",{className:"relative flex-1"},t.createElement(se,{center:[a.lat,a.lon],zoom:15,style:{height:"100%",width:"100%"},scrollWheelZoom:!0},t.createElement(ue,{center:a}),t.createElement(re,{attribution:"© OpenStreetMap contributors",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),t.createElement(O,{position:[a.lat,a.lon],icon:V.divIcon({className:"flex items-center justify-center rounded-full border-2 border-white bg-indigo-600 shadow-lg",html:'<div style="width:18px;height:18px;border-radius:9999px"></div>',iconSize:[18,18],iconAnchor:[9,9]})},t.createElement(ce,{direction:"top",offset:[0,-10],opacity:1,permanent:!0},v),t.createElement(B,null,"Center • ",v)),t.createElement(D,{center:[a.lat,a.lon],radius:80,color:"#6b21a8",fillColor:"#c4b5fd",fillOpacity:.25}),t.createElement(D,{center:[a.lat,a.lon],radius:o,color:"#6b21a8",fillOpacity:0,dashArray:"6 6"}),p.map(e=>t.createElement(O,{key:e.id,position:[e.lat,e.lon],icon:de,eventHandlers:{click:()=>L(e.id)}},t.createElement(B,null,t.createElement("div",{className:"text-sm"},t.createElement("div",{className:"font-semibold"},e.name),t.createElement("div",{className:"text-gray-600"},e.address||"-"),t.createElement("div",{className:"mt-1 text-gray-600"},"⭐ ",e.rating??"-"," · ",e.review_count??0," reviews"),e.price?t.createElement("div",{className:"text-gray-600"},"$".repeat(e.price)):null,e.website?t.createElement("a",{href:e.website,target:"_blank",rel:"noreferrer",className:"mt-1 inline-block text-indigo-600 underline"},"Yelp"):null))))),t.createElement("div",{className:"pointer-events-auto absolute left-3 top-3 w-[min(560px,95%)] rounded-xl border border-gray-200 bg-white/95 p-3 shadow-md backdrop-blur"},t.createElement("div",{className:"mb-2 flex items-center justify-between"},t.createElement("div",{className:"text-sm font-semibold"},"Food Map (",v,")"),t.createElement("div",{className:"flex items-center gap-3 text-xs text-gray-600"},t.createElement("label",{className:"flex items-center gap-1"},t.createElement("input",{type:"checkbox",checked:w,onChange:e=>Z(e.target.checked)}),"by address"),t.createElement("div",{className:"flex items-center gap-1"},t.createElement("span",null,"Radius"),t.createElement("select",{className:"rounded border px-1 py-0.5",value:o,onChange:e=>f(parseInt(e.target.value,10))},[600,800,1e3,1200,1500,2e3].map(e=>t.createElement("option",{key:e,value:e},e," m")))))),t.createElement("div",{className:"relative"},t.createElement("input",{ref:K,value:y,onChange:e=>$(e.target.value),placeholder:w?"Search by address or place (e.g., 'Washington Square Park')":"Search keyword (e.g., ramen, coffee)",className:"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10",onKeyDown:e=>{!U||b.length===0||(e.key==="ArrowDown"?(e.preventDefault(),C(l=>Math.min(l+1,b.length-1))):e.key==="ArrowUp"?(e.preventDefault(),C(l=>Math.max(l-1,0))):e.key==="Enter"&&A>=0&&(e.preventDefault(),z(b[A])))}}),U&&b.length>0&&t.createElement("div",{className:"absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-lg border border-gray-200 bg-white shadow"},b.map((e,l)=>t.createElement("button",{key:`${e.type}-${e.text}-${l}`,onClick:()=>z(e),className:`block w-full px-3 py-2 text-left text-sm ${l===A?"bg-gray-100":""}`,onMouseEnter:()=>C(l)},t.createElement("span",{className:"mr-2 rounded bg-gray-100 px-1.5 py-0.5 text-xs text-gray-700"},e.type),e.text)))),t.createElement("div",{className:"mt-2 flex flex-wrap items-center gap-2 text-xs"},t.createElement("span",{className:"text-gray-600"},"Types:"),["restaurant","cafe","fast food"].map(e=>{const l=m.includes(e);return t.createElement("button",{key:e,onClick:()=>G(e),className:`rounded-full px-2 py-1 ${l?"bg-gray-900 text-white":"border border-gray-300 text-gray-700 hover:bg-gray-50"}`},e)}),t.createElement("span",{className:"ml-2 text-gray-600"},"Min ⭐"),t.createElement("select",{className:"rounded border px-1 py-0.5",value:d,onChange:e=>x(parseFloat(e.target.value))},[0,3.5,4,4.5].map(e=>t.createElement("option",{key:e,value:e},e))),t.createElement("span",{className:"ml-2 text-gray-600"},"Min reviews"),t.createElement("select",{className:"rounded border px-1 py-0.5",value:g,onChange:e=>k(parseInt(e.target.value,10))},[0,20,50,100,200].map(e=>t.createElement("option",{key:e,value:e},e))),t.createElement("span",{className:"ml-2 text-gray-600"},"Sort"),t.createElement("select",{className:"rounded border px-1 py-0.5",value:h,onChange:e=>E(e.target.value)},t.createElement("option",{value:"best_match"},"best match"),t.createElement("option",{value:"rating"},"rating"),t.createElement("option",{value:"review_count"},"review count"),t.createElement("option",{value:"distance"},"distance")))),t.createElement("div",{className:"pointer-events-none absolute left-3 bottom-3 rounded-lg bg-white/90 px-3 py-1 text-xs text-gray-700 shadow"},_?"Loading…":`${p.length} places`,I&&t.createElement("span",{className:"ml-2 text-red-600"},I),j&&t.createElement("span",{className:"ml-2"},"Feature not available for ",t.createElement("b",null,v)," yet."))),t.createElement("div",{className:"w-[380px] border-l bg-white"},t.createElement("div",{className:"flex items-center justify-between border-b px-4 py-3"},t.createElement("div",{className:"text-sm font-semibold"},"Results"),t.createElement("div",{className:"text-xs text-gray-500"},p.length)),t.createElement("div",{className:"flex-1 overflow-auto"},j?t.createElement("div",{className:"p-4 text-sm text-gray-700"},"This feature is not available for ",t.createElement("b",null,v)," yet."):!_&&p.length===0?t.createElement("div",{className:"p-4 text-sm text-gray-500"},"No results. Try widening radius or changing filters."):t.createElement("ul",{className:"divide-y"},p.map(e=>{var i;const l=N===e.id;return t.createElement("li",{key:e.id,className:`cursor-pointer px-4 py-3 hover:bg-gray-50 ${l?"bg-indigo-50":""}`,onClick:()=>L(e.id)},t.createElement("div",{className:"flex items-start justify-between"},t.createElement("div",null,t.createElement("div",{className:"font-medium"},e.name),t.createElement("div",{className:"text-xs text-gray-600"},((i=e.categories)==null?void 0:i.join(" • "))||"-"),t.createElement("div",{className:"mt-1 text-xs text-gray-600"},"⭐ ",e.rating??"-"," · ",e.review_count??0," reviews",e.price?t.createElement("span",null," · ","$".repeat(e.price)):null),t.createElement("div",{className:"mt-1 text-xs text-gray-500"},e.address||"-")),e.website?t.createElement("a",{href:e.website,target:"_blank",rel:"noreferrer",className:"ml-3 rounded bg-gray-900 px-2 py-1 text-xs text-white",onClick:J=>J.stopPropagation()},"Yelp"):null))})))))}export{pe as default};
