import{r as p,a as F,c as R,u as z,d as D,R as e,L as v,P as T}from"./index-ea1fd978.js";import{l as $,a as B}from"./market-5ac18d5b.js";const x=20,G=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0});function H(){return e.createElement("div",{className:"animate-pulse rounded-2xl border border-gray-200/60 bg-white shadow-sm"},e.createElement("div",{className:"aspect-[4/3] w-full rounded-t-2xl bg-gray-100"}),e.createElement("div",{className:"p-4 space-y-3"},e.createElement("div",{className:"h-4 w-3/5 rounded bg-gray-100"}),e.createElement("div",{className:"h-4 w-2/5 rounded bg-gray-100"}),e.createElement("div",{className:"h-3 w-1/2 rounded bg-gray-100"})))}function Q({schoolPath:t}){return e.createElement("div",{className:"rounded-2xl border border-dashed border-gray-300 bg-white/60 p-10 text-center"},e.createElement("div",{className:"mx-auto mb-3 flex h-14 w-14 items-center justify-center rounded-full bg-gray-100 text-2xl"},"🛒"),e.createElement("h3",{className:"text-lg font-semibold text-gray-800"},"No listings yet"),e.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Be the first to create a listing. Items with photos and prices get more attention!"),e.createElement(v,{to:t("/market/write"),className:"mt-6 inline-flex items-center rounded-xl bg-gray-900 px-4 py-2 text-sm font-medium text-white shadow hover:bg-black/90 focus:outline-none focus:ring-2 focus:ring-gray-900/30"},"+ Create Listing"))}function Z({item:t,schoolPath:m}){var u;const S=t._id||t.id,d=((u=t==null?void 0:t.images)==null?void 0:u[0])||(t==null?void 0:t.image);return e.createElement(v,{to:m(`/market/${S}`),className:"group block overflow-hidden rounded-2xl border border-gray-200/60 bg-white shadow-sm transition hover:shadow-md focus:outline-none focus:ring-2 focus:ring-gray-900/20","aria-label":`${t.title} detail`},e.createElement("div",{className:"relative aspect-[4/3] w-full overflow-hidden bg-gray-50"},d?e.createElement("img",{src:d,alt:t.title,className:"h-full w-full object-cover transition duration-300 group-hover:scale-[1.02]",loading:"lazy"}):e.createElement("div",{className:"flex h-full w-full items-center justify-center text-4xl"},"🖼️")),e.createElement("div",{className:"p-4"},e.createElement("h3",{className:"line-clamp-1 text-base font-semibold text-gray-900"},t.title),e.createElement("p",{className:"mt-1 text-sm font-medium text-gray-800"},G.format(Number(t.price)||0)),e.createElement("p",{className:"mt-1 line-clamp-1 text-xs text-gray-500"},t.sellerNickname||"Unknown"),t.location&&e.createElement("div",{className:"mt-2 inline-flex items-center rounded-md bg-gray-100 px-2 py-0.5 text-[11px] text-gray-600"},t.location)))}const O=()=>{const[t,m]=p.useState([]),[S,d]=p.useState(!0),[u,A]=p.useState(null),{school:y,schoolTheme:k}=F(),h=R(),{token:C}=z(),[i,L]=D(),g=Math.max(1,parseInt(i.get("page")||"1",10)),f=i.get("q")||"",l=i.get("sort")||"new",_=r=>{const a=new URLSearchParams(i.toString());a.set("page",String(r)),L(a,{replace:!0})},j=r=>{const a=new URLSearchParams(i.toString());r?a.set("q",r):a.delete("q"),a.set("page","1"),L(a,{replace:!0})},q=r=>{const a=new URLSearchParams(i.toString());a.set("sort",r),a.set("page","1"),L(a,{replace:!0})},[M,P]=p.useState(0);return p.useEffect(()=>{let r=!0;return y&&(async()=>{try{if(d(!0),A(null),C){const o=await $({school:y,token:C,page:g,limit:x,q:f,sort:l==="new"?"latest":l==="price-asc"?"price_asc":l==="price-desc"?"price_desc":"latest"});if(!r)return;if(o&&typeof o=="object"&&Array.isArray(o.items))m(o.items),P(Number(o.total||0));else{const U=Array.isArray(o)?o:[],b=(f||"").trim().toLowerCase();let w=U.filter(n=>{var c,E,N;return b?((c=n.title)==null?void 0:c.toLowerCase().includes(b))||((E=n.description)==null?void 0:E.toLowerCase().includes(b))||((N=n.seller)==null?void 0:N.toLowerCase().includes(b)):!0});w=w.sort((n,c)=>{if(l==="price-asc")return(n.price??0)-(c.price??0);if(l==="price-desc")return(c.price??0)-(n.price??0);const E=n.createdAt??n._id??"",N=c.createdAt??c._id??"";return String(N).localeCompare(String(E))}),P(w.length);const I=(g-1)*x;m(w.slice(I,I+x))}}else{const s=await B({school:y,page:g,pageSize:x,q:f,sort:l});if(!r)return;m(Array.isArray(s==null?void 0:s.items)?s.items:[]),P(Number((s==null?void 0:s.total)||0))}}catch(s){console.error("❌ Failed to load listings",s),A("Failed to load listings.")}finally{r&&d(!1)}})(),()=>{r=!1}},[y,C,g,f,l]),e.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:k.bg}},e.createElement("div",{className:"mx-auto max-w-6xl"},e.createElement("div",{className:"mb-5 flex flex-col justify-between gap-3 sm:flex-row sm:items-center"},e.createElement("h2",{className:"text-2xl font-bold tracking-tight",style:{color:k.text}},"Marketplace"),e.createElement("div",{className:"flex w-full flex-col gap-2 sm:w-auto sm:flex-row sm:items-center"},e.createElement("div",{className:"relative sm:w-72"},e.createElement("input",{type:"search",value:f,onChange:r=>j(r.target.value),placeholder:"Search: title, seller",className:"w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-800 placeholder:text-gray-400 shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10","aria-label":"search items"})),e.createElement("select",{value:l,onChange:r=>q(r.target.value),className:"rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-800 shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10","aria-label":"sort items"},e.createElement("option",{value:"new"},"Newest"),e.createElement("option",{value:"price-asc"},"Lowest Price"),e.createElement("option",{value:"price-desc"},"Highest Price")),e.createElement(v,{to:h("/messages"),className:"inline-flex items-center justify-center rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-800 shadow-sm transition hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-900/10"},"💬 My Chats"),e.createElement(v,{to:h("/market/write"),className:"inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold text-white shadow transition focus:outline-none focus:ring-2 focus:ring-offset-0",style:{backgroundColor:k.primary}},"+ Create Listing"))),u&&e.createElement("div",{className:"mb-4 rounded-xl border border-red-200 bg-red-50 p-3 text-sm text-red-700"},u),S?e.createElement("div",{className:"grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5"},Array.from({length:10}).map((r,a)=>e.createElement(H,{key:a}))):t.length===0?e.createElement(Q,{schoolPath:h}):e.createElement(e.Fragment,null,e.createElement("div",{className:"grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5"},t.map(r=>e.createElement(Z,{key:r._id||r.id,item:r,schoolPath:h}))),e.createElement(T,{page:g,total:M,limit:x,onPageChange:_,siblingCount:1,boundaryCount:1,className:"mb-2",showStatus:!0}))))};export{O as default};
