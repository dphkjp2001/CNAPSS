import{s as P,x as q,y as z,z as K,c as U,b as G,t as H,r as c,R as a,i as O,v as V}from"./index-7bd7f188.js";import{a as Z,d as A,r as Q}from"./relativeTime-5cb0efbe.js";var J={exports:{}};(function(r,u){(function(l,i){r.exports=i()})(P,function(){var l={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"};return function(i,M,m){var o=M.prototype,v=o.format;m.en.formats=l,o.format=function(x){x===void 0&&(x="YYYY-MM-DDTHH:mm:ssZ");var Y=this.$locale().formats,s=function(d,_){return d.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,function(f,y,h){var E=h&&h.toUpperCase();return y||_[h]||l[h]||_[E].replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,function(w,b,L){return b||L.slice(1)})})}(x,Y===void 0?{}:Y);return v.call(this,s)}}})})(J);var W=J.exports;const X=q(W);var I={exports:{}};(function(r,u){(function(l,i){r.exports=i(Z)})(P,function(l){function i(o){return o&&typeof o=="object"&&"default"in o?o:{default:o}}var M=i(l),m={name:"ko",weekdays:"ì¼ìš”ì¼_ì›”ìš”ì¼_í™”ìš”ì¼_ìˆ˜ìš”ì¼_ëª©ìš”ì¼_ê¸ˆìš”ì¼_í† ìš”ì¼".split("_"),weekdaysShort:"ì¼_ì›”_í™”_ìˆ˜_ëª©_ê¸ˆ_í† ".split("_"),weekdaysMin:"ì¼_ì›”_í™”_ìˆ˜_ëª©_ê¸ˆ_í† ".split("_"),months:"1ì›”_2ì›”_3ì›”_4ì›”_5ì›”_6ì›”_7ì›”_8ì›”_9ì›”_10ì›”_11ì›”_12ì›”".split("_"),monthsShort:"1ì›”_2ì›”_3ì›”_4ì›”_5ì›”_6ì›”_7ì›”_8ì›”_9ì›”_10ì›”_11ì›”_12ì›”".split("_"),ordinal:function(o){return o+"ì¼"},formats:{LT:"A h:mm",LTS:"A h:mm:ss",L:"YYYY.MM.DD.",LL:"YYYYë…„ MMMM Dì¼",LLL:"YYYYë…„ MMMM Dì¼ A h:mm",LLLL:"YYYYë…„ MMMM Dì¼ dddd A h:mm",l:"YYYY.MM.DD.",ll:"YYYYë…„ MMMM Dì¼",lll:"YYYYë…„ MMMM Dì¼ A h:mm",llll:"YYYYë…„ MMMM Dì¼ dddd A h:mm"},meridiem:function(o){return o<12?"ì˜¤ì „":"ì˜¤í›„"},relativeTime:{future:"%s í›„",past:"%s ì „",s:"ëª‡ ì´ˆ",m:"1ë¶„",mm:"%dë¶„",h:"í•œ ì‹œê°„",hh:"%dì‹œê°„",d:"í•˜ë£¨",dd:"%dì¼",M:"í•œ ë‹¬",MM:"%dë‹¬",y:"ì¼ ë…„",yy:"%dë…„"}};return M.default.locale(m,null,!0),m})})(I);const j="https://api.cnapss.com/api".replace(/\/$/,"");function ee({school:r,token:u}){return z(`${j}/${r}/chat/conversations`)}function te({school:r,token:u,conversationId:l,cursor:i,limit:M=50}){const m=new URL(`${j}/${r}/chat/conversations/${l}/messages`);return i&&m.searchParams.set("cursor",i),m.searchParams.set("limit",String(M)),z(m.toString())}function ae({school:r,token:u,conversationId:l,content:i}){return K(`${j}/${r}/chat/conversations/${l}/messages`,{content:i})}function re({school:r,token:u,conversationId:l}){return K(`${j}/${r}/chat/conversations/${l}/read`,{})}A.locale("ko");A.extend(Q);A.extend(X);function se({conversationId:r,userEmail:u,onClose:l,fullSize:i=!1,otherNickname:M,otherEmail:m}){const{user:o,token:v}=U()||{},{school:x}=G()||{},{socket:Y,emit:s,on:d,off:_}=H(),f=((o==null?void 0:o.email)||u||"").toLowerCase(),[y,h]=c.useState([]),[E,w]=c.useState(""),[b,L]=c.useState(!1),[F,D]=c.useState(!1),T=c.useRef(null);c.useEffect(()=>{if(!r||!v||!x)return;let e=!0;return(async()=>{try{D(!0);const n=await te({school:x,token:v,conversationId:r});if(!e)return;h((Array.isArray(n)?n:[]).reverse()),s==null||s("chat:read",{conversationId:r});try{await re({school:x,token:v,conversationId:r})}catch{}}finally{e&&D(!1)}})(),()=>{e=!1}},[r,v,x,s]),c.useEffect(()=>{if(!r||!Y)return;s==null||s("chat:join",{conversationId:r});const e=g=>{String(g.conversationId)===String(r)&&(h(N=>N.some(k=>k._id&&g._id&&String(k._id)===String(g._id))?N:[...N,g]),s==null||s("chat:read",{conversationId:r}))},n=({conversationId:g,reader:N})=>{String(g)===String(r)&&h(B=>B.map(k=>(k.readBy||[]).includes(N)?k:{...k,readBy:[...k.readBy||[],N]}))},p=d==null?void 0:d("chat:receive",e),S=d==null?void 0:d("chat:read:updated",n);return()=>{typeof p=="function"&&p(),typeof S=="function"&&S()}},[Y,s,d,r]);const $=async()=>{const e=E.trim();if(!(!e||!r))try{const n=await ae({school:x,token:v,conversationId:r,content:e});h(p=>(n==null?void 0:n._id)&&p.some(g=>String(g._id)===String(n._id))?p:[...p,n])}catch(n){console.error("send failed",n),alert("ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨")}finally{w("")}};c.useEffect(()=>{var e;(e=T.current)==null||e.scrollIntoView({behavior:"smooth",block:"nearest"})},[y]);const C=(e,n)=>{var p;return n===0||!A(e.createdAt).isSame((p=y[n-1])==null?void 0:p.createdAt,"day")},t=[...y].reverse().find(e=>(e.sender||"").toLowerCase()===f&&(e.readBy||[]).map(n=>n.toLowerCase()).includes((m||"").toLowerCase()));return a.createElement("div",{className:`relative border rounded-lg shadow bg-white flex flex-col ${i?"w-full h-full":"w-[360px]"}`},l&&a.createElement("button",{onClick:l,className:"absolute top-2 right-2 text-gray-400 hover:text-black text-xl"},"Ã—"),a.createElement("div",{className:"flex items-center gap-2 border-b p-2 font-semibold"},a.createElement("span",null,"ğŸ—¨ï¸"),a.createElement("span",null,M||"Chat")),a.createElement("div",{className:"flex-1 overflow-y-auto p-3 space-y-2"},F&&a.createElement("div",{className:"text-sm text-gray-500"},"Loading..."),y.map((e,n)=>a.createElement("div",{key:e._id||n},C(e,n)&&a.createElement("div",{className:"text-center text-xs text-gray-400 my-2"},A(e.createdAt).format("YYYYë…„ Mì›” Dì¼")),a.createElement("div",{className:`flex ${(e.sender||"").toLowerCase()===f?"justify-end":"justify-start"}`},a.createElement("div",{className:"max-w-xs"},a.createElement("div",{className:`px-3 py-1 rounded-lg break-words ${(e.sender||"").toLowerCase()===f?"bg-blue-600 text-white":"bg-gray-200 text-black"}`},e.content),a.createElement("div",{className:`text-[11px] mt-1 ${(e.sender||"").toLowerCase()===f?"text-right text-gray-400":"text-left text-gray-500"}`},A(e.createdAt).format("A h:mm"),e===t&&a.createElement("span",{className:"ml-1 text-blue-500 font-medium"},"Seen")))))),a.createElement("div",{ref:T})),a.createElement("div",{className:"flex gap-2 p-2 border-t"},a.createElement("input",{type:"text",className:"flex-1 border rounded p-2",value:E,onChange:e=>w(e.target.value),onCompositionStart:()=>L(!0),onCompositionEnd:()=>L(!1),onKeyDown:e=>{e.key==="Enter"&&!b&&$()},placeholder:"ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."}),a.createElement("button",{onClick:$,disabled:!E.trim(),className:"bg-blue-600 text-white px-4 rounded hover:bg-blue-700 disabled:opacity-50"},"Send")))}function le(){const{user:r,token:u}=U()||{},{school:l}=O(),[i,M]=V(),{on:m}=H()||{},[o,v]=c.useState([]),[x,Y]=c.useState(!0),[s,d]=c.useState(null),[_,f]=c.useState("all"),y=(l||"").toLowerCase(),h=c.useMemo(()=>((r==null?void 0:r.email)||"").toLowerCase(),[r]),E=c.useCallback(async()=>{if(!(!u||!y)){Y(!0);try{const t=await ee({school:y,token:u}),e=Array.isArray(t)?t:Array.isArray(t==null?void 0:t.items)?t.items:[];return v(e),e}finally{Y(!1)}}},[y,u]);c.useEffect(()=>{let t=!0;(async()=>{const n=await E();if(!t)return;const p=i.get("conversation");if(p&&Array.isArray(n)){const S=n.find(g=>String(g._id)===String(p));S&&(d(S),f($(S)))}})();const e=m==null?void 0:m("chat:preview",()=>{E()});return()=>{t=!1,typeof e=="function"&&e()}},[E,m,i]);const w=t=>String(t||"").toLowerCase().replace(/[\s-]+/g,"_"),b=t=>String(t==null?void 0:t.source).toLowerCase()==="looking_for",L=t=>{const e=String((t==null?void 0:t.buyer)||"").toLowerCase(),n=String((t==null?void 0:t.seller)||"").toLowerCase();return e===h?n:e},F=t=>t?String(t).split("@")[0]:"Unknown",D=t=>(t==null?void 0:t.resourceTitle)&&t.resourceTitle.trim()||F(L(t)),T=t=>{if(!b(t))return"ğŸ’¬ DM";const e=w(t==null?void 0:t.seekingKind);return e==="course_materials"?"ğŸ“ Materials":e==="study_mate"?"ğŸ‘¥ Study Buddy":e==="coffee_chat"?"â˜• Coffee Chat":"ğŸ“ Seeking"},$=t=>{if(!b(t))return"all";const e=w(t==null?void 0:t.seekingKind);return e==="course_materials"?"lf_course_materials":e==="study_mate"?"lf_study_mate":e==="coffee_chat"?"lf_coffee_chat":"all"},C=c.useMemo(()=>{if(_==="all")return o;const t=_.replace(/^lf_/,"");return o.filter(e=>b(e)&&w(e==null?void 0:e.seekingKind)===t)},[o,_]);return c.useEffect(()=>{const t=s!=null&&s._id?String(s._id):null,e=new URLSearchParams(i.toString());t?e.set("conversation",t):e.delete("conversation"),M(e,{replace:!0})},[s]),a.createElement("div",{className:"mx-auto flex h-[calc(100vh-120px)] max-w-6xl gap-4 p-4"},a.createElement("div",{className:"flex w-[340px] shrink-0 flex-col rounded-2xl border bg-white"},a.createElement("div",{className:"flex flex-wrap gap-2 p-3"},a.createElement(R,{active:_==="all",onClick:()=>f("all")},"All"),a.createElement(R,{active:_==="lf_course_materials",onClick:()=>f("lf_course_materials")},"Materials"),a.createElement(R,{active:_==="lf_study_mate",onClick:()=>f("lf_study_mate")},"Study Buddy"),a.createElement(R,{active:_==="lf_coffee_chat",onClick:()=>f("lf_coffee_chat")},"Coffee Chat")),a.createElement("div",{className:"min-h-0 grow overflow-y-auto"},x?a.createElement("div",{className:"p-3 text-sm text-gray-500"},"Loadingâ€¦"):C!=null&&C.length?a.createElement("ul",{className:"divide-y"},C.map(t=>{const e=(s==null?void 0:s._id)===t._id;return a.createElement("li",{key:t._id},a.createElement("button",{onClick:()=>{d(t),f($(t))},className:"flex w-full items-center justify-between gap-2 px-3 py-3 text-left hover:bg-gray-50 "+(e?"bg-violet-50":"")},a.createElement("div",{className:"min-w-0"},a.createElement("div",{className:"flex items-center gap-2"},a.createElement("span",{className:"whitespace-nowrap rounded-full bg-gray-800 px-2 py-0.5 text-[11px] font-semibold text-white"},T(t)),a.createElement("span",{className:"truncate text-sm font-semibold text-gray-900"},D(t))),t.lastMessage?a.createElement("div",{className:"truncate text-xs text-gray-500"},t.lastMessage):null)))})):a.createElement("div",{className:"p-3 text-sm text-gray-500"},"No conversations."))),a.createElement("div",{className:"min-w-0 grow rounded-2xl border bg-white"},s?a.createElement(se,{conversationId:s._id,userEmail:r==null?void 0:r.email,otherEmail:L(s),otherNickname:D(s),fullSize:!0}):a.createElement("div",{className:"mt-20 text-center text-gray-400"},"ğŸ§­ ì™¼ìª½ì—ì„œ ì±„íŒ…ì„ ì„ íƒí•˜ì„¸ìš”.")))}function R({active:r,children:u,onClick:l}){return a.createElement("button",{onClick:l,className:"rounded-full px-3 py-1 text-xs font-semibold "+(r?"bg-violet-600 text-white":"border border-gray-300 bg-white text-gray-700 hover:bg-gray-50")},u)}export{le as default};
