import{u as ee,a as te,f as ue,r as c,R as e,A as ge,g as he,b as ye,e as fe,c as pe,L as be,h as xe}from"./index-1bb73cb9.js";import{d as O,r as ne}from"./relativeTime-8d676988.js";import"./en-0c19d194.js";import{d as Ee,e as we,t as Ce,u as Se}from"./posts-c0527c6f.js";const W="https://api.cnapss.com/api".replace(/\/$/,""),H=r=>({"Content-Type":"application/json",Authorization:`Bearer ${r}`});async function ve({school:r,token:n,postId:y}){const a=String(r||"").toLowerCase().trim(),s=await fetch(`${W}/${a}/comments/${y}`,{headers:H(n)});if(!s.ok)throw new Error("Failed to load comments");return s.json()}async function Z({school:r,token:n,postId:y,content:a,parentId:s=null}){const m=String(r||"").toLowerCase().trim(),g={content:String(a||"").trim()};s&&(g.parentId=String(s));const l=await fetch(`${W}/${m}/comments/${y}`,{method:"POST",headers:H(n),body:JSON.stringify(g)});if(!l.ok)throw new Error("Failed to add comment");return l.json()}async function Ne({school:r,token:n,commentId:y,content:a}){const s=String(r||"").toLowerCase().trim(),m=await fetch(`${W}/${s}/comments/${y}`,{method:"PUT",headers:H(n),body:JSON.stringify({content:a})});if(!m.ok)throw new Error("Failed to update comment");return m.json()}async function ke({school:r,token:n,commentId:y}){const a=String(r||"").toLowerCase().trim(),s=await fetch(`${W}/${a}/comments/${y}`,{method:"DELETE",headers:H(n)});if(!s.ok)throw new Error("Failed to delete comment");return s.json()}async function Le({school:r,token:n,commentId:y}){const a=String(r||"").toLowerCase().trim(),s=await fetch(`${W}/${a}/comments/${y}/thumbs`,{method:"POST",headers:H(n)});if(!s.ok)throw new Error("Failed to toggle comment like");return s.json()}O.extend(ne);O.locale("en");const E=r=>r==null?"":String(r),B=r=>String(r||"").toLowerCase().trim();function _e({postId:r,authorEmail:n="",highlightId:y=null}){const{user:a,token:s}=ee(),{school:m}=te(),g=ue(),l=B(a==null?void 0:a.email),C=B(n),[S,w]=c.useState([]),[v,N]=c.useState(!0),[_,k]=c.useState(""),[I,L]=c.useState(""),[R,$]=c.useState(!1),[T,D]=c.useState(!1),[F,P]=c.useState(null),[A,j]=c.useState(""),[z,M]=c.useState(null),[o,p]=c.useState(null),[h,U]=c.useState(""),[oe,q]=c.useState(null),[se,G]=c.useState(null),[re,Q]=c.useState(null),[le,Ie]=c.useState(null),V=c.useCallback(async()=>{if(!(!r||!m||!s)){N(!0),k("");try{const t=await ve({school:m,token:s,postId:r});w(Array.isArray(t)?t:[])}catch(t){console.error("comments:load failed",t),k("Failed to load comments."),w([])}finally{N(!1)}}},[r,m,s]);c.useEffect(()=>{V()},[V]),c.useEffect(()=>{if(!(g!=null&&g.emit)||!(g!=null&&g.on)||!r)return;g.emit("post:join",{postId:r});const t=d=>{!d||String(d.postId)!==String(r)||w(i=>i.some(x=>E(x._id)===E(d._id))?i:[...i,d])},u=d=>{!d||String(d.postId)!==String(r)||w(i=>i.map(x=>E(x._id)===E(d._id)?d:x))},f=({_id:d})=>{d&&w(i=>i.filter(x=>E(x._id)!==E(d)))},b=({_id:d,thumbs:i})=>{d&&w(x=>x.map(K=>E(K._id)===E(d)?{...K,thumbsUpUsers:i||[],thumbsCount:(i||[]).length}:K))};return g.on("comment:new",t),g.on("comment:update",u),g.on("comment:delete",f),g.on("comment:thumbs",b),()=>{try{g.emit("post:leave",{postId:r})}catch{}g.off("comment:new",t),g.off("comment:update",u),g.off("comment:delete",f),g.off("comment:thumbs",b)}},[g,r]);const J=c.useMemo(()=>{const t=new Map;for(const b of S){const d=B(b.email);if(!d)continue;const i=new Date(b.createdAt||0).getTime();t.has(d)?t.set(d,Math.min(t.get(d),i)):t.set(d,i)}const u=Array.from(t.keys()).filter(b=>b&&b!==C);u.sort((b,d)=>(t.get(b)||0)-(t.get(d)||0));const f=new Map;return C&&f.set(C,"anonymous (게시자)"),u.forEach((b,d)=>f.set(b,`anonymous ${d+1}`)),f},[S,C]);c.useCallback(t=>J.get(B(t))||"anonymous",[J]);const X=c.useMemo(()=>{const t=(S||[]).map(i=>({...i,_id:E(i._id),parentId:i.parentId?E(i.parentId):null,children:[]})),u=new Map;t.forEach(i=>u.set(i._id,i));const f=[];t.forEach(i=>{const x=i.parentId?E(i.parentId):"";x&&u.has(x)?u.get(x).children.push(i):f.push(i)});const b=(i,x)=>new Date(i.createdAt)-new Date(x.createdAt),d=i=>{i.sort(b),i.forEach(x=>d(x.children))};return d(f),f},[S]),Y=async()=>{const t=I.trim();if(t){$(!0);try{await Z({school:m,token:s,postId:r,content:t}),L("")}catch(u){console.error("comments:add root failed",u),alert("Failed to add comment.")}finally{$(!1)}}},ie=async t=>{const u=A.trim();if(!u)return;const f=E(t);M(f);try{await Z({school:m,token:s,postId:r,content:u,parentId:f}),P(null),j("")}catch(b){console.error("comments:add reply failed",b),alert("Failed to add reply.")}finally{M(null)}},ce=async()=>{const t=h.trim();if(!(!t||!o)){q(o);try{const u=await Ne({school:m,token:s,commentId:o,content:t});p(null),U("")}catch(u){console.error("comments:update failed",u),alert("Failed to update comment.")}finally{q(null)}}},me=async t=>{if(!window.confirm("Delete this comment?"))return;const u=E(t);G(u);try{await ke({school:m,token:s,commentId:u})}catch(f){console.error("comments:delete failed",f),alert("Failed to delete comment.")}finally{G(null)}},de=async t=>{const u=E(t);Q(u);try{await Le({school:m,token:s,commentId:u})}catch(f){console.error("comments:thumb toggle failed",f)}finally{Q(null)}};return!a||!s?e.createElement("div",{className:"mt-6 rounded-xl border bg-white p-4 text-sm text-gray-600"},"Please log in to view and write comments."):e.createElement("div",{className:"mt-8"},e.createElement("h3",{className:"mb-3 text-lg font-semibold text-gray-900"},"Comments"),e.createElement("div",{className:"mb-4 rounded-xl border bg-white p-3 shadow-sm"},e.createElement("textarea",{value:I,onChange:t=>L(t.target.value),onCompositionStart:()=>D(!0),onCompositionEnd:()=>D(!1),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&!T&&(t.preventDefault(),Y())},placeholder:"Write a comment…",className:"h-20 w-full resize-none rounded-lg border px-3 py-2 text-sm"}),e.createElement("div",{className:"mt-2 text-right"},e.createElement(ge,{disabled:R,onClick:Y,className:"rounded-lg bg-gray-900 px-3 py-2 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},R?"Posting…":"Post"))),e.createElement("div",{className:"rounded-xl border bg-white p-2 sm:p-3"},v?e.createElement("div",{className:"p-3 text-sm text-gray-600"},"Loading…"):_?e.createElement("div",{className:"rounded-lg bg-red-50 p-3 text-sm text-red-700"},_):X.length===0?e.createElement("div",{className:"p-3 text-sm text-gray-600"},"No comments yet."):e.createElement("ul",{className:"space-y-3"},X.map(t=>e.createElement(ae,{key:t._id,node:t,me:l,getLabel:u=>J.get(B(u))||"anonymous",replyingId:F,replyText:A,postingReplyId:z,editingId:o,editText:h,savingId:oe,deletingId:se,likingId:re,onStartReply:P,onCancelReply:()=>{P(null),j("")},onChangeReply:j,onSubmitReply:ie,onStartEdit:u=>{p(E(u._id)),U(u.content||"")},onCancelEdit:()=>{p(null),U("")},onChangeEdit:U,onSaveEdit:ce,onDelete:me,onToggleLike:de,flashId:le})))))}function ae(r){var p;const{node:n,me:y,getLabel:a,replyingId:s,replyText:m,postingReplyId:g,editingId:l,editText:C,savingId:S,deletingId:w,likingId:v,onStartReply:N,onCancelReply:_,onChangeReply:k,onSubmitReply:I,onStartEdit:L,onCancelEdit:R,onChangeEdit:$,onSaveEdit:T,onDelete:D,onToggleLike:F,flashId:P}=r,A=n.thumbs??n.thumbsUpUsers??[],j=A.map(h=>String(h||"").toLowerCase()).includes(y),z=n.thumbsCount??A.length,o=String(P||"")===String(n._id)?"bg-yellow-50 ring-2 ring-yellow-300 rounded-lg p-2 transition-colors":"";return e.createElement("li",null,e.createElement("div",{id:`comment-${n._id}`,className:`flex items-start gap-3 ${o}`},e.createElement("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gray-200"}),e.createElement("div",{className:"min-w-0 flex-1"},e.createElement("div",{className:"flex items-center gap-2"},e.createElement("span",{className:"text-sm font-medium text-gray-900"},a(n.email)),e.createElement("span",{className:"text-xs text-gray-500"},"• ",O(n.createdAt).fromNow())),l===n._id?e.createElement("div",{className:"mt-2"},e.createElement("textarea",{value:C,onChange:h=>$(h.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),e.createElement("div",{className:"mt-2 flex gap-2"},e.createElement("button",{onClick:T,disabled:S===n._id,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},S===n._id?"Saving…":"Save"),e.createElement("button",{onClick:R,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))):e.createElement("p",{className:"mt-1 whitespace-pre-wrap break-words text-sm text-gray-800"},n.content),e.createElement("div",{className:"mt-2 flex items-center gap-3 text-xs text-gray-600"},e.createElement("button",{onClick:()=>F(n._id),disabled:v===n._id,className:`rounded px-2 py-1 ${j?"bg-blue-50 text-blue-600":"hover:bg-gray-100"} disabled:opacity-60`},"👍 ",z),e.createElement("button",{onClick:()=>N(n._id),className:"rounded px-2 py-1 hover:bg-gray-100"},"Reply"),String(n.email||"").toLowerCase()===y&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>L(n),className:"rounded px-2 py-1 hover:bg-gray-100"},"Edit"),e.createElement("button",{onClick:()=>D(n._id),disabled:w===n._id,className:"rounded px-2 py-1 text-red-600 hover:bg-red-50 disabled:opacity-60"},w===n._id?"Deleting…":"Delete"))),((p=n.children)==null?void 0:p.length)>0&&e.createElement("ul",{className:"mt-3 space-y-3 border-l-2 border-gray-200 pl-6"},n.children.map(h=>e.createElement(ae,{key:h._id,node:h,me:y,getLabel:a,replyingId:s,replyText:m,postingReplyId:g,editingId:l,editText:C,savingId:S,deletingId:w,likingId:v,onStartReply:N,onCancelReply:_,onChangeReply:k,onSubmitReply:I,onStartEdit:L,onCancelEdit:R,onChangeEdit:$,onSaveEdit:T,onDelete:D,onToggleLike:F,flashId:P}))))),s===n._id&&e.createElement("div",{className:"ml-11 mt-2"},e.createElement("textarea",{value:m,onChange:h=>k(h.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10",placeholder:"Write a reply…"}),e.createElement("div",{className:"mt-2 flex gap-2"},e.createElement("button",{onClick:()=>I(n._id),disabled:g===n._id,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},g===n._id?"Posting…":"Reply"),e.createElement("button",{onClick:_,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))))}O.extend(ne);O.locale("en");function Te(){var M;const{id:r}=he(),n=ye(),y=fe(),{user:a}=ee(),{school:s,schoolTheme:m}=te(),g=pe(),[l,C]=c.useState(null),[S,w]=c.useState(""),[v,N]=c.useState(!1),[_,k]=c.useState(""),[I,L]=c.useState(""),[R,$]=c.useState(!1),T=async()=>{try{const o=await Ee({school:s,id:r});C(o),k((o==null?void 0:o.title)||""),L((o==null?void 0:o.content)||"")}catch(o){w(o.message||"Failed to load the post.")}};c.useEffect(()=>{T()},[r,s]),c.useEffect(()=>{const p=new URLSearchParams(y.search).get("nid");async function h(){if(!(!p||!(a!=null&&a.email)||!s))try{const U="https://api.cnapss.com/api".replace(/\/+$/,"");await xe(`${U}/${s}/notification/mark-read`,{method:"POST",headers:{"Content-Type":"application/json"},body:{commentId:p,email:a.email}})}catch{}}h()},[y.search,a==null?void 0:a.email,s]);const D=c.useMemo(()=>{const o=y.hash||"",p=o.startsWith("#comment-")?o.slice(9):null,h=new URLSearchParams(y.search).get("nid");return p||h||null},[y.hash,y.search]),F=c.useMemo(()=>((a==null?void 0:a.email)||"").toLowerCase()===((l==null?void 0:l.email)||"").toLowerCase(),[a,l]),P=async()=>{if(window.confirm("Delete this post?"))try{await we({school:s,id:l._id}),alert("Post deleted."),n(g("/freeboard"))}catch(o){alert("Delete failed: "+(o.message||"Unknown error"))}},A=async()=>{try{await Ce({school:s,id:l._id}),C(o=>o&&{...o,thumbsUpUsers:(o.thumbsUpUsers||[]).includes(((a==null?void 0:a.email)||"").toLowerCase())?o.thumbsUpUsers.filter(p=>p.toLowerCase()!==((a==null?void 0:a.email)||"").toLowerCase()):[...o.thumbsUpUsers||[],((a==null?void 0:a.email)||"").toLowerCase()]}),await T()}catch(o){alert("Failed to like: "+(o.message||"Unknown error"))}},j=async()=>{const o=_.trim(),p=I.trim();if(!(!o||!p)){$(!0);try{const h=await Se({school:s,id:l._id,title:o,content:p}),U=(h==null?void 0:h.post)||h;C(U),N(!1)}catch(h){alert("Update failed: "+(h.message||"Unknown error"))}finally{$(!1)}}},z=()=>{k((l==null?void 0:l.title)||""),L((l==null?void 0:l.content)||""),N(!1)};return S?e.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-red-700",style:{backgroundColor:(m==null?void 0:m.bg)||"#f6f3ff"}},S):l?e.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(m==null?void 0:m.bg)||"#f6f3ff"}},e.createElement("div",{className:"mx-auto max-w-3xl"},e.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},e.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},v?e.createElement("input",{value:_,onChange:o=>k(o.target.value),placeholder:"Title",className:"w-full rounded-xl border border-gray-300 px-3 py-2 text-lg font-semibold text-gray-900 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):e.createElement("h1",{className:"text-2xl font-bold text-gray-900"},l.title),e.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",e.createElement("span",{className:"font-medium"},"anonymous")," •"," ",O(l.createdAt).fromNow())),e.createElement("div",{className:"p-5 sm:p-6"},v?e.createElement("textarea",{value:I,onChange:o=>L(o.target.value),placeholder:"Content",className:"h-56 w-full resize-y rounded-xl border border-gray-300 px-3 py-2 text-sm text-gray-800 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):e.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},e.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},l.content)),e.createElement("div",{className:"mt-6 flex flex-wrap items-center gap-3"},e.createElement("button",{onClick:A,className:"rounded-xl border border-gray-300 bg-white px-3 py-1.5 text-sm text-gray-800 shadow-sm hover:bg-gray-50","aria-label":"like post"},"👍 ",((M=l.thumbsUpUsers)==null?void 0:M.length)||0),F&&!v&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>N(!0),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:(m==null?void 0:m.primary)||"#6b46c1"}},"Edit"),e.createElement("button",{onClick:P,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")),F&&v&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:j,disabled:R,className:"rounded-xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-black disabled:opacity-60"},R?"Saving…":"Save"),e.createElement("button",{onClick:z,className:"rounded-xl border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-800 shadow-sm hover:bg-gray-50"},"Cancel")),e.createElement(be,{to:g("/freeboard"),className:"ml-auto text-sm font-medium text-blue-600 underline underline-offset-2"},"← Back to List")))),(l==null?void 0:l._id)&&e.createElement("div",{className:"mt-6 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm sm:p-6"},e.createElement(_e,{postId:l._id,authorEmail:l.email,highlightId:D})))):e.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-gray-600",style:{backgroundColor:(m==null?void 0:m.bg)||"#f6f3ff"}},"Loading…")}export{Te as default};
