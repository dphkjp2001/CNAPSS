import{f as D,u as F,c as M,b as P,d as U,r as l,R as e}from"./index-c2238d46.js";import{a as $,b as L,d as O,e as G,s as W}from"./market-eaea0304.js";import{u as Y}from"./useLoginGate-f872750f.js";import"./http-b5e27cd5.js";const z=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0});function Q(){const{id:o}=D(),d=F(),{user:c,token:i}=M(),{school:m,schoolTheme:r}=P(),u=U(),{ensureAuth:h}=Y(),[n,k]=l.useState(null),[S,I]=l.useState(!0),[f,p]=l.useState(!1),[C,v]=l.useState(!1),[x,E]=l.useState(null),[b,N]=l.useState(""),[w,g]=l.useState(""),y=l.useMemo(()=>!!c&&!!n&&c.email===n.seller,[c,n]);l.useEffect(()=>{let s=!0;return(async()=>{var a;try{let t;if(i?t=await $({school:m,token:i,id:o}):(t=await L({school:m,id:o}),t={...t,sellerNickname:t.sellerNickname||"Unknown",images:Array.isArray(t.images)?t.images:[]}),!s)return;k(t)}catch(t){console.error(t),g(((a=t==null?void 0:t.payload)==null?void 0:a.message)||(t==null?void 0:t.message)||"Failed to load the item.")}finally{s&&I(!1)}})(),()=>{s=!1}},[m,i,o]),l.useEffect(()=>{let s=!0;return(async()=>{if(!(!n||y||!c))try{const a=await O({school:m,token:i,itemId:o});if(!s)return;v(!!(a!=null&&a.alreadySent)),E((a==null?void 0:a.conversationId)||null)}catch(a){console.warn("checkRequest failed:",a)}})(),()=>{s=!1}},[n,y,c,m,i,o]);const j=async()=>{var a;const s=String(b||"").trim();if(s)try{p(!0),g("");const t=await W({school:m,token:i,itemId:o,message:s});v(!0),E((t==null?void 0:t.conversationId)||null),N(""),t!=null&&t.conversationId&&d(u("messages")+`?conversation=${t.conversationId}`)}catch(t){console.error("send request failed",t),g((t==null?void 0:t.message)||((a=t==null?void 0:t.payload)==null?void 0:a.message)||"Failed to send request.")}finally{p(!1)}},q=()=>{h(j)},A=async()=>{var s;if(window.confirm("Delete this listing? This cannot be undone."))try{await G({school:m,token:i,id:o}),d(u("/market"))}catch(a){console.error(a),g(((s=a==null?void 0:a.payload)==null?void 0:s.message)||"Failed to delete the item.")}},R=()=>{d(u(`/market/${o}/edit`))};return S?e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-gray-600",style:{backgroundColor:(r==null?void 0:r.bg)||"#f6f3ff"}},"Loading…"):n?e.createElement("div",{className:"min-h-screen px-4 py-8",style:{backgroundColor:(r==null?void 0:r.bg)||"#f6f3ff"}},e.createElement("div",{className:"mx-auto max-w-5xl"},e.createElement("div",{className:"mb-4 flex items-start justify-between gap-3"},e.createElement("h1",{className:"text-2xl font-bold text-gray-900"},n.title),y&&e.createElement("div",{className:"flex items-center gap-2"},e.createElement("button",{onClick:R,className:"rounded-lg px-3 py-1.5 text-sm font-semibold text-white shadow",style:{backgroundColor:(r==null?void 0:r.primary)||"#6b46c1"}},"Edit"),e.createElement("button",{onClick:A,className:"rounded-lg bg-red-500 px-3 py-1.5 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete"))),e.createElement("div",{className:"grid grid-cols-1 gap-8 md:grid-cols-3"},e.createElement("div",{className:"md:col-span-2"},Array.isArray(n.images)&&n.images.length>0?e.createElement(e.Fragment,null,e.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},e.createElement("img",{src:n.images[0],alt:"cover",className:"w-full object-cover",style:{aspectRatio:"4/3"}})),n.images.length>1&&e.createElement("div",{className:"mt-3 flex gap-2"},n.images.slice(1).map((s,a)=>e.createElement("img",{key:a,src:s,alt:`thumb ${a+2}`,className:"h-16 w-16 rounded-lg object-cover ring-1 ring-gray-200"})))):e.createElement("div",{className:"flex h-64 items-center justify-center rounded-2xl border border-dashed border-gray-300 text-sm text-gray-500"},"No images")),e.createElement("div",{className:"space-y-4"},e.createElement("div",{className:"rounded-2xl border border-gray-200 bg-white p-4 shadow-sm"},e.createElement("div",{className:"text-xl font-semibold text-gray-900"},z.format(n.price)),e.createElement("div",{className:"mt-1 text-sm text-gray-600"},"Seller:"," ",e.createElement("span",{className:"font-medium"},n.sellerNickname||"Unknown")),e.createElement("div",{className:"mt-3 text-sm text-gray-700 whitespace-pre-wrap"},n.description||"No description")),!y&&e.createElement("div",{className:"rounded-2xl border border-gray-200 bg-white p-4 shadow-sm"},e.createElement("div",{className:"mb-2 text-sm font-medium text-gray-900"},"Send a request"),C&&c?e.createElement("div",{className:"flex items-center justify-between gap-2"},e.createElement("div",{className:"text-xs text-green-700"},"Request already sent."),x&&e.createElement("button",{onClick:()=>d(u("messages")+(x?`?conversation=${x}`:"")),className:"rounded-lg bg-gray-900 px-3 py-1.5 text-xs font-semibold text-white"},"Open chat")):e.createElement("div",{className:"flex flex-col gap-2"},e.createElement("input",{type:"text",className:"rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10",placeholder:"Say hi and mention pickup/payment details…",value:b,onChange:s=>N(s.target.value),disabled:f}),e.createElement("button",{onClick:q,disabled:f||!b.trim(),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white disabled:cursor-not-allowed disabled:opacity-60",style:{backgroundColor:(r==null?void 0:r.primary)||"#6b46c1"}},f?"Sending…":"Send"),!c&&e.createElement("p",{className:"text-xs text-gray-500"},"You can type freely. We’ll ask you to log in only when you press “Send”."))),w&&e.createElement("div",{className:"rounded-xl border border-red-200 bg-red-50 p-3 text-sm text-red-700"},w))))):e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-gray-600",style:{backgroundColor:(r==null?void 0:r.bg)||"#f6f3ff"}},"Item not found.")}export{Q as default};
