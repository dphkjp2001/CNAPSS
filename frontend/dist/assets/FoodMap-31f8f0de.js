import{r as o,R as t}from"./index-184638ed.js";import{u as W,c as G,l as I,b as j,e as J,d as Q,M as V,T as X,a as B,L as A,P as D}from"./leaflet-4632dfb6.js";function Z(n,a,s){a.center!==s.center&&n.setLatLng(a.center),a.radius!=null&&a.radius!==s.radius&&n.setRadius(a.radius)}function ee(){return W().map}const _=G(function({center:a,children:s,...l},m){const i=new I.Circle(a,l);return j(i,J(m,{overlayContainer:i}))},Z),te=Q(function(a,s){const l=new I.Tooltip(a,s.overlayContainer);return j(l,s)},function(a,s,{position:l},m){o.useEffect(function(){const d=s.overlayContainer;if(d==null)return;const{instance:u}=a,p=g=>{g.tooltip===u&&(l!=null&&u.setLatLng(l),u.update(),m(!0))},f=g=>{g.tooltip===u&&m(!1)};return d.on({tooltipopen:p,tooltipclose:f}),d.bindTooltip(u),function(){d.off({tooltipopen:p,tooltipclose:f}),d._map!=null&&d.unbindTooltip()}},[a,s,m,l])}),O="https://api.cnapss.com/api";async function ae({lat:n,lon:a,radius:s=1500,types:l=["restaurant","cafe","fast food"],minRating:m=0,minReviews:i=0,sortBy:d="best_match",term:u=""}){const p=new URLSearchParams({lat:n,lon:a,radius:s,types:l.join(","),minRating:m,minReviews:i,sortBy:d});u&&p.set("term",u);const f=await fetch(`${O}/places/nearby?${p.toString()}`);if(!f.ok){const g=await f.text().catch(()=>"");throw new Error(`Failed to load places: ${f.status} ${g}`)}return f.json()}async function ne({text:n,lat:a,lon:s,limit:l=8}){const m=new URLSearchParams({text:n,lat:a,lon:s,limit:String(l)}),i=await fetch(`${O}/places/suggest?${m.toString()}`);if(!i.ok)throw new Error("Failed to load suggestions");return i.json()}function se(n=0,a=!1){const s=Number.isFinite(n)?n:0,l=a?34:28,m=Math.round(120*s),i=`
    <svg xmlns="http://www.w3.org/2000/svg" width="${l}" height="${l}" viewBox="0 0 24 24">
      <path d="M12 2C8.14 2 5 5.14 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.86-3.14-7-7-7z"
        fill="hsl(${m},80%,${a?"40%":"45%"})" stroke="${a?"#111":"none"}" stroke-width="${a?.8:0}"/>
      <circle cx="12" cy="9" r="3.2" fill="white"/>
    </svg>`;return A.divIcon({html:i,iconSize:[l,l],className:""})}function le({value:n=0}){const a=Math.floor(n),s=n-a>=.5;return t.createElement("span",{className:"text-[11px]"},"★".repeat(a),s?"☆":"",t.createElement("span",{className:"text-gray-300"},"☆".repeat(5-a-(s?1:0))))}function re(n){return Number.isFinite(n)?Math.round(n/80):null}function oe({target:n,open:a}){const s=ee();return o.useEffect(()=>{if(!n)return;s.flyTo([n.lat,n.lon],17,{duration:.6});const l=setTimeout(()=>a==null?void 0:a(),650);return()=>clearTimeout(l)},[n,a,s]),null}function me(){const n=o.useMemo(()=>({lat:40.729513,lon:-73.997649}),[]),[a,s]=o.useState(null),[l,m]=o.useState(["restaurant","cafe","fast food"]),[i,d]=o.useState(1200),[u,p]=o.useState(!1),[f,g]=o.useState(""),[E,R]=o.useState(""),[w,U]=o.useState("rating"),[N,Y]=o.useState(4),[S,H]=o.useState(20),[x,M]=o.useState([]),[L,h]=o.useState(!1),[k,v]=o.useState(-1),[y,C]=o.useState(null),T=o.useRef(new Map),$=o.useMemo(()=>((a==null?void 0:a.items)||[]).find(e=>e.id===y)||null,[a,y]);o.useEffect(()=>{let e=!1;return(async()=>{var r;try{p(!0),g("");const c=await ae({lat:n.lat,lon:n.lon,radius:i,types:l,minRating:N,minReviews:S,sortBy:w,term:E.trim()});e||(s(c),!y&&((r=c.items)!=null&&r.length)&&C(c.items[0].id))}catch(c){console.error(c),e||g("Failed to load places.")}finally{e||p(!1)}})(),()=>{e=!0}},[n,i,l,N,S,w,E]),o.useEffect(()=>{let e;const r=E.trim();return r.length>=2?e=setTimeout(async()=>{try{const{suggestions:c}=await ne({text:r,lat:n.lat,lon:n.lon,limit:8});M(c||[]),h(!0),v(-1)}catch{M([]),h(!1)}},200):(M([]),h(!1)),()=>clearTimeout(e)},[E,n]);function F(e){R(e.text),h(!1)}function K(e){!L||x.length===0||(e.key==="ArrowDown"?(e.preventDefault(),v(r=>(r+1)%x.length)):e.key==="ArrowUp"?(e.preventDefault(),v(r=>(r-1+x.length)%x.length)):e.key==="Enter"?k>=0&&(e.preventDefault(),F(x[k])):e.key==="Escape"&&h(!1))}const b=o.useMemo(()=>((a==null?void 0:a.items)||[]).filter(e=>Number.isFinite(e.lat)&&Number.isFinite(e.lon)),[a]);return t.createElement("div",{className:"w-full h-[calc(100vh-80px)] flex"},t.createElement("div",{className:"flex-1 flex flex-col border-r"},t.createElement("div",{className:"p-2 flex flex-wrap items-center gap-3 border-b"},t.createElement("div",{className:"text-sm font-semibold"},"Food Map (NYU · Bobst Library)"),t.createElement("label",{className:"text-sm"},"Radius (m)"),t.createElement("input",{className:"border rounded px-2 py-1 w-24",type:"number",min:200,max:3e3,value:i,onChange:e=>d(Number(e.target.value))}),t.createElement("div",{className:"flex gap-3 text-sm"},["restaurant","cafe","fast food"].map(e=>t.createElement("label",{key:e,className:"flex items-center gap-1"},t.createElement("input",{type:"checkbox",checked:l.includes(e),onChange:()=>m(r=>r.includes(e)?r.filter(c=>c!==e):[...r,e])}),e))),u&&t.createElement("span",{className:"text-xs text-gray-500"},"Loading…"),a&&t.createElement("span",{className:"text-xs text-gray-500"},b.length," spots"),f&&t.createElement("span",{className:"text-xs text-red-500"},f)),t.createElement("div",{className:"flex-1"},t.createElement(V,{center:[n.lat,n.lon],zoom:16,style:{height:"100%",width:"100%"}},t.createElement(X,{attribution:"© OpenStreetMap contributors",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),t.createElement(B,{position:[n.lat,n.lon],icon:A.divIcon({html:`
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24">
                  <path d="M12 2C8.14 2 5 5.14 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.86-3.14-7-7-7z" fill="#6b21a8"/>
                  <path d="M7.5 8.2h9v.8h-9z" fill="white"/>
                </svg>`,iconSize:[30,30],className:""})},t.createElement(D,null,"Elmer Holmes Bobst Library (NYU)"),t.createElement(te,{direction:"top",offset:[0,-18],opacity:1,permanent:!0},"Bobst Library")),t.createElement(_,{center:[n.lat,n.lon],radius:80,color:"#6b21a8",fillColor:"#c4b5fd",fillOpacity:.25}),t.createElement(_,{center:[n.lat,n.lon],radius:i,color:"#6b21a8",fillOpacity:0,dashArray:"6 6"}),b.map(e=>{var r;return t.createElement(B,{key:e.id,position:[e.lat,e.lon],icon:se(e.score,e.id===y),ref:c=>{c&&T.current.set(e.id,c)},eventHandlers:{click:()=>C(e.id)}},t.createElement(D,null,t.createElement("div",{className:"space-y-1 text-sm"},t.createElement("div",{className:"font-semibold"},e.name),(r=e.categories)!=null&&r.length?t.createElement("div",{className:"text-xs"},e.categories.join(", ")):null,e.address&&t.createElement("div",{className:"text-xs"},e.address),t.createElement("div",{className:"text-xs"},"Score: ",Math.floor((e.score||0)*100),"/100"),typeof e.rating=="number"&&t.createElement("div",{className:"text-xs"},"Rating: ",e.rating.toFixed(1),"/5 (",e.review_count??0,")"),typeof e.price=="number"&&t.createElement("div",{className:"text-xs"},"Price: ","$".repeat(e.price)),t.createElement("div",{className:"flex gap-2 pt-1"},e.website&&t.createElement("a",{className:"text-blue-600 underline text-xs",href:e.website,target:"_blank",rel:"noreferrer"},"Yelp Page"),e.phone&&t.createElement("a",{className:"text-blue-600 underline text-xs",href:`tel:${e.phone}`},"Call")),t.createElement("div",{className:"text-[10px] text-gray-400 pt-1"},"Ratings & reviews data © Yelp"))))}),t.createElement(oe,{target:$,open:()=>{const e=$?T.current.get($.id):null;e==null||e.openPopup()}})))),t.createElement("aside",{className:"w-full max-w-md shrink-0 flex flex-col"},t.createElement("div",{className:"p-3 border-b bg-white/80 backdrop-blur"},t.createElement("div",{className:"relative mb-2"},t.createElement("input",{value:E,onChange:e=>R(e.target.value),onKeyDown:K,onFocus:()=>x.length&&h(!0),placeholder:"Search (e.g., ramen, korean, pizza)",className:"border rounded px-3 py-2 w-full text-sm"}),L&&x.length>0&&t.createElement("ul",{className:"absolute z-[1000] mt-1 w-full bg-white border rounded shadow text-sm max-h-64 overflow-auto",onMouseLeave:()=>v(-1)},x.map((e,r)=>t.createElement("li",{key:`${e.type}-${e.text}-${e.id||r}`,className:`px-3 py-2 cursor-pointer flex items-center gap-2 ${r===k?"bg-violet-50":"hover:bg-gray-50"}`,onMouseEnter:()=>v(r),onMouseDown:c=>{c.preventDefault(),F(e)}},t.createElement("span",{className:"text-[10px] px-1.5 py-0.5 rounded border bg-gray-50 text-gray-600"},e.type),t.createElement("span",null,e.text))))),t.createElement("div",{className:"flex items-center gap-2 text-xs"},t.createElement("label",null,"Sort"),t.createElement("select",{value:w,onChange:e=>U(e.target.value),className:"border rounded px-2 py-1"},t.createElement("option",{value:"rating"},"Rating"),t.createElement("option",{value:"review_count"},"Review count"),t.createElement("option",{value:"distance"},"Distance"),t.createElement("option",{value:"best_match"},"Best match")),t.createElement("label",{className:"ml-3"},"Min ⭐"),t.createElement("input",{type:"number",min:0,max:5,step:.1,value:N,onChange:e=>Y(Number(e.target.value)),className:"border rounded px-2 py-1 w-16"}),t.createElement("label",{className:"ml-3"},"Min reviews"),t.createElement("input",{type:"number",min:0,step:10,value:S,onChange:e=>H(Number(e.target.value)),className:"border rounded px-2 py-1 w-20"}))),t.createElement("div",{className:"flex-1 overflow-auto"},b.length===0&&!u&&t.createElement("div",{className:"p-4 text-sm text-gray-500"},"No results. Try widening radius or lowering filters."),t.createElement("ul",null,b.map((e,r)=>{var P;const c=re(e.distance),q=e.id===y;return t.createElement("li",{key:e.id,className:`px-4 py-3 border-b cursor-pointer ${q?"bg-violet-50":"bg-white hover:bg-gray-50"}`,onClick:()=>{C(e.id);const z=T.current.get(e.id);z&&z.openPopup()}},t.createElement("div",{className:"flex items-start gap-3"},t.createElement("div",{className:"text-xs text-gray-500 w-6 mt-[3px]"},"#",r+1),t.createElement("div",{className:"flex-1"},t.createElement("div",{className:"font-medium"},e.name),t.createElement("div",{className:"text-xs text-gray-600"},t.createElement(le,{value:e.rating??0})," ",typeof e.rating=="number"?e.rating.toFixed(1):"–","/5",e.review_count?` · ${e.review_count} reviews`:"",e.price?` · ${"$".repeat(e.price)}`:"",c?` · ${c} min walk`:""),(P=e.categories)!=null&&P.length?t.createElement("div",{className:"text-[11px] text-gray-500"},e.categories.join(", ")):null,e.address&&t.createElement("div",{className:"text-[11px] text-gray-500"},e.address))))})))))}export{me as default};
