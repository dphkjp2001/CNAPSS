import{a as ce,u as me,g as de,r as c,R as t,A as ue}from"./index-aeb17b9a.js";import{d as H,r as ge}from"./relativeTime-8749f4c7.js";import"./en-438d16f7.js";const P="https://api.cnapss.com/api".replace(/\/$/,""),j=a=>({"Content-Type":"application/json",Authorization:`Bearer ${a}`});async function pe({school:a,token:n,postId:h}){const m=String(a||"").toLowerCase().trim(),l=await fetch(`${P}/${m}/comments/${h}`,{headers:j(n)});if(!l.ok)throw new Error("Failed to load comments");return l.json()}async function Z({school:a,token:n,postId:h,content:m,parentId:l=null}){const u=String(a||"").toLowerCase().trim(),i={content:String(m||"").trim()};l&&(i.parentId=String(l));const x=await fetch(`${P}/${u}/comments/${h}`,{method:"POST",headers:j(n),body:JSON.stringify(i)});if(!x.ok)throw new Error("Failed to add comment");return x.json()}async function ye({school:a,token:n,commentId:h,content:m}){const l=String(a||"").toLowerCase().trim(),u=await fetch(`${P}/${l}/comments/${h}`,{method:"PUT",headers:j(n),body:JSON.stringify({content:m})});if(!u.ok)throw new Error("Failed to update comment");return u.json()}async function he({school:a,token:n,commentId:h}){const m=String(a||"").toLowerCase().trim(),l=await fetch(`${P}/${m}/comments/${h}`,{method:"DELETE",headers:j(n)});if(!l.ok)throw new Error("Failed to delete comment");return l.json()}async function fe({school:a,token:n,commentId:h}){const m=String(a||"").toLowerCase().trim(),l=await fetch(`${P}/${m}/comments/${h}/thumbs`,{method:"POST",headers:j(n)});if(!l.ok)throw new Error("Failed to toggle comment like");return l.json()}H.extend(ge);H.locale("en");const y=a=>a==null?"":String(a),F=a=>String(a||"").toLowerCase().trim();function Se({postId:a,authorEmail:n="",highlightId:h=null}){const{user:m,token:l}=ce(),{school:u}=me(),i=de(),x=F(m==null?void 0:m.email),w=F(n),[E,b]=c.useState([]),[U,v]=c.useState(!0),[k,_]=c.useState(""),[I,R]=c.useState(""),[L,$]=c.useState(!1),[M,T]=c.useState(!1),[O,S]=c.useState(null),[A,D]=c.useState(""),[B,J]=c.useState(null),[C,N]=c.useState(null),[f,z]=c.useState(""),[te,q]=c.useState(null),[ne,G]=c.useState(null),[oe,Q]=c.useState(null),[ae,be]=c.useState(null),V=c.useCallback(async()=>{if(!(!a||!u||!l)){v(!0),_("");try{const e=await pe({school:u,token:l,postId:a});b(Array.isArray(e)?e:[])}catch(e){console.error("comments:load failed",e),_("Failed to load comments."),b([])}finally{v(!1)}}},[a,u,l]);c.useEffect(()=>{V()},[V]),c.useEffect(()=>{if(!(i!=null&&i.emit)||!(i!=null&&i.on)||!a)return;i.emit("post:join",{postId:a});const e=s=>{!s||String(s.postId)!==String(a)||b(o=>o.some(p=>y(p._id)===y(s._id))?o:[...o,s])},r=s=>{!s||String(s.postId)!==String(a)||b(o=>o.map(p=>y(p._id)===y(s._id)?s:p))},d=({_id:s})=>{s&&b(o=>o.filter(p=>y(p._id)!==y(s)))},g=({_id:s,thumbs:o})=>{s&&b(p=>p.map(W=>y(W._id)===y(s)?{...W,thumbsUpUsers:o||[],thumbsCount:(o||[]).length}:W))};return i.on("comment:new",e),i.on("comment:update",r),i.on("comment:delete",d),i.on("comment:thumbs",g),()=>{try{i.emit("post:leave",{postId:a})}catch{}i.off("comment:new",e),i.off("comment:update",r),i.off("comment:delete",d),i.off("comment:thumbs",g)}},[i,a]);const K=c.useMemo(()=>{const e=new Map;for(const g of E){const s=F(g.email);if(!s)continue;const o=new Date(g.createdAt||0).getTime();e.has(s)?e.set(s,Math.min(e.get(s),o)):e.set(s,o)}const r=Array.from(e.keys()).filter(g=>g&&g!==w);r.sort((g,s)=>(e.get(g)||0)-(e.get(s)||0));const d=new Map;return w&&d.set(w,"anonymous (ê²Œì‹œìž)"),r.forEach((g,s)=>d.set(g,`anonymous ${s+1}`)),d},[E,w]);c.useCallback(e=>K.get(F(e))||"anonymous",[K]);const X=c.useMemo(()=>{const e=(E||[]).map(o=>({...o,_id:y(o._id),parentId:o.parentId?y(o.parentId):null,children:[]})),r=new Map;e.forEach(o=>r.set(o._id,o));const d=[];e.forEach(o=>{const p=o.parentId?y(o.parentId):"";p&&r.has(p)?r.get(p).children.push(o):d.push(o)});const g=(o,p)=>new Date(o.createdAt)-new Date(p.createdAt),s=o=>{o.sort(g),o.forEach(p=>s(p.children))};return s(d),d},[E]),Y=async()=>{const e=I.trim();if(e){$(!0);try{await Z({school:u,token:l,postId:a,content:e}),R("")}catch(r){console.error("comments:add root failed",r),alert("Failed to add comment.")}finally{$(!1)}}},se=async e=>{const r=A.trim();if(!r)return;const d=y(e);J(d);try{await Z({school:u,token:l,postId:a,content:r,parentId:d}),S(null),D("")}catch(g){console.error("comments:add reply failed",g),alert("Failed to add reply.")}finally{J(null)}},re=async()=>{const e=f.trim();if(!(!e||!C)){q(C);try{const r=await ye({school:u,token:l,commentId:C,content:e});N(null),z("")}catch(r){console.error("comments:update failed",r),alert("Failed to update comment.")}finally{q(null)}}},le=async e=>{if(!window.confirm("Delete this comment?"))return;const r=y(e);G(r);try{await he({school:u,token:l,commentId:r})}catch(d){console.error("comments:delete failed",d),alert("Failed to delete comment.")}finally{G(null)}},ie=async e=>{const r=y(e);Q(r);try{await fe({school:u,token:l,commentId:r})}catch(d){console.error("comments:thumb toggle failed",d)}finally{Q(null)}};return!m||!l?t.createElement("div",{className:"mt-6 rounded-xl border bg-white p-4 text-sm text-gray-600"},"Please log in to view and write comments."):t.createElement("div",{className:"mt-8"},t.createElement("h3",{className:"mb-3 text-lg font-semibold text-gray-900"},"Comments"),t.createElement("div",{className:"mb-4 rounded-xl border bg-white p-3 shadow-sm"},t.createElement("textarea",{value:I,onChange:e=>R(e.target.value),onCompositionStart:()=>T(!0),onCompositionEnd:()=>T(!1),onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&!M&&(e.preventDefault(),Y())},placeholder:"Write a commentâ€¦",className:"h-20 w-full resize-none rounded-lg border px-3 py-2 text-sm"}),t.createElement("div",{className:"mt-2 text-right"},t.createElement(ue,{disabled:L,onClick:Y,className:"rounded-lg bg-gray-900 px-3 py-2 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},L?"Postingâ€¦":"Post"))),t.createElement("div",{className:"rounded-xl border bg-white p-2 sm:p-3"},U?t.createElement("div",{className:"p-3 text-sm text-gray-600"},"Loadingâ€¦"):k?t.createElement("div",{className:"rounded-lg bg-red-50 p-3 text-sm text-red-700"},k):X.length===0?t.createElement("div",{className:"p-3 text-sm text-gray-600"},"No comments yet."):t.createElement("ul",{className:"space-y-3"},X.map(e=>t.createElement(ee,{key:e._id,node:e,me:x,getLabel:r=>K.get(F(r))||"anonymous",replyingId:O,replyText:A,postingReplyId:B,editingId:C,editText:f,savingId:te,deletingId:ne,likingId:oe,onStartReply:S,onCancelReply:()=>{S(null),D("")},onChangeReply:D,onSubmitReply:se,onStartEdit:r=>{N(y(r._id)),z(r.content||"")},onCancelEdit:()=>{N(null),z("")},onChangeEdit:z,onSaveEdit:re,onDelete:le,onToggleLike:ie,flashId:ae})))))}function ee(a){var N;const{node:n,me:h,getLabel:m,replyingId:l,replyText:u,postingReplyId:i,editingId:x,editText:w,savingId:E,deletingId:b,likingId:U,onStartReply:v,onCancelReply:k,onChangeReply:_,onSubmitReply:I,onStartEdit:R,onCancelEdit:L,onChangeEdit:$,onSaveEdit:M,onDelete:T,onToggleLike:O,flashId:S}=a,A=n.thumbs??n.thumbsUpUsers??[],D=A.map(f=>String(f||"").toLowerCase()).includes(h),B=n.thumbsCount??A.length,C=String(S||"")===String(n._id)?"bg-yellow-50 ring-2 ring-yellow-300 rounded-lg p-2 transition-colors":"";return t.createElement("li",null,t.createElement("div",{id:`comment-${n._id}`,className:`flex items-start gap-3 ${C}`},t.createElement("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gray-200"}),t.createElement("div",{className:"min-w-0 flex-1"},t.createElement("div",{className:"flex items-center gap-2"},t.createElement("span",{className:"text-sm font-medium text-gray-900"},m(n.email)),t.createElement("span",{className:"text-xs text-gray-500"},"â€¢ ",H(n.createdAt).fromNow())),x===n._id?t.createElement("div",{className:"mt-2"},t.createElement("textarea",{value:w,onChange:f=>$(f.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),t.createElement("div",{className:"mt-2 flex gap-2"},t.createElement("button",{onClick:M,disabled:E===n._id,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},E===n._id?"Savingâ€¦":"Save"),t.createElement("button",{onClick:L,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))):t.createElement("p",{className:"mt-1 whitespace-pre-wrap break-words text-sm text-gray-800"},n.content),t.createElement("div",{className:"mt-2 flex items-center gap-3 text-xs text-gray-600"},t.createElement("button",{onClick:()=>O(n._id),disabled:U===n._id,className:`rounded px-2 py-1 ${D?"bg-blue-50 text-blue-600":"hover:bg-gray-100"} disabled:opacity-60`},"ðŸ‘ ",B),t.createElement("button",{onClick:()=>v(n._id),className:"rounded px-2 py-1 hover:bg-gray-100"},"Reply"),String(n.email||"").toLowerCase()===h&&t.createElement(t.Fragment,null,t.createElement("button",{onClick:()=>R(n),className:"rounded px-2 py-1 hover:bg-gray-100"},"Edit"),t.createElement("button",{onClick:()=>T(n._id),disabled:b===n._id,className:"rounded px-2 py-1 text-red-600 hover:bg-red-50 disabled:opacity-60"},b===n._id?"Deletingâ€¦":"Delete"))),((N=n.children)==null?void 0:N.length)>0&&t.createElement("ul",{className:"mt-3 space-y-3 border-l-2 border-gray-200 pl-6"},n.children.map(f=>t.createElement(ee,{key:f._id,node:f,me:h,getLabel:m,replyingId:l,replyText:u,postingReplyId:i,editingId:x,editText:w,savingId:E,deletingId:b,likingId:U,onStartReply:v,onCancelReply:k,onChangeReply:_,onSubmitReply:I,onStartEdit:R,onCancelEdit:L,onChangeEdit:$,onSaveEdit:M,onDelete:T,onToggleLike:O,flashId:S}))))),l===n._id&&t.createElement("div",{className:"ml-11 mt-2"},t.createElement("textarea",{value:u,onChange:f=>_(f.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10",placeholder:"Write a replyâ€¦"}),t.createElement("div",{className:"mt-2 flex gap-2"},t.createElement("button",{onClick:()=>I(n._id),disabled:i===n._id,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},i===n._id?"Postingâ€¦":"Reply"),t.createElement("button",{onClick:k,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))))}export{Se as C};
