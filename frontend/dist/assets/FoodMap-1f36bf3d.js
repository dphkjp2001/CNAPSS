import{r as n,a as fe,b as ge,R as t}from"./index-0ab2f2c1.js";import{u as pe,c as xe,l as ne,b as re,e as he,d as ye,M as Ee,T as be,a as ee,L as se,P as te}from"./leaflet-c6a478d8.js";function ve(c,r,s){r.center!==s.center&&c.setLatLng(r.center),r.radius!=null&&r.radius!==s.radius&&c.setRadius(r.radius)}function we(){return pe().map}const ae=xe(function({center:r,children:s,...l},i){const p=new ne.Circle(r,l);return re(p,he(i,{overlayContainer:p}))},ve),Ne=ye(function(r,s){const l=new ne.Tooltip(r,s.overlayContainer);return re(l,s)},function(r,s,{position:l},i){n.useEffect(function(){const m=s.overlayContainer;if(m==null)return;const{instance:f}=r,x=g=>{g.tooltip===f&&(l!=null&&f.setLatLng(l),f.update(),i(!0))},y=g=>{g.tooltip===f&&i(!1)};return m.on({tooltipopen:x,tooltipclose:y}),m.bindTooltip(f),function(){m.off({tooltipopen:x,tooltipclose:y}),m._map!=null&&m.unbindTooltip()}},[r,s,i,l])}),le="https://api.cnapss.com/api".replace(/\/$/,""),oe=c=>({"Content-Type":"application/json",Authorization:`Bearer ${c}`});async function Se({school:c,token:r,address:s,lat:l,lon:i,radius:p,types:m=["restaurant","cafe","fast food"],minRating:f=0,minReviews:x=0,sortBy:y="best_match",term:g="",categories:C,priceLevels:v,openNow:M}){const S=String(c||"").toLowerCase().trim(),_=new URLSearchParams({...s&&{address:s},...l!=null&&{lat:l},...i!=null&&{lon:i},...p!=null&&{radius:p},types:m.join(","),minRating:f,minReviews:x,sortBy:y,...g&&{term:g},...C&&{categories:C},...v&&{priceLevels:v},...M?{openNow:"true"}:{}}),h=await fetch(`${le}/${S}/places/nearby?${_.toString()}`,{headers:oe(r)});if(h.status===501){const T=new Error("Feature unavailable");throw T.code="FEATURE_UNAVAILABLE",T}if(!h.ok)throw new Error(`Failed to load places: ${h.status}`);return h.json()}async function ke({school:c,token:r,text:s,lat:l,lon:i,limit:p=8}){const m=String(c||"").toLowerCase().trim(),f=new URLSearchParams({text:String(s||""),...l!=null&&{latitude:String(l)},...i!=null&&{longitude:String(i)},limit:String(p)}),x=await fetch(`${le}/${m}/places/suggest?${f.toString()}`,{headers:oe(r)});if(!x.ok)throw new Error("Failed to load suggestions");return x.json()}function Ce({anchor:c,focus:r}){const s=we();return n.useEffect(()=>{const l=r||c;l!=null&&l.lat&&(l!=null&&l.lon)&&s.setView([l.lat,l.lon],s.getZoom(),{animate:!0})},[c,r,s]),null}const Te=se.divIcon({className:"w-3 h-3 rounded-full bg-rose-600 ring-2 ring-white shadow-[0_0_0_2px_rgba(244,63,94,0.35)]",iconSize:[12,12],iconAnchor:[6,6]});function Re(){const{token:c}=fe(),{school:r}=ge(),[s,l]=n.useState({lat:40.729513,lon:-73.997649}),[i,p]=n.useState({lat:40.729513,lon:-73.997649}),[m,f]=n.useState(1200),[x,y]=n.useState(null),[g,C]=n.useState(["restaurant","cafe","fast food"]),[v,M]=n.useState([]),[S,_]=n.useState([1,2,3]),[h,T]=n.useState(!1),[P,ce]=n.useState(0),[j,ie]=n.useState(0),[I,ue]=n.useState("best_match"),[w,B]=n.useState(""),[A,me]=n.useState(!1),[E,F]=n.useState([]),[b,U]=n.useState(null),[D,H]=n.useState(!1),[V,q]=n.useState(""),[W,Y]=n.useState(!1),[k,z]=n.useState([]),[Z,L]=n.useState(!1),[O,R]=n.useState(-1),de=n.useRef(null),K=n.useRef({}),G=n.useRef(null),J=n.useRef({}),$=n.useMemo(()=>String(r||"").toUpperCase(),[r]);if(!c)return t.createElement("div",{className:"mx-auto max-w-4xl p-6"},t.createElement("div",{className:"rounded-xl border border-gray-200 bg-white p-6 text-sm text-gray-700"},"Please log in to use Food Map."));n.useEffect(()=>{let e=!1;return(async()=>{var a,o,u,N,X;try{H(!0),q(""),Y(!1);const d=await Se({school:r,token:c,...A?{address:w}:{term:w},radius:m,types:g,minRating:P,minReviews:j,sortBy:I,categories:v.join(","),priceLevels:S.join(","),openNow:h});if(e)return;(a=d.anchor)!=null&&a.lat&&((o=d.anchor)!=null&&o.lon)&&l(d.anchor),(u=d.center)!=null&&u.lat&&((N=d.center)!=null&&N.lon)&&p(d.center),F(Array.isArray(d.items)?d.items:[]),!b&&((X=d.items)!=null&&X.length)&&U(d.items[0].id),y(null)}catch(d){if(e)return;d&&d.code==="FEATURE_UNAVAILABLE"?(Y(!0),F([])):(q("Failed to load places."),F([]))}finally{e||H(!1)}})(),()=>{e=!0}},[r,c,m,g.join("|"),v.join("|"),S.join(","),h,P,j,I,w,A]),n.useEffect(()=>{let e;const a=w.trim();return a.length>=2?e=setTimeout(async()=>{try{const{suggestions:o}=await ke({school:r,token:c,text:a,lat:i.lat,lon:i.lon,limit:8});z(o||[]),L(!0),R(-1)}catch{z([]),L(!1)}},220):(z([]),L(!1)),()=>clearTimeout(e)},[w,r,c,i]),n.useEffect(()=>{if(!b)return;const e=E.find(N=>N.id===b),a=K.current[b];e!=null&&e.lat&&(e!=null&&e.lon)&&(y({lat:e.lat,lon:e.lon}),setTimeout(()=>{a&&typeof a.openPopup=="function"&&a.openPopup()},250));const o=J.current[b],u=G.current;if(o&&u)try{o.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}catch{const N=o.offsetTop-u.clientHeight/2+o.clientHeight/2;u.scrollTo({top:N,behavior:"smooth"})}},[b,E]);const Q=e=>{B(e.text||""),L(!1)};return t.createElement("div",{className:"flex h-[calc(100vh-72px)] flex-col overflow-hidden"},t.createElement("div",{className:"border-b bg-white/95 px-4 py-3"},t.createElement("div",{className:"flex flex-wrap items-center gap-3"},t.createElement("div",{className:"relative grow"},t.createElement("input",{ref:de,value:w,onChange:e=>B(e.target.value),placeholder:A?"Search by address or place (e.g., 'Washington Square Park')":"Search keyword (e.g., ramen, coffee)",className:"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10",onKeyDown:e=>{!Z||k.length===0||(e.key==="ArrowDown"?(e.preventDefault(),R(a=>Math.min(a+1,k.length-1))):e.key==="ArrowUp"?(e.preventDefault(),R(a=>Math.max(a-1,0))):e.key==="Enter"&&O>=0&&(e.preventDefault(),Q(k[O])))}}),Z&&k.length>0&&t.createElement("div",{className:"absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-lg border border-gray-200 bg-white shadow"},k.map((e,a)=>t.createElement("button",{key:`${e.type}-${e.text}-${a}`,onClick:()=>Q(e),className:`block w-full px-3 py-2 text-left text-sm ${a===O?"bg-gray-100":""}`,onMouseEnter:()=>R(a)},t.createElement("span",{className:"mr-2 rounded bg-gray-100 px-1.5 py-0.5 text-xs text-gray-700"},e.type),e.text)))),t.createElement("label",{className:"flex items-center gap-1 text-xs text-gray-700"},t.createElement("input",{type:"checkbox",checked:A,onChange:e=>me(e.target.checked)}),"by address"),t.createElement("div",{className:"flex items-center gap-2 text-xs text-gray-700"},t.createElement("span",null,"Radius"),t.createElement("select",{className:"rounded border px-1 py-0.5",value:m,onChange:e=>f(parseInt(e.target.value,10))},[600,800,1e3,1200,1500,2e3].map(e=>t.createElement("option",{key:e,value:e},e," m")))),t.createElement("div",{className:"flex items-center gap-2 text-xs text-gray-700"},t.createElement("span",null,"Min ⭐"),t.createElement("select",{className:"rounded border px-1 py-0.5",value:P,onChange:e=>ce(parseFloat(e.target.value))},[0,3.5,4,4.5].map(e=>t.createElement("option",{key:e,value:e},e)))),t.createElement("div",{className:"flex items-center gap-2 text-xs text-gray-700"},t.createElement("span",null,"Min reviews"),t.createElement("select",{className:"rounded border px-1 py-0.5",value:j,onChange:e=>ie(parseInt(e.target.value,10))},[0,20,50,100,200].map(e=>t.createElement("option",{key:e,value:e},e)))),t.createElement("div",{className:"flex items-center gap-2 text-xs text-gray-700"},t.createElement("span",null,"Sort"),t.createElement("select",{className:"rounded border px-1 py-0.5",value:I,onChange:e=>ue(e.target.value)},t.createElement("option",{value:"best_match"},"best match"),t.createElement("option",{value:"rating"},"rating"),t.createElement("option",{value:"review_count"},"review count"),t.createElement("option",{value:"distance"},"distance")))),t.createElement("div",{className:"mt-2 flex flex-wrap items-center gap-2 text-xs"},t.createElement("span",{className:"text-gray-600"},"Types:"),["restaurant","cafe","fast food"].map(e=>{const a=g.includes(e);return t.createElement("button",{key:e,onClick:()=>C(o=>a?o.filter(u=>u!==e):[...o,e]),className:`rounded-full px-2 py-1 ${a?"bg-gray-900 text-white":"border border-gray-300 text-gray-700 hover:bg-gray-50"}`},e)}),t.createElement("span",{className:"ml-2 text-gray-600"},"Cuisines:"),["ramen","sushi","pizza","burgers","thai","mexican","chinese","korean","indpak","vegan","italian"].map(e=>{const a=v.includes(e);return t.createElement("button",{key:e,onClick:()=>M(o=>a?o.filter(u=>u!==e):[...o,e]),className:`rounded-full px-2 py-1 ${a?"bg-indigo-600 text-white":"border border-gray-300 text-gray-700 hover:bg-gray-50"}`},e)}),t.createElement("span",{className:"ml-2 text-gray-600"},"Price:"),[1,2,3,4].map(e=>{const a=S.includes(e);return t.createElement("button",{key:e,onClick:()=>_(o=>a?o.filter(u=>u!==e):[...o,e].sort()),className:`rounded px-2 py-1 font-mono ${a?"bg-gray-900 text-white":"border border-gray-300 text-gray-700 hover:bg-gray-50"}`},"$".repeat(e))}),t.createElement("label",{className:"ml-2 flex items-center gap-1 text-gray-700"},t.createElement("input",{type:"checkbox",checked:h,onChange:e=>T(e.target.checked)}),"open now"))),t.createElement("div",{className:"flex flex-1 overflow-hidden"},t.createElement("div",{className:"relative flex-1"},t.createElement(Ee,{center:[s.lat,s.lon],zoom:15,style:{height:"100%",width:"100%"},scrollWheelZoom:!0},t.createElement(Ce,{anchor:s,focus:x||null}),t.createElement(be,{attribution:"© OpenStreetMap contributors",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),t.createElement(ee,{position:[s.lat,s.lon],icon:se.divIcon({className:"flex items-center justify-center rounded-full border-2 border-white bg-indigo-600 shadow-lg",html:'<div style="width:18px;height:18px;border-radius:9999px"></div>',iconSize:[18,18],iconAnchor:[9,9]})},t.createElement(Ne,{direction:"top",offset:[0,-10],opacity:1,permanent:!0},$),t.createElement(te,null,"Center • ",$)),t.createElement(ae,{center:[s.lat,s.lon],radius:80,color:"#6b21a8",fillColor:"#c4b5fd",fillOpacity:.25}),t.createElement(ae,{center:[i.lat,i.lon],radius:m,color:"#6b21a8",fillOpacity:0,dashArray:"6 6"}),E.map(e=>t.createElement(ee,{key:e.id,position:[e.lat,e.lon],icon:Te,eventHandlers:{click:()=>U(e.id)},ref:a=>{a&&(K.current[e.id]=a)}},t.createElement(te,null,t.createElement("div",{className:"text-sm"},t.createElement("div",{className:"font-semibold"},e.name),t.createElement("div",{className:"text-gray-600"},e.address||"-"),t.createElement("div",{className:"mt-1 text-gray-600"},"⭐ ",e.rating??"-"," · ",e.review_count??0," reviews"),e.price?t.createElement("div",{className:"text-gray-600"},"$".repeat(e.price)):null,e.website?t.createElement("a",{href:e.website,target:"_blank",rel:"noreferrer",className:"mt-1 inline-block text-indigo-600 underline"},"Yelp"):null))))),t.createElement("div",{className:"pointer-events-none absolute left-3 bottom-3 rounded-lg bg-white/90 px-3 py-1 text-xs text-gray-700 shadow"},D?"Loading…":`${E.length} places`,V&&t.createElement("span",{className:"ml-2 text-red-600"},V),W&&t.createElement("span",{className:"ml-2"},"Feature not available for ",t.createElement("b",null,$)," yet."))),t.createElement("div",{className:"w-[380px] border-l bg-white h-full flex flex-col"},t.createElement("div",{className:"flex items-center justify-between border-b px-4 py-3"},t.createElement("div",{className:"text-sm font-semibold"},"Results"),t.createElement("div",{className:"text-xs text-gray-500"},E.length)),t.createElement("div",{className:"flex-1 overflow-auto",ref:G},W?t.createElement("div",{className:"p-4 text-sm text-gray-700"},"This feature is not available for ",t.createElement("b",null,$)," yet."):!D&&E.length===0?t.createElement("div",{className:"p-4 text-sm text-gray-500"},"No results. Try widening radius or changing filters."):t.createElement("ul",{className:"divide-y"},E.map(e=>{var o;const a=b===e.id;return t.createElement("li",{key:e.id,ref:u=>{u&&(J.current[e.id]=u)},className:`cursor-pointer px-4 py-3 hover:bg-gray-50 ${a?"bg-indigo-50":""}`,onClick:()=>U(e.id)},t.createElement("div",{className:"flex items-start justify-between"},t.createElement("div",null,t.createElement("div",{className:"font-medium"},e.name),t.createElement("div",{className:"text-xs text-gray-600"},((o=e.categories)==null?void 0:o.join(" • "))||"-"),t.createElement("div",{className:"mt-1 text-xs text-gray-600"},"⭐ ",e.rating??"-"," · ",e.review_count??0," reviews",e.price?t.createElement("span",null," · ","$".repeat(e.price)):null),t.createElement("div",{className:"mt-1 text-xs text-gray-500"},e.address||"-")),e.website?t.createElement("a",{href:e.website,target:"_blank",rel:"noreferrer",className:"ml-3 rounded bg-gray-900 px-2 py-1 text-xs text-white",onClick:u=>u.stopPropagation()},"Yelp"):null))}))))))}export{Re as default};
