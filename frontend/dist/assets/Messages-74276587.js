import{t as K,y as G,z as U,B as H,d as q,b as V,v as J,r as c,R as a,j as Z,w as Q}from"./index-f5d06e92.js";import{a as W,d as D,r as X}from"./relativeTime-0382aa45.js";import{M as P}from"./message-square-291dbb91.js";var O={exports:{}};(function(r,d){(function(o,i){r.exports=i()})(K,function(){var o={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"};return function(i,E,m){var l=E.prototype,M=l.format;m.en.formats=o,l.format=function(g){g===void 0&&(g="YYYY-MM-DDTHH:mm:ssZ");var b=this.$locale().formats,s=function(u,y){return u.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,function(f,h,x){var v=x&&x.toUpperCase();return h||y[x]||o[x]||y[v].replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,function(Y,w,S){return w||S.slice(1)})})}(g,b===void 0?{}:b);return M.call(this,s)}}})})(O);var I=O.exports;const ee=G(I);var te={exports:{}};(function(r,d){(function(o,i){r.exports=i(W)})(K,function(o){function i(l){return l&&typeof l=="object"&&"default"in l?l:{default:l}}var E=i(o),m={name:"ko",weekdays:"ì¼ìš”ì¼_ì›”ìš”ì¼_í™”ìš”ì¼_ìˆ˜ìš”ì¼_ëª©ìš”ì¼_ê¸ˆìš”ì¼_í† ìš”ì¼".split("_"),weekdaysShort:"ì¼_ì›”_í™”_ìˆ˜_ëª©_ê¸ˆ_í† ".split("_"),weekdaysMin:"ì¼_ì›”_í™”_ìˆ˜_ëª©_ê¸ˆ_í† ".split("_"),months:"1ì›”_2ì›”_3ì›”_4ì›”_5ì›”_6ì›”_7ì›”_8ì›”_9ì›”_10ì›”_11ì›”_12ì›”".split("_"),monthsShort:"1ì›”_2ì›”_3ì›”_4ì›”_5ì›”_6ì›”_7ì›”_8ì›”_9ì›”_10ì›”_11ì›”_12ì›”".split("_"),ordinal:function(l){return l+"ì¼"},formats:{LT:"A h:mm",LTS:"A h:mm:ss",L:"YYYY.MM.DD.",LL:"YYYYë…„ MMMM Dì¼",LLL:"YYYYë…„ MMMM Dì¼ A h:mm",LLLL:"YYYYë…„ MMMM Dì¼ dddd A h:mm",l:"YYYY.MM.DD.",ll:"YYYYë…„ MMMM Dì¼",lll:"YYYYë…„ MMMM Dì¼ A h:mm",llll:"YYYYë…„ MMMM Dì¼ dddd A h:mm"},meridiem:function(l){return l<12?"ì˜¤ì „":"ì˜¤í›„"},relativeTime:{future:"%s í›„",past:"%s ì „",s:"ëª‡ ì´ˆ",m:"1ë¶„",mm:"%dë¶„",h:"í•œ ì‹œê°„",hh:"%dì‹œê°„",d:"í•˜ë£¨",dd:"%dì¼",M:"í•œ ë‹¬",MM:"%dë‹¬",y:"ì¼ ë…„",yy:"%dë…„"}};return E.default.locale(m,null,!0),m})})(te);const j="https://api.cnapss.com/api".replace(/\/$/,"");function ae({school:r,token:d}){return U(`${j}/${r}/chat/conversations`)}function re({school:r,token:d,conversationId:o,cursor:i,limit:E=50}){const m=new URL(`${j}/${r}/chat/conversations/${o}/messages`);return i&&m.searchParams.set("cursor",i),m.searchParams.set("limit",String(E)),U(m.toString())}function se({school:r,token:d,conversationId:o,content:i}){return H(`${j}/${r}/chat/conversations/${o}/messages`,{content:i})}function ne({school:r,token:d,conversationId:o}){return H(`${j}/${r}/chat/conversations/${o}/read`,{})}D.locale("ko");D.extend(X);D.extend(ee);function le({conversationId:r,userEmail:d,onClose:o,fullSize:i=!1,otherNickname:E,otherEmail:m}){const{user:l,token:M}=q()||{},{school:g}=V()||{},{socket:b,emit:s,on:u,off:y}=J(),f=((l==null?void 0:l.email)||d||"").toLowerCase(),[h,x]=c.useState([]),[v,Y]=c.useState(""),[w,S]=c.useState(!1),[R,$]=c.useState(!1),F=c.useRef(null);c.useEffect(()=>{if(!r||!M||!g)return;let e=!0;return(async()=>{try{$(!0);const n=await re({school:g,token:M,conversationId:r});if(!e)return;x((Array.isArray(n)?n:[]).reverse()),s==null||s("chat:read",{conversationId:r});try{await ne({school:g,token:M,conversationId:r})}catch{}}finally{e&&$(!1)}})(),()=>{e=!1}},[r,M,g,s]),c.useEffect(()=>{if(!r||!b)return;s==null||s("chat:join",{conversationId:r});const e=_=>{String(_.conversationId)===String(r)&&(x(A=>A.some(L=>L._id&&_._id&&String(L._id)===String(_._id))?A:[...A,_]),s==null||s("chat:read",{conversationId:r}))},n=({conversationId:_,reader:A})=>{String(_)===String(r)&&x(z=>z.map(L=>(L.readBy||[]).includes(A)?L:{...L,readBy:[...L.readBy||[],A]}))},p=u==null?void 0:u("chat:receive",e),k=u==null?void 0:u("chat:read:updated",n);return()=>{typeof p=="function"&&p(),typeof k=="function"&&k()}},[b,s,u,r]);const B=async()=>{const e=v.trim();if(!(!e||!r))try{const n=await se({school:g,token:M,conversationId:r,content:e});x(p=>(n==null?void 0:n._id)&&p.some(_=>String(_._id)===String(n._id))?p:[...p,n])}catch(n){console.error("send failed",n),alert("ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨")}finally{Y("")}};c.useEffect(()=>{var e;(e=F.current)==null||e.scrollIntoView({behavior:"smooth",block:"nearest"})},[h]);const C=(e,n)=>{var p;return n===0||!D(e.createdAt).isSame((p=h[n-1])==null?void 0:p.createdAt,"day")},t=[...h].reverse().find(e=>(e.sender||"").toLowerCase()===f&&(e.readBy||[]).map(n=>n.toLowerCase()).includes((m||"").toLowerCase()));return a.createElement("div",{className:`relative border rounded-lg shadow bg-white flex flex-col ${i?"w-full h-full":"w-[360px]"}`},o&&a.createElement("button",{onClick:o,className:"absolute top-2 right-2 text-gray-400 hover:text-black text-xl"},"Ã—"),a.createElement("div",{className:"flex items-center gap-2 border-b p-2 font-semibold"},a.createElement("span",null,"ğŸ—¨ï¸"),a.createElement("span",null,E||"Chat")),a.createElement("div",{className:"flex-1 overflow-y-auto p-3 space-y-2"},R&&a.createElement("div",{className:"text-sm text-gray-500"},"Loading..."),h.map((e,n)=>a.createElement("div",{key:e._id||n},C(e,n)&&a.createElement("div",{className:"text-center text-xs text-gray-400 my-2"},D(e.createdAt).format("YYYYë…„ Mì›” Dì¼")),a.createElement("div",{className:`flex ${(e.sender||"").toLowerCase()===f?"justify-end":"justify-start"}`},a.createElement("div",{className:"max-w-xs"},a.createElement("div",{className:`px-3 py-1 rounded-lg break-words ${(e.sender||"").toLowerCase()===f?"bg-blue-600 text-white":"bg-gray-200 text-black"}`},e.content),a.createElement("div",{className:`text-[11px] mt-1 ${(e.sender||"").toLowerCase()===f?"text-right text-gray-400":"text-left text-gray-500"}`},D(e.createdAt).format("A h:mm"),e===t&&a.createElement("span",{className:"ml-1 text-blue-500 font-medium"},"Seen")))))),a.createElement("div",{ref:F})),a.createElement("div",{className:"flex gap-2 p-2 border-t"},a.createElement("input",{type:"text",className:"flex-1 border rounded p-2",value:v,onChange:e=>Y(e.target.value),onCompositionStart:()=>S(!0),onCompositionEnd:()=>S(!1),onKeyDown:e=>{e.key==="Enter"&&!w&&B()},placeholder:"ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."}),a.createElement("button",{onClick:B,disabled:!v.trim(),className:"bg-blue-600 text-white px-4 rounded hover:bg-blue-700 disabled:opacity-50"},"Send")))}const N={pageBg:"#F8F9FA",text:"#1F2937",sub:"#6B7280",primary:"#111827",accent:"#FF7A70",accentHover:"#FF6B61"};function me(){const{user:r,token:d}=q()||{},{school:o}=Z(),[i,E]=Q(),{on:m}=J()||{},[l,M]=c.useState([]),[g,b]=c.useState(!0),[s,u]=c.useState(null),[y,f]=c.useState("all"),h=(o||"").toLowerCase(),x=c.useMemo(()=>((r==null?void 0:r.email)||"").toLowerCase(),[r]),v=c.useCallback(async()=>{if(!(!d||!h)){b(!0);try{const t=await ae({school:h,token:d}),e=Array.isArray(t)?t:Array.isArray(t==null?void 0:t.items)?t.items:[];return M(e),e}finally{b(!1)}}},[h,d]);c.useEffect(()=>{let t=!0;(async()=>{const n=await v();if(!t)return;const p=i.get("conversation");if(p&&Array.isArray(n)){const k=n.find(_=>String(_._id)===String(p));k&&(u(k),f(B(k)))}})();const e=m==null?void 0:m("chat:preview",()=>{v()});return()=>{t=!1,typeof e=="function"&&e()}},[v,m,i]);const Y=t=>String(t||"").toLowerCase().replace(/[\s-]+/g,"_"),w=t=>String(t==null?void 0:t.source).toLowerCase()==="looking_for",S=t=>{const e=String((t==null?void 0:t.buyer)||"").toLowerCase(),n=String((t==null?void 0:t.seller)||"").toLowerCase();return e===x?n:e},R=t=>t?String(t).split("@")[0]:"Unknown",$=t=>(t==null?void 0:t.resourceTitle)&&t.resourceTitle.trim()||R(S(t)),F=t=>{if(!w(t))return"ğŸ’¬ DM";const e=Y(t==null?void 0:t.seekingKind);return e==="course_materials"?"ğŸ“ Materials":e==="study_mate"?"ğŸ‘¥ Study Buddy":e==="coffee_chat"?"â˜• Coffee Chat":"ğŸ“ Seeking"},B=t=>{if(!w(t))return"all";const e=Y(t==null?void 0:t.seekingKind);return e==="course_materials"?"lf_course_materials":e==="study_mate"?"lf_study_mate":e==="coffee_chat"?"lf_coffee_chat":"all"},C=c.useMemo(()=>{if(y==="all")return l;const t=y.replace(/^lf_/,"");return l.filter(e=>w(e)&&Y(e==null?void 0:e.seekingKind)===t)},[l,y]);return c.useEffect(()=>{const t=s!=null&&s._id?String(s._id):null,e=new URLSearchParams(i.toString());t?e.set("conversation",t):e.delete("conversation"),E(e,{replace:!0})},[s]),a.createElement("div",{className:"min-h-screen p-4 sm:p-6",style:{backgroundColor:N.pageBg}},a.createElement("div",{className:"mx-auto max-w-7xl"},a.createElement("div",{className:"mb-6"},a.createElement("h1",{className:"text-gray-900 mb-1"},"Messages"),a.createElement("p",{className:"text-sm text-gray-600"},"Chat with classmates and connect")),a.createElement("div",{className:"flex flex-col lg:flex-row gap-4 h-[calc(100vh-200px)]"},a.createElement("div",{className:"lg:w-[360px] shrink-0 flex flex-col rounded-xl border border-gray-200 bg-white shadow-sm overflow-hidden"},a.createElement("div",{className:"flex flex-wrap gap-2 p-4 border-b border-gray-200 bg-gray-50"},a.createElement(T,{active:y==="all",onClick:()=>f("all")},"All"),a.createElement(T,{active:y==="lf_course_materials",onClick:()=>f("lf_course_materials")},"Materials"),a.createElement(T,{active:y==="lf_study_mate",onClick:()=>f("lf_study_mate")},"Study Buddy"),a.createElement(T,{active:y==="lf_coffee_chat",onClick:()=>f("lf_coffee_chat")},"Coffee Chat")),a.createElement("div",{className:"min-h-0 grow overflow-y-auto"},g?a.createElement("div",{className:"p-4 space-y-3"},Array.from({length:5}).map((t,e)=>a.createElement("div",{key:e,className:"h-16 rounded-lg bg-gray-100 animate-pulse"}))):C!=null&&C.length?a.createElement("ul",{className:"divide-y divide-gray-100"},C.map(t=>{const e=(s==null?void 0:s._id)===t._id;return a.createElement("li",{key:t._id},a.createElement("button",{onClick:()=>{u(t),f(B(t))},className:`flex w-full items-center gap-3 px-4 py-3 text-left transition-all ${e?"bg-gray-50 border-l-2":"hover:bg-gray-50"}`,style:e?{borderLeftColor:N.accent}:{}},a.createElement("div",{className:"w-11 h-11 rounded-full flex items-center justify-center shrink-0",style:{background:`linear-gradient(135deg, ${N.accent}20, ${N.accent}40)`}},a.createElement("span",{className:"text-lg"},F(t).split(" ")[0])),a.createElement("div",{className:"min-w-0 flex-1"},a.createElement("div",{className:"flex items-center gap-2 mb-1"},a.createElement("span",{className:"inline-block px-2 py-0.5 rounded-full text-xs",style:{backgroundColor:N.primary,color:"#fff"}},F(t))),a.createElement("h4",{className:"text-sm text-gray-900 truncate mb-0.5"},$(t)),t.lastMessage&&a.createElement("p",{className:"text-xs text-gray-500 truncate"},t.lastMessage))))})):a.createElement("div",{className:"text-center py-16 px-4"},a.createElement(P,{size:48,className:"mx-auto mb-3 text-gray-300"}),a.createElement("p",{className:"text-sm text-gray-500"},"No conversations yet.")))),a.createElement("div",{className:"min-w-0 flex-1 rounded-xl border border-gray-200 bg-white shadow-sm overflow-hidden"},s?a.createElement(le,{conversationId:s._id,userEmail:r==null?void 0:r.email,otherEmail:S(s),otherNickname:$(s),fullSize:!0}):a.createElement("div",{className:"h-full flex flex-col items-center justify-center text-gray-400"},a.createElement(P,{size:64,className:"mb-4 text-gray-300"}),a.createElement("p",{className:"text-sm"},"Select a conversation to start chatting"))))))}function T({active:r,children:d,onClick:o}){return a.createElement("button",{onClick:o,className:"rounded-full px-3 py-1.5 text-xs transition-all",style:r?{backgroundColor:N.accent,color:"#fff"}:{backgroundColor:"#fff",border:"1px solid #E5E7EB",color:N.text}},d)}export{me as default};
