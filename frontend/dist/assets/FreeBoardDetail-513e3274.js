import{e as q,u as G,a as J,c as K,b as Q,d as X,r,R as t,L as Z}from"./index-a7c5a64d.js";import{C as ee}from"./CommentSection-696d34d5.js";import{d as N,r as te}from"./relativeTime-0cbdc6dc.js";import{u as ae,d as ne,e as oe,f as se,v as re}from"./academicPosts-3f24bdec.js";import{a as le}from"./http-e19067b4.js";import"./useLoginGate-d8a1633c.js";N.extend(te);N.locale("en");function ge(){const{id:m}=q(),Y=G(),d=J(),{user:o,token:S}=K(),{school:l,schoolTheme:i}=Q(),k=X(),[n,h]=r.useState(null),[P,I]=r.useState(""),[u,x]=r.useState(!1),[L,f]=r.useState(""),[U,g]=r.useState(""),[V,D]=r.useState(!1),_=!!(o!=null&&o.email||S&&String(S).length>0),[A,b]=r.useState(0),[B,w]=r.useState(0),[y,F]=r.useState(null),[v,R]=r.useState(!1),z=A-B,H=async()=>{I("");try{const e=await ne({school:l,id:m});h(e),f((e==null?void 0:e.title)||""),g((e==null?void 0:e.content)||""),b((e==null?void 0:e.upCount)||0),w((e==null?void 0:e.downCount)||0)}catch(e){if((e==null?void 0:e.status)!==404){I((e==null?void 0:e.message)||"Failed to load the post.");return}}if(_)try{const e=await oe({school:l,id:m});h(e),f((e==null?void 0:e.title)||""),g((e==null?void 0:e.content)||""),b((e==null?void 0:e.upCount)||0),w((e==null?void 0:e.downCount)||0),F((e==null?void 0:e.myVote)??null)}catch{}};r.useEffect(()=>{!l||!m||H()},[m,l,_]),r.useEffect(()=>{const a=new URLSearchParams(d.search).get("nid");async function s(){if(!(!a||!(o!=null&&o.email)||!l))try{const p="https://api.cnapss.com/api".replace(/\/+$/,"");await le(`${p}/${l}/notification/mark-read`,{method:"POST",headers:{"Content-Type":"application/json"},body:{commentId:a,email:o.email}})}catch{}}s()},[d.search,o==null?void 0:o.email,l]);const O=r.useMemo(()=>{const e=d.hash||"",a=e.startsWith("#comment-")?e.slice(9):null,s=new URLSearchParams(d.search).get("nid");return a||s||null},[d.hash,d.search]),c=r.useMemo(()=>{var j,M;const e=n,a=o;if(!e||!a)return!1;const s=[a.id,a._id].filter(Boolean).map(String);return[e.userId,e.authorId,(j=e.author)==null?void 0:j._id,(M=e.author)==null?void 0:M.id].filter(Boolean).map(String).some(W=>s.includes(W))},[o,n]),T=async()=>{if(window.confirm("Delete this post?"))try{await se({school:l,id:n._id}),alert("Post deleted."),Y(k("/dashboard?tab=free"))}catch(e){alert("Delete failed: "+((e==null?void 0:e.message)||"Unknown error"))}},$=async e=>{if(!o){alert("Please log in to vote.");return}if(!(c||v)){if(y&&y!==e){alert("Cancel your current vote first.");return}R(!0);try{const a=await re({school:l,id:n._id,dir:e});typeof(a==null?void 0:a.upCount)=="number"&&b(a.upCount),typeof(a==null?void 0:a.downCount)=="number"&&w(a.downCount),typeof(a==null?void 0:a.myVote)<"u"&&F(a.myVote)}catch(a){alert("Vote failed: "+((a==null?void 0:a.message)||"Unknown error"))}finally{R(!1)}}},E=y==="up",C=y==="down";return P?t.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-red-700",style:{backgroundColor:(i==null?void 0:i.bg)||"#f6f3ff"}},P):n?t.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(i==null?void 0:i.bg)||"#f6f3ff"}},t.createElement("div",{className:"mx-auto max-w-3xl"},t.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},t.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},u?t.createElement("input",{value:L,onChange:e=>f(e.target.value),placeholder:"Title",className:"w-full rounded-xl border border-gray-300 px-3 py-2 text-lg font-semibold text-gray-900 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):t.createElement("h1",{className:"text-2xl font-bold text-gray-900"},n.title),t.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",t.createElement("span",{className:"font-medium"},"anonymous")," ‚Ä¢ ",N(n.createdAt).fromNow())),t.createElement("div",{className:"p-5 sm:p-6"},u?t.createElement("textarea",{value:U,onChange:e=>g(e.target.value),placeholder:"Content",className:"h-56 w-full resize-y rounded-xl border border-gray-300 px-3 py-2 text-sm text-gray-800 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):t.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},t.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},n.content)),t.createElement("div",{className:"mt-6 flex flex-wrap items-center gap-3"},t.createElement("div",{className:"flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-2 py-1"},t.createElement("button",{onClick:()=>$("up"),disabled:!o||c||v||C,className:`flex items-center gap-1 rounded-md px-3 py-1 text-sm font-semibold ${E?"bg-gray-100 text-red-600":"text-gray-800 hover:bg-gray-100"} disabled:opacity-60`,"aria-label":"Upvote",title:o?c?"You can‚Äôt vote on your own post.":C?"Cancel your downvote first":"Upvote":"Log in to vote"},"üëç ",t.createElement("span",null,A)),t.createElement("button",{onClick:()=>$("down"),disabled:!o||c||v||E,className:`flex items-center gap-1 rounded-md px-3 py-1 text-sm font-semibold ${C?"bg-gray-100 text-blue-600":"text-gray-800 hover:bg-gray-100"} disabled:opacity-60`,"aria-label":"Downvote",title:o?c?"You can‚Äôt vote on your own post.":E?"Cancel your upvote first":"Downvote":"Log in to vote"},"üëé ",t.createElement("span",null,B)),t.createElement("span",{className:"ml-2 text-sm font-medium text-gray-700"},"Score: ",z)),c&&!u&&t.createElement(t.Fragment,null,t.createElement("button",{onClick:()=>x(!0),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:"#6b46c1"}},"Edit"),t.createElement("button",{onClick:T,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")),c&&u&&t.createElement(t.Fragment,null,t.createElement("button",{onClick:async()=>{const e=L.trim(),a=U.trim();if(!(!e||!a)){D(!0);try{const s=await ae({school:l,id:n._id,title:e,content:a}),p=(s==null?void 0:s.post)||s;h(p),x(!1)}catch(s){alert("Update failed: "+((s==null?void 0:s.message)||"Unknown error"))}finally{D(!1)}}},disabled:V,className:"rounded-xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-black disabled:opacity-60"},V?"Saving‚Ä¶":"Save"),t.createElement("button",{onClick:()=>{f((n==null?void 0:n.title)||""),g((n==null?void 0:n.content)||""),x(!1)},className:"rounded-xl border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-800 shadow-sm hover:bg-gray-50"},"Cancel")),t.createElement(Z,{to:k("/dashboard?tab=free"),className:"ml-auto text-sm font-medium text-blue-600 underline underline-offset-2"},"‚Üê Back to List")))),(n==null?void 0:n._id)&&t.createElement("div",{className:"mt-6 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm sm:p-6"},t.createElement(ee,{postId:n._id,authorEmail:n.email,highlightId:O,anonymousMode:!0})))):t.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-gray-600",style:{backgroundColor:(i==null?void 0:i.bg)||"#f6f3ff"}},"Loading‚Ä¶")}export{ge as default};
