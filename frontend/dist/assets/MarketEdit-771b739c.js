import{f as L,u as R,c as G,a as $,b as q,r as u,R as e}from"./index-3bf3b025.js";import{g as B,u as O}from"./market-fdbf22cb.js";import{u as _}from"./uploadToCloudinary-a2ae08d3.js";const C=3,J=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}),z=()=>{const{id:f}=L(),g=R(),x=G(),{user:y,token:b}=$(),{school:h,schoolTheme:l}=q(),[s,E]=u.useState({title:"",description:"",price:""}),[i,d]=u.useState([]),[D,N]=u.useState(!0),[S,v]=u.useState(""),I=u.useMemo(()=>!(!s.title.trim()||!s.price||Number.isNaN(Number(s.price))||Number(s.price)<0),[s.title,s.price]);u.useEffect(()=>{let t=!0;return(async()=>{try{const a=await B({school:h,token:b,id:f});if(a.seller!==(y==null?void 0:y.email)){alert("You don’t have permission to edit this listing."),g(x("/market"));return}if(!t)return;E({title:a.title||"",description:a.description||"",price:String(a.price??"")});const o=Array.isArray(a.images)?a.images:[];d(o.map((n,c)=>({url:n,isCover:c===0})))}catch(a){console.error(a),alert("Failed to load the listing."),g(x("/market"))}finally{t&&N(!1)}})(),()=>{t=!1}},[f,y,g,h,x,b]);const P=t=>{const{name:r,value:a}=t.target;E(o=>({...o,[r]:a}))},F=t=>{const r=t.target.value.replace(/[^\d.]/g,"");E(a=>({...a,price:r}))},A=async t=>{const r=Math.max(0,C-i.length),a=Array.from(t||[]).slice(0,r);if(!a.length)return;const o=a.map(n=>({url:URL.createObjectURL(n),uploading:!0}));d(n=>[...n,...o]);for(let n=0;n<a.length;n++)try{const c=await _(a[n]);d(w=>{const m=[...w],p=m.findIndex(k=>k.uploading);return p!==-1&&(m[p]={url:c,uploading:!1}),m})}catch(c){console.error("image upload failed",c),d(w=>{const m=[...w],p=m.findIndex(k=>k.uploading);return p!==-1&&m.splice(p,1),m}),v("Failed to upload one or more images.")}},j=t=>{d(r=>r.filter((a,o)=>o!==t))},M=t=>{d(r=>{const a=r.map((n,c)=>({...n,isCover:c===t})),[o]=a.splice(t,1);return a.unshift(o),a})},U=async t=>{if(t.preventDefault(),!(!I||i.some(r=>r.uploading)))try{N(!0),v(""),await O({school:h,token:b,id:f,payload:{title:s.title.trim(),description:s.description.trim(),price:parseFloat(s.price),images:i.map(r=>r.url)}}),g(x(`/market/${f}`))}catch(r){console.error(r),v("Failed to save changes. Please try again."),alert("Update failed.")}finally{N(!1)}};return D?e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-gray-600",style:{backgroundColor:(l==null?void 0:l.bg)||"#f6f3ff"}},"Loading…"):e.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(l==null?void 0:l.bg)||"#f6f3ff"}},e.createElement("div",{className:"mx-auto max-w-3xl"},e.createElement("div",{className:"rounded-2xl border border-gray-200 bg-white shadow-sm"},e.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},e.createElement("h1",{className:"text-xl font-bold text-gray-900"},"Edit Listing"),e.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Update photos, title, price, and description. The first photo is used as the cover.")),e.createElement("form",{onSubmit:U,className:"p-5 sm:p-6 space-y-6"},e.createElement("section",null,e.createElement("label",{className:"block text-sm font-medium text-gray-900"},"Photos ",e.createElement("span",{className:"font-normal text-gray-400"},"(up to ",C,")")),e.createElement("div",{className:"mt-2 flex flex-col items-center justify-center rounded-xl border-2 border-dashed border-gray-300 bg-gray-50/60 p-6 text-center transition hover:bg-gray-50",onDragOver:t=>t.preventDefault(),onDrop:t=>{t.preventDefault(),!(i.length>=C)&&A(t.dataTransfer.files)}},e.createElement("input",{id:"file-input",type:"file",accept:"image/*",multiple:!0,onChange:t=>A(t.target.files),className:"hidden"}),e.createElement("div",{className:"text-3xl"},"🖼️"),e.createElement("p",{className:"mt-2 text-sm text-gray-700"},"Drag & drop images here, or"," ",e.createElement("label",{htmlFor:"file-input",className:"cursor-pointer font-medium text-gray-900 underline underline-offset-2"},"browse")),e.createElement("p",{className:"text-xs text-gray-500 mt-1"},"PNG/JPG, up to ~5MB each")),i.length>0&&e.createElement("div",{className:"mt-4 grid grid-cols-2 gap-3 sm:grid-cols-3"},i.map((t,r)=>e.createElement("div",{key:r,className:"group relative overflow-hidden rounded-xl border border-gray-200 bg-white shadow-sm"},e.createElement("div",{className:"aspect-[4/3] bg-gray-50"},e.createElement("img",{src:t.url,alt:`photo ${r+1}`,className:`h-full w-full object-cover ${t.uploading?"opacity-60":""}`})),e.createElement("div",{className:"absolute inset-x-0 bottom-0 flex items-center justify-between gap-2 p-2"},e.createElement("button",{type:"button",onClick:()=>M(r),className:"rounded-md bg-white/90 px-2 py-1 text-xs font-medium text-gray-800 shadow hover:bg-white"},r===0?"Cover":"Set as cover"),e.createElement("button",{type:"button",onClick:()=>j(r),className:"rounded-md bg-white/90 px-2 py-1 text-xs font-medium text-red-600 shadow hover:bg-white"},"Remove")),t.uploading&&e.createElement("div",{className:"absolute inset-0 flex items-center justify-center bg-white/60 text-xs text-gray-700"},"Uploading…"))))),e.createElement("section",{className:"grid grid-cols-1 gap-4 sm:grid-cols-3"},e.createElement("div",{className:"sm:col-span-2"},e.createElement("label",{className:"block text-sm font-medium text-gray-900"},"Title"),e.createElement("input",{name:"title",value:s.title,onChange:P,placeholder:"e.g., iPad Air 64GB (Blue)",className:"mt-2 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10",required:!0})),e.createElement("div",null,e.createElement("label",{className:"block text-sm font-medium text-gray-900"},"Price"),e.createElement("div",{className:"mt-2 flex items-center rounded-xl border border-gray-300 bg-white px-3 py-2 shadow-sm focus-within:ring-2 focus-within:ring-gray-900/10"},e.createElement("span",{className:"mr-2 text-gray-500"},"$"),e.createElement("input",{name:"price",value:s.price,onChange:F,inputMode:"decimal",placeholder:"0",className:"w-full text-sm text-gray-900 placeholder:text-gray-400 focus:outline-none",required:!0})),s.price&&e.createElement("p",{className:"mt-1 text-xs text-gray-500"},J.format(Number(s.price)||0)))),e.createElement("section",null,e.createElement("label",{className:"block text-sm font-medium text-gray-900"},"Description"),e.createElement("textarea",{name:"description",value:s.description,onChange:P,rows:5,placeholder:"Add key details, usage, defects, pickup options, etc.",className:"mt-2 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10",required:!0})),S&&e.createElement("div",{className:"rounded-xl border border-red-200 bg-red-50 p-3 text-sm text-red-700"},S),e.createElement("div",{className:"flex items-center justify-end gap-2 border-t border-gray-100 pt-4"},e.createElement("button",{type:"button",onClick:()=>g(-1),className:"rounded-xl border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-800 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-900/10"},"Cancel"),e.createElement("button",{type:"submit",disabled:!I||i.some(t=>t.uploading),className:"inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold text-white shadow transition disabled:cursor-not-allowed disabled:opacity-60",style:{backgroundColor:(l==null?void 0:l.primary)||"#6b46c1"}},"Save Changes"))))))};export{z as default};
