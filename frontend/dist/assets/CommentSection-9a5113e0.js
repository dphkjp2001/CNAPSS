import{g as be,c as he,b as _e,h as xe,r as u,R as o,A as ae}from"./index-e7da315f.js";import{d as Y,r as Ee}from"./relativeTime-beb47cbb.js";import{u as we}from"./useLoginGate-1a1b5587.js";var Se={exports:{}};(function(e,f){(function(i,s){e.exports=s()})(be,function(){return{name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(i){var s=["th","st","nd","rd"],c=i%100;return"["+i+(s[(c-20)%10]||s[c]||s[0])+"]"}}})})(Se);const L="https://api.cnapss.com/api".replace(/\/+$/,""),R=e=>e?{"Content-Type":"application/json",Authorization:`Bearer ${e}`}:{"Content-Type":"application/json"};async function Ne({school:e,postId:f}){const i=String(e||"").toLowerCase().trim(),s=await fetch(`${L}/public/${i}/comments/${f}`,{method:"GET"});if(!s.ok)throw new Error("Failed to load comments");return s.json()}async function Ce({school:e,token:f,postId:i}){const s=String(e||"").toLowerCase().trim();if(!f)return Ne({school:s,postId:i});const c=await fetch(`${L}/${s}/comments/${i}`,{headers:R(f)});if(!c.ok)throw new Error("Failed to load comments");return c.json()}async function ne({school:e,token:f,postId:i,content:s,parentId:c=null}){const y=String(e||"").toLowerCase().trim(),m={content:String(s||"").trim()};c&&(m.parentId=String(c));const w=await fetch(`${L}/${y}/comments/${i}`,{method:"POST",headers:R(f),body:JSON.stringify(m)});if(!w.ok)throw new Error("Failed to add comment");return w.json()}async function ve({school:e,token:f,commentId:i,content:s}){const c=String(e||"").toLowerCase().trim(),y=await fetch(`${L}/${c}/comments/${i}`,{method:"PUT",headers:R(f),body:JSON.stringify({content:s})});if(!y.ok)throw new Error("Failed to update comment");return y.json()}async function ke({school:e,token:f,commentId:i}){const s=String(e||"").toLowerCase().trim(),c=await fetch(`${L}/${s}/comments/${i}`,{method:"DELETE",headers:R(f)});if(!c.ok)throw new Error("Failed to delete comment");return c.json()}async function $e({school:e,token:f,commentId:i}){const s=String(e||"").toLowerCase().trim(),c=await fetch(`${L}/${s}/comments/${i}/thumbs`,{method:"POST",headers:R(f)});if(!c.ok)throw new Error("Failed to toggle comment like");return c.json()}Y.extend(Ee);Y.locale("en");const l=e=>e==null?"":String(e),E=e=>String(e||"").toLowerCase().trim();function je({postId:e,authorEmail:f="",highlightId:i=null}){const{user:s,token:c}=he(),{school:y}=_e(),m=xe(),{ensureAuth:w}=we(),C=E(s==null?void 0:s.email),x=E(f),[_,p]=u.useState([]),[B,v]=u.useState(!0),[k,T]=u.useState(""),[F,A]=u.useState(""),[j,M]=u.useState(!1),[J,P]=u.useState(!1),[S,$]=u.useState(null),[D,z]=u.useState(""),[G,U]=u.useState(null),[b,W]=u.useState(null),[re,I]=u.useState(""),[se,H]=u.useState(null),[le,V]=u.useState(null),[ce,q]=u.useState(null),[ie,Q]=u.useState(i||null),X=u.useCallback(async()=>{if(!(!e||!y)){v(!0),T("");try{const n=await Ce({school:y,token:c,postId:e});p(Array.isArray(n)?n:[])}catch(n){console.error("comments:load failed",n),T("Failed to load comments."),p([])}finally{v(!1)}}},[e,y,c]);u.useEffect(()=>{X()},[X]),u.useEffect(()=>{if(!(m!=null&&m.emit)||!(m!=null&&m.on)||!e)return;m.emit("post:join",{postId:e});const n=t=>{!t||String(t.postId)!==String(e)||p(g=>g.some(h=>l(h._id)===l(t._id))?g:[...g,t])},r=t=>{!t||String(t.postId)!==String(e)||p(g=>g.map(h=>l(h._id)===l(t._id)?t:h))},d=({_id:t})=>{t&&p(g=>g.filter(h=>l(h._id)!==l(t)))},a=({_id:t,thumbs:g})=>{t&&p(h=>h.map(N=>l(N._id)===l(t)?{...N,thumbsUpUsers:g||[],thumbsCount:(g||[]).length}:N))};return m.on("comment:new",n),m.on("comment:update",r),m.on("comment:delete",d),m.on("comment:thumbs",a),()=>{try{m.emit("post:leave",{postId:e})}catch{}m.off("comment:new",n),m.off("comment:update",r),m.off("comment:delete",d),m.off("comment:thumbs",a)}},[m,e]);const Z=u.useMemo(()=>{const n=new Map;for(const a of _){const t=E(a.email);if(!t)continue;const g=new Date(a.createdAt||0).getTime();n.has(t)?n.set(t,Math.min(n.get(t),g)):n.set(t,g)}const r=Array.from(n.keys()).filter(a=>a&&a!==x);r.sort((a,t)=>(n.get(a)||0)-(n.get(t)||0));const d=new Map;return x&&d.set(x,"anonymous (OP)"),r.forEach((a,t)=>d.set(a,`anonymous ${t+1}`)),d},[_,x]),me=u.useCallback(n=>Z.get(E(n))||"anonymous",[Z]);u.useEffect(()=>{if(!i)return;Q(i);const n=setTimeout(()=>Q(null),1500);return()=>clearTimeout(n)},[i]);const{roots:de,childrenMap:ue}=u.useMemo(()=>{const n=(_||[]).map(a=>({...a,_id:l(a._id),parentId:l(a.parentId)||null})),r=new Map,d=[];for(const a of n){a.parentId||d.push(a);const t=r.get(a.parentId||"__root__")||[];t.push(a),r.set(a.parentId||"__root__",t)}return{roots:d,childrenMap:r}},[_]),O=()=>!s||!c?(w(),!1):!0,ee=async()=>{const n=F.trim();if(n&&O()){M(!0);try{const r=await ne({school:y,token:c,postId:e,content:n});r!=null&&r._id&&p(d=>d.some(a=>l(a._id)===l(r._id))?d:[...d,r]),A("")}catch(r){console.error("comments:add root failed",r),alert("Failed to add comment.")}finally{M(!1)}}},fe=async n=>{const r=D.trim();if(!r||!O())return;const d=l(n);U(d);try{const a=await ne({school:y,token:c,postId:e,content:r,parentId:d});a!=null&&a._id&&p(t=>t.some(g=>l(g._id)===l(a._id))?t:[...t,a]),$(null),z("")}catch(a){console.error("comments:add reply failed",a),alert("Failed to add reply.")}finally{U(null)}},ge=async()=>{const n=re.trim();if(!n||!b||!O())return;const r=b;H(r);const d=_;p(a=>a.map(t=>l(t._id)===l(r)?{...t,content:n,updatedAt:new Date().toISOString()}:t));try{await ve({school:y,token:c,commentId:r,content:n}),W(null),I("")}catch(a){p(d),console.error("comments:update failed",a),alert("Failed to update comment.")}finally{H(null)}},pe=async n=>{if(!O()||!window.confirm("Delete this comment?"))return;const r=l(n);V(r);const d=_;p(a=>a.filter(t=>l(t._id)!==r&&l(t.parentId)!==r));try{await ke({school:y,token:c,commentId:r})}catch(a){p(d),console.error("comments:delete failed",a),alert("Failed to delete comment.")}finally{V(null)}},ye=async(n,r)=>{if(!O()||E(r)===C)return;const d=l(n);q(d);const a=_;p(t=>t.map(g=>{if(l(g._id)!==d)return g;const h=(g.thumbsUpUsers||[]).map(K=>E(K)),N=E(s==null?void 0:s.email),te=h.includes(N)?h.filter(K=>K!==N):[...h,N];return{...g,thumbsUpUsers:te,thumbsCount:te.length}}));try{await $e({school:y,token:c,commentId:d})}catch(t){p(a),console.error("comments:thumb toggle failed",t)}finally{q(null)}};return o.createElement("div",{className:"mt-8"},o.createElement("h3",{className:"mb-3 text-lg font-semibold text-gray-900"},"Comments"),o.createElement("div",{className:"mb-4 rounded-xl border bg-white p-3 shadow-sm"},o.createElement("textarea",{value:F,onChange:n=>A(n.target.value),onCompositionStart:()=>P(!0),onCompositionEnd:()=>P(!1),onKeyDown:n=>{n.key==="Enter"&&!n.shiftKey&&!J&&(n.preventDefault(),ee())},placeholder:"Write a comment…",className:"h-20 w-full resize-none rounded-lg border px-3 py-2 text-sm"}),o.createElement("div",{className:"mt-2 flex items-center justify-between"},!s&&o.createElement("span",{className:"text-xs text-gray-500"},"You’ll be asked to log in when you post."),o.createElement(ae,{disabled:j,onClick:ee,className:"rounded-lg bg-gray-900 px-3 py-2 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},j?"Posting…":"Post"))),o.createElement("div",{className:"rounded-xl border bg-white p-2 sm:p-3"},B?o.createElement("div",{className:"p-3 text-sm text-gray-600"},"Loading…"):k?o.createElement("div",{className:"rounded-lg bg-red-50 p-3 text-sm text-red-700"},k):_.length===0?o.createElement("div",{className:"p-3 text-sm text-gray-600"},"No comments yet."):o.createElement("ul",{className:"space-y-3"},de.map(n=>o.createElement(oe,{key:l(n._id),node:n,depth:0,me:C,labelOf:me,childrenMap:ue,replyingId:S,replyText:D,postingReplyId:G,setReplyingId:$,setReplyText:z,submitReply:fe,onToggleLike:ye,likingId:ce,deletingId:le,savingId:se,onStartEdit:r=>{W(l(r._id)),I(r.content||"")},onCancelEdit:()=>{W(null),I("")},onChangeEdit:I,onSaveEdit:ge,onDelete:pe,editingId:b,flashId:ie,isAuthed:!!s})))))}function oe({node:e,depth:f,me:i,labelOf:s,childrenMap:c,replyingId:y,replyText:m,postingReplyId:w,setReplyingId:C,setReplyText:x,submitReply:_,onToggleLike:p,likingId:B,deletingId:v,savingId:k,onStartEdit:T,onCancelEdit:F,onChangeEdit:A,onSaveEdit:j,onDelete:M,editingId:J,flashId:P,isAuthed:S}){const $=E(e.email)===i,D=e.thumbs??e.thumbsUpUsers??[],z=D.map(b=>E(b)).includes(i),G=e.thumbsCount??D.length,U=(c.get(l(e._id))||[]).filter(b=>l(b._id)!==l(e._id));return o.createElement("li",null,o.createElement("div",{id:`comment-${e._id}`,className:`flex items-start gap-3 rounded-lg p-2 ${P===l(e._id)?"bg-yellow-50":""} ${f?"border-l border-gray-200 pl-4":""}`,style:{marginLeft:f?f*30:0}},o.createElement("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gray-200"}),o.createElement("div",{className:"min-w-0 flex-1"},o.createElement("div",{className:"flex items-center gap-2"},o.createElement("span",{className:"text-sm font-medium text-gray-900"},s(e.email)),o.createElement("span",{className:"text-xs text-gray-500"},"• ",Y(e.createdAt).fromNow())),J===l(e._id)?o.createElement("div",{className:"mt-2"},o.createElement("textarea",{defaultValue:e.content,onChange:b=>A(b.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),o.createElement("div",{className:"mt-2 flex gap-2"},o.createElement("button",{onClick:j,disabled:k===e._id||!S,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60",title:S?"Save":"Log in to edit"},k===e._id?"Saving…":"Save"),o.createElement("button",{onClick:F,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))):o.createElement("p",{className:"mt-1 whitespace-pre-wrap break-words text-sm text-gray-800"},e.content),o.createElement("div",{className:"mt-2 flex items-center gap-3 text-xs text-gray-600"},o.createElement("button",{onClick:()=>p(e._id,e.email),disabled:B===e._id||$||!S,className:`rounded px-2 py-1 ${z?"bg-blue-50 text-blue-600":"hover:bg-gray-100"} disabled:opacity-60`,title:S?$?"You can’t like your own comment.":"Like comment":"Log in to like"},"👍 ",G),o.createElement("button",{onClick:()=>{C(l(e._id)),x("")},className:"rounded px-2 py-1 hover:bg-gray-100",title:"Reply"},"Reply"),S&&$&&o.createElement(o.Fragment,null,o.createElement("button",{onClick:()=>T(e),className:"rounded px-2 py-1 hover:bg-gray-100"},"Edit"),o.createElement("button",{onClick:()=>M(e._id),disabled:v===e._id,className:"rounded px-2 py-1 text-red-600 hover:bg-red-50 disabled:opacity-60"},v===e._id?"Deleting…":"Delete"))),y===l(e._id)&&o.createElement("div",{className:"mt-2 rounded-lg border bg-white p-2"},o.createElement("textarea",{value:m,onChange:b=>x(b.target.value),placeholder:"Write a reply…",className:"h-16 w-full resize-none rounded-md border px-3 py-2 text-sm"}),o.createElement("div",{className:"mt-2 flex items-center gap-2"},o.createElement(ae,{onClick:()=>_(e._id),disabled:w===e._id||!m.trim(),className:"rounded-md bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},w===e._id?"Posting…":"Reply"),o.createElement("button",{onClick:()=>{C(null),x("")},className:"rounded-md border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))))),U.length>0&&o.createElement("ul",{className:"mt-2 space-y-3"},U.map(b=>o.createElement(oe,{key:l(b._id),node:b,depth:Math.min(f+1,6),me:i,labelOf:s,childrenMap:c,replyingId:y,replyText:m,postingReplyId:w,setReplyingId:C,setReplyText:x,submitReply:_,onToggleLike:p,likingId:B,deletingId:v,savingId:k,onStartEdit:T,onCancelEdit:F,onChangeEdit:A,onSaveEdit:j,onDelete:M,editingId:J,flashId:P,isAuthed:S}))))}export{je as C};
