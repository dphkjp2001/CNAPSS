import{a as B,b as V,r as i,R as e,A as de,d as L,e as X,f as me,u as ue,c as ge,L as ye}from"./index-b74680e1.js";import"./en-d857925d.js";import{g as pe,d as be,t as fe}from"./posts-a3317476.js";const D="https://api.cnapss.com/api".replace(/\/$/,""),F=l=>({"Content-Type":"application/json",Authorization:`Bearer ${l}`});async function he({school:l,token:a,postId:n}){const r=String(l||"").toLowerCase().trim(),o=await fetch(`${D}/${r}/comments/${n}`,{headers:F(a)});if(!o.ok)throw new Error("Failed to load comments");return o.json()}async function Q({school:l,token:a,postId:n,content:r}){const o=String(l||"").toLowerCase().trim(),m=await fetch(`${D}/${o}/comments/${n}`,{method:"POST",headers:F(a),body:JSON.stringify({content:r})});if(!m.ok)throw new Error("Failed to add comment");return m.json()}async function xe({school:l,token:a,commentId:n,content:r}){const o=String(l||"").toLowerCase().trim(),m=await fetch(`${D}/${o}/comments/${n}`,{method:"PUT",headers:F(a),body:JSON.stringify({content:r})});if(!m.ok)throw new Error("Failed to update comment");return m.json()}async function Ee({school:l,token:a,commentId:n}){const r=String(l||"").toLowerCase().trim(),o=await fetch(`${D}/${r}/comments/${n}`,{method:"DELETE",headers:F(a)});if(!o.ok)throw new Error("Failed to delete comment");return o.json()}async function we({school:l,token:a,commentId:n}){const r=String(l||"").toLowerCase().trim(),o=await fetch(`${D}/${r}/comments/${n}/thumbs`,{method:"POST",headers:F(a)});if(!o.ok)throw new Error("Failed to toggle comment like");return o.json()}L.extend(X);L.locale("en");function Ne({postId:l}){const{user:a,token:n}=B(),{school:r}=V(),o=((a==null?void 0:a.email)||"").toLowerCase(),[m,p]=i.useState([]),[c,h]=i.useState(!0),[x,w]=i.useState(""),[E,N]=i.useState(""),[v,C]=i.useState(!1),[k,d]=i.useState(!1),[R,I]=i.useState(null),[P,_]=i.useState(""),[A,U]=i.useState(null),[S,$]=i.useState(null),[f,T]=i.useState(""),[Z,O]=i.useState(null),[ee,z]=i.useState(null),[te,M]=i.useState(null),W=i.useCallback(async()=>{if(!(!l||!r||!n)){h(!0),w("");try{const t=await he({school:r,token:n,postId:l});p(Array.isArray(t)?t:[])}catch(t){console.error("comments:load failed",t),w("Failed to load comments."),p([])}finally{h(!1)}}},[l,r,n]);i.useEffect(()=>{W()},[W]);const J=i.useMemo(()=>{const t=new Map,s=(m||[]).map(g=>({...g,children:[]}));s.forEach(g=>t.set(g._id,g));const u=[];s.forEach(g=>{g.parentId&&t.has(g.parentId)?t.get(g.parentId).children.push(g):u.push(g)});const y=g=>g.sort((j,ie)=>new Date(j.createdAt)-new Date(ie.createdAt)),b=g=>{y(g),g.forEach(j=>b(j.children))};return b(u),u},[m]),K=(t,s)=>p(u=>u.map(y=>y._id===t?s:y)),ae=t=>p(s=>{const u=new Set([t]);let y=!0;for(;y;)y=!1,s.forEach(b=>{b.parentId&&u.has(b.parentId)&&!u.has(b._id)&&(u.add(b._id),y=!0)});return s.filter(b=>!u.has(b._id))}),H=async()=>{const t=E.trim();if(t){C(!0);try{const s=await Q({school:r,token:n,postId:l,content:t});p(u=>[...u,s]),N("")}catch(s){console.error("comments:add root failed",s),alert("Failed to add comment.")}finally{C(!1)}}},ne=t=>{I(t),_("")},q=()=>{I(null),_("")},oe=async t=>{const s=P.trim();if(s){U(t);try{const u=await Q({school:r,token:n,postId:l,content:s,parentId:t});p(y=>[...y,u]),q()}catch(u){console.error("comments:add reply failed",u),alert("Failed to add reply.")}finally{U(null)}}},re=t=>{$(t._id),T(t.content||"")},G=()=>{$(null),T("")},se=async()=>{const t=f.trim();if(!(!t||!S)){O(S);try{const s=await xe({school:r,token:n,commentId:S,content:t});K(S,s),G()}catch(s){console.error("comments:update failed",s),alert("Failed to update comment.")}finally{O(null)}}},le=async t=>{if(window.confirm("Delete this comment? Replies will also be removed in the list view.")){z(t);try{await Ee({school:r,token:n,commentId:t}),ae(t)}catch(s){console.error("comments:delete failed",s),alert("Failed to delete comment.")}finally{z(null)}}},ce=async t=>{M(t);try{const s=await we({school:r,token:n,commentId:t});K(t,(u=>{var b;const y=m.find(g=>g._id===t);return y&&{...y,thumbs:s.thumbs??[],thumbsCount:s.count??(((b=s.thumbs)==null?void 0:b.length)||0)}})())}catch(s){console.error("comments:thumb toggle failed",s)}finally{M(null)}};return!a||!n?e.createElement("div",{className:"mt-6 rounded-xl border border-gray-200 bg-white p-4 text-sm text-gray-600"},"Please log in to view and write comments."):e.createElement("div",{className:"mt-8"},e.createElement("h3",{className:"mb-3 text-lg font-semibold text-gray-900"},"Comments"),e.createElement("div",{className:"mb-4 rounded-xl border border-gray-200 bg-white p-3 shadow-sm"},e.createElement("textarea",{value:E,onChange:t=>N(t.target.value),onCompositionStart:()=>d(!0),onCompositionEnd:()=>d(!1),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&!k&&(t.preventDefault(),H())},placeholder:"Write a comment…",className:"h-20 w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),e.createElement("div",{className:"mt-2 text-right"},e.createElement(de,{disabled:v,onClick:H,className:"rounded-lg bg-gray-900 px-3 py-2 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},v?"Posting…":"Post"))),e.createElement("div",{className:"rounded-xl border border-gray-200 bg-white p-2 sm:p-3"},c?e.createElement("div",{className:"p-3 text-sm text-gray-600"},"Loading…"):x?e.createElement("div",{className:"rounded-lg bg-red-50 p-3 text-sm text-red-700"},x):J.length===0?e.createElement("div",{className:"p-3 text-sm text-gray-600"},"No comments yet."):e.createElement("ul",{className:"space-y-3"},J.map(t=>e.createElement(Y,{key:t._id,node:t,me:o,replyingId:R,replyText:P,postingReplyId:A,editingId:S,editText:f,savingId:Z,deletingId:ee,likingId:te,onStartReply:ne,onCancelReply:q,onChangeReply:_,onSubmitReply:oe,onStartEdit:re,onCancelEdit:G,onChangeEdit:T,onSaveEdit:se,onDelete:le,onToggleLike:ce})))))}function Y(l){var $;const{node:a,me:n,replyingId:r,replyText:o,postingReplyId:m,editingId:p,editText:c,savingId:h,deletingId:x,likingId:w,onStartReply:E,onCancelReply:N,onChangeReply:v,onSubmitReply:C,onStartEdit:k,onCancelEdit:d,onChangeEdit:R,onSaveEdit:I,onDelete:P,onToggleLike:_}=l,A=(a.email||"").toLowerCase()===n,U=(a.thumbs||[]).map(f=>f.toLowerCase()).includes(n),S=a.thumbsCount??(a.thumbs?a.thumbs.length:0);return e.createElement("li",null,e.createElement("div",{className:"flex items-start gap-3"},e.createElement("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gray-200"}),e.createElement("div",{className:"min-w-0 flex-1"},e.createElement("div",{className:"flex items-center gap-2"},e.createElement("span",{className:"text-sm font-medium text-gray-900"},(a.email||"").split("@")[0]||"anon"),e.createElement("span",{className:"text-xs text-gray-500"},"• ",L(a.createdAt).fromNow())),p===a._id?e.createElement("div",{className:"mt-2"},e.createElement("textarea",{value:c,onChange:f=>R(f.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),e.createElement("div",{className:"mt-2 flex gap-2"},e.createElement("button",{onClick:I,disabled:h===a._id,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},h===a._id?"Saving…":"Save"),e.createElement("button",{onClick:d,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))):e.createElement("p",{className:"mt-1 whitespace-pre-wrap break-words text-sm text-gray-800"},a.content),e.createElement("div",{className:"mt-2 flex items-center gap-3 text-xs text-gray-600"},e.createElement("button",{onClick:()=>_(a._id),disabled:w===a._id,className:`rounded px-2 py-1 ${U?"bg-blue-50 text-blue-600":"hover:bg-gray-100"} disabled:opacity-60`},"👍 ",S),e.createElement("button",{onClick:()=>E(a._id),className:"rounded px-2 py-1 hover:bg-gray-100"},"Reply"),A&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>k(a),className:"rounded px-2 py-1 hover:bg-gray-100"},"Edit"),e.createElement("button",{onClick:()=>P(a._id),disabled:x===a._id,className:"rounded px-2 py-1 text-red-600 hover:bg-red-50 disabled:opacity-60"},x===a._id?"Deleting…":"Delete"))),r===a._id&&e.createElement("div",{className:"mt-2"},e.createElement("textarea",{value:o,onChange:f=>v(f.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10",placeholder:"Write a reply…"}),e.createElement("div",{className:"mt-2 flex gap-2"},e.createElement("button",{onClick:()=>C(a._id),disabled:m===a._id,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},m===a._id?"Posting…":"Reply"),e.createElement("button",{onClick:N,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))),(($=a.children)==null?void 0:$.length)>0&&e.createElement("ul",{className:"mt-3 space-y-3 border-l border-gray-100 pl-4"},a.children.map(f=>e.createElement(Y,{key:f._id,node:f,me:n,replyingId:r,replyText:o,postingReplyId:m,editingId:p,editText:c,savingId:h,deletingId:x,likingId:w,onStartReply:E,onCancelReply:N,onChangeReply:v,onSubmitReply:C,onStartEdit:k,onCancelEdit:d,onChangeEdit:R,onSaveEdit:I,onDelete:P,onToggleLike:_}))))))}L.extend(X);L.locale("en");function Se(){var k;const{id:l}=me(),a=ue(),{user:n}=B(),{school:r,schoolTheme:o}=V(),m=ge(),{token:p}=B(),[c,h]=i.useState(null),[x,w]=i.useState(""),E=async()=>{try{const d=await pe({school:r,token:p,id:l});h(d)}catch(d){w(d.message||"Failed to load the post.")}};i.useEffect(()=>{E()},[l,r]);const N=i.useMemo(()=>(n==null?void 0:n.email)===(c==null?void 0:c.email),[n,c]),v=async()=>{if(window.confirm("Delete this post?"))try{await be(l,n.email,r),alert("Post deleted."),a(m("/freeboard"))}catch(d){alert("Delete failed: "+(d.message||"Unknown error"))}},C=async()=>{try{await fe({school:r,token:p,id:c._id}),h(d=>d&&{...d,thumbsUpUsers:(d.thumbsUpUsers||[]).includes(((n==null?void 0:n.email)||"").toLowerCase())?d.thumbsUpUsers.filter(R=>R.toLowerCase()!==((n==null?void 0:n.email)||"").toLowerCase()):[...d.thumbsUpUsers||[],((n==null?void 0:n.email)||"").toLowerCase()]}),await E()}catch(d){alert("Failed to like: "+(d.message||"Unknown error"))}};return x?e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-red-700",style:{backgroundColor:(o==null?void 0:o.bg)||"#f6f3ff"}},x):c?e.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(o==null?void 0:o.bg)||"#f6f3ff"}},e.createElement("div",{className:"mx-auto max-w-3xl"},e.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},e.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},e.createElement("h1",{className:"text-2xl font-bold text-gray-900"},c.title),e.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",e.createElement("span",{className:"font-medium"},"anonymous")," • ",L(c.createdAt).fromNow())),e.createElement("div",{className:"p-5 sm:p-6"},e.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},e.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},c.content)),e.createElement("div",{className:"mt-6 flex flex-wrap items-center gap-3"},e.createElement("button",{onClick:C,className:"rounded-xl border border-gray-300 bg-white px-3 py-1.5 text-sm text-gray-800 shadow-sm hover:bg-gray-50","aria-label":"like post"},"👍 ",((k=c.thumbsUpUsers)==null?void 0:k.length)||0),N&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>a(m(`/freeboard/edit/${c._id}`)),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:(o==null?void 0:o.primary)||"#6b46c1"}},"Edit"),e.createElement("button",{onClick:v,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")),e.createElement(ye,{to:m("/freeboard"),className:"ml-auto text-sm font-medium text-blue-600 underline underline-offset-2"},"← Back to List")))),(c==null?void 0:c._id)&&e.createElement("div",{className:"mt-6 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm sm:p-6"},e.createElement(Ne,{postId:c._id,postAuthorEmail:c.email})))):e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-gray-600",style:{backgroundColor:(o==null?void 0:o.bg)||"#f6f3ff"}},"Loading…")}export{Se as default};
