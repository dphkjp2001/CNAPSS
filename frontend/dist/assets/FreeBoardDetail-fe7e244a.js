import{e as J,u as K,a as Q,c as X,b as Z,d as ee,f as te,r as s,R as a,L as ae}from"./index-3d55c829.js";import{C as ne}from"./CommentSection-94d6546e.js";import{d as S,r as oe}from"./relativeTime-05e49612.js";import{u as se,d as re,e as le,f as ie,v as ce}from"./academicPosts-3f24bdec.js";import{a as de}from"./http-e19067b4.js";import"./useLoginGate-74be7bbe.js";S.extend(oe);S.locale("en");function he(){const{id:i}=J(),H=K(),m=Q(),{user:o,token:k}=X(),{school:l,schoolTheme:c}=Z(),P=ee(),{emit:b,on:I}=te(),[n,w]=s.useState(null),[U,L]=s.useState(""),[u,v]=s.useState(!1),[V,f]=s.useState(""),[D,g]=s.useState(""),[_,A]=s.useState(!1),B=!!(o!=null&&o.email||k&&String(k).length>0),[j,p]=s.useState(0),[F,y]=s.useState(0),[h,R]=s.useState(null),[E,$]=s.useState(!1),O=j-F,T=async()=>{L("");try{const e=await re({school:l,id:i});w(e),f((e==null?void 0:e.title)||""),g((e==null?void 0:e.content)||""),p((e==null?void 0:e.upCount)||0),y((e==null?void 0:e.downCount)||0)}catch(e){if((e==null?void 0:e.status)!==404){L((e==null?void 0:e.message)||"Failed to load the post.");return}}if(B)try{const e=await le({school:l,id:i});w(e),f((e==null?void 0:e.title)||""),g((e==null?void 0:e.content)||""),p((e==null?void 0:e.upCount)||0),y((e==null?void 0:e.downCount)||0),R((e==null?void 0:e.myVote)??null)}catch{}};s.useEffect(()=>{!l||!i||T()},[i,l,B]),s.useEffect(()=>{if(!i)return;b("post:join",{postId:i});const e=I("post:voteUpdated",t=>{!t||t.postId!==i||(p(t.upCount??0),y(t.downCount??0))});return()=>{e==null||e(),b("post:leave",{postId:i})}},[i,b,I]),s.useEffect(()=>{const t=new URLSearchParams(m.search).get("nid");async function r(){if(!(!t||!(o!=null&&o.email)||!l))try{const x="https://api.cnapss.com/api".replace(/\/+$/,"");await de(`${x}/${l}/notification/mark-read`,{method:"POST",headers:{"Content-Type":"application/json"},body:{commentId:t,email:o.email}})}catch{}}r()},[m.search,o==null?void 0:o.email,l]);const W=s.useMemo(()=>{const e=m.hash||"",t=e.startsWith("#comment-")?e.slice(9):null,r=new URLSearchParams(m.search).get("nid");return t||r||null},[m.hash,m.search]),d=s.useMemo(()=>{var Y,z;const e=n,t=o;if(!e||!t)return!1;const r=[t.id,t._id].filter(Boolean).map(String);return[e.userId,e.authorId,(Y=e.author)==null?void 0:Y._id,(z=e.author)==null?void 0:z.id].filter(Boolean).map(String).some(G=>r.includes(G))},[o,n]),q=async()=>{if(window.confirm("Delete this post?"))try{await ie({school:l,id:n._id}),alert("Post deleted."),H(P("/dashboard?tab=free"))}catch(e){alert("Delete failed: "+((e==null?void 0:e.message)||"Unknown error"))}},M=async e=>{if(!o){alert("Please log in to vote.");return}if(!(d||E)){if(h&&h!==e){alert("Cancel your current vote first.");return}$(!0);try{const t=await ce({school:l,id:n._id,dir:e});typeof(t==null?void 0:t.upCount)=="number"&&p(t.upCount),typeof(t==null?void 0:t.downCount)=="number"&&y(t.downCount),typeof(t==null?void 0:t.myVote)<"u"&&R(t.myVote)}catch(t){alert("Vote failed: "+((t==null?void 0:t.message)||"Unknown error"))}finally{$(!1)}}},C=h==="up",N=h==="down";return U?a.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-red-700",style:{backgroundColor:(c==null?void 0:c.bg)||"#f6f3ff"}},U):n?a.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(c==null?void 0:c.bg)||"#f6f3ff"}},a.createElement("div",{className:"mx-auto max-w-3xl"},a.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},a.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},u?a.createElement("input",{value:V,onChange:e=>f(e.target.value),placeholder:"Title",className:"w-full rounded-xl border border-gray-300 px-3 py-2 text-lg font-semibold text-gray-900 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):a.createElement("h1",{className:"text-2xl font-bold text-gray-900"},n.title),a.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",a.createElement("span",{className:"font-medium"},"anonymous")," ‚Ä¢ ",S(n.createdAt).fromNow())),a.createElement("div",{className:"p-5 sm:p-6"},u?a.createElement("textarea",{value:D,onChange:e=>g(e.target.value),placeholder:"Content",className:"h-56 w-full resize-y rounded-xl border border-gray-300 px-3 py-2 text-sm text-gray-800 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):a.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},a.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},n.content)),a.createElement("div",{className:"mt-6 flex flex-wrap items-center gap-3"},a.createElement("div",{className:"flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-2 py-1"},a.createElement("button",{onClick:()=>M("up"),disabled:!o||d||E||N,className:`flex items-center gap-1 rounded-md px-3 py-1 text-sm font-semibold ${C?"bg-gray-100 text-red-600":"text-gray-800 hover:bg-gray-100"} disabled:opacity-60`,"aria-label":"Upvote",title:o?d?"You can‚Äôt vote on your own post.":N?"Cancel your downvote first":"Upvote":"Log in to vote"},"üëç ",a.createElement("span",null,j)),a.createElement("button",{onClick:()=>M("down"),disabled:!o||d||E||C,className:`flex items-center gap-1 rounded-md px-3 py-1 text-sm font-semibold ${N?"bg-gray-100 text-blue-600":"text-gray-800 hover:bg-gray-100"} disabled:opacity-60`,"aria-label":"Downvote",title:o?d?"You can‚Äôt vote on your own post.":C?"Cancel your upvote first":"Downvote":"Log in to vote"},"üëé ",a.createElement("span",null,F)),a.createElement("span",{className:"ml-2 text-sm font-medium text-gray-700"},"Score: ",O)),d&&!u&&a.createElement(a.Fragment,null,a.createElement("button",{onClick:()=>v(!0),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:"#6b46c1"}},"Edit"),a.createElement("button",{onClick:q,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")),d&&u&&a.createElement(a.Fragment,null,a.createElement("button",{onClick:async()=>{const e=V.trim(),t=D.trim();if(!(!e||!t)){A(!0);try{const r=await se({school:l,id:n._id,title:e,content:t}),x=(r==null?void 0:r.post)||r;w(x),v(!1)}catch(r){alert("Update failed: "+((r==null?void 0:r.message)||"Unknown error"))}finally{A(!1)}}},disabled:_,className:"rounded-xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-black disabled:opacity-60"},_?"Saving‚Ä¶":"Save"),a.createElement("button",{onClick:()=>{f((n==null?void 0:n.title)||""),g((n==null?void 0:n.content)||""),v(!1)},className:"rounded-xl border border-gray-300 bg-white px-4 py-2 text-sm font-semibold text-gray-800 shadow-sm hover:bg-gray-50"},"Cancel")),a.createElement(ae,{to:P("/dashboard?tab=free"),className:"ml-auto text-sm font-medium text-blue-600 underline underline-offset-2"},"‚Üê Back to List")))),(n==null?void 0:n._id)&&a.createElement("div",{className:"mt-6 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm sm:p-6"},a.createElement(ne,{postId:n._id,authorEmail:n.email,highlightId:W,anonymousMode:!0})))):a.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-gray-600",style:{backgroundColor:(c==null?void 0:c.bg)||"#f6f3ff"}},"Loading‚Ä¶")}export{he as default};
