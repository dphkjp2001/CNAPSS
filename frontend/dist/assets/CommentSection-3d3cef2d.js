import{u as ge,a as fe,k as pe,r as c,R as n,A as Z}from"./index-467f6660.js";import{d as K,r as ye}from"./relativeTime-4b382bcf.js";import"./en-a38582df.js";const D="https://api.cnapss.com/api".replace(/\/$/,""),M=e=>({"Content-Type":"application/json",Authorization:`Bearer ${e}`});async function be({school:e,token:g,postId:i}){const d=String(e||"").toLowerCase().trim(),o=await fetch(`${D}/${d}/comments/${i}`,{headers:M(g)});if(!o.ok)throw new Error("Failed to load comments");return o.json()}async function X({school:e,token:g,postId:i,content:d,parentId:o=null}){const f=String(e||"").toLowerCase().trim(),s={content:String(d||"").trim()};o&&(s.parentId=String(o));const h=await fetch(`${D}/${f}/comments/${i}`,{method:"POST",headers:M(g),body:JSON.stringify(s)});if(!h.ok)throw new Error("Failed to add comment");return h.json()}async function he({school:e,token:g,commentId:i,content:d}){const o=String(e||"").toLowerCase().trim(),f=await fetch(`${D}/${o}/comments/${i}`,{method:"PUT",headers:M(g),body:JSON.stringify({content:d})});if(!f.ok)throw new Error("Failed to update comment");return f.json()}async function Ee({school:e,token:g,commentId:i}){const d=String(e||"").toLowerCase().trim(),o=await fetch(`${D}/${d}/comments/${i}`,{method:"DELETE",headers:M(g)});if(!o.ok)throw new Error("Failed to delete comment");return o.json()}async function xe({school:e,token:g,commentId:i}){const d=String(e||"").toLowerCase().trim(),o=await fetch(`${D}/${d}/comments/${i}/thumbs`,{method:"POST",headers:M(g)});if(!o.ok)throw new Error("Failed to toggle comment like");return o.json()}K.extend(ye);K.locale("en");const m=e=>e==null?"":String(e),N=e=>String(e||"").toLowerCase().trim();function Ce({postId:e,authorEmail:g="",highlightId:i=null}){const{user:d,token:o}=ge(),{school:f}=fe(),s=pe(),h=N(d==null?void 0:d.email),x=N(g),[b,E]=c.useState([]),[j,v]=c.useState(!0),[S,C]=c.useState(""),[k,$]=c.useState(""),[L,T]=c.useState(!1),[R,F]=c.useState(!1),[U,_]=c.useState(null),[P,O]=c.useState(""),[B,A]=c.useState(null),[p,I]=c.useState(null),[te,z]=c.useState(""),[ne,W]=c.useState(null),[ae,H]=c.useState(null),[oe,V]=c.useState(null),[re,Y]=c.useState(i||null),q=c.useCallback(async()=>{if(!(!e||!f||!o)){v(!0),C("");try{const t=await be({school:f,token:o,postId:e});E(Array.isArray(t)?t:[])}catch(t){console.error("comments:load failed",t),C("Failed to load comments."),E([])}finally{v(!1)}}},[e,f,o]);c.useEffect(()=>{q()},[q]),c.useEffect(()=>{if(!(s!=null&&s.emit)||!(s!=null&&s.on)||!e)return;s.emit("post:join",{postId:e});const t=a=>{!a||String(a.postId)!==String(e)||E(y=>y.some(w=>m(w._id)===m(a._id))?y:[...y,a])},l=a=>{!a||String(a.postId)!==String(e)||E(y=>y.map(w=>m(w._id)===m(a._id)?a:w))},u=({_id:a})=>{a&&E(y=>y.filter(w=>m(w._id)!==m(a)))},r=({_id:a,thumbs:y})=>{a&&E(w=>w.map(J=>m(J._id)===m(a)?{...J,thumbsUpUsers:y||[],thumbsCount:(y||[]).length}:J))};return s.on("comment:new",t),s.on("comment:update",l),s.on("comment:delete",u),s.on("comment:thumbs",r),()=>{try{s.emit("post:leave",{postId:e})}catch{}s.off("comment:new",t),s.off("comment:update",l),s.off("comment:delete",u),s.off("comment:thumbs",r)}},[s,e]);const G=c.useMemo(()=>{const t=new Map;for(const r of b){const a=N(r.email);if(!a)continue;const y=new Date(r.createdAt||0).getTime();t.has(a)?t.set(a,Math.min(t.get(a),y)):t.set(a,y)}const l=Array.from(t.keys()).filter(r=>r&&r!==x);l.sort((r,a)=>(t.get(r)||0)-(t.get(a)||0));const u=new Map;return x&&u.set(x,"anonymous (OP)"),l.forEach((r,a)=>u.set(r,`anonymous ${a+1}`)),u},[b,x]),se=c.useCallback(t=>G.get(N(t))||"anonymous",[G]);c.useEffect(()=>{if(!i)return;Y(i);const t=setTimeout(()=>Y(null),1500);return()=>clearTimeout(t)},[i]);const{roots:le,childrenMap:me}=c.useMemo(()=>{const t=(b||[]).map(r=>({...r,_id:m(r._id),parentId:m(r.parentId)||null})),l=new Map,u=[];for(const r of t){r.parentId||u.push(r);const a=l.get(r.parentId||"__root__")||[];a.push(r),l.set(r.parentId||"__root__",a)}return{roots:u,childrenMap:l}},[b]),Q=async()=>{const t=k.trim();if(t){T(!0);try{await X({school:f,token:o,postId:e,content:t,parentId:null}),$("")}catch(l){console.error("comments:add root failed",l),alert("Failed to add comment.")}finally{T(!1)}}},ce=async t=>{const l=P.trim();if(!l)return;const u=m(t);A(u);try{await X({school:f,token:o,postId:e,content:l,parentId:u}),_(null),O("")}catch(r){console.error("comments:add reply failed",r),alert("Failed to add reply.")}finally{A(null)}},ie=async()=>{const t=te.trim();if(!(!t||!p)){W(p);try{await he({school:f,token:o,commentId:p,content:t}),I(null),z("")}catch(l){console.error("comments:update failed",l),alert("Failed to update comment.")}finally{W(null)}}},de=async t=>{if(!window.confirm("Delete this comment?"))return;const l=m(t);H(l);try{await Ee({school:f,token:o,commentId:l})}catch(u){console.error("comments:delete failed",u),alert("Failed to delete comment.")}finally{H(null)}},ue=async(t,l)=>{const u=m(t);if(N(l)!==h){V(u);try{await xe({school:f,token:o,commentId:u})}catch(r){console.error("comments:thumb toggle failed",r)}finally{V(null)}}};return!d||!o?n.createElement("div",{className:"mt-6 rounded-xl border bg-white p-4 text-sm text-gray-600"},"Please log in to view and write comments."):n.createElement("div",{className:"mt-8"},n.createElement("h3",{className:"mb-3 text-lg font-semibold text-gray-900"},"Comments"),n.createElement("div",{className:"mb-4 rounded-xl border bg-white p-3 shadow-sm"},n.createElement("textarea",{value:k,onChange:t=>$(t.target.value),onCompositionStart:()=>F(!0),onCompositionEnd:()=>F(!1),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&!R&&(t.preventDefault(),Q())},placeholder:"Write a comment…",className:"h-20 w-full resize-none rounded-lg border px-3 py-2 text-sm"}),n.createElement("div",{className:"mt-2 text-right"},n.createElement(Z,{disabled:L,onClick:Q,className:"rounded-lg bg-gray-900 px-3 py-2 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},L?"Posting…":"Post"))),n.createElement("div",{className:"rounded-xl border bg-white p-2 sm:p-3"},j?n.createElement("div",{className:"p-3 text-sm text-gray-600"},"Loading…"):S?n.createElement("div",{className:"rounded-lg bg-red-50 p-3 text-sm text-red-700"},S):b.length===0?n.createElement("div",{className:"p-3 text-sm text-gray-600"},"No comments yet."):n.createElement("ul",{className:"space-y-3"},le.map(t=>n.createElement(ee,{key:m(t._id),node:t,depth:0,me:h,labelOf:se,childrenMap:me,replyingId:U,replyText:P,postingReplyId:B,setReplyingId:_,setReplyText:O,submitReply:ce,onToggleLike:ue,likingId:oe,deletingId:ae,savingId:ne,onStartEdit:l=>{I(m(l._id)),z(l.content||"")},onCancelEdit:()=>{I(null),z("")},onChangeEdit:z,onSaveEdit:ie,onDelete:de,editingId:p,flashId:re})))))}function ee({node:e,depth:g,me:i,labelOf:d,childrenMap:o,replyingId:f,replyText:s,postingReplyId:h,setReplyingId:x,setReplyText:b,submitReply:E,onToggleLike:j,likingId:v,deletingId:S,savingId:C,onStartEdit:k,onCancelEdit:$,onChangeEdit:L,onSaveEdit:T,onDelete:R,editingId:F,flashId:U}){const _=N(e.email)===i,P=e.thumbs??e.thumbsUpUsers??[],O=P.map(p=>N(p)).includes(i),B=e.thumbsCount??P.length,A=(o.get(m(e._id))||[]).filter(p=>m(p._id)!==m(e._id));return n.createElement("li",null,n.createElement("div",{id:`comment-${e._id}`,className:`flex items-start gap-3 rounded-lg p-2 ${U===m(e._id)?"bg-yellow-50":""} ${g?"border-l border-gray-200 pl-4":""}`,style:{marginLeft:g?g*30:0}},n.createElement("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gray-200"}),n.createElement("div",{className:"min-w-0 flex-1"},n.createElement("div",{className:"flex items-center gap-2"},n.createElement("span",{className:"text-sm font-medium text-gray-900"},d(e.email)),n.createElement("span",{className:"text-xs text-gray-500"},"• ",K(e.createdAt).fromNow())),F===m(e._id)?n.createElement("div",{className:"mt-2"},n.createElement("textarea",{defaultValue:e.content,onChange:p=>L(p.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),n.createElement("div",{className:"mt-2 flex gap-2"},n.createElement("button",{onClick:T,disabled:C===e._id,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},C===e._id?"Saving…":"Save"),n.createElement("button",{onClick:$,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))):n.createElement("p",{className:"mt-1 whitespace-pre-wrap break-words text-sm text-gray-800"},e.content),n.createElement("div",{className:"mt-2 flex items-center gap-3 text-xs text-gray-600"},n.createElement("button",{onClick:()=>j(e._id,e.email),disabled:v===e._id||_,className:`rounded px-2 py-1 ${O?"bg-blue-50 text-blue-600":"hover:bg-gray-100"} disabled:opacity-60`,title:_?"You can’t like your own comment.":"Like comment"},"👍 ",B),n.createElement("button",{onClick:()=>{x(m(e._id)),b("")},className:"rounded px-2 py-1 hover:bg-gray-100"},"Reply"),_&&n.createElement(n.Fragment,null,n.createElement("button",{onClick:()=>k(e),className:"rounded px-2 py-1 hover:bg-gray-100"},"Edit"),n.createElement("button",{onClick:()=>R(e._id),disabled:S===e._id,className:"rounded px-2 py-1 text-red-600 hover:bg-red-50 disabled:opacity-60"},S===e._id?"Deleting…":"Delete"))),f===m(e._id)&&n.createElement("div",{className:"mt-2 rounded-lg border bg-white p-2"},n.createElement("textarea",{value:s,onChange:p=>b(p.target.value),placeholder:"Write a reply…",className:"h-16 w-full resize-none rounded-md border px-3 py-2 text-sm"}),n.createElement("div",{className:"mt-2 flex items-center gap-2"},n.createElement(Z,{onClick:()=>E(e._id),disabled:h===e._id||!s.trim(),className:"rounded-md bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},h===e._id?"Posting…":"Reply"),n.createElement("button",{onClick:()=>{x(null),b("")},className:"rounded-md border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))))),A.length>0&&n.createElement("ul",{className:"mt-2 space-y-3"},A.map(p=>n.createElement(ee,{key:m(p._id),node:p,depth:Math.min(g+1,6),me:i,labelOf:d,childrenMap:o,replyingId:f,replyText:s,postingReplyId:h,setReplyingId:x,setReplyText:b,submitReply:E,onToggleLike:j,likingId:v,deletingId:S,savingId:C,onStartEdit:k,onCancelEdit:$,onChangeEdit:L,onSaveEdit:T,onDelete:R,editingId:F,flashId:U}))))}export{Ce as C};
