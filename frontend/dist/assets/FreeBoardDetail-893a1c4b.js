import{u as q,b as te,g as ue,r as d,R as e,A as ge,d as T,e as ne,h as he,a as pe,f as fe,c as ye,L as be,i as xe}from"./index-808f52da.js";import"./en-afea8aa1.js";import{d as Ee,e as we,t as Ce}from"./posts-a526a031.js";const O="https://api.cnapss.com/api".replace(/\/$/,""),B=o=>({"Content-Type":"application/json",Authorization:`Bearer ${o}`});async function Ne({school:o,token:n,postId:h}){const a=String(o||"").toLowerCase().trim(),s=await fetch(`${O}/${a}/comments/${h}`,{headers:B(n)});if(!s.ok)throw new Error("Failed to load comments");return s.json()}async function ee({school:o,token:n,postId:h,content:a,parentId:s=null}){const l=String(o||"").toLowerCase().trim(),c={content:String(a||"").trim()};s&&(c.parentId=String(s));const N=await fetch(`${O}/${l}/comments/${h}`,{method:"POST",headers:B(n),body:JSON.stringify(c)});if(!N.ok)throw new Error("Failed to add comment");return N.json()}async function Se({school:o,token:n,commentId:h,content:a}){const s=String(o||"").toLowerCase().trim(),l=await fetch(`${O}/${s}/comments/${h}`,{method:"PUT",headers:B(n),body:JSON.stringify({content:a})});if(!l.ok)throw new Error("Failed to update comment");return l.json()}async function ve({school:o,token:n,commentId:h}){const a=String(o||"").toLowerCase().trim(),s=await fetch(`${O}/${a}/comments/${h}`,{method:"DELETE",headers:B(n)});if(!s.ok)throw new Error("Failed to delete comment");return s.json()}async function ke({school:o,token:n,commentId:h}){const a=String(o||"").toLowerCase().trim(),s=await fetch(`${O}/${a}/comments/${h}/thumbs`,{method:"POST",headers:B(n)});if(!s.ok)throw new Error("Failed to toggle comment like");return s.json()}T.extend(ne);T.locale("en");const b=o=>o==null?"":String(o),M=o=>String(o||"").toLowerCase().trim();function Le({postId:o,authorEmail:n="",highlightId:h=null}){const{user:a,token:s}=q(),{school:l}=te(),c=ue(),N=M(a==null?void 0:a.email),u=M(n),[E,x]=d.useState([]),[$,v]=d.useState(!0),[L,_]=d.useState(""),[I,R]=d.useState(""),[k,g]=d.useState(!1),[w,S]=d.useState(!1),[P,U]=d.useState(null),[A,j]=d.useState(""),[W,H]=d.useState(null),[D,F]=d.useState(null),[C,z]=d.useState(""),[oe,G]=d.useState(null),[se,Q]=d.useState(null),[re,V]=d.useState(null),[le,_e]=d.useState(null),X=d.useCallback(async()=>{if(!(!o||!l||!s)){v(!0),_("");try{const t=await Ne({school:l,token:s,postId:o});x(Array.isArray(t)?t:[])}catch(t){console.error("comments:load failed",t),_("Failed to load comments."),x([])}finally{v(!1)}}},[o,l,s]);d.useEffect(()=>{X()},[X]),d.useEffect(()=>{if(!(c!=null&&c.emit)||!(c!=null&&c.on)||!o)return;c.emit("post:join",{postId:o});const t=i=>{!i||String(i.postId)!==String(o)||x(r=>r.some(y=>b(y._id)===b(i._id))?r:[...r,i])},m=i=>{!i||String(i.postId)!==String(o)||x(r=>r.map(y=>b(y._id)===b(i._id)?i:y))},p=({_id:i})=>{i&&x(r=>r.filter(y=>b(y._id)!==b(i)))},f=({_id:i,thumbs:r})=>{i&&x(y=>y.map(K=>b(K._id)===b(i)?{...K,thumbsUpUsers:r||[],thumbsCount:(r||[]).length}:K))};return c.on("comment:new",t),c.on("comment:update",m),c.on("comment:delete",p),c.on("comment:thumbs",f),()=>{try{c.emit("post:leave",{postId:o})}catch{}c.off("comment:new",t),c.off("comment:update",m),c.off("comment:delete",p),c.off("comment:thumbs",f)}},[c,o]);const J=d.useMemo(()=>{const t=new Map;for(const f of E){const i=M(f.email);if(!i)continue;const r=new Date(f.createdAt||0).getTime();t.has(i)?t.set(i,Math.min(t.get(i),r)):t.set(i,r)}const m=Array.from(t.keys()).filter(f=>f&&f!==u);m.sort((f,i)=>(t.get(f)||0)-(t.get(i)||0));const p=new Map;return u&&p.set(u,"anonymous (게시자)"),m.forEach((f,i)=>p.set(f,`anonymous ${i+1}`)),p},[E,u]);d.useCallback(t=>J.get(M(t))||"anonymous",[J]);const Y=d.useMemo(()=>{const t=(E||[]).map(r=>({...r,_id:b(r._id),parentId:r.parentId?b(r.parentId):null,children:[]})),m=new Map;t.forEach(r=>m.set(r._id,r));const p=[];t.forEach(r=>{const y=r.parentId?b(r.parentId):"";y&&m.has(y)?m.get(y).children.push(r):p.push(r)});const f=(r,y)=>new Date(r.createdAt)-new Date(y.createdAt),i=r=>{r.sort(f),r.forEach(y=>i(y.children))};return i(p),p},[E]),Z=async()=>{const t=I.trim();if(t){g(!0);try{await ee({school:l,token:s,postId:o,content:t}),R("")}catch(m){console.error("comments:add root failed",m),alert("Failed to add comment.")}finally{g(!1)}}},ie=async t=>{const m=A.trim();if(!m)return;const p=b(t);H(p);try{await ee({school:l,token:s,postId:o,content:m,parentId:p}),U(null),j("")}catch(f){console.error("comments:add reply failed",f),alert("Failed to add reply.")}finally{H(null)}},ce=async()=>{const t=C.trim();if(!(!t||!D)){G(D);try{const m=await Se({school:l,token:s,commentId:D,content:t});F(null),z("")}catch(m){console.error("comments:update failed",m),alert("Failed to update comment.")}finally{G(null)}}},me=async t=>{if(!window.confirm("Delete this comment?"))return;const m=b(t);Q(m);try{await ve({school:l,token:s,commentId:m})}catch(p){console.error("comments:delete failed",p),alert("Failed to delete comment.")}finally{Q(null)}},de=async t=>{const m=b(t);V(m);try{await ke({school:l,token:s,commentId:m})}catch(p){console.error("comments:thumb toggle failed",p)}finally{V(null)}};return!a||!s?e.createElement("div",{className:"mt-6 rounded-xl border bg-white p-4 text-sm text-gray-600"},"Please log in to view and write comments."):e.createElement("div",{className:"mt-8"},e.createElement("h3",{className:"mb-3 text-lg font-semibold text-gray-900"},"Comments"),e.createElement("div",{className:"mb-4 rounded-xl border bg-white p-3 shadow-sm"},e.createElement("textarea",{value:I,onChange:t=>R(t.target.value),onCompositionStart:()=>S(!0),onCompositionEnd:()=>S(!1),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&!w&&(t.preventDefault(),Z())},placeholder:"Write a comment…",className:"h-20 w-full resize-none rounded-lg border px-3 py-2 text-sm"}),e.createElement("div",{className:"mt-2 text-right"},e.createElement(ge,{disabled:k,onClick:Z,className:"rounded-lg bg-gray-900 px-3 py-2 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},k?"Posting…":"Post"))),e.createElement("div",{className:"rounded-xl border bg-white p-2 sm:p-3"},$?e.createElement("div",{className:"p-3 text-sm text-gray-600"},"Loading…"):L?e.createElement("div",{className:"rounded-lg bg-red-50 p-3 text-sm text-red-700"},L):Y.length===0?e.createElement("div",{className:"p-3 text-sm text-gray-600"},"No comments yet."):e.createElement("ul",{className:"space-y-3"},Y.map(t=>e.createElement(ae,{key:t._id,node:t,me:N,getLabel:m=>J.get(M(m))||"anonymous",replyingId:P,replyText:A,postingReplyId:W,editingId:D,editText:C,savingId:oe,deletingId:se,likingId:re,onStartReply:U,onCancelReply:()=>{U(null),j("")},onChangeReply:j,onSubmitReply:ie,onStartEdit:m=>{F(b(m._id)),z(m.content||"")},onCancelEdit:()=>{F(null),z("")},onChangeEdit:z,onSaveEdit:ce,onDelete:me,onToggleLike:de,flashId:le})))))}function ae(o){var F;const{node:n,me:h,getLabel:a,replyingId:s,replyText:l,postingReplyId:c,editingId:N,editText:u,savingId:E,deletingId:x,likingId:$,onStartReply:v,onCancelReply:L,onChangeReply:_,onSubmitReply:I,onStartEdit:R,onCancelEdit:k,onChangeEdit:g,onSaveEdit:w,onDelete:S,onToggleLike:P,flashId:U}=o,A=n.thumbs??n.thumbsUpUsers??[],j=A.map(C=>String(C||"").toLowerCase()).includes(h),W=n.thumbsCount??A.length,D=String(U||"")===String(n._id)?"bg-yellow-50 ring-2 ring-yellow-300 rounded-lg p-2 transition-colors":"";return e.createElement("li",null,e.createElement("div",{id:`comment-${n._id}`,className:`flex items-start gap-3 ${D}`},e.createElement("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gray-200"}),e.createElement("div",{className:"min-w-0 flex-1"},e.createElement("div",{className:"flex items-center gap-2"},e.createElement("span",{className:"text-sm font-medium text-gray-900"},a(n.email)),e.createElement("span",{className:"text-xs text-gray-500"},"• ",T(n.createdAt).fromNow())),N===n._id?e.createElement("div",{className:"mt-2"},e.createElement("textarea",{value:u,onChange:C=>g(C.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),e.createElement("div",{className:"mt-2 flex gap-2"},e.createElement("button",{onClick:w,disabled:E===n._id,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},E===n._id?"Saving…":"Save"),e.createElement("button",{onClick:k,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))):e.createElement("p",{className:"mt-1 whitespace-pre-wrap break-words text-sm text-gray-800"},n.content),e.createElement("div",{className:"mt-2 flex items-center gap-3 text-xs text-gray-600"},e.createElement("button",{onClick:()=>P(n._id),disabled:$===n._id,className:`rounded px-2 py-1 ${j?"bg-blue-50 text-blue-600":"hover:bg-gray-100"} disabled:opacity-60`},"👍 ",W),e.createElement("button",{onClick:()=>v(n._id),className:"rounded px-2 py-1 hover:bg-gray-100"},"Reply"),String(n.email||"").toLowerCase()===h&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>R(n),className:"rounded px-2 py-1 hover:bg-gray-100"},"Edit"),e.createElement("button",{onClick:()=>S(n._id),disabled:x===n._id,className:"rounded px-2 py-1 text-red-600 hover:bg-red-50 disabled:opacity-60"},x===n._id?"Deleting…":"Delete"))),((F=n.children)==null?void 0:F.length)>0&&e.createElement("ul",{className:"mt-3 space-y-3 border-l-2 border-gray-200 pl-6"},n.children.map(C=>e.createElement(ae,{key:C._id,node:C,me:h,getLabel:a,replyingId:s,replyText:l,postingReplyId:c,editingId:N,editText:u,savingId:E,deletingId:x,likingId:$,onStartReply:v,onCancelReply:L,onChangeReply:_,onSubmitReply:I,onStartEdit:R,onCancelEdit:k,onChangeEdit:g,onSaveEdit:w,onDelete:S,onToggleLike:P,flashId:U}))))),s===n._id&&e.createElement("div",{className:"ml-11 mt-2"},e.createElement("textarea",{value:l,onChange:C=>_(C.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10",placeholder:"Write a reply…"}),e.createElement("div",{className:"mt-2 flex gap-2"},e.createElement("button",{onClick:()=>I(n._id),disabled:c===n._id,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},c===n._id?"Posting…":"Reply"),e.createElement("button",{onClick:L,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))))}T.extend(ne);T.locale("en");function Pe(){var k;const{id:o}=he(),n=pe(),h=fe(),{user:a}=q(),{school:s,schoolTheme:l}=te(),c=ye(),{token:N}=q(),[u,E]=d.useState(null),[x,$]=d.useState(""),v=async()=>{try{const g=await Ee({school:s,token:N,id:o});E(g)}catch(g){$(g.message||"Failed to load the post.")}};d.useEffect(()=>{v()},[o,s]),d.useEffect(()=>{const w=new URLSearchParams(h.search).get("nid");async function S(){if(!(!w||!(a!=null&&a.email)||!s))try{const P="https://api.cnapss.com/api".replace(/\/+$/,"");await xe(`${P}/${s}/notification/mark-read`,{method:"POST",headers:{"Content-Type":"application/json"},body:{commentId:w,email:a.email}})}catch{}}S()},[h.search,a==null?void 0:a.email,s]);const L=d.useMemo(()=>{const g=h.hash||"",w=g.startsWith("#comment-")?g.slice(9):null,S=new URLSearchParams(h.search).get("nid");return w||S||null},[h.hash,h.search]),_=d.useMemo(()=>(a==null?void 0:a.email)===(u==null?void 0:u.email),[a,u]),I=async()=>{if(window.confirm("Delete this post?"))try{await we(o,a.email,s),alert("Post deleted."),n(c("/freeboard"))}catch(g){alert("Delete failed: "+(g.message||"Unknown error"))}},R=async()=>{try{await Ce({school:s,token:N,id:u._id}),E(g=>g&&{...g,thumbsUpUsers:(g.thumbsUpUsers||[]).includes(((a==null?void 0:a.email)||"").toLowerCase())?g.thumbsUpUsers.filter(w=>w.toLowerCase()!==((a==null?void 0:a.email)||"").toLowerCase()):[...g.thumbsUpUsers||[],((a==null?void 0:a.email)||"").toLowerCase()]}),await v()}catch(g){alert("Failed to like: "+(g.message||"Unknown error"))}};return x?e.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-red-700",style:{backgroundColor:(l==null?void 0:l.bg)||"#f6f3ff"}},x):u?e.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(l==null?void 0:l.bg)||"#f6f3ff"}},e.createElement("div",{className:"mx-auto max-w-3xl"},e.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},e.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},e.createElement("h1",{className:"text-2xl font-bold text-gray-900"},u.title),e.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",e.createElement("span",{className:"font-medium"},"anonymous")," • ",T(u.createdAt).fromNow())),e.createElement("div",{className:"p-5 sm:p-6"},e.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},e.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},u.content)),e.createElement("div",{className:"mt-6 flex flex-wrap items-center gap-3"},e.createElement("button",{onClick:R,className:"rounded-xl border border-gray-300 bg-white px-3 py-1.5 text-sm text-gray-800 shadow-sm hover:bg-gray-50","aria-label":"like post"},"👍 ",((k=u.thumbsUpUsers)==null?void 0:k.length)||0),_&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>n(c(`/freeboard/edit/${u._id}`)),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:(l==null?void 0:l.primary)||"#6b46c1"}},"Edit"),e.createElement("button",{onClick:I,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")),e.createElement(be,{to:c("/freeboard"),className:"ml-auto text-sm font-medium text-blue-600 underline underline-offset-2"},"← Back to List")))),(u==null?void 0:u._id)&&e.createElement("div",{className:"mt-6 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm sm:p-6"},e.createElement(Le,{postId:u._id,authorEmail:u.email,highlightId:L})))):e.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-gray-600",style:{backgroundColor:(l==null?void 0:l.bg)||"#f6f3ff"}},"Loading…")}export{Pe as default};
