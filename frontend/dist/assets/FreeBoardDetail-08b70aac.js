import{a as A,b as D,r as i,R as e,A as z,d as b,e as j,f as R,u as I,c as J,L as K}from"./index-bc0094ac.js";import"./en-51b9912e.js";import{f as H,d as M,t as W}from"./posts-614aeac5.js";const h="https://api.cnapss.com/api".replace(/\/$/,""),E=n=>({"Content-Type":"application/json",Authorization:`Bearer ${n}`});async function q({school:n,token:m,postId:r}){const s=String(n||"").toLowerCase().trim(),a=await fetch(`${h}/${s}/comments/${r}`,{headers:E(m)});if(!a.ok)throw new Error("Failed to load comments");return a.json()}async function G({school:n,token:m,postId:r,content:s}){const a=String(n||"").toLowerCase().trim(),c=await fetch(`${h}/${a}/comments/${r}`,{method:"POST",headers:E(m),body:JSON.stringify({content:s})});if(!c.ok)throw new Error("Failed to add comment");return c.json()}async function Q({school:n,token:m,commentId:r,content:s}){const a=String(n||"").toLowerCase().trim(),c=await fetch(`${h}/${a}/comments/${r}`,{method:"PUT",headers:E(m),body:JSON.stringify({content:s})});if(!c.ok)throw new Error("Failed to update comment");return c.json()}async function V({school:n,token:m,commentId:r}){const s=String(n||"").toLowerCase().trim(),a=await fetch(`${h}/${s}/comments/${r}`,{method:"DELETE",headers:E(m)});if(!a.ok)throw new Error("Failed to delete comment");return a.json()}async function X({school:n,token:m,commentId:r}){const s=String(n||"").toLowerCase().trim(),a=await fetch(`${h}/${s}/comments/${r}/thumbs`,{method:"POST",headers:E(m)});if(!a.ok)throw new Error("Failed to toggle comment like");return a.json()}b.extend(j);b.locale("en");function Y({postId:n}){const{user:m,token:r}=A(),{school:s}=D(),[a,c]=i.useState([]),[l,w]=i.useState(!0),[x,N]=i.useState(""),[p,v]=i.useState(""),[k,C]=i.useState(!1),[g,d]=i.useState(null),[L,S]=i.useState(""),$=((m==null?void 0:m.email)||"").toLowerCase(),P=i.useCallback(async()=>{if(!(!n||!s||!r)){w(!0),N("");try{const t=await q({school:s,token:r,postId:n});c(Array.isArray(t)?t:[])}catch(t){console.error("comments:load failed",t),N("Failed to load comments."),c([])}finally{w(!1)}}},[n,s,r]);i.useEffect(()=>{P()},[P]);const F=async()=>{const t=p.trim();if(!(!t||!n))try{const o=await G({school:s,token:r,postId:n,content:t});c(u=>[...u,o]),v("")}catch(o){console.error("comments:add failed",o),alert("Failed to add comment.")}},U=t=>{d(t._id),S(t.content||"")},_=()=>{d(null),S("")},B=async()=>{const t=L.trim();if(!(!t||!g))try{const o=await Q({school:s,token:r,commentId:g,content:t});c(u=>u.map(f=>f._id===g?o:f)),_()}catch(o){console.error("comments:update failed",o),alert("Failed to update comment.")}},O=async t=>{if(window.confirm("Delete this comment?"))try{await V({school:s,token:r,commentId:t}),c(o=>o.filter(u=>u._id!==t))}catch(o){console.error("comments:delete failed",o),alert("Failed to delete comment.")}},T=async t=>{try{const o=await X({school:s,token:r,commentId:t});c(u=>u.map(f=>{var y;return f._id===t?{...f,thumbs:o.thumbs??[],thumbsCount:o.count??(((y=o.thumbs)==null?void 0:y.length)||0)}:f}))}catch(o){console.error("comments:thumb toggle failed",o)}};return!m||!r?e.createElement("div",{className:"mt-6 rounded-xl border border-gray-200 bg-white p-4 text-sm text-gray-600"},"Please log in to view and write comments."):e.createElement("div",{className:"mt-8"},e.createElement("h3",{className:"mb-3 text-lg font-semibold text-gray-900"},"Comments"),e.createElement("div",{className:"mb-4 rounded-xl border border-gray-200 bg-white p-3 shadow-sm"},e.createElement("textarea",{value:p,onChange:t=>v(t.target.value),onCompositionStart:()=>C(!0),onCompositionEnd:()=>C(!1),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&!k&&(t.preventDefault(),F())},placeholder:"Write a comment‚Ä¶",className:"h-20 w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),e.createElement("div",{className:"mt-2 text-right"},e.createElement(z,{onClick:F,className:"rounded-lg bg-gray-900 px-3 py-2 text-sm font-medium text-white hover:bg-black"},"Post"))),e.createElement("div",{className:"rounded-xl border border-gray-200 bg-white p-2 sm:p-3"},l?e.createElement("div",{className:"p-3 text-sm text-gray-600"},"Loading‚Ä¶"):x?e.createElement("div",{className:"rounded-lg bg-red-50 p-3 text-sm text-red-700"},x):a.length===0?e.createElement("div",{className:"p-3 text-sm text-gray-600"},"No comments yet."):e.createElement("ul",{className:"divide-y divide-gray-100"},a.map(t=>{const o=(t.email||"").toLowerCase()===$,u=(t.thumbs||[]).map(y=>y.toLowerCase()).includes($),f=t.thumbsCount??(t.thumbs?t.thumbs.length:0);return e.createElement("li",{key:t._id,className:"py-3"},e.createElement("div",{className:"flex items-start gap-3"},e.createElement("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gray-200"}),e.createElement("div",{className:"min-w-0 flex-1"},e.createElement("div",{className:"flex items-center gap-2"},e.createElement("span",{className:"text-sm font-medium text-gray-900"},(t.email||"").split("@")[0]||"anon"),e.createElement("span",{className:"text-xs text-gray-500"},"‚Ä¢ ",b(t.createdAt).fromNow())),g===t._id?e.createElement("div",{className:"mt-2"},e.createElement("textarea",{value:L,onChange:y=>S(y.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),e.createElement("div",{className:"mt-2 flex gap-2"},e.createElement("button",{onClick:B,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black"},"Save"),e.createElement("button",{onClick:_,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))):e.createElement("p",{className:"mt-1 whitespace-pre-wrap break-words text-sm text-gray-800"},t.content),e.createElement("div",{className:"mt-2 flex items-center gap-3 text-xs text-gray-600"},e.createElement("button",{onClick:()=>T(t._id),className:`rounded px-2 py-1 ${u?"bg-blue-50 text-blue-600":"hover:bg-gray-100"}`,title:"Like"},"üëç ",f),o&&g!==t._id&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>U(t),className:"rounded px-2 py-1 hover:bg-gray-100"},"Edit"),e.createElement("button",{onClick:()=>O(t._id),className:"rounded px-2 py-1 text-red-600 hover:bg-red-50"},"Delete"))))))}))))}b.extend(j);b.locale("en");function ae(){var g;const{id:n}=R(),m=I(),{user:r}=A(),{school:s,schoolTheme:a}=D(),c=J(),[l,w]=i.useState(null),[x,N]=i.useState(""),p=async()=>{try{const d=await H(n,s);w(d)}catch(d){N(d.message||"Failed to load the post.")}};i.useEffect(()=>{p()},[n,s]);const v=i.useMemo(()=>(r==null?void 0:r.email)===(l==null?void 0:l.email),[r,l]),k=async()=>{if(window.confirm("Delete this post?"))try{await M(n,r.email,s),alert("Post deleted."),m(c("/freeboard"))}catch(d){alert("Delete failed: "+(d.message||"Unknown error"))}},C=async()=>{try{await W(n,r.email),await p()}catch(d){alert("Failed to like: "+(d.message||"Unknown error"))}};return x?e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-red-700",style:{backgroundColor:(a==null?void 0:a.bg)||"#f6f3ff"}},x):l?e.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(a==null?void 0:a.bg)||"#f6f3ff"}},e.createElement("div",{className:"mx-auto max-w-3xl"},e.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},e.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},e.createElement("h1",{className:"text-2xl font-bold text-gray-900"},l.title),e.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",e.createElement("span",{className:"font-medium"},"anonymous")," ‚Ä¢ ",b(l.createdAt).fromNow())),e.createElement("div",{className:"p-5 sm:p-6"},e.createElement("div",{className:"prose prose-sm max-w-none text-gray-800"},e.createElement("p",{className:"whitespace-pre-wrap leading-relaxed"},l.content)),e.createElement("div",{className:"mt-6 flex flex-wrap items-center gap-3"},e.createElement("button",{onClick:C,className:"rounded-xl border border-gray-300 bg-white px-3 py-1.5 text-sm text-gray-800 shadow-sm hover:bg-gray-50","aria-label":"like post"},"üëç ",((g=l.thumbsUpUsers)==null?void 0:g.length)||0),v&&e.createElement(e.Fragment,null,e.createElement("button",{onClick:()=>m(c(`/freeboard/edit/${l._id}`)),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white shadow",style:{backgroundColor:(a==null?void 0:a.primary)||"#6b46c1"}},"Edit"),e.createElement("button",{onClick:k,className:"rounded-xl bg-red-500 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete")),e.createElement(K,{to:c("/freeboard"),className:"ml-auto text-sm font-medium text-blue-600 underline underline-offset-2"},"‚Üê Back to List")))),(l==null?void 0:l._id)&&e.createElement("div",{className:"mt-6 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm sm:p-6"},e.createElement(Y,{postId:l._id,postAuthorEmail:l.email})))):e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-gray-600",style:{backgroundColor:(a==null?void 0:a.bg)||"#f6f3ff"}},"Loading‚Ä¶")}export{ae as default};
