import{g as ye,c as pe,b as be,h as he,r as d,R as n,A as te}from"./index-23cb31e7.js";import{d as K,r as xe}from"./relativeTime-e8198505.js";import{u as we}from"./useLoginGate-ddcede42.js";var Ee={exports:{}};(function(e,u){(function(l,a){e.exports=a()})(ye,function(){return{name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(l){var a=["th","st","nd","rd"],r=l%100;return"["+l+(a[(r-20)%10]||a[r]||a[0])+"]"}}})})(Ee);const $="https://api.cnapss.com/api".replace(/\/$/,""),R=e=>e?{"Content-Type":"application/json",Authorization:`Bearer ${e}`}:{"Content-Type":"application/json"};async function _e({school:e,postId:u}){const l=String(e||"").toLowerCase().trim(),a=await fetch(`${$}/public/${l}/comments/${u}`,{method:"GET"});if(!a.ok)throw new Error("Failed to load comments");return a.json()}async function Se({school:e,token:u,postId:l}){const a=String(e||"").toLowerCase().trim();if(!u)return _e({school:a,postId:l});const r=await fetch(`${$}/${a}/comments/${l}`,{headers:R(u)});if(!r.ok)throw new Error("Failed to load comments");return r.json()}async function ee({school:e,token:u,postId:l,content:a,parentId:r=null}){const g=String(e||"").toLowerCase().trim(),c={content:String(a||"").trim()};r&&(c.parentId=String(r));const x=await fetch(`${$}/${g}/comments/${l}`,{method:"POST",headers:R(u),body:JSON.stringify(c)});if(!x.ok)throw new Error("Failed to add comment");return x.json()}async function Ce({school:e,token:u,commentId:l,content:a}){const r=String(e||"").toLowerCase().trim(),g=await fetch(`${$}/${r}/comments/${l}`,{method:"PUT",headers:R(u),body:JSON.stringify({content:a})});if(!g.ok)throw new Error("Failed to update comment");return g.json()}async function Ne({school:e,token:u,commentId:l}){const a=String(e||"").toLowerCase().trim(),r=await fetch(`${$}/${a}/comments/${l}`,{method:"DELETE",headers:R(u)});if(!r.ok)throw new Error("Failed to delete comment");return r.json()}async function ve({school:e,token:u,commentId:l}){const a=String(e||"").toLowerCase().trim(),r=await fetch(`${$}/${a}/comments/${l}/thumbs`,{method:"POST",headers:R(u)});if(!r.ok)throw new Error("Failed to toggle comment like");return r.json()}K.extend(xe);K.locale("en");const i=e=>e==null?"":String(e),S=e=>String(e||"").toLowerCase().trim();function Te({postId:e,authorEmail:u="",highlightId:l=null}){const{user:a,token:r}=pe(),{school:g}=be(),c=he(),{ensureAuth:x}=we(),C=S(a==null?void 0:a.email),b=S(u),[w,h]=d.useState([]),[U,N]=d.useState(!0),[v,L]=d.useState(""),[T,F]=d.useState(""),[j,M]=d.useState(!1),[J,P]=d.useState(!1),[E,k]=d.useState(null),[A,z]=d.useState(""),[G,D]=d.useState(null),[y,I]=d.useState(null),[ae,B]=d.useState(""),[oe,Y]=d.useState(null),[re,H]=d.useState(null),[se,V]=d.useState(null),[le,q]=d.useState(l||null),Q=d.useCallback(async()=>{if(!(!e||!g)){N(!0),L("");try{const t=await Se({school:g,token:r,postId:e});h(Array.isArray(t)?t:[])}catch(t){console.error("comments:load failed",t),L("Failed to load comments."),h([])}finally{N(!1)}}},[e,g,r]);d.useEffect(()=>{Q()},[Q]),d.useEffect(()=>{if(!(c!=null&&c.emit)||!(c!=null&&c.on)||!e)return;c.emit("post:join",{postId:e});const t=o=>{!o||String(o.postId)!==String(e)||h(p=>p.some(_=>i(_._id)===i(o._id))?p:[...p,o])},m=o=>{!o||String(o.postId)!==String(e)||h(p=>p.map(_=>i(_._id)===i(o._id)?o:_))},f=({_id:o})=>{o&&h(p=>p.filter(_=>i(_._id)!==i(o)))},s=({_id:o,thumbs:p})=>{o&&h(_=>_.map(W=>i(W._id)===i(o)?{...W,thumbsUpUsers:p||[],thumbsCount:(p||[]).length}:W))};return c.on("comment:new",t),c.on("comment:update",m),c.on("comment:delete",f),c.on("comment:thumbs",s),()=>{try{c.emit("post:leave",{postId:e})}catch{}c.off("comment:new",t),c.off("comment:update",m),c.off("comment:delete",f),c.off("comment:thumbs",s)}},[c,e]);const X=d.useMemo(()=>{const t=new Map;for(const s of w){const o=S(s.email);if(!o)continue;const p=new Date(s.createdAt||0).getTime();t.has(o)?t.set(o,Math.min(t.get(o),p)):t.set(o,p)}const m=Array.from(t.keys()).filter(s=>s&&s!==b);m.sort((s,o)=>(t.get(s)||0)-(t.get(o)||0));const f=new Map;return b&&f.set(b,"anonymous (OP)"),m.forEach((s,o)=>f.set(s,`anonymous ${o+1}`)),f},[w,b]),ce=d.useCallback(t=>X.get(S(t))||"anonymous",[X]);d.useEffect(()=>{if(!l)return;q(l);const t=setTimeout(()=>q(null),1500);return()=>clearTimeout(t)},[l]);const{roots:me,childrenMap:ie}=d.useMemo(()=>{const t=(w||[]).map(s=>({...s,_id:i(s._id),parentId:i(s.parentId)||null})),m=new Map,f=[];for(const s of t){s.parentId||f.push(s);const o=m.get(s.parentId||"__root__")||[];o.push(s),m.set(s.parentId||"__root__",o)}return{roots:f,childrenMap:m}},[w]),O=()=>!a||!r?(x(),!1):!0,Z=async()=>{const t=T.trim();if(t&&O()){M(!0);try{await ee({school:g,token:r,postId:e,content:t,parentId:null}),F("")}catch(m){console.error("comments:add root failed",m),alert("Failed to add comment.")}finally{M(!1)}}},de=async t=>{const m=A.trim();if(!m||!O())return;const f=i(t);D(f);try{await ee({school:g,token:r,postId:e,content:m,parentId:f}),k(null),z("")}catch(s){console.error("comments:add reply failed",s),alert("Failed to add reply.")}finally{D(null)}},ue=async()=>{const t=ae.trim();if(!(!t||!y)&&O()){Y(y);try{await Ce({school:g,token:r,commentId:y,content:t}),I(null),B("")}catch(m){console.error("comments:update failed",m),alert("Failed to update comment.")}finally{Y(null)}}},fe=async t=>{if(!O()||!window.confirm("Delete this comment?"))return;const m=i(t);H(m);try{await Ne({school:g,token:r,commentId:m})}catch(f){console.error("comments:delete failed",f),alert("Failed to delete comment.")}finally{H(null)}},ge=async(t,m)=>{if(!O()||S(m)===C)return;const f=i(t);V(f);try{await ve({school:g,token:r,commentId:f})}catch(s){console.error("comments:thumb toggle failed",s)}finally{V(null)}};return n.createElement("div",{className:"mt-8"},n.createElement("h3",{className:"mb-3 text-lg font-semibold text-gray-900"},"Comments"),n.createElement("div",{className:"mb-4 rounded-xl border bg-white p-3 shadow-sm"},n.createElement("textarea",{value:T,onChange:t=>F(t.target.value),onCompositionStart:()=>P(!0),onCompositionEnd:()=>P(!1),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&!J&&(t.preventDefault(),Z())},placeholder:"Write a commentâ€¦",className:"h-20 w-full resize-none rounded-lg border px-3 py-2 text-sm"}),n.createElement("div",{className:"mt-2 flex items-center justify-between"},!a&&n.createElement("span",{className:"text-xs text-gray-500"},"Youâ€™ll be asked to log in when you post."),n.createElement(te,{disabled:j,onClick:Z,className:"rounded-lg bg-gray-900 px-3 py-2 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},j?"Postingâ€¦":"Post"))),n.createElement("div",{className:"rounded-xl border bg-white p-2 sm:p-3"},U?n.createElement("div",{className:"p-3 text-sm text-gray-600"},"Loadingâ€¦"):v?n.createElement("div",{className:"rounded-lg bg-red-50 p-3 text-sm text-red-700"},v):w.length===0?n.createElement("div",{className:"p-3 text-sm text-gray-600"},"No comments yet."):n.createElement("ul",{className:"space-y-3"},me.map(t=>n.createElement(ne,{key:i(t._id),node:t,depth:0,me:C,labelOf:ce,childrenMap:ie,replyingId:E,replyText:A,postingReplyId:G,setReplyingId:k,setReplyText:z,submitReply:de,onToggleLike:ge,likingId:se,deletingId:re,savingId:oe,onStartEdit:m=>{I(i(m._id)),B(m.content||"")},onCancelEdit:()=>{I(null),B("")},onChangeEdit:B,onSaveEdit:ue,onDelete:fe,editingId:y,flashId:le,isAuthed:!!a})))))}function ne({node:e,depth:u,me:l,labelOf:a,childrenMap:r,replyingId:g,replyText:c,postingReplyId:x,setReplyingId:C,setReplyText:b,submitReply:w,onToggleLike:h,likingId:U,deletingId:N,savingId:v,onStartEdit:L,onCancelEdit:T,onChangeEdit:F,onSaveEdit:j,onDelete:M,editingId:J,flashId:P,isAuthed:E}){const k=S(e.email)===l,A=e.thumbs??e.thumbsUpUsers??[],z=A.map(y=>S(y)).includes(l),G=e.thumbsCount??A.length,D=(r.get(i(e._id))||[]).filter(y=>i(y._id)!==i(e._id));return n.createElement("li",null,n.createElement("div",{id:`comment-${e._id}`,className:`flex items-start gap-3 rounded-lg p-2 ${P===i(e._id)?"bg-yellow-50":""} ${u?"border-l border-gray-200 pl-4":""}`,style:{marginLeft:u?u*30:0}},n.createElement("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gray-200"}),n.createElement("div",{className:"min-w-0 flex-1"},n.createElement("div",{className:"flex items-center gap-2"},n.createElement("span",{className:"text-sm font-medium text-gray-900"},a(e.email)),n.createElement("span",{className:"text-xs text-gray-500"},"â€¢ ",K(e.createdAt).fromNow())),J===i(e._id)?n.createElement("div",{className:"mt-2"},n.createElement("textarea",{defaultValue:e.content,onChange:y=>F(y.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),n.createElement("div",{className:"mt-2 flex gap-2"},n.createElement("button",{onClick:j,disabled:v===e._id||!E,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60",title:E?"Save":"Log in to edit"},v===e._id?"Savingâ€¦":"Save"),n.createElement("button",{onClick:T,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))):n.createElement("p",{className:"mt-1 whitespace-pre-wrap break-words text-sm text-gray-800"},e.content),n.createElement("div",{className:"mt-2 flex items-center gap-3 text-xs text-gray-600"},n.createElement("button",{onClick:()=>h(e._id,e.email),disabled:U===e._id||k||!E,className:`rounded px-2 py-1 ${z?"bg-blue-50 text-blue-600":"hover:bg-gray-100"} disabled:opacity-60`,title:E?k?"You canâ€™t like your own comment.":"Like comment":"Log in to like"},"ðŸ‘ ",G),n.createElement("button",{onClick:()=>{C(i(e._id)),b("")},className:"rounded px-2 py-1 hover:bg-gray-100",title:"Reply"},"Reply"),E&&k&&n.createElement(n.Fragment,null,n.createElement("button",{onClick:()=>L(e),className:"rounded px-2 py-1 hover:bg-gray-100"},"Edit"),n.createElement("button",{onClick:()=>M(e._id),disabled:N===e._id,className:"rounded px-2 py-1 text-red-600 hover:bg-red-50 disabled:opacity-60"},N===e._id?"Deletingâ€¦":"Delete"))),g===i(e._id)&&n.createElement("div",{className:"mt-2 rounded-lg border bg-white p-2"},n.createElement("textarea",{value:c,onChange:y=>b(y.target.value),placeholder:"Write a replyâ€¦",className:"h-16 w-full resize-none rounded-md border px-3 py-2 text-sm"}),n.createElement("div",{className:"mt-2 flex items-center gap-2"},n.createElement(te,{onClick:()=>w(e._id),disabled:x===e._id||!c.trim(),className:"rounded-md bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},x===e._id?"Postingâ€¦":"Reply"),n.createElement("button",{onClick:()=>{C(null),b("")},className:"rounded-md border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))))),D.length>0&&n.createElement("ul",{className:"mt-2 space-y-3"},D.map(y=>n.createElement(ne,{key:i(y._id),node:y,depth:Math.min(u+1,6),me:l,labelOf:a,childrenMap:r,replyingId:g,replyText:c,postingReplyId:x,setReplyingId:C,setReplyText:b,submitReply:w,onToggleLike:h,likingId:U,deletingId:N,savingId:v,onStartEdit:L,onCancelEdit:T,onChangeEdit:F,onSaveEdit:j,onDelete:M,editingId:J,flashId:P,isAuthed:E}))))}export{Te as C};
