import{u as pe,a as ye,m as be,e as he,r as i,R as n,A as te}from"./index-ff0a1258.js";import{d as W,r as Ee}from"./relativeTime-0f8c31ec.js";import"./en-9094a96d.js";const $="https://api.cnapss.com/api".replace(/\/$/,""),U=e=>e?{"Content-Type":"application/json",Authorization:`Bearer ${e}`}:{"Content-Type":"application/json"};async function we({school:e,postId:u}){const d=String(e||"").toLowerCase().trim(),c=await fetch(`${$}/public/${d}/comments/${u}`,{method:"GET"});if(!c.ok)throw new Error("Failed to load comments");return c.json()}async function xe({school:e,token:u,postId:d}){const c=String(e||"").toLowerCase().trim();if(!u)return we({school:c,postId:d});const r=await fetch(`${$}/${c}/comments/${d}`,{headers:U(u)});if(!r.ok)throw new Error("Failed to load comments");return r.json()}async function ee({school:e,token:u,postId:d,content:c,parentId:r=null}){const g=String(e||"").toLowerCase().trim(),s={content:String(c||"").trim()};r&&(s.parentId=String(r));const E=await fetch(`${$}/${g}/comments/${d}`,{method:"POST",headers:U(u),body:JSON.stringify(s)});if(!E.ok)throw new Error("Failed to add comment");return E.json()}async function Ce({school:e,token:u,commentId:d,content:c}){const r=String(e||"").toLowerCase().trim(),g=await fetch(`${$}/${r}/comments/${d}`,{method:"PUT",headers:U(u),body:JSON.stringify({content:c})});if(!g.ok)throw new Error("Failed to update comment");return g.json()}async function Se({school:e,token:u,commentId:d}){const c=String(e||"").toLowerCase().trim(),r=await fetch(`${$}/${c}/comments/${d}`,{method:"DELETE",headers:U(u)});if(!r.ok)throw new Error("Failed to delete comment");return r.json()}async function Ne({school:e,token:u,commentId:d}){const c=String(e||"").toLowerCase().trim(),r=await fetch(`${$}/${c}/comments/${d}/thumbs`,{method:"POST",headers:U(u)});if(!r.ok)throw new Error("Failed to toggle comment like");return r.json()}W.extend(Ee);W.locale("en");const m=e=>e==null?"":String(e),S=e=>String(e||"").toLowerCase().trim();function $e({postId:e,authorEmail:u="",highlightId:d=null}){const{user:c,token:r}=pe(),{school:g}=ye(),s=be(),{ensureAuth:E}=he(),N=S(c==null?void 0:c.email),b=S(u),[w,h]=i.useState([]),[O,_]=i.useState(!0),[k,L]=i.useState(""),[T,F]=i.useState(""),[P,j]=i.useState(!1),[z,A]=i.useState(!1),[x,v]=i.useState(null),[D,B]=i.useState(""),[G,M]=i.useState(null),[p,J]=i.useState(null),[ae,I]=i.useState(""),[oe,Y]=i.useState(null),[re,H]=i.useState(null),[se,V]=i.useState(null),[le,q]=i.useState(d||null),Q=i.useCallback(async()=>{if(!(!e||!g)){_(!0),L("");try{const t=await xe({school:g,token:r,postId:e});h(Array.isArray(t)?t:[])}catch(t){console.error("comments:load failed",t),L("Failed to load comments."),h([])}finally{_(!1)}}},[e,g,r]);i.useEffect(()=>{Q()},[Q]),i.useEffect(()=>{if(!(s!=null&&s.emit)||!(s!=null&&s.on)||!e)return;s.emit("post:join",{postId:e});const t=a=>{!a||String(a.postId)!==String(e)||h(y=>y.some(C=>m(C._id)===m(a._id))?y:[...y,a])},l=a=>{!a||String(a.postId)!==String(e)||h(y=>y.map(C=>m(C._id)===m(a._id)?a:C))},f=({_id:a})=>{a&&h(y=>y.filter(C=>m(C._id)!==m(a)))},o=({_id:a,thumbs:y})=>{a&&h(C=>C.map(K=>m(K._id)===m(a)?{...K,thumbsUpUsers:y||[],thumbsCount:(y||[]).length}:K))};return s.on("comment:new",t),s.on("comment:update",l),s.on("comment:delete",f),s.on("comment:thumbs",o),()=>{try{s.emit("post:leave",{postId:e})}catch{}s.off("comment:new",t),s.off("comment:update",l),s.off("comment:delete",f),s.off("comment:thumbs",o)}},[s,e]);const X=i.useMemo(()=>{const t=new Map;for(const o of w){const a=S(o.email);if(!a)continue;const y=new Date(o.createdAt||0).getTime();t.has(a)?t.set(a,Math.min(t.get(a),y)):t.set(a,y)}const l=Array.from(t.keys()).filter(o=>o&&o!==b);l.sort((o,a)=>(t.get(o)||0)-(t.get(a)||0));const f=new Map;return b&&f.set(b,"anonymous (OP)"),l.forEach((o,a)=>f.set(o,`anonymous ${a+1}`)),f},[w,b]),ce=i.useCallback(t=>X.get(S(t))||"anonymous",[X]);i.useEffect(()=>{if(!d)return;q(d);const t=setTimeout(()=>q(null),1500);return()=>clearTimeout(t)},[d]);const{roots:me,childrenMap:ie}=i.useMemo(()=>{const t=(w||[]).map(o=>({...o,_id:m(o._id),parentId:m(o.parentId)||null})),l=new Map,f=[];for(const o of t){o.parentId||f.push(o);const a=l.get(o.parentId||"__root__")||[];a.push(o),l.set(o.parentId||"__root__",a)}return{roots:f,childrenMap:l}},[w]),R=()=>!c||!r?(E(),!1):!0,Z=async()=>{const t=T.trim();if(t&&R()){j(!0);try{await ee({school:g,token:r,postId:e,content:t,parentId:null}),F("")}catch(l){console.error("comments:add root failed",l),alert("Failed to add comment.")}finally{j(!1)}}},de=async t=>{const l=D.trim();if(!l||!R())return;const f=m(t);M(f);try{await ee({school:g,token:r,postId:e,content:l,parentId:f}),v(null),B("")}catch(o){console.error("comments:add reply failed",o),alert("Failed to add reply.")}finally{M(null)}},ue=async()=>{const t=ae.trim();if(!(!t||!p)&&R()){Y(p);try{await Ce({school:g,token:r,commentId:p,content:t}),J(null),I("")}catch(l){console.error("comments:update failed",l),alert("Failed to update comment.")}finally{Y(null)}}},fe=async t=>{if(!R()||!window.confirm("Delete this comment?"))return;const l=m(t);H(l);try{await Se({school:g,token:r,commentId:l})}catch(f){console.error("comments:delete failed",f),alert("Failed to delete comment.")}finally{H(null)}},ge=async(t,l)=>{if(!R()||S(l)===N)return;const f=m(t);V(f);try{await Ne({school:g,token:r,commentId:f})}catch(o){console.error("comments:thumb toggle failed",o)}finally{V(null)}};return n.createElement("div",{className:"mt-8"},n.createElement("h3",{className:"mb-3 text-lg font-semibold text-gray-900"},"Comments"),n.createElement("div",{className:"mb-4 rounded-xl border bg-white p-3 shadow-sm"},n.createElement("textarea",{value:T,onChange:t=>F(t.target.value),onCompositionStart:()=>A(!0),onCompositionEnd:()=>A(!1),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&!z&&(t.preventDefault(),Z())},placeholder:"Write a comment…",className:"h-20 w-full resize-none rounded-lg border px-3 py-2 text-sm"}),n.createElement("div",{className:"mt-2 flex items-center justify-between"},!c&&n.createElement("span",{className:"text-xs text-gray-500"},"You’ll be asked to log in when you post."),n.createElement(te,{disabled:P,onClick:Z,className:"rounded-lg bg-gray-900 px-3 py-2 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},P?"Posting…":"Post"))),n.createElement("div",{className:"rounded-xl border bg-white p-2 sm:p-3"},O?n.createElement("div",{className:"p-3 text-sm text-gray-600"},"Loading…"):k?n.createElement("div",{className:"rounded-lg bg-red-50 p-3 text-sm text-red-700"},k):w.length===0?n.createElement("div",{className:"p-3 text-sm text-gray-600"},"No comments yet."):n.createElement("ul",{className:"space-y-3"},me.map(t=>n.createElement(ne,{key:m(t._id),node:t,depth:0,me:N,labelOf:ce,childrenMap:ie,replyingId:x,replyText:D,postingReplyId:G,setReplyingId:v,setReplyText:B,submitReply:de,onToggleLike:ge,likingId:se,deletingId:re,savingId:oe,onStartEdit:l=>{J(m(l._id)),I(l.content||"")},onCancelEdit:()=>{J(null),I("")},onChangeEdit:I,onSaveEdit:ue,onDelete:fe,editingId:p,flashId:le,isAuthed:!!c})))))}function ne({node:e,depth:u,me:d,labelOf:c,childrenMap:r,replyingId:g,replyText:s,postingReplyId:E,setReplyingId:N,setReplyText:b,submitReply:w,onToggleLike:h,likingId:O,deletingId:_,savingId:k,onStartEdit:L,onCancelEdit:T,onChangeEdit:F,onSaveEdit:P,onDelete:j,editingId:z,flashId:A,isAuthed:x}){const v=S(e.email)===d,D=e.thumbs??e.thumbsUpUsers??[],B=D.map(p=>S(p)).includes(d),G=e.thumbsCount??D.length,M=(r.get(m(e._id))||[]).filter(p=>m(p._id)!==m(e._id));return n.createElement("li",null,n.createElement("div",{id:`comment-${e._id}`,className:`flex items-start gap-3 rounded-lg p-2 ${A===m(e._id)?"bg-yellow-50":""} ${u?"border-l border-gray-200 pl-4":""}`,style:{marginLeft:u?u*30:0}},n.createElement("div",{className:"h-8 w-8 shrink-0 rounded-full bg-gray-200"}),n.createElement("div",{className:"min-w-0 flex-1"},n.createElement("div",{className:"flex items-center gap-2"},n.createElement("span",{className:"text-sm font-medium text-gray-900"},c(e.email)),n.createElement("span",{className:"text-xs text-gray-500"},"• ",W(e.createdAt).fromNow())),z===m(e._id)?n.createElement("div",{className:"mt-2"},n.createElement("textarea",{defaultValue:e.content,onChange:p=>F(p.target.value),className:"w-full resize-none rounded-lg border border-gray-300 px-3 py-2 text-sm outline-none focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}),n.createElement("div",{className:"mt-2 flex gap-2"},n.createElement("button",{onClick:P,disabled:k===e._id||!x,className:"rounded-lg bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60",title:x?"Save":"Log in to edit"},k===e._id?"Saving…":"Save"),n.createElement("button",{onClick:T,className:"rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))):n.createElement("p",{className:"mt-1 whitespace-pre-wrap break-words text-sm text-gray-800"},e.content),n.createElement("div",{className:"mt-2 flex items-center gap-3 text-xs text-gray-600"},n.createElement("button",{onClick:()=>h(e._id,e.email),disabled:O===e._id||v||!x,className:`rounded px-2 py-1 ${B?"bg-blue-50 text-blue-600":"hover:bg-gray-100"} disabled:opacity-60`,title:x?v?"You can’t like your own comment.":"Like comment":"Log in to like"},"👍 ",G),n.createElement("button",{onClick:()=>{N(m(e._id)),b("")},className:"rounded px-2 py-1 hover:bg-gray-100",title:"Reply"},"Reply"),x&&v&&n.createElement(n.Fragment,null,n.createElement("button",{onClick:()=>L(e),className:"rounded px-2 py-1 hover:bg-gray-100"},"Edit"),n.createElement("button",{onClick:()=>j(e._id),disabled:_===e._id,className:"rounded px-2 py-1 text-red-600 hover:bg-red-50 disabled:opacity-60"},_===e._id?"Deleting…":"Delete"))),g===m(e._id)&&n.createElement("div",{className:"mt-2 rounded-lg border bg-white p-2"},n.createElement("textarea",{value:s,onChange:p=>b(p.target.value),placeholder:"Write a reply…",className:"h-16 w-full resize-none rounded-md border px-3 py-2 text-sm"}),n.createElement("div",{className:"mt-2 flex items-center gap-2"},n.createElement(te,{onClick:()=>w(e._id),disabled:E===e._id||!s.trim(),className:"rounded-md bg-gray-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-black disabled:opacity-60"},E===e._id?"Posting…":"Reply"),n.createElement("button",{onClick:()=>{N(null),b("")},className:"rounded-md border border-gray-300 px-3 py-1.5 text-sm text-gray-700"},"Cancel"))))),M.length>0&&n.createElement("ul",{className:"mt-2 space-y-3"},M.map(p=>n.createElement(ne,{key:m(p._id),node:p,depth:Math.min(u+1,6),me:d,labelOf:c,childrenMap:r,replyingId:g,replyText:s,postingReplyId:E,setReplyingId:N,setReplyText:b,submitReply:w,onToggleLike:h,likingId:O,deletingId:_,savingId:k,onStartEdit:L,onCancelEdit:T,onChangeEdit:F,onSaveEdit:P,onDelete:j,editingId:z,flashId:A,isAuthed:x}))))}export{$e as C};
