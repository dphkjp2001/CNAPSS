import{f as V,u as X,a as Z,c as ee,b as te,d as ae,r as c,R as t}from"./index-23cb31e7.js";import{C as se}from"./CommentSection-2c879fea.js";import{d as N,r as ne}from"./relativeTime-e8198505.js";import{g as C,b as re,d as oe,p as j,a as ce}from"./http-3e12da79.js";import{u as le}from"./useLoginGate-ddcede42.js";const b="https://api.cnapss.com/api".replace(/\/$/,"");async function ie({school:s,id:n}){const r=`${b}/public/${s}/career-posts/${n}`;return C(r)}async function de({school:s,id:n}){const r=`${b}/${s}/career-posts/${n}`;return C(r)}async function me({school:s,id:n,title:r,content:i,postType:g,type:f,kind:l,tags:d}){const p=`${b}/${s}/career-posts/${n}`;return re(p,{title:r,content:i,postType:g,type:f,kind:l,tags:d})}async function ue({school:s,id:n}){const r=`${b}/${s}/career-posts/${n}`;return oe(r)}async function fe({school:s,id:n}){const r=`${b}/${s}/career-posts/${n}/thumbs`;return j(r,{})}const D="https://api.cnapss.com/api".replace(/\/$/,"");function ge({school:s,targetId:n,initialMessage:r}){return j(`${D}/${s}/request`,{targetId:n,initialMessage:r})}function pe({school:s,targetId:n}){const r=new URL(`${D}/${s}/request/exists`);return r.searchParams.set("targetId",n),C(r.toString())}N.extend(ne);N.locale("en");const ye=(s,n=!1)=>{const r=String(s||(n?"looking_for":"")).toLowerCase();return r==="looking_for"||r==="looking"||r==="lf"||r==="seeking"?"seeking":"question"},xe=s=>{const n=String(s||"").toLowerCase();return n==="study_group"?"study_mate":n},be=s=>s==="course_materials"?"Course Materials":s==="study_mate"?"Study Mate":s==="coffee_chat"?"Coffee Chat":"";function Ne(){var M;const{id:s}=V(),n=X(),r=Z(),{user:i,token:g}=ee(),{ensureAuth:f}=le(),{school:l,schoolTheme:d}=te(),p=ae(),[e,S]=c.useState(null),[$,T]=c.useState(""),[h,E]=c.useState(!1),[J,z]=c.useState(""),[q,I]=c.useState(""),[P,_]=c.useState(!1),[O,v]=c.useState(!1),[L,B]=c.useState(""),[R,U]=c.useState(!1),[u,G]=c.useState({exists:!1,conversationId:null}),A=async()=>{try{const a=g?await de({school:l,id:s}):await ie({school:l,id:s});S(a),z((a==null?void 0:a.title)||""),I((a==null?void 0:a.content)||"")}catch(a){T(a.message||"Failed to load the post.")}};c.useEffect(()=>{A()},[s,l,g]),c.useEffect(()=>{const o=new URLSearchParams(r.search).get("nid");async function m(){if(!(!o||!(i!=null&&i.email)||!l))try{const w="https://api.cnapss.com/api".replace(/\/+$/,"");await ce(`${w}/${l}/notification/mark-read`,{method:"POST",headers:{"Content-Type":"application/json"},body:{commentId:o,email:i.email}})}catch{}}m()},[r.search,i==null?void 0:i.email,l]);const x=c.useMemo(()=>((i==null?void 0:i.email)||"").toLowerCase()===((e==null?void 0:e.email)||"").toLowerCase(),[i,e]),k=c.useMemo(()=>ye((e==null?void 0:e.postType)||(e==null?void 0:e.type),(e==null?void 0:e.lookingFor)||(e==null?void 0:e.isLookingFor)),[e]),y=k==="seeking",F=c.useMemo(()=>y?xe(e==null?void 0:e.kind):"",[y,e==null?void 0:e.kind]);c.useEffect(()=>{let a=!0;return(async()=>{if(!(!g||!l||!(e!=null&&e._id)||!y))try{const o=await pe({school:l,targetId:e._id});if(!a)return;G({exists:!!(o!=null&&o.exists),conversationId:(o==null?void 0:o.conversationId)||null})}catch{}})(),()=>{a=!1}},[g,l,e==null?void 0:e._id,y]);const Y=async()=>{f(async()=>{if(window.confirm("Delete this post?"))try{await ue({school:l,id:e._id}),alert("Post deleted."),n(p("/dashboard?tab=academic"))}catch(a){alert("Delete failed: "+(a.message||"Unknown error"))}})},K=async()=>{f(async()=>{try{await fe({school:l,id:e._id}),await A()}catch(a){alert("Failed to like: "+(a.message||"Unknown error"))}})},Q=async()=>{f(async()=>{const a=J.trim(),o=q.trim();if(a){_(!0);try{const m=await me({school:l,id:e._id,title:a,content:o,postType:k,kind:F}),w=(m==null?void 0:m.post)||m;S(w),E(!1)}catch(m){alert("Update failed: "+(m.message||"Unknown error"))}finally{_(!1)}}})},W=()=>f(()=>{u.exists&&u.conversationId?n(p(`/messages?conversation=${u.conversationId}`)):v(!0)}),H=()=>f(async()=>{if(!y)return;const a=(L||"").trim();if(!a){alert("Write a short hello message.");return}U(!0);try{const o=await ge({school:l,targetId:e._id,initialMessage:a}),m=o==null?void 0:o.conversationId;m?(v(!1),n(p(`/messages?conversation=${m}`))):alert("Sent, but failed to find the conversation ID.")}catch(o){alert((o==null?void 0:o.message)||"Failed to send request.")}finally{U(!1)}});return $?t.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-red-700",style:{backgroundColor:(d==null?void 0:d.bg)||"#f6f3ff"}},$):e?t.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(d==null?void 0:d.bg)||"#f6f3ff"}},t.createElement("div",{className:"mx-auto max-w-3xl"},t.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},t.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},t.createElement("div",{className:"flex items-center gap-2"},t.createElement("h1",{className:"text-2xl font-bold text-gray-900"},e.title),t.createElement("span",{className:"rounded-full border px-2 py-0.5 text-xs text-gray-700"},k==="question"?"General Question":`Seeking · ${be(F)}`)),t.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Posted by ",t.createElement("span",{className:"font-medium"},"anonymous")," • ",N(e.createdAt).fromNow())),t.createElement("div",{className:"p-5 sm:p-6"},h?t.createElement("textarea",{value:q,onChange:a=>I(a.target.value),placeholder:"Content",className:"h-56 w-full resize-y rounded-xl border border-gray-300 px-3 py-2 text-sm text-gray-800 focus:border-gray-900 focus:ring-2 focus:ring-gray-900/10"}):t.createElement("div",{className:"prose max-w-none whitespace-pre-wrap text-sm text-gray-900"},e.content)),t.createElement("div",{className:"flex items-center justify-between border-t border-gray-100 px-5 py-3 sm:px-6"},t.createElement("div",{className:"flex items-center gap-2"},t.createElement("button",{onClick:K,disabled:x,className:"rounded-lg border px-3 py-1 text-sm hover:bg-gray-50 disabled:opacity-60",title:x?"You can’t like your own post.":"Like post"},"👍 Like"),t.createElement("span",{className:"text-xs text-gray-500"},((M=e.thumbsUpUsers)==null?void 0:M.length)||0," likes")),t.createElement("div",{className:"flex items-center gap-2"},x&&!h&&t.createElement(t.Fragment,null,t.createElement("button",{onClick:()=>E(!0),className:"rounded-lg border px-3 py-1 text-sm hover:bg-gray-50"},"✏️ Edit"),t.createElement("button",{onClick:Y,className:"rounded-lg border px-3 py-1 text-sm text-red-600 hover:bg-red-50"},"🗑️ Delete")),x&&h&&t.createElement(t.Fragment,null,t.createElement("button",{onClick:Q,disabled:P,className:"rounded-lg border px-3 py-1 text-sm text-white",style:{backgroundColor:"#111827"}},P?"Saving...":"Save"),t.createElement("button",{onClick:()=>E(!1),className:"rounded-lg border px-3 py-1 text-sm"},"Cancel")),!x&&y&&t.createElement("button",{onClick:W,className:"rounded-lg border px-3 py-1 text-sm",title:u.exists?"You already requested":"Send request (first message)",disabled:u.exists&&!!u.conversationId},u.exists&&u.conversationId?"Requested":"Send request"))),t.createElement("div",{className:"border-t border-gray-100 p-5 sm:p-6"},t.createElement(se,{postId:e._id,authorEmail:e.email}))),t.createElement("div",{className:"mt-6"},t.createElement("button",{onClick:()=>n(p("/dashboard?tab=academic")),className:"text-sm text-gray-600 hover:underline"},"← Back to list"))),O&&t.createElement("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4"},t.createElement("div",{className:"w-full max-w-md rounded-2xl bg-white p-5 shadow-xl"},t.createElement("h3",{className:"mb-2 text-lg font-semibold"},"Send request"),t.createElement("p",{className:"mb-3 text-sm text-gray-600"},"This sends your first message to the author. A conversation will be created."),t.createElement("textarea",{value:L,onChange:a=>B(a.target.value),placeholder:"Say hello and what you’re looking for…",className:"h-28 w-full resize-none rounded-xl border px-3 py-2 text-sm"}),t.createElement("div",{className:"mt-3 flex justify-end gap-2"},t.createElement("button",{onClick:()=>v(!1),className:"rounded-lg border px-3 py-1 text-sm"},"Cancel"),t.createElement("button",{onClick:H,disabled:R,className:"rounded-lg bg-gray-900 px-3 py-1 text-sm font-semibold text-white disabled:opacity-60"},R?"Sending…":"Send"))))):t.createElement("div",{className:"flex min-h-screen items-center justify-center text-sm text-gray-600",style:{backgroundColor:(d==null?void 0:d.bg)||"#f6f3ff"}},"Loading…")}export{Ne as default};
