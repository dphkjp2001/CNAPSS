import{e as $,u as M,a as L,b as R,r as u,R as e}from"./index-1baf5031.js";import{a as D}from"./axios-b5ee139b.js";import{u as G}from"./uploadToCloudinary-a2ae08d3.js";const w=3,q=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}),J=()=>{const{id:x}=$(),p=M(),{user:y}=L(),{schoolTheme:o}=R(),b="https://api.cnapss.com/api",[s,h]=u.useState({title:"",description:"",price:""}),[i,d]=u.useState([]),[F,E]=u.useState(!0),[k,N]=u.useState(""),C=u.useMemo(()=>!(!s.title.trim()||!s.price||Number.isNaN(Number(s.price))||Number(s.price)<0),[s.title,s.price]);u.useEffect(()=>{let t=!0;return(async()=>{try{const n=(await D.get(`${b}/market/${x}`)).data;if(n.seller!==(y==null?void 0:y.email)){alert("You donâ€™t have permission to edit this listing."),p("/market");return}if(!t)return;h({title:n.title||"",description:n.description||"",price:String(n.price??"")});const l=Array.isArray(n.images)?n.images:[];d(l.map((c,g)=>({url:c,isCover:g===0})))}catch(a){console.error(a),alert("Failed to load the listing."),p("/market")}finally{t&&E(!1)}})(),()=>{t=!1}},[x,y,p,b]);const S=t=>{const{name:r,value:a}=t.target;h(n=>({...n,[r]:a}))},I=t=>{const r=t.target.value.replace(/[^\d.]/g,"");h(a=>({...a,price:r}))},A=async t=>{const r=Math.max(0,w-i.length),a=Array.from(t||[]).slice(0,r);if(!a.length)return;const n=a.map(l=>({url:URL.createObjectURL(l),uploading:!0}));d(l=>[...l,...n]);for(let l=0;l<a.length;l++)try{const c=await G(a[l]);d(g=>{const m=[...g],f=m.findIndex(v=>v.uploading);return f!==-1&&(m[f]={url:c,uploading:!1}),m})}catch(c){console.error("image upload failed",c),d(g=>{const m=[...g],f=m.findIndex(v=>v.uploading);return f!==-1&&m.splice(f,1),m}),N("Failed to upload one or more images.")}},j=t=>{d(r=>r.filter((a,n)=>n!==t))},P=t=>{d(r=>{const a=r.map((l,c)=>({...l,isCover:c===t})),[n]=a.splice(t,1);return a.unshift(n),a})},U=async t=>{if(t.preventDefault(),!(!C||i.some(r=>r.uploading)))try{E(!0),N(""),await D.put(`${b}/market/${x}`,{title:s.title.trim(),description:s.description.trim(),price:parseFloat(s.price),images:i.map(r=>r.url)}),p(`/market/${x}`)}catch(r){console.error(r),N("Failed to save changes. Please try again."),alert("Update failed.")}finally{E(!1)}};return F?e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-gray-600",style:{backgroundColor:(o==null?void 0:o.bg)||"#f6f3ff"}},"Loadingâ€¦"):e.createElement("div",{className:"min-h-screen px-4 py-6 sm:px-6",style:{backgroundColor:(o==null?void 0:o.bg)||"#f6f3ff"}},e.createElement("div",{className:"mx-auto max-w-3xl"},e.createElement("div",{className:"rounded-2xl border border-gray-200 bg-white shadow-sm"},e.createElement("div",{className:"border-b border-gray-100 p-5 sm:p-6"},e.createElement("h1",{className:"text-xl font-bold text-gray-900"},"Edit Listing"),e.createElement("p",{className:"mt-1 text-sm text-gray-500"},"Update photos, title, price, and description. The first photo is used as the cover.")),e.createElement("form",{onSubmit:U,className:"p-5 sm:p-6 space-y-6"},e.createElement("section",null,e.createElement("label",{className:"block text-sm font-medium text-gray-900"},"Photos ",e.createElement("span",{className:"font-normal text-gray-400"},"(up to ",w,")")),e.createElement("div",{className:"mt-2 flex flex-col items-center justify-center rounded-xl border-2 border-dashed border-gray-300 bg-gray-50/60 p-6 text-center transition hover:bg-gray-50",onDragOver:t=>t.preventDefault(),onDrop:t=>{t.preventDefault(),!(i.length>=w)&&A(t.dataTransfer.files)}},e.createElement("input",{id:"file-input",type:"file",accept:"image/*",multiple:!0,onChange:t=>A(t.target.files),className:"hidden"}),e.createElement("div",{className:"text-3xl"},"ðŸ–¼ï¸"),e.createElement("p",{className:"mt-2 text-sm text-gray-700"},"Drag & drop images here, or"," ",e.createElement("label",{htmlFor:"file-input",className:"cursor-pointer font-medium text-gray-900 underline underline-offset-2"},"browse")),e.createElement("p",{className:"text-xs text-gray-500 mt-1"},"PNG/JPG, up to ~5MB each")),i.length>0&&e.createElement("div",{className:"mt-4 grid grid-cols-2 gap-3 sm:grid-cols-3"},i.map((t,r)=>e.createElement("div",{key:r,className:"group relative overflow-hidden rounded-xl border border-gray-200 bg-white shadow-sm"},e.createElement("div",{className:"aspect-[4/3] bg-gray-50"},e.createElement("img",{src:t.url,alt:`photo ${r+1}`,className:`h-full w-full object-cover ${t.uploading?"opacity-60":""}`})),e.createElement("div",{className:"absolute inset-x-0 bottom-0 flex items-center justify-between gap-2 p-2"},e.createElement("button",{type:"button",onClick:()=>P(r),className:"rounded-md bg-white/90 px-2 py-1 text-xs font-medium text-gray-800 shadow hover:bg-white"},r===0?"Cover":"Set as cover"),e.createElement("button",{type:"button",onClick:()=>j(r),className:"rounded-md bg-white/90 px-2 py-1 text-xs font-medium text-red-600 shadow hover:bg-white"},"Remove")),t.uploading&&e.createElement("div",{className:"absolute inset-0 flex items-center justify-center bg-white/60 text-xs text-gray-700"},"Uploadingâ€¦"))))),e.createElement("section",{className:"grid grid-cols-1 gap-4 sm:grid-cols-3"},e.createElement("div",{className:"sm:col-span-2"},e.createElement("label",{className:"block text-sm font-medium text-gray-900"},"Title"),e.createElement("input",{name:"title",value:s.title,onChange:S,placeholder:"e.g., iPad Air 64GB (Blue)",className:"mt-2 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10",required:!0})),e.createElement("div",null,e.createElement("label",{className:"block text-sm font-medium text-gray-900"},"Price"),e.createElement("div",{className:"mt-2 flex items-center rounded-xl border border-gray-300 bg-white px-3 py-2 shadow-sm focus-within:ring-2 focus-within:ring-gray-900/10"},e.createElement("span",{className:"mr-2 text-gray-500"},"$"),e.createElement("input",{name:"price",value:s.price,onChange:I,inputMode:"decimal",placeholder:"0",className:"w-full text-sm text-gray-900 placeholder:text-gray-400 focus:outline-none",required:!0})),s.price&&e.createElement("p",{className:"mt-1 text-xs text-gray-500"},q.format(Number(s.price)||0)))),e.createElement("section",null,e.createElement("label",{className:"block text-sm font-medium text-gray-900"},"Description"),e.createElement("textarea",{name:"description",value:s.description,onChange:S,rows:5,placeholder:"Add key details, usage, defects, pickup options, etc.",className:"mt-2 w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10",required:!0})),k&&e.createElement("div",{className:"rounded-xl border border-red-200 bg-red-50 p-3 text-sm text-red-700"},k),e.createElement("div",{className:"flex items-center justify-end gap-2 border-t border-gray-100 pt-4"},e.createElement("button",{type:"button",onClick:()=>p(-1),className:"rounded-xl border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-800 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-900/10"},"Cancel"),e.createElement("button",{type:"submit",disabled:!C||i.some(t=>t.uploading),className:"inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold text-white shadow transition disabled:cursor-not-allowed disabled:opacity-60",style:{backgroundColor:(o==null?void 0:o.primary)||"#6b46c1"}},"Save Changes"))))))};export{J as default};
