import{g as F,j as G,c as U,b as K,h as z,r as m,R as t,f as O,i as V}from"./index-05491e16.js";import{a as Z,d as A,r as Q}from"./relativeTime-a92fcb2a.js";import{g as H,p as J}from"./http-b5e27cd5.js";var q={exports:{}};(function(r,u){(function(i,c){r.exports=c()})(F,function(){var i={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"};return function(c,y,d){var l=y.prototype,_=l.format;d.en.formats=i,l.format=function(p){p===void 0&&(p="YYYY-MM-DDTHH:mm:ssZ");var v=this.$locale().formats,s=function(f,w){return f.replace(/(\[[^\]]+])|(LTS?|l{1,4}|L{1,4})/g,function(x,h,g){var M=g&&g.toUpperCase();return h||w[g]||i[g]||w[M].replace(/(\[[^\]]+])|(MMMM|MM|DD|dddd)/g,function(k,D,b){return D||b.slice(1)})})}(p,v===void 0?{}:v);return _.call(this,s)}}})})(q);var W=q.exports;const X=G(W);var I={exports:{}};(function(r,u){(function(i,c){r.exports=c(Z)})(F,function(i){function c(l){return l&&typeof l=="object"&&"default"in l?l:{default:l}}var y=c(i),d={name:"ko",weekdays:"일요일_월요일_화요일_수요일_목요일_금요일_토요일".split("_"),weekdaysShort:"일_월_화_수_목_금_토".split("_"),weekdaysMin:"일_월_화_수_목_금_토".split("_"),months:"1월_2월_3월_4월_5월_6월_7월_8월_9월_10월_11월_12월".split("_"),monthsShort:"1월_2월_3월_4월_5월_6월_7월_8월_9월_10월_11월_12월".split("_"),ordinal:function(l){return l+"일"},formats:{LT:"A h:mm",LTS:"A h:mm:ss",L:"YYYY.MM.DD.",LL:"YYYY년 MMMM D일",LLL:"YYYY년 MMMM D일 A h:mm",LLLL:"YYYY년 MMMM D일 dddd A h:mm",l:"YYYY.MM.DD.",ll:"YYYY년 MMMM D일",lll:"YYYY년 MMMM D일 A h:mm",llll:"YYYY년 MMMM D일 dddd A h:mm"},meridiem:function(l){return l<12?"오전":"오후"},relativeTime:{future:"%s 후",past:"%s 전",s:"몇 초",m:"1분",mm:"%d분",h:"한 시간",hh:"%d시간",d:"하루",dd:"%d일",M:"한 달",MM:"%d달",y:"일 년",yy:"%d년"}};return y.default.locale(d,null,!0),d})})(I);const j="https://api.cnapss.com/api".replace(/\/$/,"");function ee({school:r,token:u}){return H(`${j}/${r}/chat/conversations`)}function te({school:r,token:u,conversationId:i,cursor:c,limit:y=50}){const d=new URL(`${j}/${r}/chat/conversations/${i}/messages`);return c&&d.searchParams.set("cursor",c),d.searchParams.set("limit",String(y)),H(d.toString())}function ae({school:r,token:u,conversationId:i,content:c}){return J(`${j}/${r}/chat/conversations/${i}/messages`,{content:c})}function re({school:r,token:u,conversationId:i}){return J(`${j}/${r}/chat/conversations/${i}/read`,{})}A.locale("ko");A.extend(Q);A.extend(X);function se({conversationId:r,userEmail:u,onClose:i,fullSize:c=!1,otherNickname:y,otherEmail:d}){const{user:l,token:_}=U()||{},{school:p}=K()||{},{socket:v,emit:s,on:f,off:w}=z(),x=((l==null?void 0:l.email)||u||"").toLowerCase(),[h,g]=m.useState([]),[M,k]=m.useState(""),[D,b]=m.useState(!1),[R,L]=m.useState(!1),e=m.useRef(null);m.useEffect(()=>{if(!r||!_||!p)return;let a=!0;return(async()=>{try{L(!0);const n=await te({school:p,token:_,conversationId:r});if(!a)return;g((Array.isArray(n)?n:[]).reverse()),s==null||s("chat:read",{conversationId:r});try{await re({school:p,token:_,conversationId:r})}catch{}}finally{a&&L(!1)}})(),()=>{a=!1}},[r,_,p,s]),m.useEffect(()=>{if(!r||!v)return;s==null||s("chat:join",{conversationId:r});const a=E=>{String(E.conversationId)===String(r)&&(g(C=>C.some(S=>S._id&&E._id&&String(S._id)===String(E._id))?C:[...C,E]),s==null||s("chat:read",{conversationId:r}))},n=({conversationId:E,reader:C})=>{String(E)===String(r)&&g(P=>P.map(S=>(S.readBy||[]).includes(C)?S:{...S,readBy:[...S.readBy||[],C]}))},Y=f==null?void 0:f("chat:receive",a),T=f==null?void 0:f("chat:read:updated",n);return()=>{typeof Y=="function"&&Y(),typeof T=="function"&&T()}},[v,s,f,r]);const o=async()=>{const a=M.trim();if(!(!a||!r))try{const n=await ae({school:p,token:_,conversationId:r,content:a});g(Y=>(n==null?void 0:n._id)&&Y.some(E=>String(E._id)===String(n._id))?Y:[...Y,n])}catch(n){console.error("send failed",n),alert("메시지 전송 실패")}finally{k("")}};m.useEffect(()=>{var a;(a=e.current)==null||a.scrollIntoView({behavior:"smooth",block:"nearest"})},[h]);const N=(a,n)=>{var Y;return n===0||!A(a.createdAt).isSame((Y=h[n-1])==null?void 0:Y.createdAt,"day")},$=[...h].reverse().find(a=>(a.sender||"").toLowerCase()===x&&(a.readBy||[]).map(n=>n.toLowerCase()).includes((d||"").toLowerCase()));return t.createElement("div",{className:`relative border rounded-lg shadow bg-white flex flex-col ${c?"w-full h-full":"w-[360px]"}`},i&&t.createElement("button",{onClick:i,className:"absolute top-2 right-2 text-gray-400 hover:text-black text-xl"},"×"),t.createElement("div",{className:"flex items-center gap-2 border-b p-2 font-semibold"},t.createElement("span",null,"🗨️"),t.createElement("span",null,y||"Chat")),t.createElement("div",{className:"flex-1 overflow-y-auto p-3 space-y-2"},R&&t.createElement("div",{className:"text-sm text-gray-500"},"Loading..."),h.map((a,n)=>t.createElement("div",{key:a._id||n},N(a,n)&&t.createElement("div",{className:"text-center text-xs text-gray-400 my-2"},A(a.createdAt).format("YYYY년 M월 D일")),t.createElement("div",{className:`flex ${(a.sender||"").toLowerCase()===x?"justify-end":"justify-start"}`},t.createElement("div",{className:"max-w-xs"},t.createElement("div",{className:`px-3 py-1 rounded-lg break-words ${(a.sender||"").toLowerCase()===x?"bg-blue-600 text-white":"bg-gray-200 text-black"}`},a.content),t.createElement("div",{className:`text-[11px] mt-1 ${(a.sender||"").toLowerCase()===x?"text-right text-gray-400":"text-left text-gray-500"}`},A(a.createdAt).format("A h:mm"),a===$&&t.createElement("span",{className:"ml-1 text-blue-500 font-medium"},"Seen")))))),t.createElement("div",{ref:e})),t.createElement("div",{className:"flex gap-2 p-2 border-t"},t.createElement("input",{type:"text",className:"flex-1 border rounded p-2",value:M,onChange:a=>k(a.target.value),onCompositionStart:()=>b(!0),onCompositionEnd:()=>b(!1),onKeyDown:a=>{a.key==="Enter"&&!D&&o()},placeholder:"메시지를 입력하세요..."}),t.createElement("button",{onClick:o,disabled:!M.trim(),className:"bg-blue-600 text-white px-4 rounded hover:bg-blue-700 disabled:opacity-50"},"Send")))}function ie(){const{user:r,token:u}=U()||{},{school:i}=O(),[c,y]=V(),{on:d}=z()||{},[l,_]=m.useState([]),[p,v]=m.useState(!0),[s,f]=m.useState(null),[w,x]=m.useState("all"),h=(i||"").toLowerCase(),g=m.useMemo(()=>((r==null?void 0:r.email)||"").toLowerCase(),[r]),M=m.useCallback(async()=>{if(!(!u||!h)){v(!0);try{const e=await ee({school:h,token:u}),o=Array.isArray(e)?e:Array.isArray(e==null?void 0:e.items)?e.items:[];return _(o),o}finally{v(!1)}}},[h,u]);m.useEffect(()=>{let e=!0;(async()=>{const N=await M();if(!e)return;const $=c.get("conversation");if($&&Array.isArray(N)){const a=N.find(n=>String(n._id)===String($));a&&(f(a),x((a==null?void 0:a.source)==="looking_for"?"looking_for":"all"))}})();const o=d==null?void 0:d("chat:preview",()=>{M()});return()=>{e=!1,typeof o=="function"&&o()}},[M,d,c]);const k=e=>{const o=String((e==null?void 0:e.buyer)||"").toLowerCase(),N=String((e==null?void 0:e.seller)||"").toLowerCase();return o===g?N:o},D=e=>e?String(e).split("@")[0]:"Unknown",b=e=>{const o=e==null?void 0:e.resourceTitle;return o&&o.trim()?o:D(k(e))},R=e=>String(e==null?void 0:e.source).toLowerCase()==="looking_for"?"🎓 Seeking":"💬 DM",L=m.useMemo(()=>w==="all"?l:l.filter(e=>String(e==null?void 0:e.source).toLowerCase()==="looking_for"),[l,w]);return m.useEffect(()=>{const e=s!=null&&s._id?String(s._id):null,o=new URLSearchParams(c.toString());e?o.set("conversation",e):o.delete("conversation"),y(o,{replace:!0})},[s]),t.createElement("div",{className:"mx-auto flex h-[calc(100vh-120px)] max-w-6xl gap-4 p-4"},t.createElement("div",{className:"flex w-[340px] shrink-0 flex-col rounded-2xl border bg-white"},t.createElement("div",{className:"flex flex-wrap gap-2 p-3"},t.createElement(B,{active:w==="all",onClick:()=>x("all")},"All"),t.createElement(B,{active:w==="looking_for",onClick:()=>x("looking_for")},"Academic Seeking")),t.createElement("div",{className:"min-h-0 grow overflow-y-auto"},p?t.createElement("div",{className:"p-3 text-sm text-gray-500"},"Loading…"):L!=null&&L.length?t.createElement("ul",{className:"divide-y"},L.map(e=>{const o=(s==null?void 0:s._id)===e._id;return t.createElement("li",{key:e._id},t.createElement("button",{onClick:()=>{f(e),x(String(e==null?void 0:e.source).toLowerCase()==="looking_for"?"looking_for":"all")},className:"flex w-full items-center justify-between gap-2 px-3 py-3 text-left hover:bg-gray-50 "+(o?"bg-violet-50":"")},t.createElement("div",{className:"min-w-0"},t.createElement("div",{className:"flex items-center gap-2"},t.createElement("span",{className:"whitespace-nowrap rounded-full bg-gray-800 px-2 py-0.5 text-[11px] font-semibold text-white"},R(e)),t.createElement("span",{className:"truncate text-sm font-semibold text-gray-900"},b(e))),e.lastMessage?t.createElement("div",{className:"truncate text-xs text-gray-500"},e.lastMessage):null)))})):t.createElement("div",{className:"p-3 text-sm text-gray-500"},"No conversations."))),t.createElement("div",{className:"min-w-0 grow rounded-2xl border bg-white"},s?t.createElement(se,{conversationId:s._id,userEmail:r==null?void 0:r.email,otherEmail:k(s),otherNickname:b(s),fullSize:!0}):t.createElement("div",{className:"mt-20 text-center text-gray-400"},"🧭 왼쪽에서 채팅을 선택하세요.")))}function B({active:r,children:u,onClick:i}){return t.createElement("button",{onClick:i,className:"rounded-full px-3 py-1 text-xs font-semibold "+(r?"bg-violet-600 text-white":"border border-gray-300 bg-white text-gray-700 hover:bg-gray-50")},u)}export{ie as default};
