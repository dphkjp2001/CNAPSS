import{u as I,h as D,n as j,g as H,r as n,q as O,R as a,C as R}from"./index-78c8ba5d.js";function q(){const{user:l,token:y}=I()||{},{school:x}=D(),[k]=j(),{on:u,off:i}=H(),b=n.useMemo(()=>String(x||localStorage.getItem("selectedSchool")||"").toLowerCase(),[x]),[f,h]=n.useState([]),[r,g]=n.useState(null),[d,A]=n.useState("all"),c=((l==null?void 0:l.email)||"").toLowerCase(),M=e=>(String(e||"").split("@")[0]||"").trim(),L=e=>{const t=((e==null?void 0:e.buyer)||"").toLowerCase()===c,s=t?e==null?void 0:e.sellerNickname:e==null?void 0:e.buyerNickname,o=t?e==null?void 0:e.seller:e==null?void 0:e.buyer;return(s&&s!=="Unknown"?s:M(o))||"Unknown"},E=e=>{const t=((e==null?void 0:e.source)||"").toLowerCase();return t==="market"?"market":t==="coursehub"?"coursehub":e!=null&&e.itemId?"market":"dm"},B=e=>{const t=E(e);return t==="market"?"🛒 Market":t==="coursehub"?"🎓 CourseHub":"💬 DM"},w=e=>{var t;return((t=e==null?void 0:e.resourceTitle)==null?void 0:t.trim())||L(e)},_=e=>(((e==null?void 0:e.buyer)||"").toLowerCase()===c?e==null?void 0:e.seller:e==null?void 0:e.buyer)||"",N=e=>((e==null?void 0:e.messages)||[]).filter(t=>(t.sender||"").toLowerCase()!==c&&!(t.readBy||[]).includes(c)).length,v=n.useCallback(async()=>{if(!(!y||!b))try{const e=await O({school:b,token:y}),t=Array.isArray(e)?e:[];h(t);const s=k.get("conversation");if(s){const o=t.find(p=>p._id===s);o&&g(o)}else!r&&t.length>0&&g(t[0])}catch{h([])}},[y,b,k,r]);n.useEffect(()=>{v()},[v]),n.useEffect(()=>{const e=({conversationId:t,lastMessage:s,updatedAt:o})=>{h(p=>{const S=p.map(m=>m._id===t?{...m,lastMessage:s,updatedAt:o}:m);return S.sort((m,P)=>new Date(P.updatedAt)-new Date(m.updatedAt)),S})};return u==null||u("chat:preview",e),()=>i==null?void 0:i("chat:preview",e)},[u,i]);const C=n.useMemo(()=>d==="all"?f:f.filter(e=>E(e)===d),[f,d]);return a.createElement("div",{className:"flex h-[calc(100vh-80px)]"},a.createElement("div",{className:"w-80 border-r p-4"},a.createElement("div",{className:"mb-3 flex items-center justify-between"},a.createElement("h2",{className:"text-lg font-bold"},"💬 Messages")),a.createElement("div",{className:"mb-3 flex gap-2"},[{key:"all",label:"All"},{key:"market",label:"Market"},{key:"coursehub",label:"CourseHub"}].map(e=>a.createElement("button",{key:e.key,onClick:()=>A(e.key),className:"rounded-full border px-3 py-1 text-xs "+(d===e.key?"border-blue-600 bg-blue-50 text-blue-700":"border-gray-300 text-gray-700")},e.label))),a.createElement("div",{className:"space-y-2"},C.length===0&&a.createElement("p",{className:"text-sm text-gray-500"},"해당 필터에 대화가 없습니다."),C.map(e=>a.createElement("button",{key:e._id,onClick:()=>g(e),className:`relative w-full text-left rounded-lg p-3 transition ${(r==null?void 0:r._id)===e._id?"bg-blue-100":"hover:bg-gray-100"}`},a.createElement("div",{className:"flex items-center justify-between"},a.createElement("p",{className:"max-w-[10rem] truncate font-medium"},w(e)),a.createElement("span",{className:"ml-2 shrink-0 rounded-full bg-gray-200 px-2 py-0.5 text-xs text-gray-700"},B(e))),a.createElement("p",{className:"mt-0.5 truncate text-sm text-gray-500"},e.lastMessage||"(메시지 없음)"),N(e)>0&&a.createElement("span",{className:"absolute right-2 top-2 rounded-full bg-red-500 px-1.5 py-0.5 text-xs text-white"},N(e)))))),a.createElement("div",{className:"flex-1 p-4"},r?a.createElement(R,{conversationId:r._id,userEmail:l==null?void 0:l.email,otherEmail:_(r),otherNickname:w(r),fullSize:!0}):a.createElement("div",{className:"mt-20 text-center text-gray-400"},"🧭 왼쪽에서 채팅을 선택하세요.")))}export{q as default};
