import{u as S,i as _,n as A,h as L,r as n,q as P,R as t,C as M}from"./index-fd1f797d.js";function B(){const{user:r,token:d}=S()||{},{school:f}=_(),[E]=A(),{on:l,off:m}=L(),c=n.useMemo(()=>String(f||localStorage.getItem("selectedSchool")||"").toLowerCase(),[f]),[x,h]=n.useState([]),[a,p]=n.useState(null),i=((r==null?void 0:r.email)||"").toLowerCase(),v=e=>(((e==null?void 0:e.buyer)||"").toLowerCase()===i?e==null?void 0:e.sellerNickname:e==null?void 0:e.buyerNickname)||"Unknown",b=e=>(((e==null?void 0:e.buyer)||"").toLowerCase()===i?e==null?void 0:e.seller:e==null?void 0:e.buyer)||"",y=e=>((e==null?void 0:e.messages)||[]).filter(s=>(s.sender||"").toLowerCase()!==i&&!(s.readBy||[]).includes(i)).length,N=n.useCallback(async()=>{if(!(!d||!c))try{const e=await P({school:c,token:d});h(Array.isArray(e)?e:[]);const s=E.get("conversation");if(s){const u=(e||[]).find(g=>g._id===s);u&&p(u)}else!a&&(e||[]).length>0&&p(e[0])}catch{h([])}},[d,c,E,a]);return n.useEffect(()=>{N()},[N]),n.useEffect(()=>{const e=({conversationId:s,lastMessage:u,updatedAt:g})=>{h(C=>{const w=C.map(o=>o._id===s?{...o,lastMessage:u,updatedAt:g}:o);return w.sort((o,k)=>new Date(k.updatedAt)-new Date(o.updatedAt)),w})};return l==null||l("chat:preview",e),()=>m==null?void 0:m("chat:preview",e)},[l,m]),t.createElement("div",{className:"flex h-[calc(100vh-80px)]"},t.createElement("div",{className:"w-80 border-r p-4"},t.createElement("h2",{className:"mb-4 text-lg font-bold"},"💬 Messages"),t.createElement("div",{className:"space-y-2"},x.length===0&&t.createElement("p",{className:"text-sm text-gray-500"},"진행 중인 채팅이 없습니다."),x.map(e=>t.createElement("div",{key:e._id,onClick:()=>p(e),className:`relative cursor-pointer rounded-lg p-3 ${(a==null?void 0:a._id)===e._id?"bg-blue-100":"hover:bg-gray-100"}`},t.createElement("p",{className:"font-medium"},v(e)),t.createElement("p",{className:"truncate text-sm text-gray-500"},e.lastMessage||"(메시지 없음)"),y(e)>0&&t.createElement("span",{className:"absolute right-2 top-2 rounded-full bg-red-500 px-1.5 py-0.5 text-xs text-white"},y(e)))))),t.createElement("div",{className:"flex-1 p-4"},a?t.createElement(M,{conversationId:a._id,userEmail:r==null?void 0:r.email,otherEmail:b(a),otherNickname:v(a),fullSize:!0}):t.createElement("div",{className:"mt-20 text-center text-gray-400"},"🧭 왼쪽에서 채팅을 선택하세요.")))}export{B as default};
