import{a as S,g as M,i as _,r as n,l as L,j as R,R as t,C as P}from"./index-338302ab.js";function A(){const{user:m,token:i}=S(),{school:p}=M(),[g]=_(),l=n.useMemo(()=>String(p||localStorage.getItem("selectedSchool")||"").toLowerCase(),[p]),[E,u]=n.useState([]),[a,d]=n.useState(null),N=n.useRef(null);n.useEffect(()=>{if(!i||!l)return;const e=L("https://api.cnapss.com",{transports:["websocket"],auth:{token:i},query:{school:l}});N.current=e;const s=()=>o(),r=({conversationId:f,lastMessage:C,updatedAt:k})=>{u(w=>w.map(h=>h._id===f?{...h,lastMessage:C,updatedAt:k}:h))};return e.on("receiveMessage",s),e.on("conversationUpdated",r),()=>{e.off("receiveMessage",s),e.off("conversationUpdated",r),e.close()}},[i,l]);const o=n.useCallback(async()=>{if(!(!i||!l))try{const e=await R({school:l,token:i});u(Array.isArray(e)?e:[]);const s=g.get("conversation");if(s){const r=e.find(f=>f._id===s);r&&d(r)}else!a&&e.length>0&&d(e[0])}catch(e){console.error("getConversations failed",e),u([])}},[i,l,g,a]);n.useEffect(()=>{o()},[o]);const c=((m==null?void 0:m.email)||"").toLowerCase(),y=e=>((e==null?void 0:e.buyer)||"").toLowerCase()===c?e==null?void 0:e.sellerNickname:e==null?void 0:e.buyerNickname,b=e=>((e==null?void 0:e.buyer)||"").toLowerCase()===c?e==null?void 0:e.seller:e==null?void 0:e.buyer,x=e=>{var s;return((s=e==null?void 0:e.messages)==null?void 0:s.filter(r=>(r.sender||"").toLowerCase()!==c&&!(r.readBy||[]).includes(c)).length)||0};return t.createElement("div",{className:"flex h-[calc(100vh-80px)]"},t.createElement("div",{className:"w-80 border-r p-4"},t.createElement("h2",{className:"mb-4 text-lg font-bold"},"💬 Messages"),t.createElement("div",{className:"space-y-2"},E.length===0&&t.createElement("p",{className:"text-sm text-gray-500"},"진행 중인 채팅이 없습니다."),E.map(e=>t.createElement("div",{key:e._id,onClick:()=>d(e),className:`relative cursor-pointer rounded-lg p-3 ${(a==null?void 0:a._id)===e._id?"bg-blue-100":"hover:bg-gray-100"}`},t.createElement("p",{className:"font-medium"},y(e)||"Unknown"),t.createElement("p",{className:"truncate text-sm text-gray-500"},e.lastMessage||"(메시지 없음)"),x(e)>0&&t.createElement("span",{className:"absolute right-2 top-2 rounded-full bg-red-500 px-1.5 py-0.5 text-xs text-white"},x(e)))))),t.createElement("div",{className:"flex-1 p-4"},a?t.createElement(P,{conversationId:a._id,userEmail:m.email,otherEmail:b(a),otherNickname:y(a),school:l,fullSize:!0}):t.createElement("div",{className:"mt-20 text-center text-gray-400"},"🧭 왼쪽에서 채팅을 선택하세요.")))}export{A as default};
