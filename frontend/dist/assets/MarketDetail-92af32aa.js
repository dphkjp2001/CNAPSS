import{e as M,b as P,u as U,a as O,c as K,r as l,R as e}from"./index-ea1fd978.js";import{b as z,d as B,s as G,e as H}from"./market-5ac18d5b.js";const J=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0});function W(){var C;const{id:o}=M(),m=P(),{user:d,token:c}=U(),{school:i,schoolTheme:n}=O(),u=K(),[s,R]=l.useState(null),[j,q]=l.useState(!0),[p,E]=l.useState(!1),[A,N]=l.useState(!1),[v,k]=l.useState(null),[w,S]=l.useState(""),[I,g]=l.useState(""),[f,y]=l.useState(0),x=l.useMemo(()=>!!d&&!!s&&d.email===s.seller,[d,s]);l.useEffect(()=>{let r=!0;return(async()=>{var t;try{const a=await z({school:i,token:c,id:o});if(!r)return;R(a),y(0)}catch(a){console.error(a),g(((t=a==null?void 0:a.payload)==null?void 0:t.message)||"Failed to load the item.")}finally{r&&q(!1)}})(),()=>{r=!1}},[i,c,o]),l.useEffect(()=>{let r=!0;return(async()=>{if(!(!s||x||!d))try{const t=await B({school:i,token:c,itemId:o});if(!r)return;N(!!(t!=null&&t.alreadySent)),k((t==null?void 0:t.conversationId)||null)}catch(t){console.warn("checkRequest failed:",t)}})(),()=>{r=!1}},[s,x,d,i,c,o]);const D=async()=>{var t;const r=String(w||"").trim();if(r)try{E(!0),g("");const a=await G({school:i,token:c,itemId:o,message:r});N(!0),k((a==null?void 0:a.conversationId)||null),S(""),a!=null&&a.conversationId&&m(u("messages")+`?conversation=${a.conversationId}`)}catch(a){console.error("send request failed",a),g((a==null?void 0:a.message)||((t=a==null?void 0:a.payload)==null?void 0:t.message)||"Failed to send request.")}finally{E(!1)}},$=async()=>{var r;if(window.confirm("Delete this listing? This cannot be undone."))try{await H({school:i,token:c,id:o}),m(u("/market"))}catch(t){console.error(t),g(((r=t==null?void 0:t.payload)==null?void 0:r.message)||"Failed to delete the item.")}},F=()=>{m(u(`/market/${o}/edit`))},h=l.useCallback(r=>{var t;(t=s==null?void 0:s.images)!=null&&t.length&&(r.key==="ArrowRight"?y(a=>(a+1)%s.images.length):r.key==="ArrowLeft"&&y(a=>(a-1+s.images.length)%s.images.length))},[(C=s==null?void 0:s.images)==null?void 0:C.length]);if(l.useEffect(()=>(window.addEventListener("keydown",h),()=>window.removeEventListener("keydown",h)),[h]),j)return e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-gray-600",style:{backgroundColor:(n==null?void 0:n.bg)||"#f6f3ff"}},"Loading…");if(!s)return e.createElement("div",{className:"min-h-screen flex items-center justify-center text-sm text-gray-600",style:{backgroundColor:(n==null?void 0:n.bg)||"#f6f3ff"}},"Item not found.");const b=Array.isArray(s.images)?s.images:[],L=b[f];return e.createElement("div",{className:"min-h-screen px-4 py-8",style:{backgroundColor:(n==null?void 0:n.bg)||"#f6f3ff"}},e.createElement("div",{className:"mx-auto max-w-6xl"},e.createElement("div",{className:"mb-4 flex items-start justify-between gap-3"},e.createElement("h1",{className:"text-2xl font-bold text-gray-900"},s.title),x&&e.createElement("div",{className:"flex items-center gap-2"},e.createElement("button",{onClick:F,className:"rounded-lg px-3 py-1.5 text-sm font-semibold text-white shadow",style:{backgroundColor:(n==null?void 0:n.primary)||"#6b46c1"}},"Edit"),e.createElement("button",{onClick:$,className:"rounded-lg bg-red-500 px-3 py-1.5 text-sm font-semibold text-white shadow hover:bg-red-600"},"Delete"))),e.createElement("div",{className:"grid grid-cols-1 gap-8 md:grid-cols-5"},e.createElement("div",{className:"md:col-span-3"},b.length>0?e.createElement(e.Fragment,null,e.createElement("div",{className:"overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm"},e.createElement("img",{src:L,alt:`photo ${f+1}`,className:"w-full h-full object-cover",style:{aspectRatio:"5/4"}})),b.length>1&&e.createElement("div",{className:"mt-3 flex gap-2 overflow-x-auto pb-1"},b.map((r,t)=>e.createElement("button",{key:t,type:"button","aria-label":`Show photo ${t+1}`,onClick:()=>y(t),className:`relative h-16 w-16 flex-shrink-0 overflow-hidden rounded-lg ring-1 transition 
                          ${t===f?"ring-gray-900":"ring-gray-200 hover:ring-gray-300"}`},e.createElement("img",{src:r,alt:`thumb ${t+1}`,className:"h-full w-full object-cover"}),t===f&&e.createElement("span",{className:"pointer-events-none absolute inset-0 ring-2 ring-offset-1 ring-gray-900/80 rounded-lg"}))))):e.createElement("div",{className:"flex h-64 items-center justify-center rounded-2xl border border-dashed border-gray-300 text-sm text-gray-500"},"No images")),e.createElement("div",{className:"md:col-span-2 space-y-4"},e.createElement("div",{className:"rounded-2xl border border-gray-200 bg-white p-5 shadow-sm"},e.createElement("div",{className:"text-2xl font-bold text-gray-900"},J.format(s.price)),e.createElement("div",{className:"mt-2 text-sm text-gray-600"},"Seller:"," ",e.createElement("span",{className:"font-medium"},s.sellerNickname||"Unknown")),e.createElement("div",{className:"mt-4 text-sm text-gray-700 whitespace-pre-wrap leading-relaxed"},s.description||"No description")),!x&&e.createElement("div",{className:"rounded-2xl border border-gray-200 bg-white p-4 shadow-sm"},e.createElement("div",{className:"mb-2 text-sm font-medium text-gray-900"},"Send a request"),A?e.createElement("div",{className:"flex items-center justify-between gap-2"},e.createElement("div",{className:"text-xs text-green-700"},"Request already sent."),v&&e.createElement("button",{onClick:()=>m(u("messages")+(v?`?conversation=${v}`:"")),className:"rounded-lg bg-gray-900 px-3 py-1.5 text-xs font-semibold text-white"},"Open chat")):e.createElement("div",{className:"flex flex-col gap-2"},e.createElement("input",{type:"text",className:"rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 placeholder:text-gray-400 shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/10",placeholder:"Say hi and mention pickup/payment details…",value:w,onChange:r=>S(r.target.value),disabled:p}),e.createElement("button",{onClick:D,disabled:p||!w.trim(),className:"rounded-xl px-4 py-2 text-sm font-semibold text-white disabled:cursor-not-allowed disabled:opacity-60",style:{backgroundColor:(n==null?void 0:n.primary)||"#6b46c1"}},p?"Sending…":"Send"))),I&&e.createElement("div",{className:"rounded-xl border border-red-200 bg-red-50 p-3 text-sm text-red-700"},I)))))}export{W as default};
